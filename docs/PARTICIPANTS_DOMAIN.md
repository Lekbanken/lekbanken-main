# Participants Domain Documentation

**Version:** 1.0  
**Last Updated:** 2025-12-17  
**Status:** Active (repo-anchored; avoid drift-prone pseudo-schema)

## Metadata

- Owner: -
- Status: active
- Last validated: 2025-12-17

## Related code (source of truth)

- API (participants): `app/api/participants/**`
- API (play surface): `app/api/play/**`
  - `app/api/play/join/route.ts` (re-export)
  - `app/api/play/rejoin/route.ts` (re-export)
  - `app/api/play/me/route.ts`
  - `app/api/play/heartbeat/route.ts`
  - `app/api/play/session/[code]/route.ts`
  - `app/api/play/sessions/**` (host runtime)
- Core services:
  - `lib/services/participants/session-service.ts`
  - `lib/services/participants/session-code-generator.ts`
  - `lib/services/participants/participant-token.ts`
- Client usage:
  - `features/play/api/session-api.ts`
  - `features/play-participant/api.ts`
  - `features/play-participant/tokenStorage.ts`
  - `features/play-participant/useParticipantSession.ts`
- DB schema + types:
  - `supabase/migrations/`
  - `types/supabase.ts` (generated)

---

## 1. Overview

Participants Domain enables **anonymous, temporary participation** in a host-owned session, without requiring participants to create accounts.

High-level shape:
- **Host** is an authenticated user (multi-tenant membership).
- **Participant** is identified by a **participant token** scoped to a **participant session**.
- Participants join via a short **6-character session code**.

---

## 2. Identity & tokens

### 2.1 Session code

- Generated by `lib/services/participants/session-code-generator.ts`.
- Format: 6 characters from a reduced alphabet (excludes confusing characters like `0/O`, `1/I/L`).
- Stored on the session row as `participant_sessions.session_code`.

### 2.2 Participant token

- Generated via `crypto.randomUUID()` in `lib/services/participants/participant-token.ts`.
- Stored on the participant row as `participants.participant_token`.
- Expiry is enforced via `participants.token_expires_at` (nullable = no expiry) plus status checks (`active|idle|disconnected|kicked|blocked`).

### 2.3 Client storage

There are multiple UI entry points; the reusable participants client stores auth per session code:
- `features/play-participant/tokenStorage.ts`: localStorage key `${prefix}.${CODE}` where `prefix = lekbanken.participant`.

---

## 3. API surface

### 3.1 Host-authenticated session management

- `POST /api/participants/sessions/create`
  - Auth required via `createServerRlsClient()`.
  - Creates a session via `ParticipantSessionService.createSession()`.
  - Supports settings like `maxParticipants`, `tokenExpiryHours` (nullable for “no expiry”), plus `expiresInHours`.
- `GET /api/participants/sessions/history`
  - Auth required.
  - Lists host-owned sessions with filtering/pagination.

Additionally, the Play runtime uses `/api/play/sessions/**` for host runtime state (see `app/api/play/sessions/**`).

### 3.2 Anonymous participant join/rejoin

- `POST /api/participants/sessions/join`
  - Anonymous join by `{ sessionCode, displayName }`.
  - Enforces session status + expiry + capacity; issues token and inserts participant.
- `POST /api/participants/sessions/rejoin`
  - Anonymous rejoin by `{ sessionCode, participantToken }`.
  - Validates token, rejects `kicked/blocked`, restores participant to active.

Play surface aliases:
- `POST /api/play/join` re-exports the participants join handler.
- `POST /api/play/rejoin` re-exports the participants rejoin handler.

### 3.3 Participant “me” + heartbeat

- `GET /api/play/me?session_code=...` with header `x-participant-token`
  - Resolves session + participant row.
- `POST /api/play/heartbeat?session_code=...` with header `x-participant-token`
  - Updates `participants.last_seen_at` and clears `disconnected_at`.

### 3.4 Token lifecycle

- `POST /api/participants/tokens/extend`
- `POST /api/participants/tokens/revoke`
- `POST /api/participants/tokens/cleanup`

These endpoints are implemented using a service role client, update participant status/expiry, and write activity log entries.

### 3.5 Host/admin participant operations (mixed maturity)

- `GET /api/participants` returns a simplified participant list.
- `POST /api/participants/[participantId]/role` updates role with host ownership check.
- `GET /api/participants/[participantId]` attempts DB lookup but falls back to mock data on failure.
- `POST /api/participants/[participantId]/actions` is a stub (returns a synthetic log entry).

---

## 4. Data model (anti-drift)

This doc intentionally avoids re-stating full table schemas.

Canonical sources:
- DB schema: `supabase/migrations/`
- Generated types: `types/supabase.ts`

Tables referenced by current implementation include:
- `participant_sessions`
- `participants`
- `participant_activity_log`
- `participant_token_quotas` (no-expiry quota)
- `participant_game_progress` (session history enrichment)

---

## 5. Security & limits (current behavior)

- Anonymous join/rejoin/write operations use a service role client in route handlers.
- Rate limiting middleware is applied in at least `POST /api/participants/sessions/create` and `POST /api/participants/sessions/join`.
- “No expiry token” sessions are quota-limited per tenant via `participant_token_quotas` (system admins are treated as unlimited in service logic).

Feature flag note:
- `FEATURE_PARTICIPANTS` exists in `lib/config/env.ts`, but there is currently no code usage detected outside documentation.

---

## 6. Validation checklist

When touching Participants Domain, verify:
- Session creation works and returns a unique 6-char code.
- Join enforces `status === active`, expiry, and `max_participants`.
- Rejoin rejects expired tokens and `kicked/blocked` participants.
- Heartbeat updates `last_seen_at`.
- Token cleanup disconnects expired tokens and archives old sessions.
- `types/supabase.ts` matches migrations for participant tables after any DB change.
