[{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\PlayPage.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"V├ñlj en lek att spela.\". Consider using useTranslations() or t() for internationalization.","line":280,"column":21,"nodeType":"Literal","messageId":"hardcodedString","endLine":280,"endColumn":45},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"Spelet ├ñr antingen inte publicerat eller s├Ñ saknas...\". Consider using useTranslations() or t() for internationalization.","line":290,"column":21,"nodeType":"Literal","messageId":"hardcodedString","endLine":290,"endColumn":85},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"Kontrollera uppkoppling eller f├Ârs├Âk igen.\". Consider using useTranslations() or t() for internationalization.","line":300,"column":21,"nodeType":"Literal","messageId":"hardcodedString","endLine":300,"endColumn":65},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":362,"column":17,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":364,"endColumn":9},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":368,"column":19,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":368,"endColumn":70},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":372,"column":19,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":372,"endColumn":75},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":376,"column":19,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":376,"endColumn":68},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":412,"column":17,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":414,"endColumn":9}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadGame'. Either include it or remove the dependency array.","line":169,"column":6,"nodeType":"ArrayExpression","endLine":169,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [gameId, loadGame]","fix":{"range":[5182,5190],"text":"[gameId, loadGame]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useMemo, useRef, useState } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { Button } from \"@/components/ui/button\";\nimport { ErrorState } from \"@/components/ui/error-state\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { SessionHeader } from \"./components/SessionHeader\";\nimport { StepViewer } from \"./components/StepViewer\";\nimport { NavigationControls } from \"./components/NavigationControls\";\nimport type { GameRun, Step } from \"./types\";\n\nconst DEFAULT_STEP_DURATION_MINUTES = 5;\nconst STORAGE_PREFIX = \"play-session:\";\n\ntype ApiGame = {\n  id: string;\n  name: string;\n  description?: string | null;\n  translations?: {\n    locale: string;\n    title: string;\n    short_description: string;\n    instructions: unknown;\n    materials?: string[] | null;\n  }[];\n  location_type?: string | null;\n  min_players?: number | null;\n  max_players?: number | null;\n  age_min?: number | null;\n  age_max?: number | null;\n};\n\ntype InstructionStep = {\n  title?: string;\n  description?: string;\n  duration_minutes?: number;\n  materials?: string[];\n  safety?: string;\n};\n\ntype ErrorCode = \"not-found\" | \"network\" | null;\n\nfunction clampStep(index: number, total: number) {\n  if (total <= 0) return 0;\n  return Math.min(Math.max(index, 0), total - 1);\n}\n\nfunction mapApiToGameRun(game: ApiGame | null, localeOrder: string[] = [\"sv\", \"no\", \"en\"]): GameRun | null {\n  if (!game) return null;\n  const translations = game.translations ?? [];\n  const translation = localeOrder.map((l) => translations.find((t) => t.locale === l)).find(Boolean) || translations[0];\n\n  const mappedSteps = Array.isArray(translation?.instructions)\n    ? (translation?.instructions as InstructionStep[]).map((s, i) => ({\n        id: s.title || `step-${i + 1}`,\n        title: s.title || `Steg ${i + 1}`,\n        description: s.description || \"\",\n        durationMinutes: s.duration_minutes ?? undefined,\n        materials: s.materials?.filter((item): item is string => Boolean(item)),\n        safety: s.safety,\n      }))\n    : [\n        {\n          id: \"step-1\",\n          title: \"Instruktioner\",\n          description: translation?.short_description || game.description || \"\",\n        },\n      ];\n\n  const materials = (translation?.materials || []).filter((item): item is string => Boolean(item));\n  if (materials.length > 0 && mappedSteps[0]) {\n    mappedSteps[0] = { ...mappedSteps[0], materials };\n  }\n\n  const groupSize =\n    game.min_players && game.max_players ? `${game.min_players}-${game.max_players} deltagare` : undefined;\n  const ageRange = game.age_min && game.age_max ? `${game.age_min}-${game.age_max} ├Ñr` : undefined;\n\n  return {\n    id: game.id,\n    title: translation?.title || game.name,\n    summary: translation?.short_description || game.description || \"\",\n    steps: mappedSteps,\n    environment: game.location_type || undefined,\n    groupSize,\n    ageRange,\n  };\n}\n\nfunction formatSeconds(seconds: number) {\n  const safe = Math.max(0, Math.floor(seconds));\n  const minutes = Math.floor(safe / 60)\n    .toString()\n    .padStart(2, \"0\");\n  const secs = (safe % 60).toString().padStart(2, \"0\");\n  return `${minutes}:${secs}`;\n}\n\nfunction getStepDurationSeconds(step?: Step | null) {\n  const minutes = step?.durationMinutes ?? DEFAULT_STEP_DURATION_MINUTES;\n  return Math.max(30, Math.round(minutes * 60));\n}\n\nexport function PlayPage({ gameId }: { gameId?: string }) {\n  const router = useRouter();\n  const [currentStep, setCurrentStep] = useState(0);\n  const [isLoading, setIsLoading] = useState(true);\n  const [errorCode, setErrorCode] = useState<ErrorCode>(null);\n  const [game, setGame] = useState<GameRun | null>(null);\n  const [timerRemaining, setTimerRemaining] = useState(0);\n  const [timerTotal, setTimerTotal] = useState(0);\n  const [isTimerRunning, setIsTimerRunning] = useState(false);\n  const restoredTimerRef = useRef(false);\n\n  const storageKey = gameId ? `${STORAGE_PREFIX}${gameId}` : null;\n\n  const totalSteps = game?.steps.length ?? 0;\n  const step = useMemo(() => game?.steps[currentStep], [game, currentStep]);\n\n  const loadGame = async () => {\n    if (!gameId) {\n      setIsLoading(false);\n      setErrorCode(\"not-found\");\n      return;\n    }\n\n    setIsLoading(true);\n    setErrorCode(null);\n    try {\n      const res = await fetch(`/api/games/${gameId}`);\n\n      if (res.status === 404) {\n        setGame(null);\n        setErrorCode(\"not-found\");\n        return;\n      }\n\n      if (!res.ok) {\n        setGame(null);\n        setErrorCode(\"network\");\n        return;\n      }\n\n      const json = (await res.json()) as { game: ApiGame };\n      const mapped = mapApiToGameRun(json.game);\n      if (!mapped || mapped.steps.length === 0) {\n        setGame(null);\n        setErrorCode(\"not-found\");\n        return;\n      }\n\n      setGame(mapped);\n      setCurrentStep(0);\n      setErrorCode(null);\n      restoredTimerRef.current = false;\n    } catch (err) {\n      console.error(\"Failed to load game\", err);\n      setGame(null);\n      setErrorCode(\"network\");\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    void loadGame();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [gameId]);\n\n  useEffect(() => {\n    if (!gameId || !game || !totalSteps) return;\n\n    try {\n      const raw = storageKey ? window.localStorage.getItem(storageKey) : null;\n      const saved = raw ? (JSON.parse(raw) as {\n        stepIndex?: number;\n        remainingSeconds?: number;\n        timerTotalSeconds?: number;\n        isRunning?: boolean;\n      }) : null;\n\n      const safeIndex = clampStep(saved?.stepIndex ?? 0, totalSteps);\n      const targetStep = game.steps[safeIndex];\n      const defaultTotal = getStepDurationSeconds(targetStep);\n      const savedTotal = saved?.timerTotalSeconds && saved.timerTotalSeconds > 0 ? saved.timerTotalSeconds : defaultTotal;\n      const savedRemaining = saved?.remainingSeconds && saved.remainingSeconds > 0\n        ? Math.min(saved.remainingSeconds, savedTotal)\n        : savedTotal;\n\n      setCurrentStep(safeIndex);\n      setTimerTotal(savedTotal);\n      setTimerRemaining(savedRemaining);\n      setIsTimerRunning(Boolean(saved?.isRunning && savedRemaining > 0));\n      restoredTimerRef.current = true;\n    } catch (err) {\n      console.warn(\"Failed to restore play state\", err);\n      setCurrentStep(0);\n      const targetStep = game.steps[0];\n      const total = getStepDurationSeconds(targetStep);\n      setTimerTotal(total);\n      setTimerRemaining(total);\n      setIsTimerRunning(false);\n    }\n  }, [gameId, game, totalSteps, storageKey]);\n\n  useEffect(() => {\n    if (!storageKey || !game || !totalSteps) return;\n    const payload = {\n      stepIndex: currentStep,\n      remainingSeconds: timerRemaining,\n      timerTotalSeconds: timerTotal,\n      isRunning: isTimerRunning,\n    };\n    try {\n      window.localStorage.setItem(storageKey, JSON.stringify(payload));\n    } catch (err) {\n      console.warn(\"Failed to persist play state\", err);\n    }\n  }, [storageKey, game, totalSteps, currentStep, timerRemaining, timerTotal, isTimerRunning]);\n\n  useEffect(() => {\n    if (!step) return;\n    if (restoredTimerRef.current) {\n      restoredTimerRef.current = false;\n      return;\n    }\n    const total = getStepDurationSeconds(step);\n    setTimerTotal(total);\n    setTimerRemaining(total);\n    setIsTimerRunning(false);\n  }, [step]);\n\n  useEffect(() => {\n    if (!isTimerRunning) return;\n    const interval = window.setInterval(() => {\n      setTimerRemaining((prev) => Math.max(0, prev - 1));\n    }, 1000);\n    return () => window.clearInterval(interval);\n  }, [isTimerRunning]);\n\n  useEffect(() => {\n    if (timerRemaining === 0 && isTimerRunning) {\n      setIsTimerRunning(false);\n    }\n  }, [timerRemaining, isTimerRunning]);\n\n  const gotoPrev = () => setCurrentStep((i) => clampStep(i - 1, totalSteps));\n  const gotoNext = () => setCurrentStep((i) => clampStep(i + 1, totalSteps));\n  const handleEnd = () => setCurrentStep(Math.max(totalSteps - 1, 0));\n\n  const handleBackToGames = () => router.push(\"/app/games\");\n  const handleToggleTimer = () => {\n    if (!step) return;\n    if (timerTotal === 0 || timerRemaining === 0) {\n      const total = getStepDurationSeconds(step);\n      setTimerTotal(total);\n      setTimerRemaining(total);\n    }\n    setIsTimerRunning((running) => !running);\n  };\n  const handleResetTimer = () => {\n    if (!step) return;\n    const total = getStepDurationSeconds(step);\n    setTimerTotal(total);\n    setTimerRemaining(total);\n    setIsTimerRunning(false);\n  };\n\n  const timerLabel = (() => {\n    if (isTimerRunning) return \"Pausa tid\";\n    if (timerRemaining > 0 && timerRemaining < timerTotal) return \"Forts├ñtt\";\n    return \"Starta tid\";\n  })();\n\n  if (!gameId) {\n    return (\n      <ErrorState\n        title=\"Ingen lek vald\"\n        description=\"V├ñlj en lek att spela.\"\n        onGoBack={handleBackToGames}\n      />\n    );\n  }\n\n  if (errorCode === \"not-found\") {\n    return (\n      <ErrorState\n        title=\"Denna lek kan inte spelas just nu\"\n        description=\"Spelet ├ñr antingen inte publicerat eller s├Ñ saknas beh├Ârighet.\"\n        onGoBack={handleBackToGames}\n      />\n    );\n  }\n\n  if (errorCode === \"network\") {\n    return (\n      <ErrorState\n        title=\"Kunde inte ladda passet\"\n        description=\"Kontrollera uppkoppling eller f├Ârs├Âk igen.\"\n        onRetry={loadGame}\n        onGoBack={handleBackToGames}\n      />\n    );\n  }\n\n  if (isLoading || !game || !step) {\n    return (\n      <div className=\"space-y-4\">\n        <div className=\"space-y-2\">\n          <Skeleton className=\"h-3 w-16\" />\n          <Skeleton className=\"h-7 w-48\" />\n          <Skeleton className=\"h-4 w-full max-w-xs\" />\n        </div>\n        <div className=\"rounded-3xl border border-border/60 bg-card p-5 shadow-md\">\n          <div className=\"flex items-start justify-between gap-3\">\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center gap-2\">\n                <Skeleton className=\"h-6 w-6 rounded-full\" />\n                <Skeleton className=\"h-3 w-24\" />\n              </div>\n              <Skeleton className=\"h-6 w-40\" />\n            </div>\n            <Skeleton className=\"h-7 w-16 rounded-full\" />\n          </div>\n          <div className=\"mt-5 space-y-2\">\n            <Skeleton className=\"h-5 w-full\" />\n            <Skeleton className=\"h-5 w-4/5\" />\n            <Skeleton className=\"h-5 w-2/3\" />\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4 pb-44\">\n      <SessionHeader\n        title={game.title}\n        summary={game.summary}\n        meta={[\n          { label: \"Milj├Â\", value: game.environment ?? \"\" },\n          { label: \"Grupp\", value: game.groupSize ?? \"\" },\n          { label: \"├àlder\", value: game.ageRange ?? \"\" },\n        ].filter((m) => m.value)}\n      />\n\n      <StepViewer\n        step={step}\n        index={currentStep}\n        total={totalSteps}\n        timerSeconds={timerRemaining}\n        timerTotalSeconds={timerTotal}\n        timerRunning={isTimerRunning}\n        formatTime={formatSeconds}\n      />\n\n      <details className=\"group rounded-2xl bg-muted/30 text-sm\" open>\n        <summary className=\"flex cursor-pointer list-none items-center gap-2 px-4 py-3 font-medium text-foreground\">\n          <svg className=\"h-4 w-4 text-primary transition-transform group-open:rotate-90\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M9 5l7 7-7 7\" />\n          </svg>\n          Tips f├Âr sessionen\n        </summary>\n        <ul className=\"space-y-1.5 px-4 pb-4 pl-10 text-muted-foreground\">\n          <li className=\"flex items-start gap-2\">\n            <span className=\"mt-1.5 h-1 w-1 shrink-0 rounded-full bg-muted-foreground/50\" />\n            <span>Skjut undan UI-krom n├ñr du l├ñser upp instruktioner.</span>\n          </li>\n          <li className=\"flex items-start gap-2\">\n            <span className=\"mt-1.5 h-1 w-1 shrink-0 rounded-full bg-muted-foreground/50\" />\n            <span>Planera 1-2 reservlekar i Planner och byt med ett tryck.</span>\n          </li>\n          <li className=\"flex items-start gap-2\">\n            <span className=\"mt-1.5 h-1 w-1 shrink-0 rounded-full bg-muted-foreground/50\" />\n            <span>Beh├Ñll sk├ñrmen ljus och textstorlek stor utomhus.</span>\n          </li>\n        </ul>\n      </details>\n\n      <div className=\"flex gap-2\">\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          className=\"flex-1 text-muted-foreground hover:text-foreground\"\n          onClick={handleBackToGames}\n        >\n          <svg className=\"mr-1.5 h-4 w-4\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5\" />\n          </svg>\n          Byt lek\n        </Button>\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          className=\"flex-1 text-muted-foreground hover:text-foreground\"\n          onClick={handleToggleTimer}\n        >\n          <svg className=\"mr-1.5 h-4 w-4\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M15.75 5.25v13.5m-7.5-13.5v13.5\" />\n          </svg>\n          {timerLabel}\n        </Button>\n        <Button\n          variant=\"outline\"\n          size=\"sm\"\n          className=\"flex-1 text-muted-foreground hover:text-foreground\"\n          onClick={handleResetTimer}\n        >\n          <svg className=\"mr-1.5 h-4 w-4\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M12 6v6l3 3\" />\n          </svg>\n          Nollst├ñll\n        </Button>\n      </div>\n\n      <NavigationControls\n        current={currentStep}\n        total={totalSteps}\n        onPrev={gotoPrev}\n        onNext={gotoNext}\n        onEnd={handleEnd}\n        progress={totalSteps > 1 ? (currentStep + 1) / totalSteps : 1}\n      />\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\PlayPlanPage.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"V├ñlj en plan att spela.\". Consider using useTranslations() or t() for internationalization.","line":339,"column":21,"nodeType":"Literal","messageId":"hardcodedString","endLine":339,"endColumn":46},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"Planen saknas eller s├Ñ har du inte beh├Ârighet.\". Consider using useTranslations() or t() for internationalization.","line":349,"column":21,"nodeType":"Literal","messageId":"hardcodedString","endLine":349,"endColumn":69},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"Kontrollera uppkoppling eller f├Ârs├Âk igen.\". Consider using useTranslations() or t() for internationalization.","line":359,"column":21,"nodeType":"Literal","messageId":"hardcodedString","endLine":359,"endColumn":65},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":429,"column":17,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":431,"endColumn":9},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":435,"column":19,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":435,"endColumn":64},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":439,"column":19,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":439,"endColumn":88},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":443,"column":19,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":443,"endColumn":71},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":479,"column":17,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":481,"endColumn":9}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useMemo, useRef, useState, useCallback } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { ErrorState } from \"@/components/ui/error-state\";\r\nimport { Skeleton } from \"@/components/ui/skeleton\";\r\nimport { SessionHeader } from \"./components/SessionHeader\";\r\nimport { StepViewer } from \"./components/StepViewer\";\r\nimport { NavigationControls } from \"./components/NavigationControls\";\r\nimport { startRun, updateRunProgress, fetchLegacyPlayView } from \"./api\";\r\nimport type { Step, Run, RunStep } from \"./types\";\r\n\r\nconst DEFAULT_STEP_DURATION_MINUTES = 5;\r\nconst STORAGE_PREFIX = \"play-run:\";\r\nconst PROGRESS_DEBOUNCE_MS = 800;\r\n\r\ntype ErrorCode = \"not-found\" | \"network\" | null;\r\n\r\n/**\r\n * Convert RunStep to legacy Step format for StepViewer compatibility\r\n */\r\nfunction runStepToStep(rs: RunStep): Step {\r\n  return {\r\n    id: rs.id,\r\n    title: rs.title,\r\n    description: rs.description,\r\n    durationMinutes: rs.durationMinutes,\r\n    materials: rs.materials,\r\n    safety: rs.safety,\r\n    tag: rs.tag,\r\n    note: rs.note,\r\n  };\r\n}\r\n\r\nfunction clampStep(index: number, total: number) {\r\n  if (total <= 0) return 0;\r\n  return Math.min(Math.max(index, 0), total - 1);\r\n}\r\n\r\nfunction getStepDurationSeconds(step?: Step | null) {\r\n  const minutes = step?.durationMinutes ?? DEFAULT_STEP_DURATION_MINUTES;\r\n  return Math.max(30, Math.round(minutes * 60));\r\n}\r\n\r\nexport function PlayPlanPage({ planId }: { planId?: string }) {\r\n  const router = useRouter();\r\n  const [currentStep, setCurrentStep] = useState(0);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [errorCode, setErrorCode] = useState<ErrorCode>(null);\r\n  const [run, setRun] = useState<Run | null>(null);\r\n  const [timerRemaining, setTimerRemaining] = useState(0);\r\n  const [timerTotal, setTimerTotal] = useState(0);\r\n  const [isTimerRunning, setIsTimerRunning] = useState(false);\r\n  const restoredTimerRef = useRef(false);\r\n  const saveProgressTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n  const lastProgressRef = useRef<string>(\"\");\r\n\r\n  const storageKey = run?.id ? `${STORAGE_PREFIX}${run.id}` : null;\r\n\r\n  const totalSteps = run?.steps.length ?? 0;\r\n  const step = useMemo(() => {\r\n    if (!run || !run.steps[currentStep]) return null;\r\n    return runStepToStep(run.steps[currentStep]);\r\n  }, [run, currentStep]);\r\n\r\n  /**\r\n   * Start or resume a run for this plan.\r\n   * Uses new Run API, falls back to legacy play view for unpublished plans.\r\n   */\r\n  const loadRun = useCallback(async () => {\r\n    if (!planId) {\r\n      setIsLoading(false);\r\n      setErrorCode(\"not-found\");\r\n      return;\r\n    }\r\n\r\n    setIsLoading(true);\r\n    setErrorCode(null);\r\n\r\n    // Try new Run API first\r\n    const result = await startRun(planId);\r\n\r\n    if (result.success) {\r\n      setRun(result.data.run);\r\n      setCurrentStep(result.data.run.currentStepIndex);\r\n      setErrorCode(null);\r\n      restoredTimerRef.current = false;\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    // Fallback for legacy plans or errors\r\n    if (result.error.code === \"NOT_FOUND\" || result.error.code === \"VALIDATION_ERROR\") {\r\n      // Try legacy API for backward compatibility\r\n      const legacyResult = await fetchLegacyPlayView(planId);\r\n      if (legacyResult.success && legacyResult.data.play) {\r\n        const legacyRun = mapLegacyPlayToRun(legacyResult.data.play);\r\n        if (legacyRun) {\r\n          setRun(legacyRun);\r\n          setCurrentStep(0);\r\n          setErrorCode(null);\r\n          restoredTimerRef.current = false;\r\n          setIsLoading(false);\r\n          return;\r\n        }\r\n      }\r\n      setErrorCode(\"not-found\");\r\n    } else {\r\n      setErrorCode(\"network\");\r\n    }\r\n    \r\n    setRun(null);\r\n    setIsLoading(false);\r\n  }, [planId]);\r\n\r\n  // Legacy fallback: convert old play view to Run format\r\n  function mapLegacyPlayToRun(play: {\r\n    planId: string;\r\n    name: string;\r\n    totalDurationMinutes?: number | null;\r\n    blocks: Array<{\r\n      id: string;\r\n      type: string;\r\n      title: string;\r\n      durationMinutes?: number | null;\r\n      notes?: string | null;\r\n      game?: {\r\n        id: string;\r\n        title: string;\r\n        summary?: string | null;\r\n        materials?: string[] | null;\r\n        steps: Array<{ title: string; description?: string | null; durationMinutes?: number | null }>;\r\n      } | null;\r\n    }>;\r\n  }): Run | null {\r\n    const steps: RunStep[] = [];\r\n    let stepIndex = 0;\r\n\r\n    play.blocks.forEach((block) => {\r\n      const tag = block.title || (block.type === \"pause\" ? \"Paus\" : \"Moment\");\r\n      const baseDuration = block.durationMinutes ?? DEFAULT_STEP_DURATION_MINUTES;\r\n\r\n      if (block.game?.steps && block.game.steps.length > 0) {\r\n        const materials = (block.game.materials || []).filter((item): item is string => Boolean(item));\r\n        block.game.steps.forEach((s, idx) => {\r\n          steps.push({\r\n            id: `${block.id}:${idx}`,\r\n            index: stepIndex++,\r\n            blockId: block.id,\r\n            blockType: block.type as 'game' | 'pause' | 'preparation' | 'custom',\r\n            title: s.title || `Steg ${idx + 1}`,\r\n            description: s.description || \"\",\r\n            durationMinutes: s.durationMinutes ?? baseDuration,\r\n            materials: idx === 0 && materials.length > 0 ? materials : undefined,\r\n            tag,\r\n            note: idx === 0 ? block.notes || undefined : undefined,\r\n            gameSnapshot: block.game ? { id: block.game.id, title: block.game.title } : null,\r\n          });\r\n        });\r\n      } else {\r\n        steps.push({\r\n          id: `${block.id}:0`,\r\n          index: stepIndex++,\r\n          blockId: block.id,\r\n          blockType: block.type as 'game' | 'pause' | 'preparation' | 'custom',\r\n          title: tag,\r\n          description: block.notes || \"Forts├ñtt n├ñr gruppen ├ñr redo.\",\r\n          durationMinutes: baseDuration,\r\n          tag,\r\n          gameSnapshot: null,\r\n        });\r\n      }\r\n    });\r\n\r\n    if (steps.length === 0) return null;\r\n\r\n    return {\r\n      id: `legacy-${play.planId}`,\r\n      planId: play.planId,\r\n      planVersionId: \"legacy\",\r\n      versionNumber: 0,\r\n      name: play.name,\r\n      status: \"in_progress\",\r\n      steps,\r\n      blockCount: play.blocks.length,\r\n      totalDurationMinutes: play.totalDurationMinutes ?? steps.reduce((sum, s) => sum + s.durationMinutes, 0),\r\n      currentStepIndex: 0,\r\n      startedAt: new Date().toISOString(),\r\n      completedAt: null,\r\n    };\r\n  }\r\n\r\n  useEffect(() => {\r\n    void loadRun();\r\n  }, [loadRun]);\r\n\r\n  // Restore progress from localStorage\r\n  useEffect(() => {\r\n    if (!run || !totalSteps) return;\r\n\r\n    try {\r\n      const raw = storageKey ? window.localStorage.getItem(storageKey) : null;\r\n      const savedLocal = raw\r\n        ? (JSON.parse(raw) as {\r\n            stepIndex?: number;\r\n            remainingSeconds?: number;\r\n            timerTotalSeconds?: number;\r\n            isRunning?: boolean;\r\n          })\r\n        : null;\r\n\r\n      if (savedLocal) {\r\n        const safeIndex = clampStep(savedLocal?.stepIndex ?? 0, totalSteps);\r\n        const targetStep = run.steps[safeIndex] ? runStepToStep(run.steps[safeIndex]) : null;\r\n        const defaultTotal = getStepDurationSeconds(targetStep);\r\n        const savedTotal =\r\n          savedLocal?.timerTotalSeconds && savedLocal.timerTotalSeconds > 0\r\n            ? savedLocal.timerTotalSeconds\r\n            : defaultTotal;\r\n        const savedRemaining =\r\n          savedLocal?.remainingSeconds && savedLocal.remainingSeconds > 0\r\n            ? Math.min(savedLocal.remainingSeconds, savedTotal)\r\n            : savedTotal;\r\n\r\n        setCurrentStep(safeIndex);\r\n        setTimerTotal(savedTotal);\r\n        setTimerRemaining(savedRemaining);\r\n        setIsTimerRunning(Boolean(savedLocal?.isRunning && savedRemaining > 0));\r\n        restoredTimerRef.current = true;\r\n      }\r\n    } catch (err) {\r\n      console.warn(\"Failed to restore play state\", err);\r\n      setCurrentStep(0);\r\n      const targetStep = run.steps[0] ? runStepToStep(run.steps[0]) : null;\r\n      const total = getStepDurationSeconds(targetStep);\r\n      setTimerTotal(total);\r\n      setTimerRemaining(total);\r\n      setIsTimerRunning(false);\r\n    }\r\n  }, [run, totalSteps, storageKey]);\r\n\r\n  // Save progress to localStorage and server\r\n  useEffect(() => {\r\n    if (!storageKey || !run || !totalSteps) return;\r\n    \r\n    const payload = {\r\n      stepIndex: currentStep,\r\n      remainingSeconds: timerRemaining,\r\n      timerTotalSeconds: timerTotal,\r\n      isRunning: isTimerRunning,\r\n    };\r\n    \r\n    // Save to localStorage\r\n    try {\r\n      window.localStorage.setItem(storageKey, JSON.stringify(payload));\r\n    } catch (err) {\r\n      console.warn(\"Failed to persist play state\", err);\r\n    }\r\n\r\n    // Save to server (debounced)\r\n    const progressPayload = {\r\n      currentStepIndex: currentStep,\r\n      status: \"in_progress\" as const,\r\n      timerRemaining,\r\n      timerTotal,\r\n      isTimerRunning,\r\n    };\r\n    const serialized = JSON.stringify(progressPayload);\r\n    if (serialized === lastProgressRef.current) return;\r\n    lastProgressRef.current = serialized;\r\n\r\n    if (saveProgressTimerRef.current) {\r\n      clearTimeout(saveProgressTimerRef.current);\r\n    }\r\n    saveProgressTimerRef.current = setTimeout(() => {\r\n      void updateRunProgress(run.id, progressPayload).catch(() => null);\r\n    }, PROGRESS_DEBOUNCE_MS);\r\n  }, [storageKey, run, totalSteps, currentStep, timerRemaining, timerTotal, isTimerRunning]);\r\n\r\n  useEffect(() => {\r\n    if (!step) return;\r\n    if (restoredTimerRef.current) {\r\n      restoredTimerRef.current = false;\r\n      return;\r\n    }\r\n    const total = getStepDurationSeconds(step);\r\n    setTimerTotal(total);\r\n    setTimerRemaining(total);\r\n    setIsTimerRunning(false);\r\n  }, [step?.id, step]);\r\n\r\n  useEffect(() => {\r\n    if (!isTimerRunning) return;\r\n    const interval = window.setInterval(() => {\r\n      setTimerRemaining((prev) => Math.max(0, prev - 1));\r\n    }, 1000);\r\n    return () => window.clearInterval(interval);\r\n  }, [isTimerRunning]);\r\n\r\n  useEffect(() => {\r\n    if (timerRemaining === 0 && isTimerRunning) {\r\n      setIsTimerRunning(false);\r\n    }\r\n  }, [timerRemaining, isTimerRunning]);\r\n\r\n  const gotoPrev = () => setCurrentStep((i) => clampStep(i - 1, totalSteps));\r\n  const gotoNext = () => setCurrentStep((i) => clampStep(i + 1, totalSteps));\r\n  const handleEnd = () => setCurrentStep(Math.max(totalSteps - 1, 0));\r\n\r\n  const handleBack = () => router.push(\"/app/planner\");\r\n  const handleToggleTimer = () => {\r\n    if (!step) return;\r\n    if (timerTotal === 0 || timerRemaining === 0) {\r\n      const total = getStepDurationSeconds(step);\r\n      setTimerTotal(total);\r\n      setTimerRemaining(total);\r\n    }\r\n    setIsTimerRunning((running) => !running);\r\n  };\r\n  const handleResetTimer = () => {\r\n    if (!step) return;\r\n    const total = getStepDurationSeconds(step);\r\n    setTimerTotal(total);\r\n    setTimerRemaining(total);\r\n    setIsTimerRunning(false);\r\n  };\r\n\r\n  const timerLabel = (() => {\r\n    if (isTimerRunning) return \"Pausa tid\";\r\n    if (timerRemaining > 0 && timerRemaining < timerTotal) return \"Forts├ñtt\";\r\n    return \"Starta tid\";\r\n  })();\r\n\r\n  if (!planId) {\r\n    return (\r\n      <ErrorState\r\n        title=\"Ingen plan vald\"\r\n        description=\"V├ñlj en plan att spela.\"\r\n        onGoBack={handleBack}\r\n      />\r\n    );\r\n  }\r\n\r\n  if (errorCode === \"not-found\") {\r\n    return (\r\n      <ErrorState\r\n        title=\"Planen kan inte spelas just nu\"\r\n        description=\"Planen saknas eller s├Ñ har du inte beh├Ârighet.\"\r\n        onGoBack={handleBack}\r\n      />\r\n    );\r\n  }\r\n\r\n  if (errorCode === \"network\") {\r\n    return (\r\n      <ErrorState\r\n        title=\"Kunde inte ladda planen\"\r\n        description=\"Kontrollera uppkoppling eller f├Ârs├Âk igen.\"\r\n        onRetry={loadRun}\r\n        onGoBack={handleBack}\r\n      />\r\n    );\r\n  }\r\n\r\n  if (isLoading || !run || !step) {\r\n    return (\r\n      <div className=\"space-y-4\">\r\n        <div className=\"space-y-2\">\r\n          <Skeleton className=\"h-3 w-16\" />\r\n          <Skeleton className=\"h-7 w-48\" />\r\n          <Skeleton className=\"h-4 w-full max-w-xs\" />\r\n        </div>\r\n        <div className=\"rounded-3xl border border-border/60 bg-card p-5 shadow-md\">\r\n          <div className=\"flex items-start justify-between gap-3\">\r\n            <div className=\"space-y-2\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <Skeleton className=\"h-6 w-6 rounded-full\" />\r\n                <Skeleton className=\"h-3 w-24\" />\r\n              </div>\r\n              <Skeleton className=\"h-6 w-40\" />\r\n            </div>\r\n            <Skeleton className=\"h-7 w-16 rounded-full\" />\r\n          </div>\r\n          <div className=\"mt-5 space-y-2\">\r\n            <Skeleton className=\"h-5 w-full\" />\r\n            <Skeleton className=\"h-5 w-4/5\" />\r\n            <Skeleton className=\"h-5 w-2/3\" />\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const meta = [\r\n    { label: \"Moment\", value: `${run.blockCount} block` },\r\n    run.totalDurationMinutes ? { label: \"L├ñngd\", value: `${run.totalDurationMinutes} min` } : null,\r\n  ].filter((m): m is { label: string; value: string } => Boolean(m?.value));\r\n\r\n  return (\r\n    <div className=\"space-y-4 pb-44\">\r\n      <SessionHeader\r\n        title={run.name}\r\n        summary=\"Planerat pass\"\r\n        meta={meta}\r\n      />\r\n\r\n      <StepViewer\r\n        step={step}\r\n        index={currentStep}\r\n        total={totalSteps}\r\n        timerSeconds={timerRemaining}\r\n        timerTotalSeconds={timerTotal}\r\n        timerRunning={isTimerRunning}\r\n        formatTime={(seconds) => {\r\n          const safe = Math.max(0, Math.floor(seconds));\r\n          const minutes = Math.floor(safe / 60)\r\n            .toString()\r\n            .padStart(2, \"0\");\r\n          const secs = (safe % 60).toString().padStart(2, \"0\");\r\n          return `${minutes}:${secs}`;\r\n        }}\r\n      />\r\n\r\n      <details className=\"group rounded-2xl bg-muted/30 text-sm\" open>\r\n        <summary className=\"flex cursor-pointer list-none items-center gap-2 px-4 py-3 font-medium text-foreground\">\r\n          <svg className=\"h-4 w-4 text-primary transition-transform group-open:rotate-90\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\r\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M9 5l7 7-7 7\" />\r\n          </svg>\r\n          Tips f├Âr passet\r\n        </summary>\r\n        <ul className=\"space-y-1.5 px-4 pb-4 pl-10 text-muted-foreground\">\r\n          <li className=\"flex items-start gap-2\">\r\n            <span className=\"mt-1.5 h-1 w-1 shrink-0 rounded-full bg-muted-foreground/50\" />\r\n            <span>G├Ñ igenom varje steg innan du startar timern.</span>\r\n          </li>\r\n          <li className=\"flex items-start gap-2\">\r\n            <span className=\"mt-1.5 h-1 w-1 shrink-0 rounded-full bg-muted-foreground/50\" />\r\n            <span>Justera planen p├Ñ plats: hoppa ├Âver block eller korta steg vid behov.</span>\r\n          </li>\r\n          <li className=\"flex items-start gap-2\">\r\n            <span className=\"mt-1.5 h-1 w-1 shrink-0 rounded-full bg-muted-foreground/50\" />\r\n            <span>H├Ñll koll p├Ñ materialtaggar i f├Ârsta steget per lek.</span>\r\n          </li>\r\n        </ul>\r\n      </details>\r\n\r\n      <div className=\"flex gap-2\">\r\n        <Button\r\n          variant=\"ghost\"\r\n          size=\"sm\"\r\n          className=\"flex-1 text-muted-foreground hover:text-foreground\"\r\n          onClick={handleBack}\r\n        >\r\n          <svg className=\"mr-1.5 h-4 w-4\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\r\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5\" />\r\n          </svg>\r\n          Till planer\r\n        </Button>\r\n        <Button\r\n          variant=\"ghost\"\r\n          size=\"sm\"\r\n          className=\"flex-1 text-muted-foreground hover:text-foreground\"\r\n          onClick={handleToggleTimer}\r\n        >\r\n          <svg className=\"mr-1.5 h-4 w-4\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\r\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M15.75 5.25v13.5m-7.5-13.5v13.5\" />\r\n          </svg>\r\n          {timerLabel}\r\n        </Button>\r\n        <Button\r\n          variant=\"ghost\"\r\n          size=\"sm\"\r\n          className=\"flex-1 text-muted-foreground hover:text-foreground\"\r\n          onClick={handleResetTimer}\r\n        >\r\n          <svg className=\"mr-1.5 h-4 w-4\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\r\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M12 6v6l4 2\" />\r\n          </svg>\r\n          Nollst├ñll\r\n        </Button>\r\n      </div>\r\n\r\n      <NavigationControls\r\n        current={currentStep}\r\n        total={totalSteps}\r\n        onPrev={gotoPrev}\r\n        onNext={gotoNext}\r\n        onEnd={handleEnd}\r\n        progress={totalSteps > 1 ? (currentStep + 1) / totalSteps : 1}\r\n      />\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\api\\chat-api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\api\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\api\\primitives-api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\api\\session-api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\api\\signals-api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\api\\time-bank-api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\ActiveSessionShell.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":97,"column":54,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":97,"endColumn":99},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":119,"column":63,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":119,"endColumn":82},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":120,"column":54,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":122,"endColumn":9},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":146,"column":12,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":148,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":162,"column":12,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":164,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":178,"column":12,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":180,"endColumn":11}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/*\r\n * ActiveSessionShell\r\n *\r\n * A focused, distraction-free session overlay shared by host + participant.\r\n * - Mobile: fullscreen overlay (covers AppShell header + BottomNav)\r\n * - Desktop: modal overlay (explicit close only; no click-outside)\r\n */\r\n\r\n'use client';\r\n\r\nimport { useEffect, useMemo, useState } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Card } from '@/components/ui/card';\r\nimport { cn } from '@/lib/utils';\r\nimport { ArrowLeftIcon, ChatBubbleLeftRightIcon } from '@heroicons/react/24/outline';\r\n\r\nexport type ActiveSessionRole = 'host' | 'participant';\r\n\r\ntype HostExitAction = 'continue_active' | 'pause_session' | 'end_session';\r\n\r\nexport interface ActiveSessionShellProps {\r\n  role: ActiveSessionRole;\r\n  title?: string;\r\n  open: boolean;\r\n  onRequestClose: () => void;\r\n\r\n  // Host-only: choose what happens to the session when leaving\r\n  onHostExitAction?: (action: HostExitAction) => Promise<void> | void;\r\n\r\n  // Optional chat affordance (PR3 wires real behavior)\r\n  chatUnreadCount?: number;\r\n  onOpenChat?: () => void;\r\n\r\n  children: React.ReactNode;\r\n}\r\n\r\nfunction useBodyScrollLock(locked: boolean) {\r\n  useEffect(() => {\r\n    if (!locked) return;\r\n    const prevOverflow = document.body.style.overflow;\r\n    const prevOverscroll = (document.body.style as unknown as { overscrollBehavior?: string }).overscrollBehavior;\r\n    document.body.style.overflow = 'hidden';\r\n    (document.body.style as unknown as { overscrollBehavior?: string }).overscrollBehavior = 'none';\r\n    return () => {\r\n      document.body.style.overflow = prevOverflow;\r\n      (document.body.style as unknown as { overscrollBehavior?: string }).overscrollBehavior = prevOverscroll ?? '';\r\n    };\r\n  }, [locked]);\r\n}\r\n\r\nexport function ActiveSessionShell({\r\n  role,\r\n  title,\r\n  open,\r\n  onRequestClose,\r\n  onHostExitAction,\r\n  chatUnreadCount = 0,\r\n  onOpenChat,\r\n  children,\r\n}: ActiveSessionShellProps) {\r\n  const [confirmOpen, setConfirmOpen] = useState(false);\r\n  const [hostBusy, setHostBusy] = useState(false);\r\n\r\n  useBodyScrollLock(open);\r\n\r\n  // Close confirm if shell closes externally\r\n  useEffect(() => {\r\n    if (!open) setConfirmOpen(false);\r\n  }, [open]);\r\n\r\n  // Prevent accidental escape-key dismissal\r\n  useEffect(() => {\r\n    if (!open) return;\r\n    const onKeyDown = (e: KeyboardEvent) => {\r\n      if (e.key === 'Escape') {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n      }\r\n    };\r\n    window.addEventListener('keydown', onKeyDown, { capture: true });\r\n    return () => window.removeEventListener('keydown', onKeyDown, { capture: true } as unknown as boolean);\r\n  }, [open]);\r\n\r\n  const topTitle = useMemo(() => {\r\n    if (title) return title;\r\n    return role === 'host' ? 'Aktiv session' : 'Aktiv session';\r\n  }, [role, title]);\r\n\r\n  if (!open) return null;\r\n\r\n  const requestClose = () => setConfirmOpen(true);\r\n\r\n  const participantConfirm = (\r\n    <Card variant=\"elevated\" className=\"w-full max-w-md p-6\">\r\n      <div className=\"space-y-3\">\r\n        <h2 className=\"text-lg font-semibold text-foreground\">Tillbaka till Lobbyn</h2>\r\n        <p className=\"text-sm text-muted-foreground\">Du ├ñr p├Ñv├ñg att l├ñmna sessionen. St├ñmmer det?</p>\r\n        <div className=\"grid grid-cols-2 gap-3 pt-2\">\r\n          <Button variant=\"outline\" onClick={() => setConfirmOpen(false)}>\r\n            Nej\r\n          </Button>\r\n          <Button\r\n            variant=\"primary\"\r\n            onClick={() => {\r\n              setConfirmOpen(false);\r\n              onRequestClose();\r\n            }}\r\n          >\r\n            Ja\r\n          </Button>\r\n        </div>\r\n      </div>\r\n    </Card>\r\n  );\r\n\r\n  const hostConfirm = (\r\n    <Card variant=\"elevated\" className=\"w-full max-w-lg p-6\">\r\n      <div className=\"space-y-4\">\r\n        <h2 className=\"text-lg font-semibold text-foreground\">L├ñmna aktiv session</h2>\r\n        <p className=\"text-sm text-muted-foreground\">\r\n          Du ├ñr p├Ñ v├ñg att l├ñmna sessionen. Vad vill du g├Âra med sessionen?\r\n        </p>\r\n        <div className=\"grid gap-2 pt-2\">\r\n          <Button\r\n            variant=\"outline\"\r\n            disabled={hostBusy}\r\n            onClick={() => {\r\n              setConfirmOpen(false);\r\n            }}\r\n          >\r\n            Avbryt\r\n          </Button>\r\n          <Button\r\n            variant=\"default\"\r\n            disabled={hostBusy}\r\n            onClick={async () => {\r\n              setHostBusy(true);\r\n              try {\r\n                await onHostExitAction?.('continue_active');\r\n                setConfirmOpen(false);\r\n                onRequestClose();\r\n              } finally {\r\n                setHostBusy(false);\r\n              }\r\n            }}\r\n          >\r\n            L├ñmna ÔÇô sessionen forts├ñtter som AKTIV\r\n          </Button>\r\n          <Button\r\n            variant=\"outline\"\r\n            disabled={hostBusy}\r\n            onClick={async () => {\r\n              setHostBusy(true);\r\n              try {\r\n                await onHostExitAction?.('pause_session');\r\n                setConfirmOpen(false);\r\n                onRequestClose();\r\n              } finally {\r\n                setHostBusy(false);\r\n              }\r\n            }}\r\n          >\r\n            L├ñmna ÔÇô sessionen PAUSAS\r\n          </Button>\r\n          <Button\r\n            variant=\"destructive\"\r\n            disabled={hostBusy}\r\n            onClick={async () => {\r\n              setHostBusy(true);\r\n              try {\r\n                await onHostExitAction?.('end_session');\r\n                setConfirmOpen(false);\r\n                onRequestClose();\r\n              } finally {\r\n                setHostBusy(false);\r\n              }\r\n            }}\r\n          >\r\n            L├ñmna ÔÇô sessionen AVSLUTAS\r\n          </Button>\r\n        </div>\r\n      </div>\r\n    </Card>\r\n  );\r\n\r\n  return (\r\n    <div\r\n      className={cn(\r\n        'fixed inset-0 z-[70] flex flex-col bg-background/95 backdrop-blur-sm',\r\n        'overscroll-contain overflow-hidden',\r\n      )}\r\n      role=\"dialog\"\r\n      aria-modal=\"true\"\r\n      aria-label={topTitle}\r\n    >\r\n      {/* Desktop overlay framing */}\r\n      <div className=\"hidden lg:block absolute inset-0 bg-black/40\" aria-hidden=\"true\" />\r\n\r\n      {/* Container: fullscreen on mobile; centered modal on desktop */}\r\n      <div className=\"relative flex h-full w-full flex-col overflow-hidden lg:mx-auto lg:my-8 lg:max-h-[calc(100vh-4rem)] lg:max-w-5xl\">\r\n        <div\r\n          className={cn(\r\n            'flex items-center justify-between border-b border-border bg-background/90 px-3 py-3 backdrop-blur',\r\n            'lg:rounded-t-2xl lg:border lg:border-border',\r\n          )}\r\n          style={{ paddingTop: 'max(0.75rem, env(safe-area-inset-top))' }}\r\n        >\r\n          <div className=\"flex items-center gap-2\">\r\n            <Button variant=\"ghost\" size=\"sm\" onClick={requestClose}>\r\n              <ArrowLeftIcon className=\"h-4 w-4\" />\r\n              Till Lobbyn\r\n            </Button>\r\n          </div>\r\n\r\n          <div className=\"min-w-0 flex-1 px-3 text-center\">\r\n            <div className=\"truncate text-sm font-medium text-foreground\">{topTitle}</div>\r\n          </div>\r\n\r\n          <div className=\"flex items-center justify-end gap-2\">\r\n            <Button variant=\"ghost\" size=\"sm\" onClick={onOpenChat} aria-label=\"Chat\" disabled={!onOpenChat}>\r\n              <span className=\"relative inline-flex items-center\">\r\n                <ChatBubbleLeftRightIcon className=\"h-5 w-5\" />\r\n                {chatUnreadCount > 0 && (\r\n                  <span className=\"absolute -right-2 -top-2 inline-flex min-w-5 items-center justify-center rounded-full bg-primary px-1.5 py-0.5 text-[10px] font-semibold text-primary-foreground\">\r\n                    {chatUnreadCount}\r\n                  </span>\r\n                )}\r\n              </span>\r\n            </Button>\r\n          </div>\r\n        </div>\r\n\r\n        <div\r\n          className={cn(\r\n            'relative flex min-h-0 flex-1 flex-col overflow-hidden bg-background',\r\n            'lg:rounded-b-2xl lg:border lg:border-t-0 lg:border-border',\r\n          )}\r\n          style={{ paddingBottom: 'max(0px, env(safe-area-inset-bottom))' }}\r\n        >\r\n          <div className=\"min-h-0 flex-1 overflow-auto px-3 py-4 sm:px-6\">\r\n            {children}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Confirm overlay (blocks click-outside close) */}\r\n      {confirmOpen && (\r\n        <div className=\"fixed inset-0 z-[80] flex items-center justify-center bg-black/60 px-4\">\r\n          {role === 'host' ? hostConfirm : participantConfirm}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\AnalyticsDashboard.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"Pussel l├Âsta\". Consider using useTranslations() or t() for internationalization.","line":164,"column":17,"nodeType":"Literal","messageId":"hardcodedString","endLine":164,"endColumn":31},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"H├ñndelser\". Consider using useTranslations() or t() for internationalization.","line":171,"column":17,"nodeType":"Literal","messageId":"hardcodedString","endLine":171,"endColumn":28},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":197,"column":62,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":197,"endColumn":79},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":222,"column":52,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":224,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":237,"column":88,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":238,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":261,"column":48,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":261,"endColumn":53},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":293,"column":44,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":293,"endColumn":49},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":366,"column":83,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":367,"endColumn":9},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":383,"column":50,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":383,"endColumn":56},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":384,"column":49,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":384,"endColumn":60},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":570,"column":54,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":570,"endColumn":64}],"suppressedMessages":[],"errorCount":11,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * AnalyticsDashboard Component\r\n * \r\n * Displays session performance metrics and analytics.\r\n * Shows completion rates, timing data, and engagement metrics.\r\n * \r\n * Backlog B.7: Analytics dashboard\r\n */\r\n\r\n'use client';\r\n\r\nimport React, { useState } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Progress } from '@/components/ui/progress';\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from '@/components/ui/card';\r\nimport { Tabs, TabPanel } from '@/components/ui/tabs';\r\nimport { Select } from '@/components/ui/select';\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from '@/components/ui/table';\r\nimport { ScrollArea } from '@/components/ui/scroll-area';\r\nimport {\r\n  ChartBarIcon,\r\n  ClockIcon,\r\n  CheckCircleIcon,\r\n  ExclamationCircleIcon,\r\n  ArrowTrendingUpIcon,\r\n  DocumentTextIcon,\r\n  TableCellsIcon,\r\n  PuzzlePieceIcon,\r\n  BoltIcon,\r\n  LightBulbIcon,\r\n  SignalIcon,\r\n} from '@heroicons/react/24/outline';\r\nimport type {\r\n  SessionAnalytics,\r\n  StepMetrics,\r\n  PuzzleMetrics,\r\n  UseSessionAnalyticsReturn,\r\n} from '@/features/play/hooks/useSessionAnalytics';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface AnalyticsDashboardProps {\r\n  /** Analytics hook return */\r\n  analyticsHook: UseSessionAnalyticsReturn;\r\n  /** Optional className */\r\n  className?: string;\r\n  /** Compact mode */\r\n  compact?: boolean;\r\n  /** Show export buttons */\r\n  showExport?: boolean;\r\n}\r\n\r\n// =============================================================================\r\n// Helpers\r\n// =============================================================================\r\n\r\nfunction formatDuration(ms: number): string {\r\n  const seconds = Math.floor(ms / 1000);\r\n  const minutes = Math.floor(seconds / 60);\r\n  const hours = Math.floor(minutes / 60);\r\n\r\n  if (hours > 0) {\r\n    return `${hours}h ${minutes % 60}m`;\r\n  }\r\n  if (minutes > 0) {\r\n    return `${minutes}m ${seconds % 60}s`;\r\n  }\r\n  return `${seconds}s`;\r\n}\r\n\r\nfunction formatPercent(value: number): string {\r\n  return `${Math.round(value * 100)}%`;\r\n}\r\n\r\nfunction getCompletionColor(rate: number): string {\r\n  if (rate >= 0.8) return 'text-green-500';\r\n  if (rate >= 0.5) return 'text-yellow-500';\r\n  return 'text-red-500';\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: MetricCard\r\n// =============================================================================\r\n\r\ninterface MetricCardProps {\r\n  title: string;\r\n  value: string | number;\r\n  icon: React.ReactNode;\r\n  description?: string;\r\n  variant?: 'default' | 'success' | 'warning' | 'error';\r\n}\r\n\r\nfunction MetricCard({\r\n  title,\r\n  value,\r\n  icon,\r\n  description,\r\n  variant = 'default',\r\n}: MetricCardProps) {\r\n  const variantClasses = {\r\n    default: 'bg-muted/30',\r\n    success: 'bg-green-500/10 border-green-500/20',\r\n    warning: 'bg-yellow-500/10 border-yellow-500/20',\r\n    error: 'bg-red-500/10 border-red-500/20',\r\n  };\r\n\r\n  return (\r\n    <div className={`p-4 rounded-lg border ${variantClasses[variant]}`}>\r\n      <div className=\"flex items-center gap-2 text-muted-foreground mb-1\">\r\n        {icon}\r\n        <span className=\"text-sm\">{title}</span>\r\n      </div>\r\n      <div className=\"text-2xl font-bold\">{value}</div>\r\n      {description && (\r\n        <div className=\"text-xs text-muted-foreground mt-1\">{description}</div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: OverviewTab\r\n// =============================================================================\r\n\r\ninterface OverviewTabProps {\r\n  analytics: SessionAnalytics;\r\n}\r\n\r\nfunction OverviewTab({ analytics }: OverviewTabProps) {\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {/* Key Metrics Grid */}\r\n      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-3\">\r\n        <MetricCard\r\n          title=\"Framsteg\"\r\n          value={`${Math.round(analytics.progressPercent)}%`}\r\n          icon={<CheckCircleIcon className=\"h-4 w-4\" />}\r\n          description={`Steg ${analytics.currentStep + 1} av ${analytics.totalSteps}`}\r\n          variant={analytics.progressPercent >= 80 ? 'success' : 'default'}\r\n        />\r\n        <MetricCard\r\n          title=\"Total tid\"\r\n          value={formatDuration(analytics.totalDuration)}\r\n          icon={<ClockIcon className=\"h-4 w-4\" />}\r\n          description={analytics.status}\r\n        />\r\n        <MetricCard\r\n          title=\"Pussel l├Âsta\"\r\n          value={`${analytics.engagement.puzzlesSolved}/${analytics.engagement.totalPuzzles}`}\r\n          icon={<PuzzlePieceIcon className=\"h-4 w-4\" />}\r\n          description={formatPercent(analytics.engagement.overallCompletionRate)}\r\n          variant={analytics.engagement.overallCompletionRate >= 0.8 ? 'success' : 'default'}\r\n        />\r\n        <MetricCard\r\n          title=\"H├ñndelser\"\r\n          value={analytics.eventCount}\r\n          icon={<SignalIcon className=\"h-4 w-4\" />}\r\n          description=\"Totalt loggade\"\r\n        />\r\n      </div>\r\n\r\n      {/* Engagement Metrics */}\r\n      <Card>\r\n        <CardHeader className=\"pb-2\">\r\n          <CardTitle className=\"text-base flex items-center gap-2\">\r\n            <ArrowTrendingUpIcon className=\"h-4 w-4\" />\r\n            Engagemang\r\n          </CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"grid grid-cols-2 md:grid-cols-3 gap-4\">\r\n            <div>\r\n              <div className=\"text-sm text-muted-foreground\">Snitt tid/steg</div>\r\n              <div className=\"font-semibold\">{formatDuration(analytics.engagement.avgTimePerStep)}</div>\r\n            </div>\r\n            <div>\r\n              <div className=\"text-sm text-muted-foreground\">Median tid/steg</div>\r\n              <div className=\"font-semibold\">{formatDuration(analytics.engagement.medianTimePerStep)}</div>\r\n            </div>\r\n            <div>\r\n              <div className=\"text-sm text-muted-foreground\">Ledtr├Ñdar anv├ñnda</div>\r\n              <div className=\"font-semibold\">{analytics.engagement.totalHintsUsed}</div>\r\n            </div>\r\n            <div>\r\n              <div className=\"text-sm text-muted-foreground\">Triggers avfyrade</div>\r\n              <div className=\"font-semibold\">{analytics.engagement.totalTriggerFires}</div>\r\n            </div>\r\n            <div>\r\n              <div className=\"text-sm text-muted-foreground\">Trigger-fel</div>\r\n              <div className={`font-semibold ${analytics.engagement.triggerErrors > 0 ? 'text-red-500' : ''}`}>\r\n                {analytics.engagement.triggerErrors}\r\n              </div>\r\n            </div>\r\n            <div>\r\n              <div className=\"text-sm text-muted-foreground\">Signaler</div>\r\n              <div className=\"font-semibold\">{analytics.engagement.signalsSent}</div>\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Completion Progress */}\r\n      <Card>\r\n        <CardHeader className=\"pb-2\">\r\n          <CardTitle className=\"text-base flex items-center gap-2\">\r\n            <CheckCircleIcon className=\"h-4 w-4\" />\r\n            Slutf├Ârandegrad\r\n          </CardTitle>\r\n        </CardHeader>\r\n        <CardContent className=\"space-y-2\">\r\n          <div className=\"flex items-center justify-between text-sm\">\r\n            <span>Total progression</span>\r\n            <span className={getCompletionColor(analytics.engagement.overallCompletionRate)}>\r\n              {formatPercent(analytics.engagement.overallCompletionRate)}\r\n            </span>\r\n          </div>\r\n          <Progress \r\n            value={analytics.engagement.overallCompletionRate * 100} \r\n          />\r\n          <div className=\"text-xs text-muted-foreground\">\r\n            {analytics.engagement.puzzlesSolved} av {analytics.engagement.totalPuzzles} pussel l├Âsta\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: StepsTab\r\n// =============================================================================\r\n\r\ninterface StepsTabProps {\r\n  stepMetrics: StepMetrics[];\r\n}\r\n\r\nfunction StepsTab({ stepMetrics }: StepsTabProps) {\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <Table>\r\n        <TableHeader>\r\n          <TableRow>\r\n            <TableHead>Steg</TableHead>\r\n            <TableHead>Tid</TableHead>\r\n            <TableHead className=\"text-center\">L├Âsta</TableHead>\r\n            <TableHead className=\"text-center\">Fel</TableHead>\r\n            <TableHead className=\"text-center\">Triggers</TableHead>\r\n            <TableHead className=\"text-right\">Status</TableHead>\r\n          </TableRow>\r\n        </TableHeader>\r\n        <TableBody>\r\n          {stepMetrics.map((step) => (\r\n            <TableRow key={step.stepIndex}>\r\n              <TableCell>\r\n                <div className=\"font-medium\">Steg {step.stepIndex + 1}</div>\r\n                <div className=\"text-xs text-muted-foreground truncate max-w-[120px]\">\r\n                  {step.stepName}\r\n                </div>\r\n              </TableCell>\r\n              <TableCell>{formatDuration(step.duration)}</TableCell>\r\n              <TableCell className=\"text-center\">\r\n                <span className=\"text-green-500\">{step.puzzlesSolved}</span>\r\n              </TableCell>\r\n              <TableCell className=\"text-center\">\r\n                <span className={step.puzzleFailures > 0 ? 'text-red-500' : ''}>\r\n                  {step.puzzleFailures}\r\n                </span>\r\n              </TableCell>\r\n              <TableCell className=\"text-center\">{step.triggersFired}</TableCell>\r\n              <TableCell className=\"text-right\">\r\n                {step.completed ? (\r\n                  <Badge variant=\"default\" className=\"bg-green-500\">\r\n                    <CheckCircleIcon className=\"h-3 w-3 mr-1\" />\r\n                    Klar\r\n                  </Badge>\r\n                ) : (\r\n                  <Badge variant=\"outline\">P├Ñg├Ñr</Badge>\r\n                )}\r\n              </TableCell>\r\n            </TableRow>\r\n          ))}\r\n        </TableBody>\r\n      </Table>\r\n\r\n      {/* Step Duration Chart (simple bar) */}\r\n      <Card>\r\n        <CardHeader className=\"pb-2\">\r\n          <CardTitle className=\"text-sm\">Tid per steg</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"space-y-2\">\r\n            {stepMetrics.map((step) => {\r\n              const maxDuration = Math.max(...stepMetrics.map((s) => s.duration));\r\n              const width = maxDuration > 0 ? (step.duration / maxDuration) * 100 : 0;\r\n              \r\n              return (\r\n                <div key={step.stepIndex} className=\"flex items-center gap-2\">\r\n                  <span className=\"text-xs w-12\">Steg {step.stepIndex + 1}</span>\r\n                  <div className=\"flex-1 h-4 bg-muted rounded overflow-hidden\">\r\n                    <div\r\n                      className=\"h-full bg-primary transition-all\"\r\n                      style={{ width: `${width}%` }}\r\n                    />\r\n                  </div>\r\n                  <span className=\"text-xs w-16 text-right\">\r\n                    {formatDuration(step.duration)}\r\n                  </span>\r\n                </div>\r\n              );\r\n            })}\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: PuzzlesTab\r\n// =============================================================================\r\n\r\ninterface PuzzlesTabProps {\r\n  puzzleMetrics: PuzzleMetrics[];\r\n}\r\n\r\nfunction PuzzlesTab({ puzzleMetrics }: PuzzlesTabProps) {\r\n  const [sortBy, setSortBy] = useState<'name' | 'time' | 'attempts'>('name');\r\n\r\n  const sortedPuzzles = [...puzzleMetrics].sort((a, b) => {\r\n    switch (sortBy) {\r\n      case 'time':\r\n        return (b.solveTime ?? 0) - (a.solveTime ?? 0);\r\n      case 'attempts':\r\n        return b.attempts - a.attempts;\r\n      default:\r\n        return a.name.localeCompare(b.name);\r\n    }\r\n  });\r\n\r\n  const sortOptions = [\r\n    { value: 'name', label: 'Namn' },\r\n    { value: 'time', label: 'L├Âsningstid' },\r\n    { value: 'attempts', label: 'F├Ârs├Âk' },\r\n  ];\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div className=\"text-sm text-muted-foreground\">\r\n          {puzzleMetrics.filter((p) => p.solved).length} av {puzzleMetrics.length} l├Âsta\r\n        </div>\r\n        <Select \r\n          value={sortBy} \r\n          onChange={(e) => setSortBy(e.target.value as typeof sortBy)}\r\n          options={sortOptions}\r\n          className=\"w-[140px]\"\r\n        />\r\n      </div>\r\n\r\n      <ScrollArea maxHeight={300}>\r\n        <Table>\r\n          <TableHeader>\r\n            <TableRow>\r\n              <TableHead>Pussel</TableHead>\r\n              <TableHead>Typ</TableHead>\r\n              <TableHead>Steg</TableHead>\r\n              <TableHead className=\"text-center\">F├Ârs├Âk</TableHead>\r\n              <TableHead className=\"text-right\">L├Âsningstid</TableHead>\r\n              <TableHead className=\"text-right\">Status</TableHead>\r\n            </TableRow>\r\n          </TableHeader>\r\n          <TableBody>\r\n            {sortedPuzzles.map((puzzle) => (\r\n              <TableRow key={puzzle.artifactId}>\r\n                <TableCell className=\"font-medium\">{puzzle.name}</TableCell>\r\n                <TableCell>\r\n                  <Badge variant=\"outline\" className=\"text-xs\">\r\n                    {puzzle.type}\r\n                  </Badge>\r\n                </TableCell>\r\n                <TableCell>Steg {puzzle.stepIndex + 1}</TableCell>\r\n                <TableCell className=\"text-center\">{puzzle.attempts}</TableCell>\r\n                <TableCell className=\"text-right\">\r\n                  {puzzle.solveTime ? formatDuration(puzzle.solveTime) : 'ÔÇô'}\r\n                </TableCell>\r\n                <TableCell className=\"text-right\">\r\n                  {puzzle.solved ? (\r\n                    <CheckCircleIcon className=\"h-4 w-4 text-green-500 inline\" />\r\n                  ) : (\r\n                    <span className=\"text-muted-foreground\">ÔÇô</span>\r\n                  )}\r\n                </TableCell>\r\n              </TableRow>\r\n            ))}\r\n          </TableBody>\r\n        </Table>\r\n      </ScrollArea>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: ExportButtons\r\n// =============================================================================\r\n\r\ninterface ExportButtonsProps {\r\n  onExportJSON: () => void;\r\n  onExportCSV: () => void;\r\n}\r\n\r\nfunction ExportButtons({ onExportJSON, onExportCSV }: ExportButtonsProps) {\r\n  return (\r\n    <div className=\"flex items-center gap-2\">\r\n      <Button variant=\"outline\" size=\"sm\" onClick={onExportJSON}>\r\n        <DocumentTextIcon className=\"h-4 w-4 mr-1\" />\r\n        JSON\r\n      </Button>\r\n      <Button variant=\"outline\" size=\"sm\" onClick={onExportCSV}>\r\n        <TableCellsIcon className=\"h-4 w-4 mr-1\" />\r\n        CSV\r\n      </Button>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function AnalyticsDashboard({\r\n  analyticsHook,\r\n  className,\r\n  compact = false,\r\n  showExport = true,\r\n}: AnalyticsDashboardProps) {\r\n  const { analytics, exportJSON, exportCSV } = analyticsHook;\r\n  const [activeTab, setActiveTab] = useState('overview');\r\n\r\n  const handleExportJSON = () => {\r\n    const data = exportJSON();\r\n    const blob = new Blob([data], { type: 'application/json' });\r\n    const url = URL.createObjectURL(blob);\r\n    const a = document.createElement('a');\r\n    a.href = url;\r\n    a.download = `session-analytics-${analytics.sessionId}.json`;\r\n    a.click();\r\n    URL.revokeObjectURL(url);\r\n  };\r\n\r\n  const handleExportCSV = () => {\r\n    const data = exportCSV();\r\n    const blob = new Blob([data], { type: 'text/csv' });\r\n    const url = URL.createObjectURL(blob);\r\n    const a = document.createElement('a');\r\n    a.href = url;\r\n    a.download = `session-analytics-${analytics.sessionId}.csv`;\r\n    a.click();\r\n    URL.revokeObjectURL(url);\r\n  };\r\n\r\n  const tabs = [\r\n    { id: 'overview', label: '├ûversikt' },\r\n    { id: 'steps', label: 'Steg' },\r\n    { id: 'puzzles', label: 'Pussel' },\r\n  ];\r\n\r\n  return (\r\n    <Card className={className}>\r\n      <CardHeader className={compact ? 'pb-2' : 'pb-3'}>\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <CardTitle className=\"flex items-center gap-2 text-base\">\r\n              <ChartBarIcon className=\"h-5 w-5\" />\r\n              Analytics Dashboard\r\n            </CardTitle>\r\n            {!compact && (\r\n              <CardDescription>\r\n                Session-prestanda och statistik\r\n              </CardDescription>\r\n            )}\r\n          </div>\r\n          {showExport && (\r\n            <ExportButtons\r\n              onExportJSON={handleExportJSON}\r\n              onExportCSV={handleExportCSV}\r\n            />\r\n          )}\r\n        </div>\r\n      </CardHeader>\r\n\r\n      <CardContent>\r\n        <Tabs tabs={tabs} activeTab={activeTab} onChange={setActiveTab} />\r\n\r\n        <div className=\"mt-4\">\r\n          <TabPanel id=\"overview\" activeTab={activeTab}>\r\n            <OverviewTab analytics={analytics} />\r\n          </TabPanel>\r\n\r\n          <TabPanel id=\"steps\" activeTab={activeTab}>\r\n            <StepsTab stepMetrics={analytics.stepMetrics} />\r\n          </TabPanel>\r\n\r\n          <TabPanel id=\"puzzles\" activeTab={activeTab}>\r\n            <PuzzlesTab puzzleMetrics={analytics.puzzleMetrics} />\r\n          </TabPanel>\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Compact Summary Card\r\n// =============================================================================\r\n\r\nexport interface AnalyticsSummaryCardProps {\r\n  analytics: SessionAnalytics;\r\n  className?: string;\r\n}\r\n\r\nexport function AnalyticsSummaryCard({\r\n  analytics,\r\n  className,\r\n}: AnalyticsSummaryCardProps) {\r\n  return (\r\n    <div className={`space-y-3 ${className}`}>\r\n      {/* Progress bar */}\r\n      <div className=\"space-y-1\">\r\n        <div className=\"flex items-center justify-between text-sm\">\r\n          <span>Framsteg</span>\r\n          <span className=\"font-medium\">{Math.round(analytics.progressPercent)}%</span>\r\n        </div>\r\n        <Progress value={analytics.progressPercent} />\r\n      </div>\r\n\r\n      {/* Quick stats */}\r\n      <div className=\"grid grid-cols-2 gap-2 text-sm\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <ClockIcon className=\"h-4 w-4 text-muted-foreground\" />\r\n          <span>{formatDuration(analytics.totalDuration)}</span>\r\n        </div>\r\n        <div className=\"flex items-center gap-2\">\r\n          <PuzzlePieceIcon className=\"h-4 w-4 text-muted-foreground\" />\r\n          <span>\r\n            {analytics.engagement.puzzlesSolved}/{analytics.engagement.totalPuzzles}\r\n          </span>\r\n        </div>\r\n        <div className=\"flex items-center gap-2\">\r\n          <BoltIcon className=\"h-4 w-4 text-muted-foreground\" />\r\n          <span>{analytics.engagement.totalTriggerFires} triggers</span>\r\n        </div>\r\n        <div className=\"flex items-center gap-2\">\r\n          <LightBulbIcon className=\"h-4 w-4 text-muted-foreground\" />\r\n          <span>{analytics.engagement.totalHintsUsed} ledtr├Ñdar</span>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Warnings */}\r\n      {analytics.engagement.triggerErrors > 0 && (\r\n        <div className=\"flex items-center gap-2 text-sm text-red-500\">\r\n          <ExclamationCircleIcon className=\"h-4 w-4\" />\r\n          <span>{analytics.engagement.triggerErrors} trigger-fel</span>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\ArtifactsPanel.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":198,"column":54,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":198,"endColumn":72},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":209,"column":58,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":209,"endColumn":103},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":215,"column":50,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":217,"endColumn":13},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":231,"column":67,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":231,"endColumn":87},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":232,"column":56,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":234,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":235,"column":48,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":237,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":238,"column":56,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":240,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":294,"column":44,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":295,"endColumn":23}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useCallback, useEffect, useMemo, useState } from 'react';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Input } from '@/components/ui/input';\r\nimport { ConversationCardsCollectionArtifact } from '@/features/play/components/ConversationCardsCollectionArtifact';\r\n\r\n/**\r\n * Sanitized keypad metadata (from server - correctCode is NEVER included)\r\n */\r\ntype KeypadMetadata = {\r\n  codeLength?: number;\r\n  maxAttempts?: number | null;\r\n  successMessage?: string | null;\r\n  failMessage?: string | null;\r\n  lockedMessage?: string | null;\r\n  keypadState?: {\r\n    isUnlocked: boolean;\r\n    isLockedOut: boolean;\r\n    attemptCount: number;\r\n    unlockedAt: string | null;\r\n  };\r\n};\r\n\r\ntype SessionArtifact = {\r\n  id: string;\r\n  title: string;\r\n  description?: string | null;\r\n  artifact_type?: string | null;\r\n  artifact_order?: number;\r\n  metadata?: Record<string, unknown> | null;\r\n};\r\n\r\ntype SessionArtifactVariant = {\r\n  id: string;\r\n  session_artifact_id: string;\r\n  title?: string | null;\r\n  body?: string | null;\r\n  visibility: 'public' | 'leader_only' | 'role_private';\r\n  visible_to_session_role_id?: string | null;\r\n  revealed_at?: string | null;\r\n  highlighted_at?: string | null;\r\n};\r\n\r\ntype KeypadAttemptResponse = {\r\n  status: 'success' | 'fail' | 'locked' | 'already_unlocked';\r\n  message: string;\r\n  attemptsLeft?: number;\r\n  revealVariantIds?: string[];\r\n  keypadState: {\r\n    isUnlocked: boolean;\r\n    isLockedOut: boolean;\r\n    attemptCount: number;\r\n  };\r\n};\r\n\r\nexport function ArtifactsPanel({ sessionId }: { sessionId: string }) {\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [artifacts, setArtifacts] = useState<SessionArtifact[]>([]);\r\n  const [variants, setVariants] = useState<SessionArtifactVariant[]>([]);\r\n  \r\n  // Keypad UI state (code entry, submission status)\r\n  const [keypadCodes, setKeypadCodes] = useState<Map<string, string>>(new Map());\r\n  const [keypadSubmitting, setKeypadSubmitting] = useState<Set<string>>(new Set());\r\n  const [keypadMessages, setKeypadMessages] = useState<Map<string, { type: 'success' | 'error'; text: string }>>(new Map());\r\n\r\n  const load = useCallback(async () => {\r\n    setLoading(true);\r\n    setError(null);\r\n    try {\r\n      const res = await fetch(`/api/play/sessions/${sessionId}/artifacts`, { cache: 'no-store' });\r\n      const data = await res.json();\r\n      if (!res.ok) throw new Error(data.error || 'Kunde inte ladda artefakter');\r\n      setArtifacts(data.artifacts || []);\r\n      setVariants(data.variants || []);\r\n    } catch (e) {\r\n      setError(e instanceof Error ? e.message : 'Kunde inte ladda artefakter');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [sessionId]);\r\n\r\n  useEffect(() => {\r\n    void load();\r\n  }, [load]);\r\n\r\n  const variantsByArtifact = useMemo(() => {\r\n    const map = new Map<string, SessionArtifactVariant[]>();\r\n    for (const v of variants) {\r\n      const list = map.get(v.session_artifact_id) ?? [];\r\n      list.push(v);\r\n      map.set(v.session_artifact_id, list);\r\n    }\r\n    return map;\r\n  }, [variants]);\r\n\r\n  const snapshot = useCallback(async () => {\r\n    setError(null);\r\n    const res = await fetch(`/api/play/sessions/${sessionId}/artifacts`, {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({}),\r\n    });\r\n    const data = await res.json().catch(() => ({}));\r\n    if (!res.ok) {\r\n      setError(data.error || 'Kunde inte snapshotta artefakter');\r\n      return;\r\n    }\r\n    await load();\r\n  }, [sessionId, load]);\r\n\r\n  const updateVariant = useCallback(\r\n    async (body: unknown) => {\r\n      setError(null);\r\n      const res = await fetch(`/api/play/sessions/${sessionId}/artifacts/state`, {\r\n        method: 'PATCH',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(body),\r\n      });\r\n      const data = await res.json().catch(() => ({}));\r\n      if (!res.ok) {\r\n        setError(data.error || 'Kunde inte uppdatera artefakt');\r\n        return;\r\n      }\r\n      await load();\r\n    },\r\n    [sessionId, load]\r\n  );\r\n\r\n  /**\r\n   * Submit keypad code to server for validation.\r\n   * Server validates code, updates session state, and returns result.\r\n   * correctCode is NEVER exposed to the client.\r\n   */\r\n  const submitKeypadCode = useCallback(\r\n    async (artifactId: string, enteredCode: string) => {\r\n      if (!enteredCode.trim()) return;\r\n\r\n      setKeypadSubmitting((prev) => new Set([...prev, artifactId]));\r\n      setKeypadMessages((prev) => {\r\n        const next = new Map(prev);\r\n        next.delete(artifactId);\r\n        return next;\r\n      });\r\n\r\n      try {\r\n        const res = await fetch(`/api/play/sessions/${sessionId}/artifacts/${artifactId}/keypad`, {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({ enteredCode }),\r\n        });\r\n\r\n        const data: KeypadAttemptResponse = await res.json();\r\n\r\n        if (!res.ok) {\r\n          setKeypadMessages((prev) => new Map(prev).set(artifactId, { type: 'error', text: 'Serverfel' }));\r\n          return;\r\n        }\r\n\r\n        // Update local message\r\n        const messageType = data.status === 'success' || data.status === 'already_unlocked' ? 'success' : 'error';\r\n        setKeypadMessages((prev) => new Map(prev).set(artifactId, { type: messageType, text: data.message }));\r\n\r\n        // Clear entered code on success or lockout\r\n        if (data.status === 'success' || data.status === 'locked') {\r\n          setKeypadCodes((prev) => {\r\n            const next = new Map(prev);\r\n            next.delete(artifactId);\r\n            return next;\r\n          });\r\n        }\r\n\r\n        // Reload artifacts to get updated state\r\n        await load();\r\n\r\n      } catch (e) {\r\n        setKeypadMessages((prev) => new Map(prev).set(artifactId, { \r\n          type: 'error', \r\n          text: e instanceof Error ? e.message : 'N├Ñgot gick fel' \r\n        }));\r\n      } finally {\r\n        setKeypadSubmitting((prev) => {\r\n          const next = new Set(prev);\r\n          next.delete(artifactId);\r\n          return next;\r\n        });\r\n      }\r\n    },\r\n    [sessionId, load]\r\n  );\r\n\r\n  if (loading) {\r\n    return (\r\n      <Card className=\"p-6\">\r\n        <p className=\"text-sm text-muted-foreground\">Laddar artefakterÔÇª</p>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <Card className=\"p-6\">\r\n        <div className=\"flex items-center justify-between gap-4\">\r\n          <div>\r\n            <h2 className=\"text-lg font-semibold\">Artefakter</h2>\r\n            <p className=\"text-sm text-muted-foreground\">Snapshot, reveal och highlight av artefakter.</p>\r\n          </div>\r\n          <div className=\"flex items-center gap-2\">\r\n            <Button size=\"sm\" variant=\"outline\" onClick={load}>\r\n              Uppdatera\r\n            </Button>\r\n            <Button size=\"sm\" onClick={snapshot}>\r\n              Snapshotta fr├Ñn spel\r\n            </Button>\r\n          </div>\r\n        </div>\r\n\r\n        {error && <p className=\"mt-4 text-sm text-destructive\">{error}</p>}\r\n      </Card>\r\n\r\n      {artifacts.length === 0 ? (\r\n        <Card className=\"p-6 text-center space-y-3\">\r\n          <div className=\"mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-muted\">\r\n            <svg className=\"h-6 w-6 text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z\" />\r\n            </svg>\r\n          </div>\r\n          <h3 className=\"text-base font-semibold text-foreground\">Inga artefakter ├ñnnu</h3>\r\n          <p className=\"text-sm text-muted-foreground\">\r\n            Spelet kan ha dokument, bilder eller andra resurser kopplade till sig.\r\n          </p>\r\n          <Button size=\"sm\" onClick={snapshot}>\r\n            H├ñmta artefakter fr├Ñn spelet\r\n          </Button>\r\n          <p className=\"text-xs text-muted-foreground\">\r\n            Om knappen inte fungerar har spelet inga artefakter definierade.\r\n          </p>\r\n        </Card>\r\n      ) : (\r\n        artifacts.map((a) => {\r\n          const vs = variantsByArtifact.get(a.id) ?? [];\r\n\r\n          if (a.artifact_type === 'conversation_cards_collection') {\r\n            return (\r\n              <ConversationCardsCollectionArtifact\r\n                key={a.id}\r\n                sessionId={sessionId}\r\n                participantToken={null}\r\n                artifactTitle={a.title ?? null}\r\n                artifactDescription={a.description ?? null}\r\n                metadata={a.metadata ?? null}\r\n              />\r\n            );\r\n          }\r\n\r\n          // Keypad artifact rendering (server-side validation - correctCode never exposed)\r\n          if (a.artifact_type === 'keypad') {\r\n            const meta = (a.metadata || {}) as KeypadMetadata;\r\n            const codeLength = meta.codeLength || 4;\r\n            const maxAttempts = meta.maxAttempts;\r\n            const successMessage = meta.successMessage || 'Koden ├ñr korrekt!';\r\n            const lockedMessage = meta.lockedMessage || 'Keypaden ├ñr l├Ñst.';\r\n            \r\n            // Server-provided state\r\n            const keypadState = meta.keypadState || { isUnlocked: false, isLockedOut: false, attemptCount: 0 };\r\n            const isUnlocked = keypadState.isUnlocked;\r\n            const isLockedOut = keypadState.isLockedOut;\r\n            const attemptsRemaining = maxAttempts ? Math.max(0, maxAttempts - keypadState.attemptCount) : null;\r\n\r\n            // Local UI state\r\n            const enteredCode = keypadCodes.get(a.id) || '';\r\n            const isSubmitting = keypadSubmitting.has(a.id);\r\n            const message = keypadMessages.get(a.id);\r\n\r\n            return (\r\n              <Card key={a.id} className=\"p-6 space-y-4\">\r\n                <div className=\"flex items-start justify-between gap-4\">\r\n                  <div>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <span className=\"text-lg\">{isLockedOut ? '­ƒöÆ' : isUnlocked ? '­ƒöô' : '­ƒöÉ'}</span>\r\n                      <h3 className=\"font-medium\">{a.title}</h3>\r\n                    </div>\r\n                    {a.description && <p className=\"text-sm text-muted-foreground mt-1\">{a.description}</p>}\r\n                  </div>\r\n                  <div className=\"flex flex-col items-end gap-1\">\r\n                    <Badge variant={isUnlocked ? 'default' : isLockedOut ? 'destructive' : 'secondary'}>\r\n                      {isUnlocked ? 'Uppl├Ñst' : isLockedOut ? 'L├Ñst ut' : 'L├Ñst'}\r\n                    </Badge>\r\n                    {attemptsRemaining !== null && !isUnlocked && !isLockedOut && (\r\n                      <span className=\"text-xs text-muted-foreground\">\r\n                        {attemptsRemaining} f├Ârs├Âk kvar\r\n                      </span>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n\r\n                {isUnlocked ? (\r\n                  <div className=\"rounded-lg border border-green-500/30 bg-green-500/10 p-4 text-center\">\r\n                    <p className=\"text-sm font-medium text-green-600 dark:text-green-400\">\r\n                      Ô£ô {successMessage}\r\n                    </p>\r\n                    {vs.length > 0 && (\r\n                      <div className=\"mt-3 space-y-2 text-left\">\r\n                        {vs.map((v) => (\r\n                          <div key={v.id} className=\"rounded border border-border p-2 text-sm\">\r\n                            <p className=\"font-medium\">{v.title || 'Uppl├Ñst inneh├Ñll'}</p>\r\n                            {v.body && <p className=\"text-muted-foreground\">{v.body}</p>}\r\n                          </div>\r\n                        ))}\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                ) : isLockedOut ? (\r\n                  <div className=\"rounded-lg border border-destructive/30 bg-destructive/10 p-4 text-center\">\r\n                    <p className=\"text-sm font-medium text-destructive\">\r\n                      ­ƒöÆ {lockedMessage}\r\n                    </p>\r\n                  </div>\r\n                ) : (\r\n                  <div className=\"space-y-3\">\r\n                    {/* Code entry - server validates, never exposes correctCode */}\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <Input\r\n                        type=\"text\"\r\n                        inputMode=\"numeric\"\r\n                        pattern=\"[0-9]*\"\r\n                        maxLength={codeLength}\r\n                        placeholder={'ÔÇó'.repeat(codeLength)}\r\n                        value={enteredCode}\r\n                        onChange={(e) => {\r\n                          const val = e.target.value.replace(/\\D/g, '').slice(0, codeLength);\r\n                          setKeypadCodes((prev) => new Map(prev).set(a.id, val));\r\n                          // Clear error message when user starts typing\r\n                          if (message?.type === 'error') {\r\n                            setKeypadMessages((prev) => {\r\n                              const next = new Map(prev);\r\n                              next.delete(a.id);\r\n                              return next;\r\n                            });\r\n                          }\r\n                        }}\r\n                        onKeyDown={(e) => {\r\n                          if (e.key === 'Enter' && enteredCode.length === codeLength && !isSubmitting) {\r\n                            void submitKeypadCode(a.id, enteredCode);\r\n                          }\r\n                        }}\r\n                        disabled={isSubmitting}\r\n                        className={`text-center text-2xl tracking-[0.5em] font-mono transition-transform ${\r\n                          message?.type === 'error' ? 'animate-shake border-destructive' : ''\r\n                        }`}\r\n                      />\r\n                      <Button\r\n                        onClick={() => submitKeypadCode(a.id, enteredCode)}\r\n                        disabled={enteredCode.length !== codeLength || isSubmitting}\r\n                      >\r\n                        {isSubmitting ? 'Kontrollerar...' : 'L├Ñs upp'}\r\n                      </Button>\r\n                    </div>\r\n\r\n                    {/* Feedback message */}\r\n                    {message && (\r\n                      <p className={`text-sm text-center ${message.type === 'success' ? 'text-green-600' : 'text-destructive'}`}>\r\n                        {message.text}\r\n                      </p>\r\n                    )}\r\n\r\n                    {/* Code dots visualization */}\r\n                    <div className=\"flex justify-center gap-2\">\r\n                      {Array.from({ length: codeLength }).map((_, i) => (\r\n                        <div\r\n                          key={i}\r\n                          className={`h-3 w-3 rounded-full transition-colors ${\r\n                            i < enteredCode.length ? 'bg-primary' : 'bg-muted'\r\n                          }`}\r\n                        />\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </Card>\r\n            );\r\n          }\r\n\r\n          // Standard artifact rendering (card, document, image, etc.)\r\n          return (\r\n            <Card key={a.id} className=\"p-6 space-y-3\">\r\n              <div className=\"flex items-start justify-between gap-4\">\r\n                <div>\r\n                  <h3 className=\"font-medium\">{a.title}</h3>\r\n                  {a.description && <p className=\"text-sm text-muted-foreground\">{a.description}</p>}\r\n                </div>\r\n                <Badge variant=\"secondary\">{vs.length} varianter</Badge>\r\n              </div>\r\n\r\n              <div className=\"space-y-2\">\r\n                {vs.map((v) => {\r\n                  const revealable = v.visibility === 'public';\r\n                  const revealed = Boolean(v.revealed_at);\r\n                  const highlighted = Boolean(v.highlighted_at);\r\n                  return (\r\n                    <div key={v.id} className=\"rounded-lg border border-border p-3\">\r\n                      <div className=\"flex flex-wrap items-center justify-between gap-2\">\r\n                        <div className=\"min-w-0\">\r\n                          <p className=\"text-sm font-medium truncate\">\r\n                            {v.title || 'Variant'}\r\n                          </p>\r\n                          <p className=\"text-xs text-muted-foreground\">\r\n                            {v.visibility}\r\n                            {v.visibility === 'role_private' && v.visible_to_session_role_id ? ' (roll)' : ''}\r\n                          </p>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          {revealable && (\r\n                            <Button\r\n                              size=\"sm\"\r\n                              variant={revealed ? 'outline' : 'primary'}\r\n                              onClick={() =>\r\n                                updateVariant({ action: 'reveal_variant', variantId: v.id, revealed: !revealed })\r\n                              }\r\n                            >\r\n                              {revealed ? 'D├Âlj' : 'Reveal'}\r\n                            </Button>\r\n                          )}\r\n                          <Button\r\n                            size=\"sm\"\r\n                            variant={highlighted ? 'outline' : 'ghost'}\r\n                            onClick={() =>\r\n                              updateVariant({ action: 'highlight_variant', variantId: v.id, highlighted: !highlighted })\r\n                            }\r\n                          >\r\n                            {highlighted ? 'Avmarkera' : 'Highlight'}\r\n                          </Button>\r\n                        </div>\r\n                      </div>\r\n                      {v.body && <p className=\"mt-2 text-sm whitespace-pre-wrap\">{v.body}</p>}\r\n                    </div>\r\n                  );\r\n                })}\r\n              </div>\r\n            </Card>\r\n          );\r\n        })\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\BatchArtifactPanel.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":285,"column":46,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":285,"endColumn":64},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":373,"column":28,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":375,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":407,"column":31,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":407,"endColumn":49},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":408,"column":37,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":409,"endColumn":41},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":413,"column":62,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":415,"endColumn":17},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":418,"column":62,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":420,"endColumn":17},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":426,"column":56,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":428,"endColumn":13}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * BatchArtifactPanel Component\r\n * \r\n * UI for selecting and performing batch operations on artifacts.\r\n * Supports filtering, multi-select, and progress tracking.\r\n * \r\n * Backlog B.5: Batch artifact operations\r\n */\r\n\r\n'use client';\r\n\r\nimport React, { useState } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Checkbox } from '@/components/ui/checkbox';\r\nimport { Progress } from '@/components/ui/progress';\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from '@/components/ui/card';\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n} from '@/components/ui/dropdown-menu';\r\nimport {\r\n  AlertDialog,\r\n  AlertDialogAction,\r\n  AlertDialogCancel,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n} from '@/components/ui/alert-dialog';\r\nimport { ScrollArea } from '@/components/ui/scroll-area';\r\nimport {\r\n  RectangleStackIcon,\r\n  EyeIcon,\r\n  EyeSlashIcon,\r\n  LockClosedIcon,\r\n  LockOpenIcon,\r\n  ArrowPathIcon,\r\n  CheckCircleIcon,\r\n  ChevronDownIcon,\r\n  PuzzlePieceIcon,\r\n  DocumentTextIcon,\r\n  KeyIcon,\r\n  QuestionMarkCircleIcon,\r\n  PhotoIcon,\r\n  SpeakerWaveIcon,\r\n  Squares2X2Icon,\r\n  CircleStackIcon,\r\n  CursorArrowRaysIcon,\r\n  CheckIcon,\r\n  MinusIcon,\r\n  StopIcon,\r\n  ExclamationTriangleIcon,\r\n} from '@heroicons/react/24/outline';\r\nimport type {\r\n  ArtifactInfo,\r\n  BatchOperation,\r\n  UseBatchArtifactsReturn,\r\n} from '@/features/play/hooks/useBatchArtifacts';\r\nimport {\r\n  PRESET_FILTERS,\r\n  OPERATION_LABELS,\r\n} from '@/features/play/hooks/useBatchArtifacts';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface BatchArtifactPanelProps {\r\n  /** Batch artifacts hook return */\r\n  batch: UseBatchArtifactsReturn;\r\n  /** All artifacts */\r\n  artifacts: ArtifactInfo[];\r\n  /** Optional className */\r\n  className?: string;\r\n  /** Compact mode */\r\n  compact?: boolean;\r\n}\r\n\r\n// =============================================================================\r\n// Constants\r\n// =============================================================================\r\n\r\nconst ARTIFACT_TYPE_ICONS: Record<string, React.ReactNode> = {\r\n  keypad: <KeyIcon className=\"h-4 w-4\" />,\r\n  riddle: <QuestionMarkCircleIcon className=\"h-4 w-4\" />,\r\n  cipher: <CircleStackIcon className=\"h-4 w-4\" />,\r\n  tile_puzzle: <Squares2X2Icon className=\"h-4 w-4\" />,\r\n  logic_grid: <Squares2X2Icon className=\"h-4 w-4\" />,\r\n  hotspot: <CursorArrowRaysIcon className=\"h-4 w-4\" />,\r\n  card: <DocumentTextIcon className=\"h-4 w-4\" />,\r\n  document: <DocumentTextIcon className=\"h-4 w-4\" />,\r\n  image: <PhotoIcon className=\"h-4 w-4\" />,\r\n  audio: <SpeakerWaveIcon className=\"h-4 w-4\" />,\r\n  default: <PuzzlePieceIcon className=\"h-4 w-4\" />,\r\n};\r\n\r\nconst OPERATION_CONFIGS: Array<{\r\n  operation: BatchOperation;\r\n  icon: React.ReactNode;\r\n  variant: 'default' | 'primary' | 'destructive' | 'outline';\r\n  confirmRequired?: boolean;\r\n}> = [\r\n  { operation: 'reveal', icon: <EyeIcon className=\"h-4 w-4\" />, variant: 'default' },\r\n  { operation: 'hide', icon: <EyeSlashIcon className=\"h-4 w-4\" />, variant: 'outline' },\r\n  { operation: 'reset', icon: <ArrowPathIcon className=\"h-4 w-4\" />, variant: 'outline', confirmRequired: true },\r\n  { operation: 'unlock', icon: <LockOpenIcon className=\"h-4 w-4\" />, variant: 'outline' },\r\n  { operation: 'lock', icon: <LockClosedIcon className=\"h-4 w-4\" />, variant: 'outline' },\r\n  { operation: 'solve', icon: <CheckCircleIcon className=\"h-4 w-4\" />, variant: 'default', confirmRequired: true },\r\n];\r\n\r\n// =============================================================================\r\n// Sub-Component: ArtifactRow\r\n// =============================================================================\r\n\r\ninterface ArtifactRowProps {\r\n  artifact: ArtifactInfo;\r\n  isSelected: boolean;\r\n  onToggle: () => void;\r\n}\r\n\r\nfunction ArtifactRow({ artifact, isSelected, onToggle }: ArtifactRowProps) {\r\n  const icon = ARTIFACT_TYPE_ICONS[artifact.type] || ARTIFACT_TYPE_ICONS.default;\r\n\r\n  return (\r\n    <div\r\n      className={`\r\n        flex items-center gap-3 p-2 rounded-lg cursor-pointer transition-colors\r\n        ${isSelected ? 'bg-primary/10 border border-primary/30' : 'hover:bg-muted/50'}\r\n      `}\r\n      onClick={onToggle}\r\n    >\r\n      <Checkbox checked={isSelected} onChange={onToggle} />\r\n      <div className=\"text-muted-foreground\">{icon}</div>\r\n      <div className=\"flex-1 min-w-0\">\r\n        <div className=\"font-medium text-sm truncate\">{artifact.name}</div>\r\n        <div className=\"text-xs text-muted-foreground\">{artifact.type}</div>\r\n      </div>\r\n      <div className=\"flex items-center gap-1\">\r\n        {artifact.visible ? (\r\n          <EyeIcon className=\"h-3 w-3 text-green-500\" />\r\n        ) : (\r\n          <EyeSlashIcon className=\"h-3 w-3 text-muted-foreground\" />\r\n        )}\r\n        {artifact.locked && <LockClosedIcon className=\"h-3 w-3 text-yellow-500\" />}\r\n        {artifact.solved && <CheckCircleIcon className=\"h-3 w-3 text-green-500\" />}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: SelectionHeader\r\n// =============================================================================\r\n\r\ninterface SelectionHeaderProps {\r\n  batch: UseBatchArtifactsReturn;\r\n  totalCount: number;\r\n}\r\n\r\nfunction SelectionHeader({ batch, totalCount }: SelectionHeaderProps) {\r\n  const allSelected = batch.selectedCount === totalCount && totalCount > 0;\r\n  const someSelected = batch.selectedCount > 0 && batch.selectedCount < totalCount;\r\n\r\n  const handleToggleAll = () => {\r\n    if (allSelected || someSelected) {\r\n      batch.clearSelection();\r\n    } else {\r\n      batch.selectAll();\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"flex items-center gap-3 pb-3 border-b\">\r\n      <button\r\n        onClick={handleToggleAll}\r\n        className=\"flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground\"\r\n      >\r\n        {allSelected ? (\r\n          <CheckIcon className=\"h-4 w-4 text-primary\" />\r\n        ) : someSelected ? (\r\n          <MinusIcon className=\"h-4 w-4 text-primary\" />\r\n        ) : (\r\n          <StopIcon className=\"h-4 w-4\" />\r\n        )}\r\n        {allSelected ? 'Avmarkera alla' : 'Markera alla'}\r\n      </button>\r\n\r\n      <div className=\"flex-1\" />\r\n\r\n      <DropdownMenu>\r\n        <DropdownMenuTrigger asChild>\r\n          <Button variant=\"outline\" size=\"sm\">\r\n            Snabbval\r\n            <ChevronDownIcon className=\"h-4 w-4 ml-1\" />\r\n          </Button>\r\n        </DropdownMenuTrigger>\r\n        <DropdownMenuContent align=\"end\">\r\n          {PRESET_FILTERS.map((preset) => (\r\n            <DropdownMenuItem\r\n              key={preset.id}\r\n              onClick={() => batch.selectByFilter(preset.filter)}\r\n            >\r\n              {preset.label}\r\n            </DropdownMenuItem>\r\n          ))}\r\n          <DropdownMenuSeparator />\r\n          {batch.filterOptions.types.map((type) => (\r\n            <DropdownMenuItem\r\n              key={type}\r\n              onClick={() => batch.selectByFilter({ type: 'type', value: type })}\r\n            >\r\n              Alla {type}\r\n            </DropdownMenuItem>\r\n          ))}\r\n        </DropdownMenuContent>\r\n      </DropdownMenu>\r\n\r\n      <Badge variant=\"default\">\r\n        {batch.selectedCount} av {totalCount}\r\n      </Badge>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: OperationButtons\r\n// =============================================================================\r\n\r\ninterface OperationButtonsProps {\r\n  batch: UseBatchArtifactsReturn;\r\n  onOperation: (operation: BatchOperation) => void;\r\n}\r\n\r\nfunction OperationButtons({ batch, onOperation }: OperationButtonsProps) {\r\n  const disabled = batch.selectedCount === 0 || batch.isProcessing;\r\n\r\n  return (\r\n    <div className=\"flex flex-wrap gap-2 pt-3 border-t\">\r\n      {OPERATION_CONFIGS.map((config) => (\r\n        <Button\r\n          key={config.operation}\r\n          variant={config.variant}\r\n          size=\"sm\"\r\n          disabled={disabled}\r\n          onClick={() => onOperation(config.operation)}\r\n          className=\"gap-1\"\r\n        >\r\n          {config.icon}\r\n          {OPERATION_LABELS[config.operation]}\r\n        </Button>\r\n      ))}\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: ProgressOverlay\r\n// =============================================================================\r\n\r\ninterface ProgressOverlayProps {\r\n  isProcessing: boolean;\r\n  progress: number;\r\n  selectedCount: number;\r\n}\r\n\r\nfunction ProgressOverlay({ isProcessing, progress, selectedCount }: ProgressOverlayProps) {\r\n  if (!isProcessing) return null;\r\n\r\n  return (\r\n    <div className=\"absolute inset-0 bg-background/80 backdrop-blur-sm flex items-center justify-center z-10 rounded-lg\">\r\n      <div className=\"text-center space-y-3\">\r\n        <ArrowPathIcon className=\"h-8 w-8 animate-spin mx-auto text-primary\" />\r\n        <div className=\"space-y-1\">\r\n          <p className=\"text-sm font-medium\">Utf├Âr operation...</p>\r\n          <p className=\"text-xs text-muted-foreground\">\r\n            {Math.round((progress / 100) * selectedCount)} av {selectedCount}\r\n          </p>\r\n        </div>\r\n        <Progress value={progress} className=\"w-48\" />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: ResultSummary\r\n// =============================================================================\r\n\r\ninterface ResultSummaryProps {\r\n  result: UseBatchArtifactsReturn['lastResult'];\r\n}\r\n\r\nfunction ResultSummary({ result }: ResultSummaryProps) {\r\n  if (!result) return null;\r\n\r\n  const hasErrors = result.failed.length > 0;\r\n\r\n  return (\r\n    <div\r\n      className={`\r\n        p-3 rounded-lg text-sm\r\n        ${hasErrors ? 'bg-yellow-500/10 text-yellow-600' : 'bg-green-500/10 text-green-600'}\r\n      `}\r\n    >\r\n      <div className=\"flex items-center gap-2\">\r\n        {hasErrors ? (\r\n          <ExclamationTriangleIcon className=\"h-4 w-4\" />\r\n        ) : (\r\n          <CheckCircleIcon className=\"h-4 w-4\" />\r\n        )}\r\n        <span>\r\n          {OPERATION_LABELS[result.operation]}: {result.successful.length} lyckades\r\n          {hasErrors && `, ${result.failed.length} misslyckades`}\r\n        </span>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function BatchArtifactPanel({\r\n  batch,\r\n  artifacts,\r\n  className,\r\n  compact = false,\r\n}: BatchArtifactPanelProps) {\r\n  const [confirmOperation, setConfirmOperation] = useState<BatchOperation | null>(null);\r\n\r\n  const handleOperation = (operation: BatchOperation) => {\r\n    const config = OPERATION_CONFIGS.find((c) => c.operation === operation);\r\n    if (config?.confirmRequired) {\r\n      setConfirmOperation(operation);\r\n    } else {\r\n      batch.performBatchOperation(operation);\r\n    }\r\n  };\r\n\r\n  const handleConfirm = () => {\r\n    if (confirmOperation) {\r\n      batch.performBatchOperation(confirmOperation);\r\n      setConfirmOperation(null);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Card className={`relative ${className}`}>\r\n      <ProgressOverlay\r\n        isProcessing={batch.isProcessing}\r\n        progress={batch.progress}\r\n        selectedCount={batch.selectedCount}\r\n      />\r\n\r\n      <CardHeader className={compact ? 'pb-2' : 'pb-3'}>\r\n        <CardTitle className=\"flex items-center gap-2 text-base\">\r\n          <RectangleStackIcon className=\"h-5 w-5\" />\r\n          Massoperationer\r\n        </CardTitle>\r\n        {!compact && (\r\n          <CardDescription>\r\n            V├ñlj artefakter och utf├Âr operationer p├Ñ flera samtidigt\r\n          </CardDescription>\r\n        )}\r\n      </CardHeader>\r\n\r\n      <CardContent className=\"space-y-3\">\r\n        <SelectionHeader batch={batch} totalCount={artifacts.length} />\r\n\r\n        <ScrollArea maxHeight={compact ? '200px' : '300px'}>\r\n          <div className=\"space-y-1 pr-3\">\r\n            {artifacts.map((artifact) => (\r\n              <ArtifactRow\r\n                key={artifact.id}\r\n                artifact={artifact}\r\n                isSelected={batch.isSelected(artifact.id)}\r\n                onToggle={() => batch.toggleSelection(artifact.id)}\r\n              />\r\n            ))}\r\n          </div>\r\n        </ScrollArea>\r\n\r\n        <OperationButtons batch={batch} onOperation={handleOperation} />\r\n\r\n        <ResultSummary result={batch.lastResult} />\r\n      </CardContent>\r\n\r\n      {/* Confirmation Dialog */}\r\n      <AlertDialog\r\n        open={confirmOperation !== null}\r\n        onOpenChange={() => setConfirmOperation(null)}\r\n      >\r\n        <AlertDialogContent>\r\n          <AlertDialogHeader>\r\n            <AlertDialogTitle>Bekr├ñfta operation</AlertDialogTitle>\r\n            <AlertDialogDescription>\r\n              ├är du s├ñker p├Ñ att du vill{' '}\r\n              <strong>{confirmOperation && OPERATION_LABELS[confirmOperation].toLowerCase()}</strong>{' '}\r\n              {batch.selectedCount} artefakt{batch.selectedCount !== 1 ? 'er' : ''}?\r\n              {confirmOperation === 'reset' && (\r\n                <span className=\"block mt-2 text-yellow-600\">\r\n                  Detta ├Ñterst├ñller alla valda pussel till ursprungsl├ñget.\r\n                </span>\r\n              )}\r\n              {confirmOperation === 'solve' && (\r\n                <span className=\"block mt-2 text-yellow-600\">\r\n                  Detta markerar alla valda som l├Âsta utan att spelarna l├Âst dem.\r\n                </span>\r\n              )}\r\n            </AlertDialogDescription>\r\n          </AlertDialogHeader>\r\n          <AlertDialogFooter>\r\n            <AlertDialogCancel>Avbryt</AlertDialogCancel>\r\n            <AlertDialogAction onClick={handleConfirm}>\r\n              Ja, forts├ñtt\r\n            </AlertDialogAction>\r\n          </AlertDialogFooter>\r\n        </AlertDialogContent>\r\n      </AlertDialog>\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\ConversationCardsCollectionArtifact.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":115,"column":64,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":115,"endColumn":83},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":148,"column":137,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":150,"endColumn":13},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":156,"column":14,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":158,"endColumn":13}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useEffect, useMemo, useState } from 'react';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\n\r\ntype ConversationCard = {\r\n  id: string;\r\n  card_title: string | null;\r\n  primary_prompt: string;\r\n  followup_1: string | null;\r\n  followup_2: string | null;\r\n  followup_3: string | null;\r\n  leader_tip: string | null;\r\n};\r\n\r\ntype DeckResponse = {\r\n  collection?: {\r\n    id: string;\r\n    title: string;\r\n    description: string | null;\r\n  };\r\n  cards?: ConversationCard[];\r\n};\r\n\r\nfunction readCollectionId(metadata: Record<string, unknown> | null | undefined): string | null {\r\n  if (!metadata || typeof metadata !== 'object') return null;\r\n  const value = (metadata as Record<string, unknown>).conversation_card_collection_id;\r\n  return typeof value === 'string' && value.trim() ? value.trim() : null;\r\n}\r\n\r\nexport function ConversationCardsCollectionArtifact(props: {\r\n  sessionId: string;\r\n  participantToken?: string | null;\r\n  artifactTitle?: string | null;\r\n  artifactDescription?: string | null;\r\n  metadata?: Record<string, unknown> | null;\r\n}) {\r\n  const { sessionId, participantToken, artifactTitle, artifactDescription, metadata } = props;\r\n\r\n  const collectionId = useMemo(() => readCollectionId(metadata), [metadata]);\r\n\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [cards, setCards] = useState<ConversationCard[]>([]);\r\n  const [deckTitle, setDeckTitle] = useState<string | null>(null);\r\n  const [deckDescription, setDeckDescription] = useState<string | null>(null);\r\n  const [index, setIndex] = useState(0);\r\n\r\n  const current = cards[index] ?? null;\r\n\r\n  useEffect(() => {\r\n    let cancelled = false;\r\n\r\n    async function run() {\r\n      setError(null);\r\n      setCards([]);\r\n      setIndex(0);\r\n      setDeckTitle(null);\r\n      setDeckDescription(null);\r\n\r\n      if (!collectionId) {\r\n        setError('Samtalskort saknar kopplad lek (conversation_card_collection_id).');\r\n        return;\r\n      }\r\n\r\n      setLoading(true);\r\n      try {\r\n        const res = await fetch(`/api/play/sessions/${sessionId}/conversation-cards/collections/${collectionId}`, {\r\n          method: 'GET',\r\n          headers: participantToken ? { 'x-participant-token': participantToken } : undefined,\r\n          cache: 'no-store',\r\n        });\r\n\r\n        const data = (await res.json().catch(() => ({}))) as DeckResponse & { error?: string };\r\n        if (!res.ok) {\r\n          throw new Error(typeof data?.error === 'string' ? data.error : `Kunde inte ladda samtalskort (${res.status})`);\r\n        }\r\n\r\n        if (cancelled) return;\r\n        setDeckTitle(data.collection?.title ?? null);\r\n        setDeckDescription(data.collection?.description ?? null);\r\n        setCards(Array.isArray(data.cards) ? data.cards : []);\r\n      } catch (e) {\r\n        if (cancelled) return;\r\n        setError(e instanceof Error ? e.message : 'Kunde inte ladda samtalskort');\r\n      } finally {\r\n        if (!cancelled) setLoading(false);\r\n      }\r\n    }\r\n\r\n    void run();\r\n    return () => {\r\n      cancelled = true;\r\n    };\r\n  }, [sessionId, participantToken, collectionId]);\r\n\r\n  return (\r\n    <div className=\"rounded-md border border-border p-3 space-y-2\">\r\n      <div className=\"flex items-center justify-between gap-2\">\r\n        <p className=\"text-sm font-medium text-foreground\">{artifactTitle ?? 'Samtalskort'}</p>\r\n        <Badge variant=\"secondary\">Samtalskort</Badge>\r\n      </div>\r\n\r\n      {artifactDescription && <p className=\"text-xs text-muted-foreground\">{artifactDescription}</p>}\r\n\r\n      {(deckTitle || deckDescription) && (\r\n        <Card className=\"p-3 bg-muted/30\">\r\n          {deckTitle && <p className=\"text-sm font-semibold text-foreground\">{deckTitle}</p>}\r\n          {deckDescription && <p className=\"mt-1 text-xs text-muted-foreground\">{deckDescription}</p>}\r\n        </Card>\r\n      )}\r\n\r\n      {loading && <p className=\"text-sm text-muted-foreground\">Laddar samtalskortÔÇª</p>}\r\n      {error && <p className=\"text-sm text-destructive\">{error}</p>}\r\n\r\n      {!loading && !error && cards.length === 0 && (\r\n        <p className=\"text-sm text-muted-foreground\">Inga kort i leken.</p>\r\n      )}\r\n\r\n      {!loading && !error && current && (\r\n        <Card className=\"p-3 space-y-2\">\r\n          <div className=\"flex items-center justify-between gap-2\">\r\n            <p className=\"text-sm font-semibold text-foreground\">{current.card_title ?? 'Kort'}</p>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              {index + 1} / {cards.length}\r\n            </p>\r\n          </div>\r\n\r\n          <p className=\"text-sm text-foreground\">{current.primary_prompt}</p>\r\n\r\n          {(current.followup_1 || current.followup_2 || current.followup_3) && (\r\n            <div className=\"space-y-1\">\r\n              {current.followup_1 && <p className=\"text-xs text-muted-foreground\">ÔÇó {current.followup_1}</p>}\r\n              {current.followup_2 && <p className=\"text-xs text-muted-foreground\">ÔÇó {current.followup_2}</p>}\r\n              {current.followup_3 && <p className=\"text-xs text-muted-foreground\">ÔÇó {current.followup_3}</p>}\r\n            </div>\r\n          )}\r\n\r\n          {current.leader_tip && (\r\n            <div className=\"rounded border border-border bg-muted/30 p-2\">\r\n              <p className=\"text-xs text-muted-foreground\">Ledartips: {current.leader_tip}</p>\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"flex gap-2\">\r\n            <Button type=\"button\" size=\"sm\" variant=\"outline\" onClick={() => setIndex((i) => Math.max(0, i - 1))} disabled={index <= 0}>\r\n              F├Âreg├Ñende\r\n            </Button>\r\n            <Button\r\n              type=\"button\"\r\n              size=\"sm\"\r\n              onClick={() => setIndex((i) => Math.min(cards.length - 1, i + 1))}\r\n              disabled={index >= cards.length - 1}\r\n            >\r\n              N├ñsta\r\n            </Button>\r\n          </div>\r\n        </Card>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\DecisionsPanel.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":146,"column":54,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":146,"endColumn":68},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":156,"column":56,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":156,"endColumn":108},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"Ex: Vad g├Âr ni nu?\". Consider using useTranslations() or t() for internationalization.","line":164,"column":95,"nodeType":"Literal","messageId":"hardcodedString","endLine":164,"endColumn":115},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":186,"column":16,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":188,"endColumn":15},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":226,"column":56,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":228,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":229,"column":56,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":231,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":254,"column":72,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":256,"endColumn":17},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":259,"column":91,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":261,"endColumn":17},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":265,"column":92,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":267,"endColumn":19}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useCallback, useEffect, useMemo, useState } from 'react';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Textarea } from '@/components/ui/textarea';\r\nimport { Badge } from '@/components/ui/badge';\r\n\r\ntype Decision = {\r\n  id: string;\r\n  title: string;\r\n  prompt?: string | null;\r\n  options: Array<{ key: string; label: string }>;\r\n  status: 'draft' | 'open' | 'closed' | 'revealed';\r\n  max_choices?: number;\r\n  allow_anonymous?: boolean;\r\n  revealed_at?: string | null;\r\n};\r\n\r\ntype DecisionResult = { key: string; label: string; count: number };\r\n\r\nexport function DecisionsPanel({ sessionId }: { sessionId: string }) {\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [decisions, setDecisions] = useState<Decision[]>([]);\r\n\r\n  const [newTitle, setNewTitle] = useState('');\r\n  const [newPrompt, setNewPrompt] = useState('');\r\n  const [newOptions, setNewOptions] = useState<Array<{ key: string; label: string }>>([\r\n    { key: 'a', label: '' },\r\n    { key: 'b', label: '' },\r\n  ]);\r\n\r\n  const [resultsByDecisionId, setResultsByDecisionId] = useState<Record<string, DecisionResult[]>>({});\r\n\r\n  const load = useCallback(async () => {\r\n    setLoading(true);\r\n    setError(null);\r\n    try {\r\n      const res = await fetch(`/api/play/sessions/${sessionId}/decisions`, { cache: 'no-store' });\r\n      const data = await res.json();\r\n      if (!res.ok) throw new Error(data.error || 'Kunde inte ladda beslut');\r\n      setDecisions(data.decisions || []);\r\n    } catch (e) {\r\n      setError(e instanceof Error ? e.message : 'Kunde inte ladda beslut');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [sessionId]);\r\n\r\n  useEffect(() => {\r\n    void load();\r\n  }, [load]);\r\n\r\n  const createDecision = useCallback(async () => {\r\n    setError(null);\r\n    const title = newTitle.trim();\r\n    if (!title) {\r\n      setError('Titel kr├ñvs');\r\n      return;\r\n    }\r\n\r\n    const options = newOptions\r\n      .map((o) => ({ key: o.key.trim(), label: o.label.trim() }))\r\n      .filter((o) => o.key && o.label);\r\n\r\n    if (options.length < 2) {\r\n      setError('Minst tv├Ñ alternativ kr├ñvs');\r\n      return;\r\n    }\r\n\r\n    const res = await fetch(`/api/play/sessions/${sessionId}/decisions`, {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        action: 'create',\r\n        title,\r\n        prompt: newPrompt.trim() || null,\r\n        options,\r\n        max_choices: 1,\r\n      }),\r\n    });\r\n    const data = await res.json().catch(() => ({}));\r\n    if (!res.ok) {\r\n      setError(data.error || 'Kunde inte skapa beslut');\r\n      return;\r\n    }\r\n\r\n    setNewTitle('');\r\n    setNewPrompt('');\r\n    setNewOptions([\r\n      { key: 'a', label: '' },\r\n      { key: 'b', label: '' },\r\n    ]);\r\n\r\n    await load();\r\n  }, [sessionId, newTitle, newPrompt, newOptions, load]);\r\n\r\n  const action = useCallback(\r\n    async (decisionId: string, act: 'open' | 'close' | 'reveal') => {\r\n      setError(null);\r\n      const res = await fetch(`/api/play/sessions/${sessionId}/decisions`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ action: act, decisionId }),\r\n      });\r\n      const data = await res.json().catch(() => ({}));\r\n      if (!res.ok) {\r\n        setError(data.error || 'Kunde inte uppdatera beslut');\r\n        return;\r\n      }\r\n      await load();\r\n    },\r\n    [sessionId, load]\r\n  );\r\n\r\n  const loadResults = useCallback(\r\n    async (decisionId: string) => {\r\n      const res = await fetch(`/api/play/sessions/${sessionId}/decisions/${decisionId}/results`, {\r\n        cache: 'no-store',\r\n      });\r\n      const data = await res.json().catch(() => ({}));\r\n      if (!res.ok) return;\r\n      setResultsByDecisionId((prev) => ({ ...prev, [decisionId]: data.results || [] }));\r\n    },\r\n    [sessionId]\r\n  );\r\n\r\n  useEffect(() => {\r\n    // Auto-load results for revealed decisions\r\n    void (async () => {\r\n      for (const d of decisions) {\r\n        if (d.status === 'revealed' && !resultsByDecisionId[d.id]) {\r\n          await loadResults(d.id);\r\n        }\r\n      }\r\n    })();\r\n  }, [decisions, resultsByDecisionId, loadResults]);\r\n\r\n  const optionKeySuggestions = useMemo(() => ['a', 'b', 'c', 'd', 'e'], []);\r\n\r\n  if (loading) {\r\n    return (\r\n      <Card className=\"p-6\">\r\n        <p className=\"text-sm text-muted-foreground\">Laddar beslutÔÇª</p>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <Card className=\"p-6 space-y-4\">\r\n        <div>\r\n          <h2 className=\"text-lg font-semibold\">Beslut</h2>\r\n          <p className=\"text-sm text-muted-foreground\">Skapa ett beslut och ├Âppna r├Âstning (single-choice).</p>\r\n        </div>\r\n\r\n        {error && <p className=\"text-sm text-destructive\">{error}</p>}\r\n\r\n        <div className=\"grid gap-3\">\r\n          <div>\r\n            <label className=\"text-sm font-medium\">Titel</label>\r\n            <Input value={newTitle} onChange={(e) => setNewTitle(e.target.value)} placeholder=\"Ex: Vad g├Âr ni nu?\" />\r\n          </div>\r\n          <div>\r\n            <label className=\"text-sm font-medium\">Prompt</label>\r\n            <Textarea value={newPrompt} onChange={(e) => setNewPrompt(e.target.value)} rows={3} placeholder=\"Valfri kontextÔÇª\" />\r\n          </div>\r\n\r\n          <div className=\"space-y-2\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <label className=\"text-sm font-medium\">Alternativ</label>\r\n              <Button\r\n                size=\"sm\"\r\n                variant=\"outline\"\r\n                onClick={() =>\r\n                  setNewOptions((prev) => [\r\n                    ...prev,\r\n                    {\r\n                      key: optionKeySuggestions[Math.min(prev.length, optionKeySuggestions.length - 1)] ?? String(prev.length + 1),\r\n                      label: '',\r\n                    },\r\n                  ])\r\n                }\r\n              >\r\n                L├ñgg till\r\n              </Button>\r\n            </div>\r\n            {newOptions.map((o, idx) => (\r\n              <div key={idx} className=\"grid grid-cols-5 gap-2\">\r\n                <Input\r\n                  className=\"col-span-1\"\r\n                  value={o.key}\r\n                  onChange={(e) =>\r\n                    setNewOptions((prev) => prev.map((p, i) => (i === idx ? { ...p, key: e.target.value } : p)))\r\n                  }\r\n                  placeholder=\"key\"\r\n                />\r\n                <Input\r\n                  className=\"col-span-4\"\r\n                  value={o.label}\r\n                  onChange={(e) =>\r\n                    setNewOptions((prev) => prev.map((p, i) => (i === idx ? { ...p, label: e.target.value } : p)))\r\n                  }\r\n                  placeholder=\"Label\"\r\n                />\r\n              </div>\r\n            ))}\r\n          </div>\r\n\r\n          <div className=\"flex justify-end\">\r\n            <Button onClick={createDecision}>Skapa beslut</Button>\r\n          </div>\r\n        </div>\r\n      </Card>\r\n\r\n      {decisions.length === 0 ? (\r\n        <Card className=\"p-6 text-center space-y-3\">\r\n          <div className=\"mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-muted\">\r\n            <svg className=\"h-6 w-6 text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z\" />\r\n            </svg>\r\n          </div>\r\n          <h3 className=\"text-base font-semibold text-foreground\">Inga beslut skapade</h3>\r\n          <p className=\"text-sm text-muted-foreground\">\r\n            Skapa ett beslut ovan f├Âr att l├Ñta deltagarna r├Âsta under sessionen.\r\n          </p>\r\n          <p className=\"text-xs text-muted-foreground\">\r\n            Beslut g├Ñr genom: Utkast ÔåÆ ├ûppen r├Âstning ÔåÆ St├ñngd ÔåÆ Resultat visas\r\n          </p>\r\n        </Card>\r\n      ) : (\r\n        decisions.map((d) => (\r\n          <Card key={d.id} className=\"p-6 space-y-3\">\r\n            <div className=\"flex flex-wrap items-center justify-between gap-2\">\r\n              <div>\r\n                <h3 className=\"font-medium\">{d.title}</h3>\r\n                {d.prompt && <p className=\"text-sm text-muted-foreground\">{d.prompt}</p>}\r\n              </div>\r\n              <Badge variant=\"secondary\">{d.status}</Badge>\r\n            </div>\r\n\r\n            <ul className=\"text-sm list-disc list-inside text-muted-foreground\">\r\n              {d.options?.map((o) => (\r\n                <li key={o.key}>\r\n                  <span className=\"font-medium text-foreground\">{o.label}</span> <span className=\"opacity-75\">({o.key})</span>\r\n                </li>\r\n              ))}\r\n            </ul>\r\n\r\n            <div className=\"flex flex-wrap items-center gap-2\">\r\n              {d.status === 'draft' && (\r\n                <Button size=\"sm\" onClick={() => action(d.id, 'open')}>\r\n                  ├ûppna r├Âstning\r\n                </Button>\r\n              )}\r\n              {d.status === 'open' && (\r\n                <Button size=\"sm\" variant=\"outline\" onClick={() => action(d.id, 'close')}>\r\n                  St├ñng\r\n                </Button>\r\n              )}\r\n              {d.status === 'closed' && (\r\n                <>\r\n                  <Button size=\"sm\" variant=\"outline\" onClick={() => action(d.id, 'open')}>\r\n                    ├ûppna igen\r\n                  </Button>\r\n                  <Button size=\"sm\" onClick={() => action(d.id, 'reveal')}>\r\n                    Reveal resultat\r\n                  </Button>\r\n                </>\r\n              )}\r\n              {d.status === 'revealed' && (\r\n                <Button size=\"sm\" variant=\"outline\" onClick={() => loadResults(d.id)}>\r\n                  Uppdatera resultat\r\n                </Button>\r\n              )}\r\n            </div>\r\n\r\n            {d.status === 'revealed' && resultsByDecisionId[d.id] && (\r\n              <div className=\"pt-2 border-t border-border\">\r\n                <p className=\"text-sm font-medium mb-2\">Resultat</p>\r\n                <div className=\"space-y-1\">\r\n                  {resultsByDecisionId[d.id].map((r) => (\r\n                    <div key={r.key} className=\"flex items-center justify-between text-sm\">\r\n                      <span>{r.label}</span>\r\n                      <span className=\"font-mono tabular-nums\">{r.count}</span>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            )}\r\n          </Card>\r\n        ))\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\DirectorModeDrawer.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":125,"column":71,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":127,"endColumn":7},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":495,"column":72,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":497,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":507,"column":71,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":509,"endColumn":7},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":746,"column":62,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":748,"endColumn":23},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":810,"column":65,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":810,"endColumn":78},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":817,"column":68,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":819,"endColumn":25},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":820,"column":61,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":822,"endColumn":25}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * DirectorModeDrawer Component\r\n * \r\n * Overlay drawer for Director Mode during active sessions.\r\n * Slides in from the right, providing focused game control\r\n * while keeping the lobby accessible underneath.\r\n */\r\n\r\n'use client';\r\n\r\nimport { useEffect, useState } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { cn } from '@/lib/utils';\r\nimport {\r\n  ArrowLeftIcon,\r\n  PlayIcon,\r\n  PauseIcon,\r\n  ChevronLeftIcon,\r\n  ChevronRightIcon,\r\n  BoltIcon,\r\n  ClockIcon,\r\n  SignalIcon,\r\n  DocumentTextIcon,\r\n  BookOpenIcon,\r\n} from '@heroicons/react/24/outline';\r\nimport { StopIcon } from '@heroicons/react/24/solid';\r\nimport type { \r\n  CockpitStep, \r\n  CockpitPhase,\r\n  CockpitTrigger,\r\n  SessionEvent,\r\n  Signal,\r\n} from '@/types/session-cockpit';\r\nimport { StoryViewModal } from './StoryViewModal';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface DirectorModeDrawerProps {\r\n  /** Is the drawer open? */\r\n  open: boolean;\r\n  /** Called when user requests to close */\r\n  onClose: () => void;\r\n  \r\n  /** Session display name */\r\n  sessionName: string;\r\n  /** Session code */\r\n  sessionCode: string;\r\n  /** Session status */\r\n  status: 'active' | 'paused' | 'ended';\r\n  \r\n  /** Steps */\r\n  steps: CockpitStep[];\r\n  /** Current step index */\r\n  currentStepIndex: number;\r\n  /** Phases (reserved for future) */\r\n  phases: CockpitPhase[];\r\n  /** Current phase index */\r\n  currentPhaseIndex: number;\r\n  \r\n  /** Triggers */\r\n  triggers: CockpitTrigger[];\r\n  \r\n  /** Recent signals */\n  recentSignals: Signal[];\n\n  /** Optional device signal presets */\n  signalPresets?: Array<{\n    id: string;\n    name: string;\n    type: 'torch' | 'audio' | 'vibration' | 'screen_flash' | 'notification';\n    color?: string;\n    disabled?: boolean;\n    disabledReason?: string;\n  }>;\n  \r\n  /** Recent events */\r\n  events: SessionEvent[];\r\n  \r\n  /** Time bank balance (seconds) */\r\n  timeBankBalance: number;\r\n  /** Time bank paused? */\r\n  timeBankPaused: boolean;\r\n  \r\n  /** Participant count */\r\n  participantCount: number;\r\n  \r\n  // Actions\r\n  onPause: () => Promise<void>;\r\n  onResume: () => Promise<void>;\r\n  onNextStep: () => Promise<void>;\r\n  onPreviousStep: () => Promise<void>;\r\n  onFireTrigger: (triggerId: string) => Promise<void>;\n  onDisableAllTriggers: () => Promise<void>;\n  onSendSignal: (channel: string, payload: unknown) => Promise<void>;\n  onExecuteSignal?: (type: string, config: Record<string, unknown>) => Promise<void>;\n  onTimeBankDelta: (delta: number, reason: string) => Promise<void>;\n  \r\n  /** Optional class name */\r\n  className?: string;\r\n}\r\n\r\ntype DirectorTab = 'play' | 'triggers' | 'signals' | 'events';\r\n\r\n// =============================================================================\r\n// Sub-components\r\n// =============================================================================\r\n\r\nfunction StepNavigation({\r\n  steps,\r\n  currentIndex,\r\n  onNext,\r\n  onPrevious,\r\n}: {\r\n  steps: CockpitStep[];\r\n  currentIndex: number;\r\n  onNext: () => void;\r\n  onPrevious: () => void;\r\n}) {\r\n  if (steps.length === 0) {\r\n    return (\r\n      <div className=\"text-sm text-muted-foreground text-center py-6\">\r\n        Inga steg tillg├ñngliga ├ñnnu\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const currentStep = steps[currentIndex];\r\n  const isFirst = currentIndex <= 0;\r\n  const isLast = currentIndex >= steps.length - 1;\r\n\r\n  return (\r\n    <div className=\"space-y-3\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <Button\r\n          variant=\"outline\"\r\n          size=\"sm\"\r\n          onClick={onPrevious}\r\n          disabled={isFirst}\r\n        >\r\n          <ChevronLeftIcon className=\"h-4 w-4\" />\r\n        </Button>\r\n        \r\n        <div className=\"text-center flex-1 px-4\">\r\n          <div className=\"text-xs text-muted-foreground\">\r\n            Steg {currentIndex + 1} av {steps.length}\r\n          </div>\r\n          <div className=\"font-medium text-foreground truncate\">\r\n            {currentStep?.title ?? 'Ej startat'}\r\n          </div>\r\n        </div>\r\n        \r\n        <Button\r\n          variant=\"outline\"\r\n          size=\"sm\"\r\n          onClick={onNext}\r\n          disabled={isLast}\r\n        >\r\n          <ChevronRightIcon className=\"h-4 w-4\" />\r\n        </Button>\r\n      </div>\r\n      \r\n      {/* Progress bar */}\r\n      <div className=\"h-1.5 bg-muted rounded-full overflow-hidden\">\r\n        <div\r\n          className=\"h-full bg-primary transition-all duration-300\"\r\n          style={{ width: `${((currentIndex + 1) / steps.length) * 100}%` }}\r\n        />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction LeaderScriptPanel({ script }: { script?: string }) {\r\n  if (!script) return null;\r\n  \r\n  return (\r\n    <Card className=\"p-4 bg-amber-50 border-amber-200 dark:bg-amber-950/20 dark:border-amber-800\">\r\n      <div className=\"flex items-start gap-2\">\r\n        <DocumentTextIcon className=\"h-5 w-5 text-amber-600 shrink-0 mt-0.5\" />\r\n        <div>\r\n          <div className=\"text-xs font-medium text-amber-700 dark:text-amber-400 mb-1\">\r\n            LEADER SCRIPT\r\n          </div>\r\n          <div className=\"text-sm text-amber-900 dark:text-amber-100 whitespace-pre-wrap\">\r\n            {script}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </Card>\r\n  );\r\n}\r\n\r\nfunction TriggerPanel({\r\n  triggers,\r\n  onFire,\r\n  onDisableAll,\r\n}: {\r\n  triggers: CockpitTrigger[];\r\n  onFire: (id: string) => void;\r\n  onDisableAll: () => void;\r\n}) {\r\n  const armedTriggers = triggers.filter((t) => t.status === 'armed');\r\n  const firedTriggers = triggers.filter((t) => t.status === 'fired');\r\n  const errorTriggers = triggers.filter((t) => t.status === 'error');\r\n  // Note: disabled triggers reserved for future \"show all\" toggle\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {/* Kill switch */}\r\n      {armedTriggers.length > 0 && (\r\n        <div className=\"flex justify-end\">\r\n          <Button\r\n            variant=\"destructive\"\r\n            size=\"sm\"\r\n            onClick={onDisableAll}\r\n          >\r\n            <StopIcon className=\"h-4 w-4 mr-1\" />\r\n            Inaktivera alla\r\n          </Button>\r\n        </div>\r\n      )}\r\n      \r\n      {/* Armed */}\r\n      {armedTriggers.length > 0 && (\r\n        <div className=\"space-y-2\">\r\n          <div className=\"text-xs font-medium text-muted-foreground\">\r\n            ­ƒƒó ARMED ({armedTriggers.length})\r\n          </div>\r\n          {armedTriggers.map((t) => (\r\n            <div\r\n              key={t.id}\r\n              className=\"flex items-center justify-between p-2 rounded-lg border bg-green-50 border-green-200 dark:bg-green-950/20 dark:border-green-800\"\r\n            >\r\n              <div className=\"min-w-0 flex-1\">\r\n                <div className=\"font-medium text-sm truncate\">{t.name}</div>\r\n                <div className=\"text-xs text-muted-foreground truncate\">\r\n                  {t.conditionSummary} ÔåÆ {t.actionSummary}\r\n                </div>\r\n              </div>\r\n              <Button size=\"sm\" variant=\"outline\" onClick={() => onFire(t.id)}>\r\n                <BoltIcon className=\"h-4 w-4\" />\r\n              </Button>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      )}\r\n      \r\n      {/* Errors */}\r\n      {errorTriggers.length > 0 && (\r\n        <div className=\"space-y-2\">\r\n          <div className=\"text-xs font-medium text-destructive\">\r\n            ÔØî ERROR ({errorTriggers.length})\r\n          </div>\r\n          {errorTriggers.map((t) => (\r\n            <div\r\n              key={t.id}\r\n              className=\"p-2 rounded-lg border bg-destructive/10 border-destructive/30\"\r\n            >\r\n              <div className=\"font-medium text-sm\">{t.name}</div>\r\n              <div className=\"text-xs text-destructive\">{t.lastError}</div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      )}\r\n      \r\n      {/* Fired */}\r\n      {firedTriggers.length > 0 && (\r\n        <div className=\"space-y-2\">\r\n          <div className=\"text-xs font-medium text-muted-foreground\">\r\n            Ô£à FIRED ({firedTriggers.length})\r\n          </div>\r\n          {firedTriggers.slice(0, 5).map((t) => (\r\n            <div\r\n              key={t.id}\r\n              className=\"p-2 rounded-lg border bg-muted/50\"\r\n            >\r\n              <div className=\"font-medium text-sm text-muted-foreground\">{t.name}</div>\r\n              <div className=\"text-xs text-muted-foreground\">\r\n                {t.lastFiredAt ? new Date(t.lastFiredAt).toLocaleTimeString() : 'ÔÇô'}\r\n              </div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      )}\r\n      \r\n      {triggers.length === 0 && (\r\n        <div className=\"text-sm text-muted-foreground text-center py-8\">\r\n          Inga triggers i denna session\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction SignalQuickPanel({\r\n  recentSignals,\r\n  presets = [],\r\n  onSend,\r\n  onExecuteSignal,\r\n}: {\r\n  recentSignals: Signal[];\r\n  presets?: Array<{\n    id: string;\n    name: string;\n    type: 'torch' | 'audio' | 'vibration' | 'screen_flash' | 'notification';\n    color?: string;\n    disabled?: boolean;\n    disabledReason?: string;\n  }>;\n  onSend: (channel: string, payload: unknown) => void;\r\n  onExecuteSignal?: (type: string, config: Record<string, unknown>) => Promise<void>;\r\n}) {\r\n  const [channel, setChannel] = useState('');\r\n  const [message, setMessage] = useState('');\r\n  const [executingSignal, setExecutingSignal] = useState<string | null>(null);\r\n  const [showCustom, setShowCustom] = useState(false);\r\n\r\n  const handleSend = () => {\r\n    if (!channel.trim() || !message.trim()) return;\r\n    onSend(channel.trim(), { message: message.trim() });\r\n    setMessage('');\r\n  };\r\n\r\n  const handleExecutePreset = async (preset: { id: string; type: string; color?: string; disabled?: boolean }) => {\n    if (!onExecuteSignal || preset.disabled) return;\n    \r\n    setExecutingSignal(preset.id);\r\n    try {\r\n      await onExecuteSignal(preset.type, { color: preset.color });\r\n    } finally {\r\n      setExecutingSignal(null);\r\n    }\r\n  };\r\n\r\n  // Quick presets - built-in\r\n  const builtInPresets = [\r\n    { id: 'pause', channel: 'pause', label: 'ÔÅ© Paus', message: 'Paus!', icon: 'ÔÅ©' },\r\n    { id: 'hint', channel: 'hint', label: '­ƒÆí Hint', message: 'Ledtr├Ñd tillg├ñnglig', icon: '­ƒÆí' },\r\n    { id: 'attention', channel: 'attention', label: 'ÔÜí Uppm├ñrksamhet', message: 'Titta hit!', icon: 'ÔÜí' },\r\n    { id: 'flash', channel: 'flash', label: '­ƒÆÑ Blinka', message: 'Flash!', icon: '­ƒÆÑ' },\r\n  ];\r\n\r\n  // Signal type icons\r\n  const getSignalTypeIcon = (type: string) => {\r\n    switch (type) {\r\n      case 'torch': return '­ƒöª';\r\n      case 'audio': return '­ƒöè';\r\n      case 'vibration': return '­ƒô│';\r\n      case 'screen_flash': return '­ƒÆí';\r\n      case 'notification': return '­ƒöö';\r\n      default: return '­ƒôí';\r\n    }\r\n  };\n\n  const notificationPreset = presets.find((preset) => preset.type === 'notification');\n  const notificationStatus = notificationPreset?.disabled ? notificationPreset.disabledReason : null;\n\n  return (\n    <div className=\"space-y-4\">\r\n      {/* Device signal presets */}\r\n      {presets.length > 0 && (\r\n        <div className=\"space-y-2\">\r\n          <div className=\"text-xs font-medium text-muted-foreground uppercase tracking-wider\">\r\n            Enhetssignaler\r\n          </div>\r\n          <div className=\"flex flex-wrap gap-2\">\r\n            {presets.map((p) => (\n              <Button\n                key={p.id}\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => handleExecutePreset(p)}\n                disabled={executingSignal === p.id || p.disabled}\n                className=\"gap-1\"\n                title={p.disabled && p.disabledReason ? p.disabledReason : undefined}\n                style={p.type === 'screen_flash' && p.color ? {\n                  borderColor: p.color,\n                  color: p.color,\n                } : undefined}\n              >\r\n                <span>{getSignalTypeIcon(p.type)}</span>\r\n                <span>{p.name}</span>\r\n                {executingSignal === p.id && (\r\n                  <span className=\"animate-pulse\">ÔùÅ</span>\r\n                )}\n              </Button>\n            ))}\n          </div>\n          {notificationStatus && (\n            <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\n              <span>Notifications: {notificationStatus}</span>\n              {onExecuteSignal && (\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => void onExecuteSignal('notification', {\n                    forceToast: true,\n                    title: 'Notification',\n                    body: 'In-app toast',\n                  })}\n                >\n                  Show in-app toast\n                </Button>\n              )}\n            </div>\n          )}\n        </div>\n      )}\n      \r\n      {/* Message presets */}\r\n      <div className=\"space-y-2\">\r\n        <div className=\"text-xs font-medium text-muted-foreground uppercase tracking-wider\">\r\n          Snabbmeddelanden\r\n        </div>\r\n        <div className=\"flex flex-wrap gap-2\">\r\n          {builtInPresets.map((p) => (\r\n            <Button\r\n              key={p.id}\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              onClick={() => onSend(p.channel, { message: p.message })}\r\n            >\r\n              {p.label}\r\n            </Button>\r\n          ))}\r\n        </div>\r\n      </div>\r\n      \r\n      {/* Custom signal toggle */}\r\n      <div className=\"border-t pt-3\">\r\n        <Button\r\n          variant=\"ghost\"\r\n          size=\"sm\"\r\n          onClick={() => setShowCustom(!showCustom)}\r\n          className=\"w-full justify-between\"\r\n        >\r\n          <span>Anpassad signal</span>\r\n          <span className=\"text-muted-foreground\">{showCustom ? 'ÔêÆ' : '+'}</span>\r\n        </Button>\r\n        \r\n        {showCustom && (\r\n          <div className=\"mt-2 space-y-2\">\r\n            <input\r\n              type=\"text\"\r\n              placeholder=\"Kanal (t.ex. 'team-red')\"\r\n              value={channel}\r\n              onChange={(e) => setChannel(e.target.value)}\r\n              className=\"w-full px-3 py-2 text-sm border rounded-lg bg-background\"\r\n            />\r\n            <div className=\"flex gap-2\">\r\n              <input\r\n                type=\"text\"\r\n                placeholder=\"Meddelande\"\r\n                value={message}\r\n                onChange={(e) => setMessage(e.target.value)}\r\n                className=\"flex-1 px-3 py-2 text-sm border rounded-lg bg-background\"\r\n                onKeyDown={(e) => e.key === 'Enter' && handleSend()}\r\n              />\r\n              <Button size=\"sm\" onClick={handleSend} disabled={!channel || !message}>\r\n                Skicka\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n      \r\n      {/* Recent signals */}\r\n      {recentSignals.length > 0 && (\r\n        <div className=\"space-y-2\">\r\n          <div className=\"text-xs font-medium text-muted-foreground uppercase tracking-wider\">\r\n            Senaste signaler\r\n          </div>\r\n          <div className=\"space-y-1 max-h-[120px] overflow-y-auto\">\r\n            {recentSignals.slice(0, 8).map((s) => (\r\n              <div \r\n                key={s.id} \r\n                className=\"text-xs text-muted-foreground flex items-center justify-between p-2 rounded bg-muted/30 hover:bg-muted/50 cursor-pointer\"\r\n                onClick={() => onSend(s.channel, s.payload)}\r\n              >\r\n                <span className=\"font-mono truncate max-w-[120px]\">{s.channel}</span>\r\n                <span className=\"text-[10px] opacity-70\">\r\n                  {new Date(s.createdAt).toLocaleTimeString('sv-SE', { \r\n                    hour: '2-digit', \r\n                    minute: '2-digit',\r\n                    second: '2-digit'\r\n                  })}\r\n                </span>\r\n              </div>\r\n            ))}\r\n          </div>\r\n          <p className=\"text-[10px] text-muted-foreground text-center\">\r\n            Klicka f├Âr att skicka igen\r\n          </p>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction EventFeed({ events }: { events: SessionEvent[] }) {\r\n  if (events.length === 0) {\r\n    return (\r\n      <div className=\"text-sm text-muted-foreground text-center py-8\">\r\n        Inga h├ñndelser ├ñnnu\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const getEventIcon = (type: string) => {\r\n    if (type.includes('trigger')) return 'ÔÜí';\r\n    if (type.includes('artifact')) return '­ƒôª';\r\n    if (type.includes('signal')) return '­ƒôí';\r\n    if (type.includes('step')) return '­ƒôì';\r\n    if (type.includes('error')) return 'ÔØî';\r\n    return 'ÔÇó';\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-1 max-h-[300px] overflow-y-auto\">\r\n      {events.slice(0, 20).map((e) => (\r\n        <div\r\n          key={e.id}\r\n          className={cn(\r\n            'flex items-start gap-2 text-xs p-2 rounded',\r\n            e.type.includes('error') && 'bg-destructive/10'\r\n          )}\r\n        >\r\n          <span className=\"shrink-0\">{getEventIcon(e.type)}</span>\r\n          <div className=\"min-w-0 flex-1\">\r\n            <div className=\"font-medium truncate\">{e.type}</div>\r\n            {e.payload && Object.keys(e.payload).length > 0 && (\r\n              <div className=\"text-muted-foreground truncate\">\r\n                {JSON.stringify(e.payload).slice(0, 50)}\r\n              </div>\r\n            )}\r\n          </div>\r\n          <span className=\"text-muted-foreground shrink-0\">\r\n            {new Date(e.timestamp).toLocaleTimeString()}\r\n          </span>\r\n        </div>\r\n      ))}\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction TimeBankQuickPanel({\r\n  balance,\r\n  paused,\r\n  onDelta,\r\n}: {\r\n  balance: number;\r\n  paused: boolean;\r\n  onDelta: (delta: number, reason: string) => void;\r\n}) {\r\n  const minutes = Math.floor(balance / 60);\r\n  const seconds = balance % 60;\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <div className=\"text-center\">\r\n        <div className=\"text-4xl font-mono font-bold text-primary\">\r\n          {String(minutes).padStart(2, '0')}:{String(seconds).padStart(2, '0')}\r\n        </div>\r\n        {paused && (\r\n          <Badge variant=\"warning\" size=\"sm\" className=\"mt-1\">\r\n            PAUSAD\r\n          </Badge>\r\n        )}\r\n      </div>\r\n      \r\n      <div className=\"flex justify-center gap-2\">\r\n        <Button\r\n          variant=\"outline\"\r\n          size=\"sm\"\r\n          onClick={() => onDelta(-60, 'Manuell justering')}\r\n        >\r\n          ÔêÆ1 min\r\n        </Button>\r\n        <Button\r\n          variant=\"outline\"\r\n          size=\"sm\"\r\n          onClick={() => onDelta(-30, 'Manuell justering')}\r\n        >\r\n          ÔêÆ30s\r\n        </Button>\r\n        <Button\r\n          variant=\"outline\"\r\n          size=\"sm\"\r\n          onClick={() => onDelta(30, 'Manuell justering')}\r\n        >\r\n          +30s\r\n        </Button>\r\n        <Button\r\n          variant=\"outline\"\r\n          size=\"sm\"\r\n          onClick={() => onDelta(60, 'Manuell justering')}\r\n        >\r\n          +1 min\r\n        </Button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function DirectorModeDrawer({\r\n  open,\r\n  onClose,\r\n  sessionName,\r\n  sessionCode,\r\n  status,\r\n  steps,\r\n  currentStepIndex,\r\n  phases: _phases, // Reserved for phase navigation\r\n  currentPhaseIndex: _currentPhaseIndex, // Reserved for phase navigation\n  triggers,\n  recentSignals,\n  signalPresets,\n  events,\n  timeBankBalance,\n  timeBankPaused,\n  participantCount,\n  onPause,\n  onResume,\r\n  onNextStep,\r\n  onPreviousStep,\n  onFireTrigger,\n  onDisableAllTriggers,\n  onSendSignal,\n  onExecuteSignal,\n  onTimeBankDelta,\n  className,\n}: DirectorModeDrawerProps) {\n  const [activeTab, setActiveTab] = useState<DirectorTab>('play');\r\n  const [actionPending, setActionPending] = useState(false);\r\n  const [showStoryView, setShowStoryView] = useState(false);\r\n\r\n  const currentStep = steps[currentStepIndex];\r\n\r\n  // Lock body scroll when open\r\n  useEffect(() => {\r\n    if (!open) return;\r\n    const prev = document.body.style.overflow;\r\n    document.body.style.overflow = 'hidden';\r\n    return () => {\r\n      document.body.style.overflow = prev;\r\n    };\r\n  }, [open]);\r\n\r\n  // Handle escape key\r\n  useEffect(() => {\r\n    if (!open) return;\r\n    const handler = (e: KeyboardEvent) => {\r\n      if (e.key === 'Escape') {\r\n        e.preventDefault();\r\n        onClose();\r\n      }\r\n    };\r\n    window.addEventListener('keydown', handler);\r\n    return () => window.removeEventListener('keydown', handler);\r\n  }, [open, onClose]);\r\n\r\n  const handlePauseResume = async () => {\r\n    setActionPending(true);\r\n    try {\r\n      if (status === 'active') {\r\n        await onPause();\r\n      } else {\r\n        await onResume();\r\n      }\r\n    } finally {\r\n      setActionPending(false);\r\n    }\r\n  };\r\n\r\n  const tabs = [\r\n    { id: 'play' as const, label: 'Spela', icon: PlayIcon },\r\n    { id: 'triggers' as const, label: 'Triggers', icon: BoltIcon, badge: triggers.filter((t) => t.status === 'armed').length },\r\n    { id: 'signals' as const, label: 'Signals', icon: SignalIcon },\r\n    { id: 'events' as const, label: 'H├ñndelser', icon: ClockIcon, badge: events.length },\r\n  ];\r\n\r\n  return (\r\n    <>\r\n      {/* Backdrop */}\r\n      <div\r\n        className={cn(\r\n          'fixed inset-0 bg-black/50 z-50 transition-opacity duration-300',\r\n          open ? 'opacity-100' : 'opacity-0 pointer-events-none'\r\n        )}\r\n        onClick={onClose}\r\n      />\r\n      \r\n      {/* Drawer */}\r\n      <div\r\n        className={cn(\r\n          'fixed top-0 right-0 bottom-0 w-full max-w-lg bg-background border-l shadow-xl z-50 flex flex-col transition-transform duration-300 ease-out',\r\n          open ? 'translate-x-0' : 'translate-x-full',\r\n          className\r\n        )}\r\n      >\r\n            {/* Header */}\r\n            <div className=\"flex items-center justify-between p-4 border-b bg-muted/30\">\r\n              <div className=\"flex items-center gap-3\">\r\n                <Button variant=\"ghost\" size=\"sm\" onClick={onClose}>\r\n                  <ArrowLeftIcon className=\"h-4 w-4\" />\r\n                </Button>\r\n                <div>\r\n                  <div className=\"font-semibold text-foreground\">{sessionName}</div>\r\n                  <div className=\"text-xs text-muted-foreground\">\r\n                    <span className=\"font-mono\">{sessionCode}</span>\r\n                    <span className=\"mx-2\">ÔÇó</span>\r\n                    <span>{participantCount} deltagare</span>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n              \r\n              <div className=\"flex items-center gap-2\">\r\n                <Badge\r\n                  variant={status === 'active' ? 'success' : status === 'paused' ? 'warning' : 'default'}\r\n                >\r\n                  {status === 'active' ? 'ÔùÅ LIVE' : status === 'paused' ? 'ÔÅ© PAUSAD' : 'AVSLUTAD'}\r\n                </Badge>\r\n                \r\n                {status !== 'ended' && (\r\n                  <Button\r\n                    variant={status === 'active' ? 'outline' : 'default'}\r\n                    size=\"sm\"\r\n                    onClick={handlePauseResume}\r\n                    disabled={actionPending}\r\n                  >\r\n                    {status === 'active' ? (\r\n                      <>\r\n                        <PauseIcon className=\"h-4 w-4 mr-1\" />\r\n                        Pausa\r\n                      </>\r\n                    ) : (\r\n                      <>\r\n                        <PlayIcon className=\"h-4 w-4 mr-1\" />\r\n                        Forts├ñtt\r\n                      </>\r\n                    )}\r\n                  </Button>\r\n                )}\r\n              </div>\r\n            </div>\r\n            \r\n            {/* Tabs */}\r\n            <div className=\"flex border-b\">\r\n              {tabs.map((tab) => (\r\n                <button\r\n                  key={tab.id}\r\n                  onClick={() => setActiveTab(tab.id)}\r\n                  className={cn(\r\n                    'flex-1 flex items-center justify-center gap-1.5 py-3 text-sm font-medium transition-colors',\r\n                    activeTab === tab.id\r\n                      ? 'text-primary border-b-2 border-primary'\r\n                      : 'text-muted-foreground hover:text-foreground'\r\n                  )}\r\n                >\r\n                  <tab.icon className=\"h-4 w-4\" />\r\n                  {tab.label}\r\n                  {tab.badge !== undefined && tab.badge > 0 && (\r\n                    <Badge variant=\"default\" size=\"sm\">\r\n                      {tab.badge}\r\n                    </Badge>\r\n                  )}\r\n                </button>\r\n              ))}\r\n            </div>\r\n            \r\n            {/* Content */}\r\n            <div className=\"flex-1 overflow-y-auto p-4\">\r\n              {activeTab === 'play' && (\r\n                <div className=\"space-y-6\">\r\n                  {/* Step Navigation */}\r\n                  <StepNavigation\r\n                    steps={steps}\r\n                    currentIndex={currentStepIndex}\r\n                    onNext={onNextStep}\r\n                    onPrevious={onPreviousStep}\r\n                  />\r\n                  \r\n                  {/* Leader Script */}\r\n                  <LeaderScriptPanel script={currentStep?.leaderScript} />\r\n                  \r\n                  {/* Time Bank */}\r\n                  <Card className=\"p-4\">\r\n                    <div className=\"flex items-center gap-2 mb-3\">\r\n                      <ClockIcon className=\"h-5 w-5 text-primary\" />\r\n                      <span className=\"font-medium\">Tidsbank</span>\r\n                    </div>\r\n                    <TimeBankQuickPanel\r\n                      balance={timeBankBalance}\r\n                      paused={timeBankPaused}\r\n                      onDelta={onTimeBankDelta}\r\n                    />\r\n                  </Card>\r\n                  \r\n                  {/* Quick Actions */}\r\n                  {currentStep && (\r\n                    <Card className=\"p-4\">\r\n                      <div className=\"text-sm font-medium mb-3\">Snabb├Ñtg├ñrder</div>\r\n                      <div className=\"flex flex-wrap gap-2\">\r\n                        <Button \r\n                          variant=\"outline\" \r\n                          size=\"sm\"\r\n                          onClick={() => setShowStoryView(true)}\r\n                        >\r\n                          <BookOpenIcon className=\"h-4 w-4 mr-1\" />\r\n                          Ber├ñttelse\r\n                        </Button>\r\n                        <Button variant=\"outline\" size=\"sm\">\r\n                          ­ƒÆí Ge ledtr├Ñd\r\n                        </Button>\r\n                        <Button variant=\"outline\" size=\"sm\">\r\n                          ­ƒöä Reset\r\n                        </Button>\r\n                        <Button variant=\"outline\" size=\"sm\">\r\n                          ­ƒôú Meddelande\r\n                        </Button>\r\n                      </div>\r\n                    </Card>\r\n                  )}\r\n                </div>\r\n              )}\r\n              \r\n              {activeTab === 'triggers' && (\r\n                <TriggerPanel\r\n                  triggers={triggers}\r\n                  onFire={onFireTrigger}\r\n                  onDisableAll={onDisableAllTriggers}\r\n                />\r\n              )}\r\n              \r\n              {activeTab === 'signals' && (\n                <SignalQuickPanel\n                  recentSignals={recentSignals}\n                  presets={signalPresets}\n                  onSend={onSendSignal}\n                  onExecuteSignal={onExecuteSignal}\n                />\n              )}\n              \r\n              {activeTab === 'events' && (\r\n                <EventFeed events={events} />\r\n              )}\r\n            </div>\r\n            \r\n            {/* Footer */}\r\n            <div className=\"p-4 border-t bg-muted/30\">\r\n              <Button\r\n                variant=\"outline\"\r\n                className=\"w-full\"\r\n                onClick={onClose}\r\n              >\r\n                <ArrowLeftIcon className=\"h-4 w-4 mr-2\" />\r\n                Tillbaka till Lobby\r\n              </Button>\r\n            </div>\r\n          </div>\r\n          \r\n          {/* Story View Modal */}\r\n          <StoryViewModal\r\n            open={showStoryView}\r\n            onClose={() => setShowStoryView(false)}\r\n            steps={steps}\r\n            currentStepIndex={currentStepIndex}\r\n            title={sessionName}\r\n          />\r\n    </>\r\n  );\r\n}\r\n\r\nexport default DirectorModeDrawer;\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\EventFeedPanel.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":404,"column":51,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":406,"endColumn":15},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":411,"column":30,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":412,"endColumn":15},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"S├Âk i h├ñndelser...\". Consider using useTranslations() or t() for internationalization.","line":458,"column":31,"nodeType":"Literal","messageId":"hardcodedString","endLine":458,"endColumn":51}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * EventFeedPanel Component\r\n * \r\n * Real-time event feed showing all session events with filtering,\r\n * grouping, and correlation tracking.\r\n * \r\n * Epic 6: Event System & Observability - Task 6.3\r\n */\r\n\r\n'use client';\r\n\r\nimport React, { useState, useMemo } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from '@/components/ui/card';\r\nimport { Select } from '@/components/ui/select';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { ScrollArea } from '@/components/ui/scroll-area';\r\nimport {\r\n  Collapsible,\r\n  CollapsibleContent,\r\n  CollapsibleTrigger,\r\n} from '@/components/ui/collapsible';\r\nimport { Switch } from '@/components/ui/switch';\r\nimport {\r\n  ChartBarIcon,\r\n  ChevronDownIcon,\r\n  ChevronRightIcon,\r\n  FunnelIcon,\r\n  ArrowPathIcon,\r\n  BoltIcon,\r\n  PuzzlePieceIcon,\r\n  RadioIcon,\r\n  ClockIcon,\r\n  MapIcon,\r\n  UserIcon,\r\n  StarIcon,\r\n  PlayCircleIcon,\r\n  ExclamationTriangleIcon,\r\n  ExclamationCircleIcon,\r\n  InformationCircleIcon,\r\n  BugAntIcon,\r\n  MagnifyingGlassIcon,\r\n  XMarkIcon,\r\n} from '@heroicons/react/24/outline';\r\nimport type {\r\n  SessionEvent,\r\n  EventCategory,\r\n  EventSeverity,\r\n  EventStats,\r\n} from '@/types/session-event';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface EventFeedPanelProps {\r\n  /** Events to display */\r\n  events: SessionEvent[];\r\n  /** Event statistics */\r\n  stats?: EventStats[];\r\n  /** Loading state */\r\n  isLoading?: boolean;\r\n  /** Error message */\r\n  error?: Error | null;\r\n  /** Callback to refresh events */\r\n  onRefresh?: () => void;\r\n  /** Callback to clear events */\r\n  onClear?: () => void;\r\n  /** Maximum height for scroll area */\r\n  maxHeight?: string;\r\n  /** Compact mode */\r\n  compact?: boolean;\r\n  /** Optional className */\r\n  className?: string;\r\n}\r\n\r\n// =============================================================================\r\n// Constants\r\n// =============================================================================\r\n\r\nconst CATEGORY_ICONS: Record<EventCategory, React.ReactNode> = {\r\n  trigger: <BoltIcon className=\"h-3.5 w-3.5\" />,\r\n  artifact: <PuzzlePieceIcon className=\"h-3.5 w-3.5\" />,\r\n  lifecycle: <PlayCircleIcon className=\"h-3.5 w-3.5\" />,\r\n  signal: <RadioIcon className=\"h-3.5 w-3.5\" />,\r\n  timebank: <ClockIcon className=\"h-3.5 w-3.5\" />,\r\n  navigation: <MapIcon className=\"h-3.5 w-3.5\" />,\r\n  participant: <UserIcon className=\"h-3.5 w-3.5\" />,\r\n  host: <StarIcon className=\"h-3.5 w-3.5\" />,\r\n};\r\n\r\nconst CATEGORY_COLORS: Record<EventCategory, string> = {\r\n  trigger: 'bg-yellow-500/10 text-yellow-600 border-yellow-500/20',\r\n  artifact: 'bg-purple-500/10 text-purple-600 border-purple-500/20',\r\n  lifecycle: 'bg-blue-500/10 text-blue-600 border-blue-500/20',\r\n  signal: 'bg-green-500/10 text-green-600 border-green-500/20',\r\n  timebank: 'bg-orange-500/10 text-orange-600 border-orange-500/20',\r\n  navigation: 'bg-cyan-500/10 text-cyan-600 border-cyan-500/20',\r\n  participant: 'bg-pink-500/10 text-pink-600 border-pink-500/20',\r\n  host: 'bg-indigo-500/10 text-indigo-600 border-indigo-500/20',\r\n};\r\n\r\nconst SEVERITY_ICONS: Record<EventSeverity, React.ReactNode> = {\r\n  debug: <BugAntIcon className=\"h-3 w-3 text-muted-foreground\" />,\r\n  info: <InformationCircleIcon className=\"h-3 w-3 text-blue-500\" />,\r\n  warning: <ExclamationTriangleIcon className=\"h-3 w-3 text-yellow-500\" />,\r\n  error: <ExclamationCircleIcon className=\"h-3 w-3 text-red-500\" />,\r\n};\r\n\r\nconst CATEGORY_LABELS: Record<EventCategory, string> = {\r\n  trigger: 'Trigger',\r\n  artifact: 'Artefakt',\r\n  lifecycle: 'Session',\r\n  signal: 'Signal',\r\n  timebank: 'Tidsbank',\r\n  navigation: 'Navigation',\r\n  participant: 'Deltagare',\r\n  host: 'Ledare',\r\n};\r\n\r\n// =============================================================================\r\n// Helper: Format event type for display\r\n// =============================================================================\r\n\r\nfunction formatEventType(eventType: string): string {\r\n  return eventType\r\n    .replace(/_/g, ' ')\r\n    .replace(/\\b\\w/g, (c) => c.toUpperCase());\r\n}\r\n\r\n// =============================================================================\r\n// Helper: Format time for display\r\n// =============================================================================\r\n\r\nfunction formatTime(date: Date): string {\r\n  return date.toLocaleTimeString('sv-SE', {\r\n    hour: '2-digit',\r\n    minute: '2-digit',\r\n    second: '2-digit',\r\n  });\r\n}\r\n\r\n// =============================================================================\r\n// Helper: Group events by time\r\n// =============================================================================\r\n\r\ninterface EventGroup {\r\n  label: string;\r\n  events: SessionEvent[];\r\n}\r\n\r\nfunction groupEventsByTime(events: SessionEvent[]): EventGroup[] {\r\n  const now = new Date();\r\n  const groups: EventGroup[] = [];\r\n  \r\n  const thisMinute: SessionEvent[] = [];\r\n  const last5Min: SessionEvent[] = [];\r\n  const last15Min: SessionEvent[] = [];\r\n  const older: SessionEvent[] = [];\r\n  \r\n  for (const event of events) {\r\n    const diffMs = now.getTime() - event.createdAt.getTime();\r\n    const diffMin = diffMs / 60000;\r\n    \r\n    if (diffMin < 1) {\r\n      thisMinute.push(event);\r\n    } else if (diffMin < 5) {\r\n      last5Min.push(event);\r\n    } else if (diffMin < 15) {\r\n      last15Min.push(event);\r\n    } else {\r\n      older.push(event);\r\n    }\r\n  }\r\n  \r\n  if (thisMinute.length > 0) {\r\n    groups.push({ label: 'Senaste minuten', events: thisMinute });\r\n  }\r\n  if (last5Min.length > 0) {\r\n    groups.push({ label: 'Senaste 5 minuterna', events: last5Min });\r\n  }\r\n  if (last15Min.length > 0) {\r\n    groups.push({ label: 'Senaste 15 minuterna', events: last15Min });\r\n  }\r\n  if (older.length > 0) {\r\n    groups.push({ label: 'Tidigare', events: older });\r\n  }\r\n  \r\n  return groups;\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: EventRow\r\n// =============================================================================\r\n\r\ninterface EventRowProps {\r\n  event: SessionEvent;\r\n  compact?: boolean;\r\n}\r\n\r\nfunction EventRow({ event, compact }: EventRowProps) {\r\n  const [isExpanded, setIsExpanded] = useState(false);\r\n  const hasPayload = Object.keys(event.payload).length > 0;\r\n  \r\n  return (\r\n    <div\r\n      className={`\r\n        border-l-2 pl-3 py-2\r\n        ${event.severity === 'error' ? 'border-l-red-500 bg-red-500/5' : ''}\r\n        ${event.severity === 'warning' ? 'border-l-yellow-500 bg-yellow-500/5' : ''}\r\n        ${event.severity === 'info' ? 'border-l-transparent' : ''}\r\n        ${event.severity === 'debug' ? 'border-l-muted opacity-60' : ''}\r\n      `}\r\n    >\r\n      <div className=\"flex items-start gap-2\">\r\n        {/* Severity icon */}\r\n        <div className=\"mt-0.5\">\r\n          {SEVERITY_ICONS[event.severity]}\r\n        </div>\r\n        \r\n        {/* Main content */}\r\n        <div className=\"flex-1 min-w-0\">\r\n          <div className=\"flex items-center gap-2 flex-wrap\">\r\n            {/* Category badge */}\r\n            <span\r\n              className={`\r\n                inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium\r\n                ${CATEGORY_COLORS[event.eventCategory]}\r\n              `}\r\n            >\r\n              {CATEGORY_ICONS[event.eventCategory]}\r\n              {!compact && CATEGORY_LABELS[event.eventCategory]}\r\n            </span>\r\n            \r\n            {/* Event type */}\r\n            <span className=\"text-sm font-medium truncate\">\r\n              {formatEventType(event.eventType)}\r\n            </span>\r\n            \r\n            {/* Target name */}\r\n            {event.targetName && (\r\n              <span className=\"text-sm text-muted-foreground truncate\">\r\n                ÔåÆ {event.targetName}\r\n              </span>\r\n            )}\r\n          </div>\r\n          \r\n          {/* Actor and time */}\r\n          <div className=\"flex items-center gap-2 mt-0.5 text-xs text-muted-foreground\">\r\n            {event.actorName && (\r\n              <span>{event.actorName}</span>\r\n            )}\r\n            {event.actorName && <span>ÔÇó</span>}\r\n            <span title={event.createdAt.toLocaleString('sv-SE')}>\r\n              {formatTime(event.createdAt)}\r\n            </span>\r\n            {event.correlationId && (\r\n              <>\r\n                <span>ÔÇó</span>\r\n                <span className=\"font-mono text-xs opacity-50\">\r\n                  {event.correlationId.slice(0, 8)}\r\n                </span>\r\n              </>\r\n            )}\r\n          </div>\r\n          \r\n          {/* Expandable payload */}\r\n          {hasPayload && !compact && (\r\n            <Collapsible open={isExpanded} onOpenChange={setIsExpanded}>\r\n              <CollapsibleTrigger asChild>\r\n                <button className=\"flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground mt-1\">\r\n                  {isExpanded ? (\r\n                    <ChevronDownIcon className=\"h-3 w-3\" />\r\n                  ) : (\r\n                    <ChevronRightIcon className=\"h-3 w-3\" />\r\n                  )}\r\n                  Detaljer\r\n                </button>\r\n              </CollapsibleTrigger>\r\n              <CollapsibleContent>\r\n                <pre className=\"text-xs bg-muted/50 p-2 rounded mt-1 overflow-x-auto\">\r\n                  {JSON.stringify(event.payload, null, 2)}\r\n                </pre>\r\n              </CollapsibleContent>\r\n            </Collapsible>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: EventGroupSection\r\n// =============================================================================\r\n\r\ninterface EventGroupSectionProps {\r\n  group: EventGroup;\r\n  compact?: boolean;\r\n}\r\n\r\nfunction EventGroupSection({ group, compact }: EventGroupSectionProps) {\r\n  const [isOpen, setIsOpen] = useState(true);\r\n  \r\n  return (\r\n    <Collapsible open={isOpen} onOpenChange={setIsOpen}>\r\n      <CollapsibleTrigger asChild>\r\n        <button className=\"flex items-center gap-2 w-full py-2 px-2 hover:bg-muted/50 rounded transition-colors\">\r\n          {isOpen ? (\r\n            <ChevronDownIcon className=\"h-4 w-4\" />\r\n          ) : (\r\n            <ChevronRightIcon className=\"h-4 w-4\" />\r\n          )}\r\n          <span className=\"text-sm font-medium\">{group.label}</span>\r\n          <Badge variant=\"default\" className=\"ml-auto\">\r\n            {group.events.length}\r\n          </Badge>\r\n        </button>\r\n      </CollapsibleTrigger>\r\n      <CollapsibleContent>\r\n        <div className=\"space-y-1 ml-2\">\r\n          {group.events.map((event) => (\r\n            <EventRow key={event.id} event={event} compact={compact} />\r\n          ))}\r\n        </div>\r\n      </CollapsibleContent>\r\n    </Collapsible>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function EventFeedPanel({\r\n  events,\r\n  stats = [],\r\n  isLoading = false,\r\n  error = null,\r\n  onRefresh,\r\n  onClear,\r\n  maxHeight = '500px',\r\n  compact = false,\r\n  className,\r\n}: EventFeedPanelProps) {\r\n  // Filters\r\n  const [categoryFilter, setCategoryFilter] = useState<EventCategory | 'all'>('all');\r\n  const [severityFilter, setSeverityFilter] = useState<EventSeverity | 'all'>('all');\r\n  const [searchQuery, setSearchQuery] = useState('');\r\n  const [showFilters, setShowFilters] = useState(false);\r\n  const [groupByTime, setGroupByTime] = useState(true);\r\n\r\n  // Filter events\r\n  const filteredEvents = useMemo(() => {\r\n    let result = events;\r\n    \r\n    if (categoryFilter !== 'all') {\r\n      result = result.filter((e) => e.eventCategory === categoryFilter);\r\n    }\r\n    \r\n    if (severityFilter !== 'all') {\r\n      result = result.filter((e) => e.severity === severityFilter);\r\n    }\r\n    \r\n    if (searchQuery.trim()) {\r\n      const query = searchQuery.toLowerCase();\r\n      result = result.filter((e) =>\r\n        e.eventType.toLowerCase().includes(query) ||\r\n        e.targetName?.toLowerCase().includes(query) ||\r\n        e.actorName?.toLowerCase().includes(query) ||\r\n        JSON.stringify(e.payload).toLowerCase().includes(query)\r\n      );\r\n    }\r\n    \r\n    return result;\r\n  }, [events, categoryFilter, severityFilter, searchQuery]);\r\n\r\n  // Group events\r\n  const groupedEvents = useMemo(() => {\r\n    if (!groupByTime) {\r\n      return [{ label: 'Alla h├ñndelser', events: filteredEvents }];\r\n    }\r\n    return groupEventsByTime(filteredEvents);\r\n  }, [filteredEvents, groupByTime]);\r\n\r\n  // Count by severity\r\n  const errorCount = events.filter((e) => e.severity === 'error').length;\r\n  const warningCount = events.filter((e) => e.severity === 'warning').length;\r\n\r\n  return (\r\n    <Card className={className}>\r\n      <CardHeader className=\"pb-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <CardTitle className=\"flex items-center gap-2 text-base\">\r\n              <ChartBarIcon className=\"h-5 w-5\" />\r\n              H├ñndelsefl├Âde\r\n              {isLoading && (\r\n                <ArrowPathIcon className=\"h-4 w-4 animate-spin text-muted-foreground\" />\r\n              )}\r\n            </CardTitle>\r\n            <CardDescription className=\"flex items-center gap-2 mt-1\">\r\n              {events.length} h├ñndelser\r\n              {errorCount > 0 && (\r\n                <Badge variant=\"destructive\" className=\"text-xs\">\r\n                  {errorCount} fel\r\n                </Badge>\r\n              )}\r\n              {warningCount > 0 && (\r\n                <Badge variant=\"outline\" className=\"text-xs text-yellow-600\">\r\n                  {warningCount} varningar\r\n                </Badge>\r\n              )}\r\n            </CardDescription>\r\n          </div>\r\n          \r\n          <div className=\"flex items-center gap-2\">\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"sm\"\r\n              onClick={() => setShowFilters(!showFilters)}\r\n              className={showFilters ? 'bg-muted' : ''}\r\n            >\r\n              <FunnelIcon className=\"h-4 w-4\" />\r\n            </Button>\r\n            {onRefresh && (\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={onRefresh}\r\n                disabled={isLoading}\r\n              >\r\n                <ArrowPathIcon className={`h-4 w-4 ${isLoading ? 'animate-spin' : ''}`} />\r\n              </Button>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </CardHeader>\r\n\r\n      <CardContent className=\"space-y-3\">\r\n        {/* Filters */}\r\n        {showFilters && (\r\n          <div className=\"space-y-3 p-3 bg-muted/50 rounded-lg\">\r\n            <div className=\"flex items-center gap-3\">\r\n              <div className=\"flex-1 relative\">\r\n                <MagnifyingGlassIcon className=\"absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n                <Input\r\n                  value={searchQuery}\r\n                  onChange={(e) => setSearchQuery(e.target.value)}\r\n                  placeholder=\"S├Âk i h├ñndelser...\"\r\n                  className=\"pl-8\"\r\n                />\r\n                {searchQuery && (\r\n                  <button\r\n                    onClick={() => setSearchQuery('')}\r\n                    className=\"absolute right-2 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\r\n                  >\r\n                    <XMarkIcon className=\"h-4 w-4\" />\r\n                  </button>\r\n                )}\r\n              </div>\r\n            </div>\r\n            \r\n            <div className=\"grid grid-cols-2 gap-3\">\r\n              <div className=\"space-y-1\">\r\n                <Label className=\"text-xs\">Kategori</Label>\r\n                <Select\r\n                  value={categoryFilter}\r\n                  onChange={(e) => setCategoryFilter(e.target.value as EventCategory | 'all')}\r\n                  options={[\r\n                    { value: 'all', label: 'Alla kategorier' },\r\n                    ...Object.entries(CATEGORY_LABELS).map(([key, label]) => ({\r\n                      value: key,\r\n                      label,\r\n                    })),\r\n                  ]}\r\n                />\r\n              </div>\r\n              \r\n              <div className=\"space-y-1\">\r\n                <Label className=\"text-xs\">Allvarlighet</Label>\r\n                <Select\r\n                  value={severityFilter}\r\n                  onChange={(e) => setSeverityFilter(e.target.value as EventSeverity | 'all')}\r\n                  options={[\r\n                    { value: 'all', label: 'Alla niv├Ñer' },\r\n                    { value: 'error', label: 'Fel' },\r\n                    { value: 'warning', label: 'Varningar' },\r\n                    { value: 'info', label: 'Info' },\r\n                    { value: 'debug', label: 'Debug' },\r\n                  ]}\r\n                />\r\n              </div>\r\n            </div>\r\n            \r\n            <div className=\"flex items-center justify-between\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <Switch\r\n                  id=\"group-time\"\r\n                  checked={groupByTime}\r\n                  onCheckedChange={setGroupByTime}\r\n                />\r\n                <Label htmlFor=\"group-time\" className=\"text-xs\">\r\n                  Gruppera efter tid\r\n                </Label>\r\n              </div>\r\n              \r\n              {onClear && events.length > 0 && (\r\n                <Button\r\n                  variant=\"ghost\"\r\n                  size=\"sm\"\r\n                  onClick={onClear}\r\n                  className=\"text-xs h-7\"\r\n                >\r\n                  Rensa\r\n                </Button>\r\n              )}\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Error state */}\r\n        {error && (\r\n          <div className=\"flex items-center gap-2 p-3 rounded-lg bg-red-500/10 text-red-600 text-sm\">\r\n            <ExclamationCircleIcon className=\"h-4 w-4\" />\r\n            {error.message}\r\n          </div>\r\n        )}\r\n\r\n        {/* Event list */}\r\n        <ScrollArea maxHeight={maxHeight} className=\"pr-3\">\r\n          {filteredEvents.length === 0 ? (\r\n            <div className=\"text-center py-8 text-muted-foreground\">\r\n              {events.length === 0\r\n                ? 'Inga h├ñndelser ├ñn'\r\n                : 'Inga h├ñndelser matchar filtret'}\r\n            </div>\r\n          ) : (\r\n            <div className=\"space-y-2\">\r\n              {groupedEvents.map((group) => (\r\n                <EventGroupSection\r\n                  key={group.label}\r\n                  group={group}\r\n                  compact={compact}\r\n                />\r\n              ))}\r\n            </div>\r\n          )}\r\n        </ScrollArea>\r\n\r\n        {/* Stats summary */}\r\n        {stats.length > 0 && !compact && (\r\n          <div className=\"pt-3 border-t\">\r\n            <div className=\"flex flex-wrap gap-2\">\r\n              {stats.map((stat) => (\r\n                <div\r\n                  key={stat.eventCategory}\r\n                  className={`\r\n                    inline-flex items-center gap-1.5 px-2 py-1 rounded text-xs\r\n                    ${CATEGORY_COLORS[stat.eventCategory]}\r\n                  `}\r\n                >\r\n                  {CATEGORY_ICONS[stat.eventCategory]}\r\n                  <span>{stat.eventCount}</span>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        )}\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\FacilitatorDashboard.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":584,"column":49,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":586,"endColumn":15},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"Visa nedr├ñkning f├Âr deltagare\". Consider using useTranslations() or t() for internationalization.","line":610,"column":23,"nodeType":"Literal","messageId":"hardcodedString","endLine":610,"endColumn":54},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"Skriv ett meddelande som visas p├Ñ tavlan...\". Consider using useTranslations() or t() for internationalization.","line":668,"column":29,"nodeType":"Literal","messageId":"hardcodedString","endLine":668,"endColumn":74},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":676,"column":18,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":678,"endColumn":17},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":758,"column":64,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":758,"endColumn":82},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":788,"column":64,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":788,"endColumn":86},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"Skriv till allaÔÇª\". Consider using useTranslations() or t() for internationalization.","line":808,"column":31,"nodeType":"Literal","messageId":"hardcodedString","endLine":808,"endColumn":49},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":841,"column":123,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":843,"endColumn":9}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * FacilitatorDashboard Component\r\n * \r\n * Main dashboard for facilitators running a game session.\r\n * Provides controls for:\r\n * - Step navigation (content)\r\n * - Phase navigation (runtime/tempo)\r\n * - Timer controls\r\n * - Board message\r\n * - Connection status\r\n */\r\n\r\n'use client';\r\n\r\nimport { useEffect, useMemo, useState, useCallback, useRef } from 'react';\nimport {\r\n  PlayIcon,\r\n  PauseIcon,\r\n  StopIcon,\r\n  SignalIcon,\r\n  SignalSlashIcon,\r\n  ChatBubbleBottomCenterTextIcon,\r\n  UserGroupIcon,\r\n  Cog6ToothIcon,\r\n  ClockIcon,\r\n} from '@heroicons/react/24/solid';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { usePlayBroadcast } from '@/features/play/hooks/usePlayBroadcast';\r\nimport { useTriggerEngine, withSignalAndTimeBank } from '@/features/play/hooks';\nimport { useLiveSession } from '@/features/play/hooks/useLiveSession';\r\nimport { TimerControl } from './TimerControl';\r\nimport { StepPhaseNavigation, type StepInfo, type PhaseInfo } from './StepPhaseNavigation';\r\nimport { TriggerPanel } from '@/features/play/components/TriggerPanel';\r\nimport { createTimerState, pauseTimer, resumeTimer } from '@/lib/utils/timer-utils';\r\nimport type { TimerState, SessionRuntimeState, SignalReceivedBroadcast } from '@/types/play-runtime';\r\nimport type { SessionTrigger } from '@/types/games';\r\nimport type { TriggerActionContext, TriggerEvent } from '@/features/play/hooks';\nimport {\r\n  getSessionChatMessages,\r\n  sendSessionChatMessage,\r\n  type ChatMessage,\r\n} from '@/features/play/api/chat-api';\r\nimport { sendSessionSignal } from '@/features/play/api/signals-api';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface FacilitatorDashboardProps {\r\n  /** Session ID */\r\n  sessionId: string;\r\n  /** Game title */\r\n  gameTitle: string;\r\n  /** Steps data */\r\n  steps: StepInfo[];\r\n  /** Phases data (optional) */\r\n  phases?: PhaseInfo[];\r\n  /** Initial runtime state from server */\r\n  initialState?: Partial<SessionRuntimeState>;\r\n  /** Session triggers for automation */\r\n  triggers?: SessionTrigger[];\r\n  /** Called when session state is updated via API */\r\n  onStateUpdate?: (updates: Partial<SessionRuntimeState>) => Promise<void>;\r\n  /** Called when a trigger is manually fired */\r\n  onTriggerAction?: (triggerId: string, action: 'fire' | 'disable' | 'arm') => Promise<void>;\r\n  /** Called when session ends */\r\n  onEndSession?: () => void;\r\n  /** Number of active participants */\r\n  participantCount?: number;\r\n}\r\n\r\n// =============================================================================\r\n// Component\r\n// =============================================================================\r\n\r\nexport function FacilitatorDashboard({\r\n  sessionId,\r\n  gameTitle,\r\n  steps,\r\n  phases = [],\r\n  initialState,\r\n  triggers = [],\r\n  onStateUpdate,\r\n  onTriggerAction,\r\n  onEndSession,\r\n  participantCount = 0,\r\n}: FacilitatorDashboardProps) {\r\n  // Local state (mirrors server state)\r\n  // Use -1 as default to indicate \"not started yet\"\r\n  const [currentStepIndex, setCurrentStepIndex] = useState(initialState?.current_step_index ?? -1);\r\n  const [currentPhaseIndex, setCurrentPhaseIndex] = useState(initialState?.current_phase_index ?? -1);\r\n  const [timerState, setTimerState] = useState<TimerState | null>(initialState?.timer_state ?? null);\r\n  const [boardMessage, setBoardMessage] = useState(initialState?.board_state?.message ?? '');\r\n  const [status, setStatus] = useState<SessionRuntimeState['status']>(initialState?.status ?? 'active');\r\n\r\n  // Chat (host)\r\n  const [chatMessages, setChatMessages] = useState<ChatMessage[]>([]);\r\n  const [chatInput, setChatInput] = useState('');\r\n  const [chatSending, setChatSending] = useState(false);\r\n  const [chatError, setChatError] = useState<string | null>(null);\r\n\r\n  // Signals (host)\r\n  const [signalChannel, setSignalChannel] = useState('');\r\n  const [signalMessage, setSignalMessage] = useState('');\r\n  const [signalSending, setSignalSending] = useState(false);\r\n  const [signalError, setSignalError] = useState<string | null>(null);\r\n  const [recentSignals, setRecentSignals] = useState<SignalReceivedBroadcast['payload'][]>([]);\r\n\r\n  const latestChatTimestamp = useMemo(() => {\r\n    if (chatMessages.length === 0) return undefined;\r\n    return chatMessages[chatMessages.length - 1]?.createdAt;\r\n  }, [chatMessages]);\r\n  \r\n  // UI state\n  const [isSaving, setIsSaving] = useState(false);\n  const [showSettings, setShowSettings] = useState(false);\n  const processEventRef = useRef<((event: TriggerEvent) => Promise<void>) | null>(null);\n  \r\n  // Broadcast hook\r\n  const { \r\n    connected, \r\n    broadcastStateChange, \r\n    broadcastTimerUpdate, \r\n    broadcastBoardUpdate,\r\n    broadcastCountdown \r\n  } = usePlayBroadcast({ sessionId });\r\n\r\n  // Receive realtime play events (signals/time-bank/etc)\r\n  const { connected: liveConnected } = useLiveSession({\n    sessionId,\n    enabled: true,\n    onSignalReceived: (payload) => {\n      setRecentSignals((prev) => {\n        const next = [payload, ...prev.filter((p) => p.id !== payload.id)];\n        return next.slice(0, 20);\n      });\n      if (!signalChannel) {\n        setSignalChannel(payload.channel);\n      }\n      const triggerEvent: TriggerEvent = {\n        type: 'signal_received',\n        channel: payload.channel,\n        payload: payload.payload,\n        sender_user_id: payload.sender_user_id ?? undefined,\n        sender_participant_id: payload.sender_participant_id ?? undefined,\n      };\n      void processEventRef.current?.(triggerEvent);\n    },\n  });\n\r\n  const quickChannels = useMemo(() => {\r\n    const channels: string[] = [];\r\n    for (const s of recentSignals) {\r\n      if (!channels.includes(s.channel)) channels.push(s.channel);\r\n      if (channels.length >= 4) break;\r\n    }\r\n    return channels;\r\n  }, [recentSignals]);\r\n\r\n  const formatSignalText = useCallback((payload: unknown): string => {\r\n    if (!payload) return '';\r\n    if (typeof payload === 'string') return payload;\r\n    if (typeof payload === 'object' && payload !== null && 'message' in payload) {\r\n      const msg = (payload as { message?: unknown }).message;\r\n      if (typeof msg === 'string') return msg;\r\n    }\r\n    try {\r\n      return JSON.stringify(payload);\r\n    } catch {\r\n      return '';\r\n    }\r\n  }, []);\r\n\r\n  const handleSendSignal = useCallback(async () => {\r\n    const channel = signalChannel.trim();\r\n    const message = signalMessage.trim();\r\n    if (!channel || !message) return;\r\n\r\n    setSignalSending(true);\r\n    setSignalError(null);\r\n    try {\r\n      await sendSessionSignal(sessionId, { channel, message });\r\n      setSignalMessage('');\r\n    } catch (err) {\r\n      const msg = err instanceof Error ? err.message : 'Failed to send signal';\r\n      setSignalError(msg);\r\n    } finally {\r\n      setSignalSending(false);\r\n    }\r\n  }, [sessionId, signalChannel, signalMessage]);\r\n\r\n  // ========================================================================\r\n  // State Update Helpers\r\n  // ========================================================================\r\n\r\n  const updateAndBroadcast = useCallback(async (\r\n    updates: Partial<SessionRuntimeState>,\r\n    broadcast: () => Promise<boolean>\r\n  ) => {\r\n    setIsSaving(true);\r\n    try {\r\n      // Update server via callback\r\n      if (onStateUpdate) {\r\n        await onStateUpdate(updates);\r\n      }\r\n      // Broadcast to clients\r\n      await broadcast();\r\n    } catch (error) {\r\n      console.error('[FacilitatorDashboard] Failed to update:', error);\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  }, [onStateUpdate]);\r\n\r\n  // ========================================================================\r\n  // Core Handlers (no trigger events)\r\n  // ========================================================================\r\n\r\n  const handleStepChangeCore = useCallback(async (index: number) => {\r\n    setCurrentStepIndex(index);\r\n    await updateAndBroadcast(\r\n      { current_step_index: index },\r\n      () => broadcastStateChange({ current_step_index: index })\r\n    );\r\n  }, [updateAndBroadcast, broadcastStateChange]);\r\n\r\n  const handlePhaseChangeCore = useCallback(async (index: number) => {\r\n    setCurrentPhaseIndex(index);\r\n    await updateAndBroadcast(\r\n      { current_phase_index: index },\r\n      () => broadcastStateChange({ current_phase_index: index })\r\n    );\r\n  }, [updateAndBroadcast, broadcastStateChange]);\r\n\r\n  const handleTimerStartCore = useCallback(async (durationSeconds: number) => {\r\n    const newTimerState = createTimerState(durationSeconds);\r\n    setTimerState(newTimerState);\r\n    await updateAndBroadcast(\r\n      { timer_state: newTimerState },\r\n      () => broadcastTimerUpdate('start', newTimerState)\r\n    );\r\n  }, [updateAndBroadcast, broadcastTimerUpdate]);\r\n\r\n  // ========================================================================\r\n  // Trigger Engine (executes actions locally + patches status)\r\n  // ========================================================================\r\n\r\n  const actionContext: TriggerActionContext = useMemo(() => {\r\n    const base: TriggerActionContext = {\r\n      sessionId,\r\n      broadcastCountdown: async (action, duration, message) => {\r\n        if (action === 'show') return broadcastCountdown('show', duration, message);\r\n        // Best-effort \"hide\" mapping for current broadcast protocol\r\n        return broadcastCountdown('complete', 0, message);\r\n      },\r\n      broadcastStateChange: async (updates) => {\r\n        const payload: { current_step_index?: number; current_phase_index?: number; status?: string } = {};\r\n        const stepIndex = updates.current_step_index;\r\n        const phaseIndex = updates.current_phase_index;\r\n        const nextStatus = updates.status;\r\n        if (typeof stepIndex === 'number') payload.current_step_index = stepIndex;\r\n        if (typeof phaseIndex === 'number') payload.current_phase_index = phaseIndex;\r\n        if (typeof nextStatus === 'string') payload.status = nextStatus;\r\n        return broadcastStateChange(payload);\r\n      },\r\n      advanceStep: async () => {\r\n        const nextIndex = currentStepIndex + 1;\r\n        if (nextIndex < 0 || nextIndex >= steps.length) return;\r\n        await handleStepChangeCore(nextIndex);\r\n      },\r\n      advancePhase: async () => {\r\n        const nextIndex = currentPhaseIndex + 1;\r\n        if (nextIndex < 0 || nextIndex >= phases.length) return;\r\n        await handlePhaseChangeCore(nextIndex);\r\n      },\r\n      startTimer: async (duration) => {\r\n        await handleTimerStartCore(duration);\r\n      },\r\n      sendBoardMessage: async (message) => {\r\n        const trimmed = message.trim();\r\n        await updateAndBroadcast(\r\n          { board_state: { message: trimmed || undefined } },\r\n          () => broadcastBoardUpdate(trimmed || undefined)\r\n        );\r\n      },\r\n    };\r\n\r\n    return withSignalAndTimeBank(base);\r\n  }, [\r\n    sessionId,\r\n    broadcastCountdown,\r\n    broadcastStateChange,\r\n    broadcastBoardUpdate,\r\n    currentStepIndex,\r\n    currentPhaseIndex,\r\n    steps.length,\r\n    phases.length,\r\n    handleStepChangeCore,\r\n    handlePhaseChangeCore,\r\n    handleTimerStartCore,\r\n    updateAndBroadcast,\r\n  ]);\r\n\r\n  const { processEvent, fireTrigger: fireTriggerActions } = useTriggerEngine({\n    sessionId,\n    triggers,\n    actionContext,\n    onTriggerStatusUpdate: async (triggerId, status) => {\n      const action = status === 'disabled' ? 'disable' : status === 'fired' ? 'fire' : 'arm';\n      await onTriggerAction?.(triggerId, action);\n    },\n    enabled: true,\n  });\n\n  useEffect(() => {\n    processEventRef.current = processEvent;\n  }, [processEvent]);\n\r\n  const handleManualTriggerFire = useCallback(\r\n    async (triggerId: string) => {\r\n      await fireTriggerActions(triggerId);\r\n    },\r\n    [fireTriggerActions]\r\n  );\r\n\r\n  // ========================================================================\r\n  // UI Handlers (emit trigger events)\r\n  // ========================================================================\r\n\r\n  const handleStepChange = useCallback(async (index: number) => {\r\n    await handleStepChangeCore(index);\r\n    const stepId = steps[index]?.id;\r\n    if (stepId) {\r\n      await processEvent({ type: 'step_started', stepId });\r\n    }\r\n  }, [handleStepChangeCore, steps, processEvent]);\r\n\r\n  const handlePhaseChange = useCallback(async (index: number) => {\r\n    await handlePhaseChangeCore(index);\r\n    const phaseId = phases[index]?.id;\r\n    if (phaseId) {\r\n      await processEvent({ type: 'phase_started', phaseId });\r\n    }\r\n  }, [handlePhaseChangeCore, phases, processEvent]);\r\n\r\n  // Keep name used by UI\r\n  const handleTimerStart = handleTimerStartCore;\r\n  \r\n  const handleTimerPause = useCallback(async () => {\r\n    if (!timerState) return;\r\n    const pausedState = pauseTimer(timerState);\r\n    setTimerState(pausedState);\r\n    await updateAndBroadcast(\r\n      { timer_state: pausedState },\r\n      () => broadcastTimerUpdate('pause', pausedState)\r\n    );\r\n  }, [timerState, updateAndBroadcast, broadcastTimerUpdate]);\r\n  \r\n  const handleTimerResume = useCallback(async () => {\r\n    if (!timerState) return;\r\n    const resumedState = resumeTimer(timerState);\r\n    setTimerState(resumedState);\r\n    await updateAndBroadcast(\r\n      { timer_state: resumedState },\r\n      () => broadcastTimerUpdate('resume', resumedState)\r\n    );\r\n  }, [timerState, updateAndBroadcast, broadcastTimerUpdate]);\r\n  \r\n  const handleTimerReset = useCallback(async () => {\r\n    setTimerState(null);\r\n    await updateAndBroadcast(\r\n      { timer_state: null },\r\n      () => broadcastTimerUpdate('reset', null)\r\n    );\r\n  }, [updateAndBroadcast, broadcastTimerUpdate]);\r\n  \r\n  // ==========================================================================\r\n  // Board Message Handler\r\n  // ==========================================================================\r\n  \r\n  const handleBoardMessageSubmit = useCallback(async () => {\r\n    const message = boardMessage.trim() || undefined;\r\n    await updateAndBroadcast(\r\n      { board_state: { message } },\r\n      () => broadcastBoardUpdate(message)\r\n    );\r\n  }, [boardMessage, updateAndBroadcast, broadcastBoardUpdate]);\r\n  \r\n  const handleClearBoardMessage = useCallback(async () => {\r\n    setBoardMessage('');\r\n    await updateAndBroadcast(\r\n      { board_state: { message: undefined } },\r\n      () => broadcastBoardUpdate(undefined)\r\n    );\r\n  }, [updateAndBroadcast, broadcastBoardUpdate]);\r\n  \r\n  // ==========================================================================\r\n  // Session Control\r\n  // ==========================================================================\r\n  \r\n  const handlePauseSession = useCallback(async () => {\r\n    setStatus('paused');\r\n    await updateAndBroadcast(\r\n      { status: 'paused' },\r\n      () => broadcastStateChange({ status: 'paused' })\r\n    );\r\n  }, [updateAndBroadcast, broadcastStateChange]);\r\n  \r\n  const handleResumeSession = useCallback(async () => {\r\n    setStatus('active');\r\n    await updateAndBroadcast(\r\n      { status: 'active' },\r\n      () => broadcastStateChange({ status: 'active' })\r\n    );\r\n  }, [updateAndBroadcast, broadcastStateChange]);\r\n  \r\n  const handleEndSession = useCallback(async () => {\r\n    if (!confirm('├är du s├ñker p├Ñ att du vill avsluta sessionen?')) return;\r\n    setStatus('ended');\r\n    await updateAndBroadcast(\r\n      { status: 'ended' },\r\n      () => broadcastStateChange({ status: 'ended' })\r\n    );\r\n    onEndSession?.();\r\n  }, [updateAndBroadcast, broadcastStateChange, onEndSession]);\r\n\r\n  // Get current step duration for timer default\r\n  const currentStep = steps[currentStepIndex];\r\n  const defaultTimerDuration = currentStep?.durationMinutes \r\n    ? currentStep.durationMinutes * 60 \r\n    : 300;\r\n\r\n  useEffect(() => {\r\n    let cancelled = false;\r\n\r\n    const loadInitial = async () => {\r\n      try {\r\n        const messages = await getSessionChatMessages(sessionId);\r\n        if (!cancelled) {\r\n          setChatMessages(messages);\r\n          setChatError(null);\r\n        }\r\n      } catch (err) {\r\n        if (!cancelled) {\r\n          setChatError(err instanceof Error ? err.message : 'Kunde inte ladda chatten');\r\n        }\r\n      }\r\n    };\r\n\r\n    void loadInitial();\r\n    return () => {\r\n      cancelled = true;\r\n    };\r\n  }, [sessionId]);\r\n\r\n  useEffect(() => {\r\n    const interval = window.setInterval(async () => {\r\n      try {\r\n        const messages = await getSessionChatMessages(sessionId, { since: latestChatTimestamp });\r\n        if (messages.length > 0) {\r\n          setChatMessages((prev) => {\r\n            const seen = new Set(prev.map((m) => m.id));\r\n            const next = [...prev];\r\n            for (const m of messages) {\r\n              if (!seen.has(m.id)) next.push(m);\r\n            }\r\n            return next.slice(-400);\r\n          });\r\n        }\r\n      } catch {\r\n        // best-effort polling\r\n      }\r\n    }, 2000);\r\n\r\n    return () => window.clearInterval(interval);\r\n  }, [sessionId, latestChatTimestamp]);\r\n\r\n  const handleSendChat = useCallback(async () => {\r\n    const msg = chatInput.trim();\r\n    if (!msg) return;\r\n\r\n    setChatSending(true);\r\n    setChatError(null);\r\n    try {\r\n      await sendSessionChatMessage(sessionId, { message: msg, visibility: 'public' });\r\n      setChatInput('');\r\n\r\n      const messages = await getSessionChatMessages(sessionId, { since: latestChatTimestamp });\r\n      if (messages.length > 0) {\r\n        setChatMessages((prev) => {\r\n          const seen = new Set(prev.map((m) => m.id));\r\n          const next = [...prev];\r\n          for (const m of messages) {\r\n            if (!seen.has(m.id)) next.push(m);\r\n          }\r\n          return next.slice(-400);\r\n        });\r\n      }\r\n    } catch (err) {\r\n      setChatError(err instanceof Error ? err.message : 'Kunde inte skicka meddelandet');\r\n    } finally {\r\n      setChatSending(false);\r\n    }\r\n  }, [chatInput, latestChatTimestamp, sessionId]);\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex items-start justify-between gap-4\">\r\n        <div>\r\n          <p className=\"text-xs font-bold uppercase tracking-widest text-primary\">\r\n            Facilitator\r\n          </p>\r\n          <h1 className=\"text-2xl font-bold text-foreground\">{gameTitle}</h1>\r\n        </div>\r\n        \r\n        <div className=\"flex items-center gap-2\">\r\n          {/* Connection status */}\r\n          <Badge variant={connected ? 'default' : 'destructive'} className=\"gap-1.5\">\r\n            {connected ? (\r\n              <SignalIcon className=\"h-3 w-3\" />\r\n            ) : (\r\n              <SignalSlashIcon className=\"h-3 w-3\" />\r\n            )}\r\n            {connected ? 'Ansluten' : 'Ej ansluten'}\r\n          </Badge>\r\n          \r\n          {/* Participant count */}\r\n          <Badge variant=\"secondary\" className=\"gap-1.5\">\r\n            <UserGroupIcon className=\"h-3 w-3\" />\r\n            {participantCount} deltagare\r\n          </Badge>\r\n          \r\n          {/* Settings toggle */}\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            onClick={() => setShowSettings(!showSettings)}\r\n            className=\"p-2\"\r\n          >\r\n            <Cog6ToothIcon className=\"h-5 w-5\" />\r\n          </Button>\r\n        </div>\r\n      </div>\r\n      \r\n      {/* Session Controls */}\r\n      <Card className=\"p-4\">\r\n        <div className=\"flex items-center justify-between gap-4\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <span className={`h-3 w-3 rounded-full ${\r\n              status === 'active' ? 'bg-green-500 animate-pulse' :\r\n              status === 'paused' ? 'bg-yellow-500' :\r\n              'bg-gray-500'\r\n            }`} />\r\n            <span className=\"text-sm font-medium\">\r\n              {status === 'active' ? 'Aktiv' :\r\n               status === 'paused' ? 'Pausad' :\r\n               status === 'ended' ? 'Avslutad' : status}\r\n            </span>\r\n          </div>\r\n          \r\n          <div className=\"flex items-center gap-2\">\r\n            {status === 'active' ? (\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={handlePauseSession}\r\n                disabled={isSaving}\r\n                className=\"gap-1.5\"\r\n              >\r\n                <PauseIcon className=\"h-4 w-4\" />\r\n                Pausa\r\n              </Button>\r\n            ) : status === 'paused' ? (\r\n              <Button\r\n                size=\"sm\"\r\n                onClick={handleResumeSession}\r\n                disabled={isSaving}\r\n                className=\"gap-1.5\"\r\n              >\r\n                <PlayIcon className=\"h-4 w-4\" />\r\n                ├àteruppta\r\n              </Button>\r\n            ) : null}\r\n            \r\n            {status !== 'ended' && (\r\n              <Button\r\n                variant=\"destructive\"\r\n                size=\"sm\"\r\n                onClick={handleEndSession}\r\n                disabled={isSaving}\r\n                className=\"gap-1.5\"\r\n              >\r\n                <StopIcon className=\"h-4 w-4\" />\r\n                Avsluta\r\n              </Button>\r\n            )}\r\n\r\n            {/* Countdown Overlay Button */}\r\n            {status === 'active' && (\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={() => void broadcastCountdown('show', 5, 'N├ñsta moment startar om')}\r\n                disabled={isSaving}\r\n                className=\"gap-1.5\"\r\n                title=\"Visa nedr├ñkning f├Âr deltagare\"\r\n              >\r\n                <ClockIcon className=\"h-4 w-4\" />\r\n                5s\r\n              </Button>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </Card>\r\n      \r\n      {/* Main Controls Grid */}\r\n      <div className=\"grid gap-6 lg:grid-cols-2\">\r\n        {/* Left: Navigation */}\r\n        <div>\r\n          <StepPhaseNavigation\r\n            currentStepIndex={currentStepIndex}\r\n            totalSteps={steps.length}\r\n            steps={steps}\r\n            currentPhaseIndex={currentPhaseIndex}\r\n            totalPhases={phases.length}\r\n            phases={phases}\r\n            onStepChange={handleStepChange}\r\n            onPhaseChange={handlePhaseChange}\r\n            disabled={isSaving || status === 'ended'}\r\n            showPhases={phases.length > 0}\r\n            unified\r\n          />\r\n        </div>\r\n        \r\n        {/* Right: Timer + Board Message */}\r\n        <div className=\"space-y-6\">\r\n          {/* Timer Control */}\r\n          <Card className=\"p-4\">\r\n            <h3 className=\"mb-4 text-sm font-semibold uppercase tracking-wider text-muted-foreground\">\r\n              Timer\r\n            </h3>\r\n            <TimerControl\r\n              timerState={timerState}\r\n              onStart={handleTimerStart}\r\n              onPause={handleTimerPause}\r\n              onResume={handleTimerResume}\r\n              onReset={handleTimerReset}\r\n              defaultDuration={defaultTimerDuration}\r\n              disabled={isSaving || status === 'ended'}\r\n              size=\"md\"\r\n            />\r\n          </Card>\r\n          \r\n          {/* Board Message */}\r\n          <Card className=\"p-4\">\r\n            <h3 className=\"mb-4 text-sm font-semibold uppercase tracking-wider text-muted-foreground\">\r\n              <ChatBubbleBottomCenterTextIcon className=\"mr-2 inline h-4 w-4\" />\r\n              Meddelande till tavlan\r\n            </h3>\r\n            <div className=\"space-y-3\">\r\n              <Input\r\n                value={boardMessage}\r\n                onChange={(e) => setBoardMessage(e.target.value)}\r\n                placeholder=\"Skriv ett meddelande som visas p├Ñ tavlan...\"\r\n                disabled={isSaving || status === 'ended'}\r\n              />\r\n              <div className=\"flex gap-2\">\r\n                <Button\r\n                  size=\"sm\"\r\n                  onClick={handleBoardMessageSubmit}\r\n                  disabled={isSaving || status === 'ended' || !boardMessage.trim()}\r\n                >\r\n                  Visa p├Ñ tavlan\r\n                </Button>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  onClick={handleClearBoardMessage}\r\n                  disabled={isSaving || status === 'ended'}\r\n                >\r\n                  Rensa\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          </Card>\r\n\r\n          {/* Signals */}\r\n          <Card className=\"p-4\">\r\n            <div className=\"mb-4 flex items-center justify-between\">\r\n              <h3 className=\"text-sm font-semibold uppercase tracking-wider text-muted-foreground\">\r\n                <SignalIcon className=\"mr-2 inline h-4 w-4\" />\r\n                Signals\r\n              </h3>\r\n              <Badge variant={liveConnected ? 'success' : 'secondary'} size=\"sm\">\r\n                {liveConnected ? 'Live' : 'Offline'}\r\n              </Badge>\r\n            </div>\r\n\r\n            <div className=\"space-y-3\">\r\n              {signalError && <p className=\"text-sm text-destructive\">{signalError}</p>}\r\n\r\n              <div className=\"flex gap-2\">\r\n                <Input\r\n                  value={signalChannel}\r\n                  onChange={(e) => setSignalChannel(e.target.value)}\r\n                  placeholder=\"Kanal (t.ex. READY)\"\r\n                  disabled={signalSending || status === 'ended'}\r\n                />\r\n                <Input\r\n                  value={signalMessage}\r\n                  onChange={(e) => setSignalMessage(e.target.value)}\r\n                  placeholder=\"Meddelande\"\r\n                  disabled={signalSending || status === 'ended'}\r\n                  onKeyDown={(e) => {\r\n                    if (e.key === 'Enter') {\r\n                      e.preventDefault();\r\n                      void handleSendSignal();\r\n                    }\r\n                  }}\r\n                />\r\n                <Button\r\n                  type=\"button\"\r\n                  onClick={() => void handleSendSignal()}\r\n                  disabled={\r\n                    signalSending ||\r\n                    status === 'ended' ||\r\n                    !signalChannel.trim() ||\r\n                    !signalMessage.trim()\r\n                  }\r\n                >\r\n                  Skicka\r\n                </Button>\r\n              </div>\r\n\r\n              {quickChannels.length > 0 && (\r\n                <div className=\"flex flex-wrap gap-2\">\r\n                  {quickChannels.map((c) => (\r\n                    <Button\r\n                      key={c}\r\n                      type=\"button\"\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                      onClick={() => setSignalChannel(c)}\r\n                      disabled={signalSending || status === 'ended'}\r\n                    >\r\n                      {c}\r\n                    </Button>\r\n                  ))}\r\n                </div>\r\n              )}\r\n\r\n              <div className=\"max-h-48 overflow-auto rounded-md border border-border p-3 space-y-2\">\r\n                {recentSignals.length === 0 ? (\r\n                  <p className=\"text-sm text-muted-foreground\">Inga signals ├ñnnu.</p>\r\n                ) : (\r\n                  recentSignals.map((s) => (\r\n                    <div key={s.id} className=\"text-sm\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <Badge variant=\"secondary\" size=\"sm\">{s.channel}</Badge>\r\n                        <span className=\"text-xs text-muted-foreground\">\r\n                          {new Date(s.created_at).toLocaleTimeString()}\r\n                        </span>\r\n                      </div>\r\n                      {formatSignalText(s.payload) && (\r\n                        <p className=\"text-muted-foreground\">{formatSignalText(s.payload)}</p>\r\n                      )}\r\n                    </div>\r\n                  ))\r\n                )}\r\n              </div>\r\n            </div>\r\n          </Card>\r\n\r\n          {/* Chat */}\r\n          <Card className=\"p-4\">\r\n            <h3 className=\"mb-4 text-sm font-semibold uppercase tracking-wider text-muted-foreground\">\r\n              <ChatBubbleBottomCenterTextIcon className=\"mr-2 inline h-4 w-4\" />\r\n              Chatt\r\n            </h3>\r\n\r\n            <div className=\"space-y-3\">\r\n              <div className=\"max-h-72 overflow-auto rounded-md border border-border p-3 space-y-2\">\r\n                {chatMessages.length === 0 ? (\r\n                  <p className=\"text-sm text-muted-foreground\">Inga meddelanden ├ñnnu.</p>\r\n                ) : (\r\n                  chatMessages.map((m) => (\r\n                    <div key={m.id} className=\"text-sm\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <span className=\"font-medium text-foreground\">{m.senderLabel}</span>\r\n                        {m.visibility === 'host' && <Badge variant=\"secondary\">Privat</Badge>}\r\n                      </div>\r\n                      <p className=\"text-muted-foreground\">{m.message}</p>\r\n                    </div>\r\n                  ))\r\n                )}\r\n              </div>\r\n\r\n              {chatError && <p className=\"text-sm text-destructive\">{chatError}</p>}\r\n\r\n              <div className=\"flex gap-2\">\r\n                <Input\r\n                  value={chatInput}\r\n                  onChange={(e) => setChatInput(e.target.value)}\r\n                  placeholder=\"Skriv till allaÔÇª\"\r\n                  disabled={chatSending || status === 'ended'}\r\n                  onKeyDown={(e) => {\r\n                    if (e.key === 'Enter') {\r\n                      e.preventDefault();\r\n                      void handleSendChat();\r\n                    }\r\n                  }}\r\n                />\r\n                <Button\r\n                  type=\"button\"\r\n                  onClick={() => void handleSendChat()}\r\n                  disabled={chatSending || status === 'ended'}\r\n                >\r\n                  Skicka\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          </Card>\r\n        </div>\r\n      </div>\r\n      \r\n      {/* Trigger Panel (if triggers exist) */}\r\n      {triggers.length > 0 && (\r\n        <TriggerPanel\r\n          triggers={triggers}\r\n          onFireTrigger={handleManualTriggerFire}\r\n          disabled={isSaving || status === 'ended'}\r\n        />\r\n      )}\r\n      \r\n      {/* Saving indicator */}\r\n      {isSaving && (\r\n        <div className=\"fixed bottom-4 right-4 rounded-lg bg-primary px-4 py-2 text-sm text-primary-foreground shadow-lg\">\r\n          Sparar...\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\HostPlayMode.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":232,"column":51,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":234,"endColumn":9},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":263,"column":52,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":265,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":375,"column":57,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":377,"endColumn":13},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":390,"column":58,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":390,"endColumn":75},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":391,"column":52,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":393,"endColumn":15},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":395,"column":21,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":395,"endColumn":40},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":398,"column":21,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":398,"endColumn":42}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Host Play Mode Component\r\n * \r\n * Integrates FacilitatorDashboard with the existing host session view.\r\n * Shows play controls when a game is linked and session is active.\r\n */\r\n\r\n'use client';\r\n\r\nimport { useState, useEffect, useCallback } from 'react';\r\nimport { FacilitatorDashboard } from './FacilitatorDashboard';\r\nimport { RoleAssignerContainer } from './RoleAssignerContainer';\r\nimport { ArtifactsPanel } from './ArtifactsPanel';\r\nimport { DecisionsPanel } from './DecisionsPanel';\r\nimport { OutcomePanel } from './OutcomePanel';\r\nimport { PuzzleProgressPanel } from './PuzzleProgressPanel';\r\nimport { PropConfirmationManager } from './PropConfirmationManager';\r\nimport { getHostPlaySession, updatePlaySessionState, type PlaySessionData } from '../api';\r\nimport type { SessionTrigger } from '@/types/games';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Skeleton } from '@/components/ui/skeleton';\r\nimport { \r\n  PlayIcon, \r\n  Cog6ToothIcon,\r\n  UserGroupIcon,\r\n  CubeIcon,\r\n  ScaleIcon,\r\n  FlagIcon,\r\n  ArrowLeftIcon,\r\n  PuzzlePieceIcon,\r\n} from '@heroicons/react/24/outline';\r\nimport type { SessionRuntimeState } from '@/types/play-runtime';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface HostPlayModeProps {\r\n  /** Session ID */\r\n  sessionId: string;\r\n  /** Callback when user wants to exit play mode */\r\n  onExitPlayMode?: () => void;\r\n  /** Whether to show the internal exit button (defaults to true). */\r\n  showExitButton?: boolean;\r\n  /** Number of participants */\r\n  participantCount?: number;\r\n}\r\n\r\n// Navigation zones: Play (main), Content (artifacts/decisions/outcomes), Manage (roles/settings)\r\ntype PlayModeZone = 'play' | 'content' | 'manage';\r\ntype ContentSubTab = 'artifacts' | 'decisions' | 'outcome' | 'puzzles';\r\ntype ManageSubTab = 'roles' | 'settings';\r\n\r\n// =============================================================================\r\n// Component\r\n// =============================================================================\r\n\r\nexport function HostPlayMode({\r\n  sessionId,\r\n  onExitPlayMode,\r\n  showExitButton = true,\r\n  participantCount = 0,\r\n}: HostPlayModeProps) {\r\n  // Data state\r\n  const [playData, setPlayData] = useState<PlaySessionData | null>(null);\r\n  const [triggers, setTriggers] = useState<SessionTrigger[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  \r\n  // UI state - simplified 3-zone navigation\r\n  const [activeZone, setActiveZone] = useState<PlayModeZone>('play');\r\n  const [contentSubTab, setContentSubTab] = useState<ContentSubTab>('artifacts');\r\n  const [manageSubTab, setManageSubTab] = useState<ManageSubTab>('roles');\r\n\r\n  // Load play session data\r\n  const loadData = useCallback(async () => {\r\n    try {\r\n      const data = await getHostPlaySession(sessionId);\r\n      if (data) {\r\n        setPlayData(data);\r\n        setError(null);\r\n      } else {\r\n        setError('Kunde inte ladda speldata');\r\n      }\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : 'Ett fel uppstod');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [sessionId]);\r\n  // Load triggers (snapshot if needed)\r\n  const loadTriggers = useCallback(async () => {\r\n    try {\r\n      // Try to get existing session triggers\r\n      const res = await fetch(`/api/play/sessions/${sessionId}/triggers`, {\r\n        cache: 'no-store',\r\n      });\r\n      \r\n      if (res.ok) {\r\n        const data = await res.json();\r\n        if (data.triggers && data.triggers.length > 0) {\r\n          setTriggers(data.triggers);\r\n          return;\r\n        }\r\n      }\r\n\r\n      // If no triggers exist, try to snapshot from game\r\n      const snapshotRes = await fetch(`/api/play/sessions/${sessionId}/triggers`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n\r\n      if (snapshotRes.ok) {\r\n        // Reload triggers after snapshot\r\n        const reloadRes = await fetch(`/api/play/sessions/${sessionId}/triggers`, {\r\n          cache: 'no-store',\r\n        });\r\n        if (reloadRes.ok) {\r\n          const reloadData = await reloadRes.json();\r\n          setTriggers(reloadData.triggers || []);\r\n        }\r\n      }\r\n    } catch (err) {\r\n      console.warn('[HostPlayMode] Failed to load triggers:', err);\r\n    }\r\n  }, [sessionId]);\r\n  useEffect(() => {\r\n    void loadData();\r\n    void loadTriggers();\r\n  }, [loadData, loadTriggers]);\r\n\r\n  // Handle state updates\r\n  const handleStateUpdate = useCallback(async (updates: Partial<SessionRuntimeState>) => {\r\n    const previousState = playData?.runtimeState;\r\n    const success = await updatePlaySessionState(sessionId, updates, previousState);\r\n    if (success) {\r\n      // Update local state optimistically\r\n      setPlayData((prev) => {\r\n        if (!prev) return prev;\r\n        return {\r\n          ...prev,\r\n          runtimeState: {\r\n            ...prev.runtimeState,\r\n            ...updates,\r\n          },\r\n        };\r\n      });\r\n    }\r\n  }, [sessionId, playData?.runtimeState]);\r\n\r\n  // Handle session end\r\n  const handleEndSession = useCallback(() => {\r\n    // This should be handled by the parent component\r\n    onExitPlayMode?.();\r\n  }, [onExitPlayMode]);\r\n\r\n  // Handle trigger fire\r\n  const handleTriggerAction = useCallback(async (triggerId: string, action: 'fire' | 'disable' | 'arm') => {\r\n    try {\r\n      const res = await fetch(`/api/play/sessions/${sessionId}/triggers`, {\r\n        method: 'PATCH',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ triggerId, action }),\r\n      });\r\n\r\n      if (res.ok) {\r\n        // Update local state\r\n        setTriggers((prev) => {\r\n          return prev.map((t) => {\r\n            if (t.id !== triggerId) return t;\r\n            if (action === 'fire') {\r\n              return {\r\n                ...t,\r\n                status: 'fired' as const,\r\n                fired_count: (t.fired_count || 0) + 1,\r\n                fired_at: new Date().toISOString(),\r\n              };\r\n            }\r\n            if (action === 'disable') {\r\n              return { ...t, status: 'disabled' as const };\r\n            }\r\n            if (action === 'arm') {\r\n              return { ...t, status: 'armed' as const };\r\n            }\r\n            return t;\r\n          });\r\n        });\r\n      }\r\n    } catch (err) {\r\n      console.error('[HostPlayMode] Failed to update trigger:', err);\r\n    }\r\n  }, [sessionId]);\r\n\r\n  // Handle role assignment complete\r\n  const handleRolesAssigned = useCallback(() => {\r\n    // Reload data to get updated assignments\r\n    void loadData();\r\n    // Switch to play view\r\n    setActiveZone('play');\r\n  }, [loadData]);\r\n\r\n  // Loading state\r\n  if (loading) {\r\n    return (\r\n      <div className=\"space-y-4\">\r\n        <Skeleton className=\"h-12 w-full\" />\r\n        <Skeleton className=\"h-64 w-full\" />\r\n        <Skeleton className=\"h-32 w-full\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Error state\r\n  if (error || !playData) {\r\n    return (\r\n      <Card className=\"p-8 text-center\">\r\n        <p className=\"text-destructive mb-4\">{error || 'Ingen speldata tillg├ñnglig'}</p>\r\n        <Button variant=\"outline\" onClick={onExitPlayMode}>\r\n          <ArrowLeftIcon className=\"h-4 w-4 mr-2\" />\r\n          Tillbaka\r\n        </Button>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // No game linked - show message\r\n  if (!playData.gameId) {\r\n    return (\r\n      <Card className=\"p-8 text-center\">\r\n        <h2 className=\"text-lg font-semibold mb-2\">Inget spel kopplat</h2>\r\n        <p className=\"text-muted-foreground mb-4\">\r\n          Denna session har inget spel kopplat. Spell├ñget kr├ñver ett spel med steg och instruktioner.\r\n        </p>\r\n        <Button variant=\"outline\" onClick={onExitPlayMode}>\r\n          <ArrowLeftIcon className=\"h-4 w-4 mr-2\" />\r\n          Tillbaka till session\r\n        </Button>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {/* Simplified 3-zone navigation */}\r\n      <div className=\"flex items-center justify-between border-b border-border pb-4\">\r\n        <div className=\"flex gap-1 rounded-lg bg-muted p-1\">\r\n          <Button\r\n            variant={activeZone === 'play' ? 'primary' : 'ghost'}\r\n            size=\"sm\"\r\n            onClick={() => setActiveZone('play')}\r\n            className=\"min-w-[80px]\"\r\n          >\r\n            <PlayIcon className=\"h-4 w-4 mr-1.5\" />\r\n            Spela\r\n          </Button>\r\n          <Button\r\n            variant={activeZone === 'content' ? 'primary' : 'ghost'}\r\n            size=\"sm\"\r\n            onClick={() => setActiveZone('content')}\r\n            className=\"min-w-[80px]\"\r\n          >\r\n            <CubeIcon className=\"h-4 w-4 mr-1.5\" />\r\n            Inneh├Ñll\r\n          </Button>\r\n          <Button\r\n            variant={activeZone === 'manage' ? 'primary' : 'ghost'}\r\n            size=\"sm\"\r\n            onClick={() => setActiveZone('manage')}\r\n            className=\"min-w-[80px]\"\r\n          >\r\n            <Cog6ToothIcon className=\"h-4 w-4 mr-1.5\" />\r\n            Hantera\r\n          </Button>\r\n        </div>\r\n        \r\n        {showExitButton && (\r\n          <Button variant=\"ghost\" size=\"sm\" onClick={onExitPlayMode}>\r\n            <ArrowLeftIcon className=\"h-4 w-4 mr-1\" />\r\n            Lobby\r\n          </Button>\r\n        )}\r\n      </div>\r\n\r\n      {/* Zone: Play - Main facilitator dashboard */}\r\n      {activeZone === 'play' && (\r\n        <FacilitatorDashboard\r\n          sessionId={sessionId}\r\n          gameTitle={playData.gameTitle}\r\n          steps={playData.steps}\r\n          phases={playData.phases}\r\n          initialState={playData.runtimeState}\r\n          triggers={triggers}\r\n          onStateUpdate={handleStateUpdate}\r\n          onTriggerAction={handleTriggerAction}\r\n          onEndSession={handleEndSession}\r\n          participantCount={participantCount}\r\n        />\r\n      )}\r\n\r\n      {/* Zone: Content - Artifacts, Decisions, Outcomes, Puzzles */}\r\n      {activeZone === 'content' && (\r\n        <div className=\"space-y-4\">\r\n          {/* Sub-tabs for content zone */}\r\n          <div className=\"flex gap-2 border-b border-border/50 pb-3\">\r\n            <Button\r\n              variant={contentSubTab === 'artifacts' ? 'outline' : 'ghost'}\r\n              size=\"sm\"\r\n              onClick={() => setContentSubTab('artifacts')}\r\n            >\r\n              <CubeIcon className=\"h-4 w-4 mr-1\" />\r\n              Artefakter\r\n            </Button>\r\n            <Button\r\n              variant={contentSubTab === 'puzzles' ? 'outline' : 'ghost'}\r\n              size=\"sm\"\r\n              onClick={() => setContentSubTab('puzzles')}\r\n            >\r\n              <PuzzlePieceIcon className=\"h-4 w-4 mr-1\" />\r\n              Pussel\r\n            </Button>\r\n            <Button\r\n              variant={contentSubTab === 'decisions' ? 'outline' : 'ghost'}\r\n              size=\"sm\"\r\n              onClick={() => setContentSubTab('decisions')}\r\n            >\r\n              <ScaleIcon className=\"h-4 w-4 mr-1\" />\r\n              Beslut\r\n            </Button>\r\n            <Button\r\n              variant={contentSubTab === 'outcome' ? 'outline' : 'ghost'}\r\n              size=\"sm\"\r\n              onClick={() => setContentSubTab('outcome')}\r\n            >\r\n              <FlagIcon className=\"h-4 w-4 mr-1\" />\r\n              Utfall\r\n            </Button>\r\n          </div>\r\n\r\n          {contentSubTab === 'artifacts' && <ArtifactsPanel sessionId={sessionId} />}\r\n          {contentSubTab === 'puzzles' && (\r\n            <div className=\"space-y-4\">\r\n              <PropConfirmationManager sessionId={sessionId} />\r\n              <PuzzleProgressPanel sessionId={sessionId} />\r\n            </div>\r\n          )}\r\n          {contentSubTab === 'decisions' && <DecisionsPanel sessionId={sessionId} />}\r\n          {contentSubTab === 'outcome' && <OutcomePanel sessionId={sessionId} />}\r\n        </div>\r\n      )}\r\n\r\n      {/* Zone: Manage - Roles, Settings */}\r\n      {activeZone === 'manage' && (\r\n        <div className=\"space-y-4\">\r\n          {/* Sub-tabs for manage zone */}\r\n          <div className=\"flex gap-2 border-b border-border/50 pb-3\">\r\n            <Button\r\n              variant={manageSubTab === 'roles' ? 'outline' : 'ghost'}\r\n              size=\"sm\"\r\n              onClick={() => setManageSubTab('roles')}\r\n            >\r\n              <UserGroupIcon className=\"h-4 w-4 mr-1\" />\r\n              Roller\r\n              {playData.sessionRoles.length > 0 && (\r\n                <span className=\"ml-1 text-xs opacity-75\">\r\n                  ({playData.sessionRoles.length})\r\n                </span>\r\n              )}\r\n            </Button>\r\n            <Button\r\n              variant={manageSubTab === 'settings' ? 'outline' : 'ghost'}\r\n              size=\"sm\"\r\n              onClick={() => setManageSubTab('settings')}\r\n            >\r\n              <Cog6ToothIcon className=\"h-4 w-4 mr-1\" />\r\n              Inst├ñllningar\r\n            </Button>\r\n          </div>\r\n\r\n          {manageSubTab === 'roles' && (\r\n            <RoleAssignerContainer\r\n              sessionId={sessionId}\r\n              sessionRoles={playData.sessionRoles}\r\n              onAssignmentComplete={handleRolesAssigned}\r\n            />\r\n          )}\r\n\r\n          {manageSubTab === 'settings' && (\r\n            <Card className=\"p-6\">\r\n              <h2 className=\"text-lg font-semibold mb-4\">Spelinst├ñllningar</h2>\r\n              <p className=\"text-muted-foreground\">\r\n                Inst├ñllningar f├Âr spelet kommer h├ñr i framtida versioner.\r\n              </p>\r\n              <ul className=\"mt-4 text-sm text-muted-foreground list-disc list-inside space-y-1\">\r\n                <li>Timer-inst├ñllningar</li>\r\n                <li>Automatisk stegframsteg</li>\r\n                <li>Ljudeffekter</li>\r\n                <li>Deltagarbegr├ñnsningar</li>\r\n              </ul>\r\n            </Card>\r\n          )}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\HostSessionWithPlay.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\LeaderScriptPanel.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":240,"column":49,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":241,"endColumn":25},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":365,"column":75,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":367,"endColumn":19}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * LeaderScriptPanel Component\r\n * \r\n * Displays multi-language leader script with language selector.\r\n * Shows current step/phase content with navigation.\r\n * \r\n * Backlog B.8: Multi-language leader script\r\n */\r\n\r\n'use client';\r\n\r\nimport React, { useState } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { ScrollArea } from '@/components/ui/scroll-area';\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from '@/components/ui/card';\r\nimport { Select } from '@/components/ui/select';\r\nimport {\r\n  Collapsible,\r\n  CollapsibleContent,\r\n  CollapsibleTrigger,\r\n} from '@/components/ui/collapsible';\r\nimport { Progress } from '@/components/ui/progress';\r\nimport {\r\n  BookOpenIcon,\r\n  GlobeAltIcon,\r\n  ChevronLeftIcon,\r\n  ChevronRightIcon,\r\n  ChevronDownIcon,\r\n  ChevronUpIcon,\r\n  ChatBubbleBottomCenterTextIcon,\r\n  BoltIcon,\r\n  DocumentTextIcon,\r\n  ExclamationCircleIcon,\r\n  CheckCircleIcon,\r\n  Bars3BottomLeftIcon,\r\n} from '@heroicons/react/24/outline';\r\nimport type {\r\n  SupportedLanguage,\r\n  LeaderScriptBlock,\r\n} from '@/lib/multi-language-script';\r\nimport {\r\n  BLOCK_TYPE_LABELS,\r\n  getLanguageInfo,\r\n} from '@/lib/multi-language-script';\r\nimport type { UseMultiLanguageScriptReturn } from '@/features/play/hooks/useMultiLanguageScript';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface LeaderScriptPanelProps {\r\n  /** Multi-language script hook return */\r\n  scriptHook: UseMultiLanguageScriptReturn;\r\n  /** Optional className */\r\n  className?: string;\r\n  /** Compact mode */\r\n  compact?: boolean;\r\n  /** Show navigation controls */\r\n  showNavigation?: boolean;\r\n  /** Show translation status */\r\n  showTranslationStatus?: boolean;\r\n  /** Max height for scroll area */\r\n  maxHeight?: number;\r\n}\r\n\r\n// =============================================================================\r\n// Constants\r\n// =============================================================================\r\n\r\nconst BLOCK_TYPE_ICONS: Record<LeaderScriptBlock['type'], React.ReactNode> = {\r\n  heading: <Bars3BottomLeftIcon className=\"h-4 w-4\" />,\r\n  instruction: <ExclamationCircleIcon className=\"h-4 w-4\" />,\r\n  dialogue: <ChatBubbleBottomCenterTextIcon className=\"h-4 w-4\" />,\r\n  action: <BoltIcon className=\"h-4 w-4\" />,\r\n  note: <DocumentTextIcon className=\"h-4 w-4\" />,\r\n  cue: <ExclamationCircleIcon className=\"h-4 w-4\" />,\r\n};\r\n\r\nconst BLOCK_TYPE_STYLES: Record<LeaderScriptBlock['type'], string> = {\r\n  heading: 'font-bold text-lg border-b pb-2 mb-2',\r\n  instruction: 'pl-4 border-l-2 border-primary',\r\n  dialogue: 'bg-muted/30 rounded-lg p-3 italic',\r\n  action: 'bg-yellow-500/10 rounded-lg p-3 font-medium',\r\n  note: 'bg-blue-500/10 rounded-lg p-3 text-sm',\r\n  cue: 'bg-red-500/10 rounded-lg p-3',\r\n};\r\n\r\n// =============================================================================\r\n// Sub-Component: LanguageSelector\r\n// =============================================================================\r\n\r\ninterface LanguageSelectorProps {\r\n  language: SupportedLanguage;\r\n  availableLanguages: SupportedLanguage[];\r\n  onLanguageChange: (lang: SupportedLanguage) => void;\r\n  translationComplete?: boolean;\r\n}\r\n\r\nfunction LanguageSelector({\r\n  language,\r\n  availableLanguages,\r\n  onLanguageChange,\r\n  translationComplete,\r\n}: LanguageSelectorProps) {\r\n  const _currentLang = getLanguageInfo(language);\r\n  \r\n  const options = availableLanguages.map((code) => {\r\n    const lang = getLanguageInfo(code);\r\n    return {\r\n      value: code,\r\n      label: lang ? `${lang.flag} ${lang.nativeName}` : code,\r\n    };\r\n  });\r\n\r\n  return (\r\n    <div className=\"flex items-center gap-2\">\r\n      <GlobeAltIcon className=\"h-4 w-4 text-muted-foreground\" />\r\n      <Select\r\n        options={options}\r\n        value={language}\r\n        onChange={(e) => onLanguageChange(e.target.value as SupportedLanguage)}\r\n        className=\"w-[140px] h-8\"\r\n      />\r\n      {translationComplete !== undefined && (\r\n        translationComplete ? (\r\n          <CheckCircleIcon className=\"h-4 w-4 text-green-500\" />\r\n        ) : (\r\n          <ExclamationCircleIcon className=\"h-4 w-4 text-yellow-500\" />\r\n        )\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: PhaseNavigation\r\n// =============================================================================\r\n\r\ninterface PhaseNavigationProps {\r\n  currentPhase: 'intro' | 'main' | 'outro';\r\n  onPhaseChange: (phase: 'intro' | 'main' | 'outro') => void;\r\n  language: SupportedLanguage;\r\n}\r\n\r\nfunction PhaseNavigation({ currentPhase, onPhaseChange, language }: PhaseNavigationProps) {\r\n  const phases: ('intro' | 'main' | 'outro')[] = ['intro', 'main', 'outro'];\r\n  const labels: Record<string, Record<string, string>> = {\r\n    intro: { sv: 'Intro', en: 'Intro' },\r\n    main: { sv: 'Huvud', en: 'Main' },\r\n    outro: { sv: 'Avslut', en: 'Outro' },\r\n  };\r\n\r\n  return (\r\n    <div className=\"flex gap-1\">\r\n      {phases.map((phase) => (\r\n        <Button\r\n          key={phase}\r\n          variant={currentPhase === phase ? 'default' : 'ghost'}\r\n          size=\"sm\"\r\n          onClick={() => onPhaseChange(phase)}\r\n          className=\"flex-1\"\r\n        >\r\n          {labels[phase][language] ?? labels[phase]['sv']}\r\n        </Button>\r\n      ))}\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: ScriptBlock\r\n// =============================================================================\r\n\r\ninterface ScriptBlockProps {\r\n  block: LeaderScriptBlock;\r\n  text: string;\r\n  language: SupportedLanguage;\r\n  compact?: boolean;\r\n}\r\n\r\nfunction ScriptBlock({ block, text, language, compact }: ScriptBlockProps) {\r\n  const icon = BLOCK_TYPE_ICONS[block.type];\r\n  const style = BLOCK_TYPE_STYLES[block.type];\r\n  const typeLabel = BLOCK_TYPE_LABELS[block.type][language] ?? BLOCK_TYPE_LABELS[block.type]['sv'];\r\n\r\n  return (\r\n    <div className={`${style} ${compact ? 'py-1' : 'py-2'}`}>\r\n      {/* Header for non-heading types */}\r\n      {block.type !== 'heading' && (\r\n        <div className=\"flex items-center gap-2 mb-1\">\r\n          {icon}\r\n          <span className=\"text-xs text-muted-foreground uppercase tracking-wide\">\r\n            {typeLabel}\r\n          </span>\r\n          {block.timing && (\r\n            <Badge variant=\"outline\" className=\"text-xs ml-auto\">\r\n              {block.timing}\r\n            </Badge>\r\n          )}\r\n          {block.speaker && (\r\n            <Badge variant=\"outline\" className=\"text-xs\">\r\n              {block.speaker}\r\n            </Badge>\r\n          )}\r\n        </div>\r\n      )}\r\n\r\n      {/* Content */}\r\n      <div className={block.type === 'heading' ? 'flex items-center gap-2' : ''}>\r\n        {block.type === 'heading' && icon}\r\n        <span>{text || <span className=\"text-muted-foreground italic\">Ingen text</span>}</span>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: TranslationStatusBar\r\n// =============================================================================\r\n\r\ninterface TranslationStatusBarProps {\r\n  completion: number;\r\n  language: SupportedLanguage;\r\n}\r\n\r\nfunction TranslationStatusBar({ completion, language }: TranslationStatusBarProps) {\r\n  const langInfo = getLanguageInfo(language);\r\n  const isComplete = completion === 1;\r\n\r\n  return (\r\n    <div className=\"space-y-1\">\r\n      <div className=\"flex items-center justify-between text-xs\">\r\n        <span className=\"text-muted-foreground\">\r\n          ├ûvers├ñttning ({langInfo?.nativeName})\r\n        </span>\r\n        <span className={isComplete ? 'text-green-500' : 'text-yellow-500'}>\r\n          {Math.round(completion * 100)}%\r\n        </span>\r\n      </div>\r\n      <Progress value={completion * 100} className=\"h-1\" />\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function LeaderScriptPanel({\r\n  scriptHook,\r\n  className,\r\n  compact = false,\r\n  showNavigation = true,\r\n  showTranslationStatus = true,\r\n  maxHeight = 400,\r\n}: LeaderScriptPanelProps) {\r\n  const [isExpanded, setIsExpanded] = useState(true);\r\n\r\n  const {\r\n    language,\r\n    setLanguage,\r\n    availableLanguages,\r\n    currentStepIndex,\r\n    currentPhase,\r\n    goToPhase,\r\n    nextStep,\r\n    prevStep,\r\n    content,\r\n    gameTitle,\r\n    translationStatus,\r\n    isTranslationComplete,\r\n  } = scriptHook;\r\n\r\n  return (\r\n    <Card className={className}>\r\n      <Collapsible open={isExpanded} onOpenChange={setIsExpanded}>\r\n        <CardHeader className={compact ? 'pb-2' : 'pb-3'}>\r\n          <div className=\"flex items-center justify-between\">\r\n            <CollapsibleTrigger asChild>\r\n              <button className=\"flex items-center gap-2 hover:opacity-80\">\r\n                <BookOpenIcon className=\"h-5 w-5\" />\r\n                <CardTitle className=\"text-base\">Spelledarens manus</CardTitle>\r\n                {isExpanded ? (\r\n                  <ChevronUpIcon className=\"h-4 w-4 text-muted-foreground\" />\r\n                ) : (\r\n                  <ChevronDownIcon className=\"h-4 w-4 text-muted-foreground\" />\r\n                )}\r\n              </button>\r\n            </CollapsibleTrigger>\r\n            <LanguageSelector\r\n              language={language}\r\n              availableLanguages={availableLanguages}\r\n              onLanguageChange={setLanguage}\r\n              translationComplete={isTranslationComplete}\r\n            />\r\n          </div>\r\n          {!compact && (\r\n            <CardDescription>\r\n              {gameTitle} ┬À Steg {currentStepIndex + 1}\r\n            </CardDescription>\r\n          )}\r\n        </CardHeader>\r\n\r\n        <CollapsibleContent>\r\n          <CardContent className=\"space-y-3\">\r\n            {/* Step header */}\r\n            <div className=\"flex items-center justify-between\">\r\n              <h3 className=\"font-semibold\">{content.stepName}</h3>\r\n              {showNavigation && (\r\n                <div className=\"flex gap-1\">\r\n                  <Button\r\n                    variant=\"ghost\"\r\n                    size=\"sm\"\r\n                    onClick={prevStep}\r\n                    disabled={currentStepIndex === 0}\r\n                    className=\"h-8 w-8 p-0\"\r\n                  >\r\n                    <ChevronLeftIcon className=\"h-4 w-4\" />\r\n                  </Button>\r\n                  <Button\r\n                    variant=\"ghost\"\r\n                    size=\"sm\"\r\n                    onClick={nextStep}\r\n                    className=\"h-8 w-8 p-0\"\r\n                  >\r\n                    <ChevronRightIcon className=\"h-4 w-4\" />\r\n                  </Button>\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {/* Phase navigation */}\r\n            <PhaseNavigation\r\n              currentPhase={currentPhase}\r\n              onPhaseChange={goToPhase}\r\n              language={language}\r\n            />\r\n\r\n            {/* Phase title */}\r\n            <h4 className=\"text-sm font-medium text-muted-foreground\">\r\n              {content.phaseTitle}\r\n            </h4>\r\n\r\n            {/* Content blocks */}\r\n            <ScrollArea maxHeight={`${maxHeight}px`}>\r\n              <div className=\"space-y-3 pr-3\">\r\n                {content.blocks.length > 0 ? (\r\n                  content.blocks.map((block) => (\r\n                    <ScriptBlock\r\n                      key={block.id}\r\n                      block={block}\r\n                      text={content.getBlockText(block)}\r\n                      language={language}\r\n                      compact={compact}\r\n                    />\r\n                  ))\r\n                ) : (\r\n                  <div className=\"text-center text-muted-foreground py-8\">\r\n                    Inget inneh├Ñll i denna fas\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </ScrollArea>\r\n\r\n            {/* Translation status */}\r\n            {showTranslationStatus && translationStatus && (\r\n              <TranslationStatusBar\r\n                completion={translationStatus.completionRate}\r\n                language={language}\r\n              />\r\n            )}\r\n          </CardContent>\r\n        </CollapsibleContent>\r\n      </Collapsible>\r\n    </Card>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Compact Script Line\r\n// =============================================================================\r\n\r\nexport interface CompactScriptLineProps {\r\n  scriptHook: UseMultiLanguageScriptReturn;\r\n  className?: string;\r\n}\r\n\r\nexport function CompactScriptLine({\r\n  scriptHook,\r\n  className,\r\n}: CompactScriptLineProps) {\r\n  const { content, currentPhase } = scriptHook;\r\n  \r\n  // Get first non-empty block\r\n  const firstBlock = content.blocks[0];\r\n  const text = firstBlock ? content.getBlockText(firstBlock) : '';\r\n\r\n  return (\r\n    <div className={`flex items-center gap-2 text-sm ${className}`}>\r\n      <BookOpenIcon className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\r\n      <div className=\"flex-1 truncate\">\r\n        {text || <span className=\"text-muted-foreground\">Inget manus</span>}\r\n      </div>\r\n      <Badge variant=\"outline\" className=\"flex-shrink-0\">\r\n        {currentPhase}\r\n      </Badge>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\NavigationControls.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":68,"column":64,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":70,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":76,"column":14,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":78,"endColumn":15}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { CheckIcon, ChevronLeftIcon, ChevronRightIcon } from \"@heroicons/react/24/outline\";\nimport { Button } from \"@/components/ui/button\";\n\ntype NavigationControlsProps = {\n  current: number;\n  total: number;\n  onPrev: () => void;\n  onNext: () => void;\n  onEnd?: () => void;\n  progress?: number; // 0-1\n};\n\nexport function NavigationControls({ current, total, onPrev, onNext, onEnd, progress }: NavigationControlsProps) {\n  const isFirst = current === 0;\n  const isLast = current === total - 1;\n\n  return (\n    <div \n      className=\"fixed inset-x-0 z-30 px-4 lg:bottom-6\" \n      style={{ bottom: \"calc(72px + env(safe-area-inset-bottom, 0px))\" }}\n    >\n      <div className=\"mx-auto flex max-w-5xl flex-col gap-3 rounded-2xl border border-border/50 bg-card/98 p-4 shadow-xl backdrop-blur-xl\">\n        {/* Progress section */}\n        <div className=\"flex items-center justify-between gap-4\">\n          <div className=\"flex items-center gap-2\">\n            {/* Step dots */}\n            <div className=\"flex items-center gap-1\">\n              {Array.from({ length: total }).map((_, i) => (\n                <span\n                  key={i}\n                  className={`h-2 w-2 rounded-full transition-all ${\n                    i === current \n                      ? \"bg-primary scale-125\" \n                      : i < current \n                        ? \"bg-primary/40\" \n                        : \"bg-muted\"\n                  }`}\n                  aria-hidden\n                />\n              ))}\n            </div>\n          </div>\n          <span className=\"text-xs font-medium text-muted-foreground\">\n            Steg {current + 1} av {total}\n          </span>\n        </div>\n\n        {/* Progress bar */}\n        {typeof progress === \"number\" && (\n          <div className=\"h-1 w-full overflow-hidden rounded-full bg-muted\">\n            <div\n              className=\"h-full rounded-full bg-primary transition-all duration-300 ease-out\"\n              style={{ width: `${Math.min(1, Math.max(0, progress)) * 100}%` }}\n              aria-hidden\n            />\n          </div>\n        )}\n\n        {/* Navigation buttons */}\n        <div className=\"flex items-center gap-3\">\n          <Button \n            variant=\"outline\" \n            size=\"lg\" \n            onClick={onPrev} \n            disabled={isFirst}\n            className=\"h-12 flex-1 gap-2 text-sm font-medium transition-all active:scale-95 disabled:opacity-40\"\n          >\n            <ChevronLeftIcon className=\"h-4 w-4\" aria-hidden />\n            F├Âreg├Ñende\n          </Button>\n          {!isLast ? (\n            <Button \n              size=\"lg\" \n              onClick={onNext}\n              className=\"h-12 flex-1 gap-2 text-sm font-medium shadow-lg shadow-primary/20 transition-all active:scale-95\"\n            >\n              N├ñsta\n              <ChevronRightIcon className=\"h-4 w-4\" aria-hidden />\n            </Button>\n          ) : (\n            <Button \n              size=\"lg\" \n              onClick={onEnd}\n              className=\"h-12 flex-1 gap-2 bg-green-600 text-sm font-medium shadow-lg shadow-green-600/20 transition-all hover:bg-green-700 active:scale-95\"\n            >\n              <CheckIcon className=\"h-4 w-4\" aria-hidden />\n              Avsluta\n            </Button>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\OutcomePanel.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":93,"column":54,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":93,"endColumn":68},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":103,"column":56,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":103,"endColumn":94},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":131,"column":56,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":133,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":134,"column":56,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":136,"endColumn":11}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useCallback, useEffect, useState } from 'react';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Textarea } from '@/components/ui/textarea';\r\nimport { Badge } from '@/components/ui/badge';\r\n\r\ntype Outcome = {\r\n  id: string;\r\n  title: string;\r\n  body?: string | null;\r\n  outcome_type?: string | null;\r\n  revealed_at?: string | null;\r\n};\r\n\r\nexport function OutcomePanel({ sessionId }: { sessionId: string }) {\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [outcomes, setOutcomes] = useState<Outcome[]>([]);\r\n\r\n  const [title, setTitle] = useState('');\r\n  const [body, setBody] = useState('');\r\n\r\n  const load = useCallback(async () => {\r\n    setLoading(true);\r\n    setError(null);\r\n    try {\r\n      const res = await fetch(`/api/play/sessions/${sessionId}/outcome`, { cache: 'no-store' });\r\n      const data = await res.json();\r\n      if (!res.ok) throw new Error(data.error || 'Kunde inte ladda utfall');\r\n      setOutcomes(data.outcomes || []);\r\n    } catch (e) {\r\n      setError(e instanceof Error ? e.message : 'Kunde inte ladda utfall');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [sessionId]);\r\n\r\n  useEffect(() => {\r\n    void load();\r\n  }, [load]);\r\n\r\n  const createOutcome = useCallback(async () => {\r\n    setError(null);\r\n    const t = title.trim();\r\n    if (!t) {\r\n      setError('Titel kr├ñvs');\r\n      return;\r\n    }\r\n\r\n    const res = await fetch(`/api/play/sessions/${sessionId}/outcome`, {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({ action: 'set', title: t, body: body.trim() || null }),\r\n    });\r\n\r\n    const data = await res.json().catch(() => ({}));\r\n    if (!res.ok) {\r\n      setError(data.error || 'Kunde inte skapa utfall');\r\n      return;\r\n    }\r\n\r\n    setTitle('');\r\n    setBody('');\r\n    await load();\r\n  }, [sessionId, title, body, load]);\r\n\r\n  const toggleReveal = useCallback(\r\n    async (outcomeId: string, reveal: boolean) => {\r\n      setError(null);\r\n      const res = await fetch(`/api/play/sessions/${sessionId}/outcome`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ action: reveal ? 'reveal' : 'hide', outcomeId }),\r\n      });\r\n\r\n      const data = await res.json().catch(() => ({}));\r\n      if (!res.ok) {\r\n        setError(data.error || 'Kunde inte uppdatera utfall');\r\n        return;\r\n      }\r\n\r\n      await load();\r\n    },\r\n    [sessionId, load]\r\n  );\r\n\r\n  if (loading) {\r\n    return (\r\n      <Card className=\"p-6\">\r\n        <p className=\"text-sm text-muted-foreground\">Laddar utfallÔÇª</p>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <Card className=\"p-6 space-y-4\">\r\n        <div>\r\n          <h2 className=\"text-lg font-semibold\">Utfall</h2>\r\n          <p className=\"text-sm text-muted-foreground\">Skriv ett utfall och reveal p├Ñ tavlan.</p>\r\n        </div>\r\n\r\n        {error && <p className=\"text-sm text-destructive\">{error}</p>}\r\n\r\n        <div className=\"grid gap-3\">\r\n          <div>\r\n            <label className=\"text-sm font-medium\">Titel</label>\r\n            <Input value={title} onChange={(e) => setTitle(e.target.value)} placeholder=\"Ex: Domen faller\" />\r\n          </div>\r\n          <div>\r\n            <label className=\"text-sm font-medium\">Text</label>\r\n            <Textarea value={body} onChange={(e) => setBody(e.target.value)} rows={4} placeholder=\"Valfri beskrivningÔÇª\" />\r\n          </div>\r\n          <div className=\"flex justify-end\">\r\n            <Button onClick={createOutcome}>Skapa utfall</Button>\r\n          </div>\r\n        </div>\r\n      </Card>\r\n\r\n      {outcomes.length === 0 ? (\r\n        <Card className=\"p-6 text-center space-y-3\">\r\n          <div className=\"mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-muted\">\r\n            <svg className=\"h-6 w-6 text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z\" />\r\n            </svg>\r\n          </div>\r\n          <h3 className=\"text-base font-semibold text-foreground\">Inga utfall registrerade</h3>\r\n          <p className=\"text-sm text-muted-foreground\">\r\n            Anv├ñnd formul├ñret ovan f├Âr att dokumentera vad som h├ñnde under sessionen.\r\n          </p>\r\n          <p className=\"text-xs text-muted-foreground\">\r\n            Utfall kan visas f├Âr deltagare som en sammanfattning/debrief i slutet av sessionen.\r\n          </p>\r\n        </Card>\r\n      ) : (\r\n        outcomes.map((o) => (\r\n          <Card key={o.id} className=\"p-6 space-y-3\">\r\n            <div className=\"flex flex-wrap items-center justify-between gap-2\">\r\n              <div>\r\n                <h3 className=\"font-medium\">{o.title}</h3>\r\n                {o.body && <p className=\"text-sm text-muted-foreground whitespace-pre-wrap\">{o.body}</p>}\r\n              </div>\r\n              <Badge variant=\"secondary\">{o.revealed_at ? 'revealed' : 'hidden'}</Badge>\r\n            </div>\r\n            <div>\r\n              <Button\r\n                size=\"sm\"\r\n                variant={o.revealed_at ? 'outline' : 'primary'}\r\n                onClick={() => toggleReveal(o.id, !o.revealed_at)}\r\n              >\r\n                {o.revealed_at ? 'D├Âlj' : 'Reveal'}\r\n              </Button>\r\n            </div>\r\n          </Card>\r\n        ))\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\ParticipantPlayMode.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":93,"column":46,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":93,"endColumn":73},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":107,"column":52,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":107,"endColumn":71},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":108,"column":46,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":110,"endColumn":9}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Participant Play Mode Component\r\n * \r\n * Integrates ParticipantPlayView with the participant session client.\r\n * Shows game content when session is active and has a game linked.\r\n */\r\n\r\n'use client';\r\n\r\nimport { useState, useEffect, useCallback } from 'react';\r\nimport { ParticipantPlayView } from './ParticipantPlayView';\r\nimport { getParticipantPlaySession, type ParticipantPlayData } from '../api';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Skeleton } from '@/components/ui/skeleton';\r\nimport { ClockIcon } from '@heroicons/react/24/outline';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface ParticipantPlayModeProps {\r\n  /** Session code */\r\n  sessionCode: string;\r\n  /** Participant token from storage */\r\n  participantToken: string;\r\n  /** Whether to show role card */\r\n  showRole?: boolean;\r\n}\r\n\r\n// =============================================================================\r\n// Component\r\n// =============================================================================\r\n\r\nexport function ParticipantPlayMode({\r\n  sessionCode,\r\n  participantToken,\r\n  showRole = true,\r\n}: ParticipantPlayModeProps) {\r\n  // Data state\r\n  const [playData, setPlayData] = useState<ParticipantPlayData | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  // Load play data\r\n  const loadData = useCallback(async () => {\r\n    try {\r\n      const data = await getParticipantPlaySession(sessionCode, participantToken);\r\n      if (data) {\r\n        setPlayData(data);\r\n        setError(null);\r\n      } else {\r\n        setError('Kunde inte ladda speldata');\r\n      }\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : 'Ett fel uppstod');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [sessionCode, participantToken]);\r\n\r\n  useEffect(() => {\r\n    void loadData();\r\n    \r\n    // Refresh every 30 seconds to get updated state\r\n    const interval = setInterval(() => void loadData(), 30000);\r\n    return () => clearInterval(interval);\r\n  }, [loadData]);\r\n\r\n  // Loading state\r\n  if (loading) {\r\n    return (\r\n      <div className=\"max-w-2xl mx-auto space-y-4 px-4\">\r\n        <Skeleton className=\"h-8 w-48\" />\r\n        <Skeleton className=\"h-64 w-full\" />\r\n        <Skeleton className=\"h-24 w-full\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Error state\r\n  if (error) {\r\n    return (\r\n      <Card className=\"max-w-md mx-auto p-6 text-center\">\r\n        <p className=\"text-destructive\">{error}</p>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // No data\r\n  if (!playData) {\r\n    return (\r\n      <Card className=\"max-w-md mx-auto p-6 text-center\">\r\n        <p className=\"text-muted-foreground\">Ingen speldata tillg├ñnglig.</p>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // No game linked - show waiting message\r\n  if (!playData.gameId || playData.steps.length === 0) {\r\n    return (\r\n      <Card className=\"max-w-md mx-auto p-8 text-center\">\r\n        <div className=\"flex justify-center mb-4\">\r\n          <div className=\"h-12 w-12 rounded-full bg-primary/10 flex items-center justify-center\">\r\n            <ClockIcon className=\"h-6 w-6 text-primary\" />\r\n          </div>\r\n        </div>\r\n        <h2 className=\"text-lg font-semibold mb-2\">V├ñntar p├Ñ aktivitet</h2>\r\n        <p className=\"text-muted-foreground\">\r\n          Spelinneh├Ñll visas h├ñr n├ñr v├ñrden startar.\r\n        </p>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // Build role for ParticipantPlayView (must match RoleCardData interface)\r\n  const role = playData.assignedRole\r\n    ? {\r\n        id: playData.assignedRole.id,\r\n        name: playData.assignedRole.name,\r\n        icon: playData.assignedRole.icon,\r\n        color: playData.assignedRole.color,\r\n        public_description: playData.assignedRole.public_description,\r\n        private_instructions: playData.assignedRole.private_instructions,\r\n        private_hints: playData.assignedRole.private_hints,\r\n      }\r\n    : undefined;\r\n\r\n  return (\r\n    <ParticipantPlayView\r\n      sessionId={playData.sessionId}\r\n      sessionCode={sessionCode}\r\n      gameTitle={playData.gameTitle}\r\n      steps={playData.steps.map((s) => ({\r\n        ...s,\r\n        display_mode: s.display_mode ?? undefined,\r\n      }))}\r\n      phases={playData.phases}\r\n      role={role}\r\n      initialState={playData.runtimeState}\r\n      participantName={playData.participantName}\r\n      participantId={playData.participantId}\r\n      isNextStarter={playData.isNextStarter}\r\n      participantToken={participantToken}\r\n      showRole={showRole && !!role}\r\n      secretRoleRevealedAt={playData.secretRoleRevealedAt}\r\n      boardTheme={playData.boardTheme}\r\n      tools={playData.tools}\r\n    />\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\ParticipantPlayView.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 't'. Either include it or remove the dependency array.","line":317,"column":6,"nodeType":"ArrayExpression","endLine":317,"endColumn":35,"suggestions":[{"desc":"Update the dependencies array to be: [participantToken, sessionId, t]","fix":{"range":[12101,12130],"text":"[participantToken, sessionId, t]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 't'. Either include it or remove the dependency array.","line":348,"column":6,"nodeType":"ArrayExpression","endLine":348,"endColumn":35,"suggestions":[{"desc":"Update the dependencies array to be: [participantToken, sessionId, t]","fix":{"range":[13219,13248],"text":"[participantToken, sessionId, t]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 't'. Either include it or remove the dependency array.","line":382,"column":6,"nodeType":"ArrayExpression","endLine":382,"endColumn":50,"suggestions":[{"desc":"Update the dependencies array to be: [participantToken, sessionId, loadArtifacts, t]","fix":{"range":[14626,14670],"text":"[participantToken, sessionId, loadArtifacts, t]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 't'. Either include it or remove the dependency array.","line":540,"column":6,"nodeType":"ArrayExpression","endLine":540,"endColumn":37,"suggestions":[{"desc":"Update the dependencies array to be: [participantToken, sessionCode, t]","fix":{"range":[20419,20450],"text":"[participantToken, sessionCode, t]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 't'. Either include it or remove the dependency array.","line":568,"column":6,"nodeType":"ArrayExpression","endLine":568,"endColumn":66,"suggestions":[{"desc":"Update the dependencies array to be: [participantToken, role, steps, currentStepIndex, t, sessionId]","fix":{"range":[21228,21288],"text":"[participantToken, role, steps, currentStepIndex, t, sessionId]"}}]}],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":1189,"column":17,"nodeType":"JSXOpeningElement","endLine":1193,"endColumn":19,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * ParticipantPlayView Component\r\n * \r\n * Main view for participants during a play session.\r\n * Shows current step, timer, role info, and board messages.\r\n */\r\n\r\n'use client';\r\n\r\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\r\nimport { useTranslations } from 'next-intl';\r\nimport {\r\n  ClockIcon,\r\n  PauseCircleIcon,\r\n  CheckCircleIcon,\r\n  ExclamationTriangleIcon,\r\n  SignalIcon,\r\n  SignalSlashIcon,\r\n  ChatBubbleBottomCenterTextIcon,\r\n} from '@heroicons/react/24/solid';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { CountdownOverlay, StoryOverlay, TypewriterText, type TypewriterSpeed } from '@/components/play';\r\nimport { useLiveSession } from '@/features/play/hooks/useLiveSession';\r\nimport { useLiveTimer } from '@/features/play/hooks/useLiveSession';\r\nimport { ParticipantSignalMicroUI } from '@/features/play/components/ParticipantSignalMicroUI';\r\nimport { ParticipantTimeBankDisplay } from '@/features/play/components/ParticipantTimeBankDisplay';\r\nimport { isFeatureEnabled } from '@/lib/config/env';\r\nimport { Toolbelt } from '@/features/tools/components/Toolbelt';\r\nimport { formatTime, getTrafficLightColor } from '@/lib/utils/timer-utils';\r\nimport { RoleCard, type RoleCardData } from './RoleCard';\r\nimport type { TimerState, SessionRuntimeState, SignalReceivedBroadcast } from '@/types/play-runtime';\r\nimport type { BoardTheme } from '@/types/games';\r\nimport { sendSessionChatMessage } from '@/features/play/api/chat-api';\r\nimport { PuzzleArtifactRenderer } from '@/features/play/components/PuzzleArtifactRenderer';\r\nimport { ConversationCardsCollectionArtifact } from '@/features/play/components/ConversationCardsCollectionArtifact';\r\nimport {\r\n  getParticipantArtifacts,\r\n  getParticipantDecisions,\r\n  castParticipantVote,\r\n  getParticipantDecisionResults,\r\n  submitKeypadCode,\r\n  type ParticipantSessionArtifact,\r\n  type ParticipantSessionArtifactVariant,\r\n  type ParticipantDecision,\r\n  type DecisionResultsResponse,\r\n  type SanitizedKeypadMetadata,\r\n} from '@/features/play/api';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface StepData {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  durationMinutes?: number;\r\n  media?: { type: string; url: string; altText?: string };\r\n  materials?: string[];\r\n  safety?: string;\r\n  tag?: string;\r\n  note?: string;\r\n  display_mode?: 'instant' | 'typewriter' | 'dramatic';\r\n}\r\n\r\nexport interface PhaseData {\r\n  name: string;\r\n  description?: string;\r\n  duration?: number | null;\r\n}\r\n\r\nexport interface ParticipantPlayViewProps {\r\n  /** Session ID */\r\n  sessionId: string;\r\n  /** Session code (needed for token-auth participant endpoints) */\r\n  sessionCode?: string;\r\n  /** Game title */\r\n  gameTitle: string;\r\n  /** Steps data */\r\n  steps: StepData[];\r\n  /** Phases data */\r\n  phases?: PhaseData[];\r\n  /** Participant's assigned role (if any) */\r\n  role?: RoleCardData;\r\n  /** Initial state from server */\r\n  initialState?: Partial<SessionRuntimeState>;\r\n  /** Participant name */\r\n  participantName?: string;\r\n  /** Participant id (used for turn indicator) */\r\n  participantId?: string;\r\n  /** Initial next-starter state from server */\r\n  isNextStarter?: boolean;\r\n  /** Participant token (used for chat API) */\r\n  participantToken?: string;\r\n  tools?: Array<{ tool_key: string; enabled?: boolean; scope?: string }>;\r\n  /** Whether to show role card */\r\n  showRole?: boolean;\r\n  /** When this participant revealed their secret role instructions */\r\n  secretRoleRevealedAt?: string | null;\r\n  /** Board theme (from game board config) */\r\n  boardTheme?: BoardTheme;\r\n}\r\n\r\nfunction getThemeAccentClasses(theme?: BoardTheme) {\r\n  switch (theme) {\r\n    case 'mystery':\r\n      return { label: 'text-slate-200', badge: 'bg-slate-800 text-slate-50' };\r\n    case 'party':\r\n      return { label: 'text-pink-600', badge: 'bg-pink-600 text-white' };\r\n    case 'sport':\r\n      return { label: 'text-green-600', badge: 'bg-green-600 text-white' };\r\n    case 'nature':\r\n      return { label: 'text-emerald-700', badge: 'bg-emerald-700 text-white' };\r\n    case 'neutral':\r\n    default:\r\n      return { label: 'text-primary', badge: 'bg-primary text-primary-foreground' };\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// Sub-components\r\n// =============================================================================\r\n\r\ninterface TimerDisplayProps {\r\n  timerState: TimerState | null;\r\n  translations: {\r\n    paused: string;\r\n    timeUp: string;\r\n    timeRemaining: string;\r\n  };\r\n}\r\n\r\nfunction TimerDisplay({ timerState, translations }: TimerDisplayProps) {\r\n  const display = useLiveTimer({ timerState });\r\n  \r\n  if (!timerState) {\r\n    return null;\r\n  }\r\n  \r\n  const trafficColor = getTrafficLightColor(display);\r\n  \r\n  const colorClasses = {\r\n    green: 'text-green-500 bg-green-50 border-green-200',\r\n    yellow: 'text-yellow-500 bg-yellow-50 border-yellow-200',\r\n    red: 'text-red-500 bg-red-50 border-red-200',\r\n  };\r\n  \r\n  const progressColorClasses = {\r\n    green: 'bg-green-500',\r\n    yellow: 'bg-yellow-500',\r\n    red: 'bg-red-500',\r\n  };\r\n\r\n  return (\r\n    <div className={`rounded-2xl border-2 p-4 ${colorClasses[trafficColor]}`}>\r\n      <div className=\"flex items-center justify-between\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <ClockIcon className=\"h-5 w-5\" />\r\n          <span className=\"text-sm font-medium\">\r\n            {display.isPaused ? translations.paused : display.isFinished ? translations.timeUp : translations.timeRemaining}\r\n          </span>\r\n        </div>\r\n        <span className=\"font-mono text-2xl font-bold tabular-nums\">\r\n          {formatTime(display.remaining)}\r\n        </span>\r\n      </div>\r\n      \r\n      {/* Progress bar */}\r\n      <div className=\"mt-3 h-2 overflow-hidden rounded-full bg-white/50\">\r\n        <div\r\n          className={`h-full rounded-full transition-all duration-300 ${progressColorClasses[trafficColor]}`}\r\n          style={{ width: `${(1 - display.progress) * 100}%` }}\r\n        />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\ninterface StatusIndicatorProps {\r\n  status: SessionRuntimeState['status'];\r\n  connected: boolean;\r\n  translations: {\r\n    active: string;\r\n    paused: string;\r\n    ended: string;\r\n    cancelled: string;\r\n    live: string;\r\n    offline: string;\r\n  };\r\n}\r\n\r\nfunction StatusIndicator({ status, connected, translations }: StatusIndicatorProps) {\r\n  const statusConfig = {\r\n    active: { icon: SignalIcon, text: translations.active, color: 'text-green-500' },\r\n    paused: { icon: PauseCircleIcon, text: translations.paused, color: 'text-yellow-500' },\r\n    ended: { icon: CheckCircleIcon, text: translations.ended, color: 'text-gray-500' },\r\n    cancelled: { icon: ExclamationTriangleIcon, text: translations.cancelled, color: 'text-red-500' },\r\n  };\r\n  \r\n  const config = statusConfig[status];\r\n  const Icon = config.icon;\r\n  \r\n  return (\r\n    <div className=\"flex items-center gap-3\">\r\n      <Badge variant={connected ? 'default' : 'destructive'} className=\"gap-1\">\r\n        {connected ? (\r\n          <SignalIcon className=\"h-3 w-3\" />\r\n        ) : (\r\n          <SignalSlashIcon className=\"h-3 w-3\" />\r\n        )}\r\n        {connected ? translations.live : translations.offline}\r\n      </Badge>\r\n      \r\n      <div className={`flex items-center gap-1 ${config.color}`}>\r\n        <Icon className=\"h-4 w-4\" />\r\n        <span className=\"text-sm font-medium\">{config.text}</span>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\ninterface BoardMessageProps {\r\n  message?: string;\r\n}\r\n\r\nfunction BoardMessage({ message }: BoardMessageProps) {\r\n  if (!message) return null;\r\n  \r\n  return (\r\n    <Card className=\"border-2 border-primary/20 bg-primary/5 p-4\">\r\n      <div className=\"flex items-start gap-3\">\r\n        <ChatBubbleBottomCenterTextIcon className=\"mt-0.5 h-5 w-5 shrink-0 text-primary\" />\r\n        <p className=\"text-sm font-medium text-foreground\">{message}</p>\r\n      </div>\r\n    </Card>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function ParticipantPlayView({\r\n  sessionId,\r\n  sessionCode,\r\n  gameTitle,\r\n  steps,\r\n  phases = [],\r\n  role,\r\n  initialState,\r\n  participantName,\r\n  participantId,\r\n  isNextStarter: initialIsNextStarter,\r\n  participantToken,\r\n  tools: _tools,\r\n  showRole = true,\r\n  secretRoleRevealedAt,\r\n  boardTheme,\r\n}: ParticipantPlayViewProps) {\r\n  // --------------------------------------------------------------------------\r\n  // i18n\r\n  // --------------------------------------------------------------------------\r\n  const t = useTranslations('play.participantView');\r\n\r\n  // --------------------------------------------------------------------------\r\n  // Primitives (participant): Artifacts + Decisions\r\n  // --------------------------------------------------------------------------\r\n\r\n  const [artifacts, setArtifacts] = useState<ParticipantSessionArtifact[]>([]);\r\n  const [artifactVariants, setArtifactVariants] = useState<ParticipantSessionArtifactVariant[]>([]);\r\n  const [artifactsError, setArtifactsError] = useState<string | null>(null);\r\n\r\n  const [decisions, setDecisions] = useState<ParticipantDecision[]>([]);\r\n  const [decisionsError, setDecisionsError] = useState<string | null>(null);\r\n  const [selectedOptionByDecisionId, setSelectedOptionByDecisionId] = useState<Record<string, string>>({});\r\n  const [voteSendingByDecisionId, setVoteSendingByDecisionId] = useState<Record<string, boolean>>({});\r\n  const [voteMessageByDecisionId, setVoteMessageByDecisionId] = useState<Record<string, string | null>>({});\r\n  const [resultsByDecisionId, setResultsByDecisionId] = useState<Record<string, DecisionResultsResponse | null>>({});\r\n  const [submittedVoteByDecisionId, setSubmittedVoteByDecisionId] = useState<Record<string, boolean>>({});\r\n  const [bodyLocked, setBodyLocked] = useState(false);\r\n\r\n  // Keypad UI state\r\n  const [keypadCodes, setKeypadCodes] = useState<Record<string, string>>({});\r\n  const [keypadSubmitting, setKeypadSubmitting] = useState<Record<string, boolean>>({});\r\n  const [keypadMessages, setKeypadMessages] = useState<Record<string, { type: 'success' | 'error'; text: string } | null>>({});\r\n\r\n  // Countdown overlay state\r\n  const [countdownOpen, setCountdownOpen] = useState(false);\r\n  const [countdownDuration, setCountdownDuration] = useState(5);\r\n  const [countdownMessage, setCountdownMessage] = useState<string | undefined>();\r\n  const [countdownVariant, setCountdownVariant] = useState<'default' | 'dramatic'>('default');\r\n\r\n  // Story overlay state\r\n  const [storyOverlayOpen, setStoryOverlayOpen] = useState(false);\r\n  const [storyOverlayText, setStoryOverlayText] = useState('');\r\n  const [storyOverlayTitle, setStoryOverlayTitle] = useState<string | undefined>();\r\n  const [storyOverlaySpeed, setStoryOverlaySpeed] = useState<TypewriterSpeed>('dramatic');\r\n  const [storyOverlayTheme, setStoryOverlayTheme] = useState<'dark' | 'light' | 'dramatic'>('dramatic');\r\n  const [storyOverlayShowProgress, setStoryOverlayShowProgress] = useState(true);\r\n  const [storyOverlayAllowSkip, setStoryOverlayAllowSkip] = useState(true);\r\n  const [storyOverlayAllowParticipantSkip, setStoryOverlayAllowParticipantSkip] = useState(false);\r\n  const [storyOverlayAllowClose, setStoryOverlayAllowClose] = useState(true);\r\n\r\n  const loadArtifacts = useCallback(async () => {\r\n    if (!participantToken) return;\r\n    try {\r\n      const data = await getParticipantArtifacts(sessionId, { participantToken });\r\n      setArtifacts(data.artifacts);\r\n      setArtifactVariants(data.variants);\r\n      setArtifactsError(null);\r\n    } catch (err) {\r\n      setArtifactsError(err instanceof Error ? err.message : t('errors.couldNotLoadArtifacts'));\r\n    }\r\n  }, [sessionId, participantToken]);\r\n\r\n  const loadDecisions = useCallback(async () => {\r\n    if (!participantToken) return;\r\n    try {\r\n      const list = await getParticipantDecisions(sessionId, { participantToken });\r\n      setDecisions(list);\r\n      setDecisionsError(null);\r\n\r\n      // Fetch results for revealed decisions (best-effort)\r\n      const revealed = list.filter((d) => d.status === 'revealed');\r\n      if (revealed.length > 0) {\r\n        const entries = await Promise.all(\r\n          revealed.map(async (d) => {\r\n            try {\r\n              const res = await getParticipantDecisionResults(sessionId, d.id, { participantToken });\r\n              return [d.id, res] as const;\r\n            } catch {\r\n              return [d.id, null] as const;\r\n            }\r\n          })\r\n        );\r\n        setResultsByDecisionId((prev) => {\r\n          const next = { ...prev };\r\n          for (const [id, res] of entries) next[id] = res;\r\n          return next;\r\n        });\r\n      }\r\n    } catch (err) {\r\n      setDecisionsError(err instanceof Error ? err.message : t('errors.couldNotLoadDecisions'));\r\n    }\r\n  }, [sessionId, participantToken]);\r\n\r\n  /**\r\n   * Submit keypad code for server-side validation.\r\n   * correctCode is NEVER exposed to the participant.\r\n   */\r\n  const handleKeypadSubmit = useCallback(async (artifactId: string, enteredCode: string) => {\r\n    if (!participantToken || !enteredCode.trim()) return;\r\n\r\n    setKeypadSubmitting((prev) => ({ ...prev, [artifactId]: true }));\r\n    setKeypadMessages((prev) => ({ ...prev, [artifactId]: null }));\r\n\r\n    try {\r\n      const result = await submitKeypadCode(sessionId, artifactId, enteredCode, { participantToken });\r\n      \r\n      const messageType = result.status === 'success' || result.status === 'already_unlocked' ? 'success' : 'error';\r\n      setKeypadMessages((prev) => ({ ...prev, [artifactId]: { type: messageType, text: result.message } }));\r\n\r\n      // Clear code on success or lockout\r\n      if (result.status === 'success' || result.status === 'locked') {\r\n        setKeypadCodes((prev) => ({ ...prev, [artifactId]: '' }));\r\n      }\r\n\r\n      // Reload artifacts to get updated state and revealed variants\r\n      await loadArtifacts();\r\n\r\n    } catch (err) {\r\n      setKeypadMessages((prev) => ({ \r\n        ...prev, \r\n        [artifactId]: { type: 'error', text: err instanceof Error ? err.message : t('errors.serverError') }\r\n      }));\r\n    } finally {\r\n      setKeypadSubmitting((prev) => ({ ...prev, [artifactId]: false }));\r\n    }\r\n  }, [sessionId, participantToken, loadArtifacts]);\r\n\r\n  const [signalToast, setSignalToast] = useState<{\r\n    id: string;\r\n    channel: string;\r\n    message: string;\r\n    createdAt: string;\r\n  } | null>(null);\r\n  const signalToastTimerRef = useRef<number | null>(null);\r\n\r\n  const formatSignalText = useCallback((payload: unknown): string => {\r\n    if (!payload) return '';\r\n    if (typeof payload === 'string') return payload;\r\n    if (typeof payload === 'object' && payload !== null && 'message' in payload) {\r\n      const msg = (payload as { message?: unknown }).message;\r\n      if (typeof msg === 'string') return msg;\r\n    }\r\n    try {\r\n      return JSON.stringify(payload);\r\n    } catch {\r\n      return '';\r\n    }\r\n  }, []);\r\n\r\n  const handleSignalToast = useCallback((payload: SignalReceivedBroadcast['payload']) => {\r\n    const message = formatSignalText(payload.payload);\r\n    const fallback = message || `Signal: ${payload.channel}`;\r\n    setSignalToast({\r\n      id: payload.id,\r\n      channel: payload.channel,\r\n      message: fallback,\r\n      createdAt: payload.created_at,\r\n    });\r\n\r\n    if (signalToastTimerRef.current) {\r\n      window.clearTimeout(signalToastTimerRef.current);\r\n    }\r\n    signalToastTimerRef.current = window.setTimeout(() => {\r\n      setSignalToast(null);\r\n    }, 4000);\r\n  }, [formatSignalText]);\r\n\r\n  useEffect(() => {\r\n    return () => {\r\n      if (signalToastTimerRef.current) {\r\n        window.clearTimeout(signalToastTimerRef.current);\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  // Subscribe to live session updates\r\n  const {\r\n    currentStepIndex,\r\n    currentPhaseIndex,\r\n    status,\r\n    timerState,\r\n    boardState,\r\n    nextStarterParticipantId,\r\n    connected,\r\n  } = useLiveSession({\r\n    sessionId,\r\n    initialState,\r\n    onStateChange: (payload) => {\r\n      const unlockedAt = (payload as Partial<SessionRuntimeState>).secret_instructions_unlocked_at;\r\n      const unlockedBy = (payload as Partial<SessionRuntimeState>).secret_instructions_unlocked_by;\r\n      if (unlockedAt !== undefined) setSecretUnlockedAt(unlockedAt ?? null);\r\n      if (unlockedBy !== undefined) setSecretUnlockedBy(unlockedBy ?? null);\r\n    },\r\n    onArtifactUpdate: () => {\r\n      void loadArtifacts();\r\n    },\r\n    onDecisionUpdate: () => {\r\n      void loadDecisions();\r\n    },\r\n    onCountdown: (payload) => {\r\n      if (payload.action === 'show') {\r\n        setCountdownDuration(payload.duration);\r\n        setCountdownMessage(payload.message);\r\n        setCountdownVariant(payload.variant ?? 'default');\r\n        setCountdownOpen(true);\r\n      } else if (payload.action === 'skip' || payload.action === 'complete') {\r\n        setCountdownOpen(false);\r\n      }\r\n    },\r\n    onStoryOverlay: (payload) => {\r\n      if (payload.action === 'show') {\r\n        setStoryOverlayText(payload.text ?? '');\r\n        setStoryOverlayTitle(payload.title);\r\n        setStoryOverlaySpeed(payload.speed ?? 'dramatic');\r\n        setStoryOverlayTheme(payload.theme ?? 'dramatic');\r\n        setStoryOverlayShowProgress(payload.showProgress ?? true);\r\n        setStoryOverlayAllowSkip(payload.allowSkip ?? true);\r\n        setStoryOverlayAllowParticipantSkip(payload.allowParticipantSkip ?? false);\r\n        setStoryOverlayAllowClose(payload.allowClose ?? true);\r\n        setStoryOverlayOpen(true);\r\n      } else {\r\n        setStoryOverlayOpen(false);\r\n      }\r\n    },\r\n    onSignalReceived: handleSignalToast,\r\n  });\r\n\r\n  // --------------------------------------------------------------------------\r\n  // Secret Instructions (participant gate)\r\n  // --------------------------------------------------------------------------\r\n\r\n  const [secretUnlockedAt, setSecretUnlockedAt] = useState<string | null>(\r\n    (initialState?.secret_instructions_unlocked_at as string | null | undefined) ?? null\r\n  );\r\n  const [secretUnlockedBy, setSecretUnlockedBy] = useState<string | null>(\r\n    (initialState?.secret_instructions_unlocked_by as string | null | undefined) ?? null\r\n  );\r\n  const [secretRevealedAt, setSecretRevealedAt] = useState<string | null>(secretRoleRevealedAt ?? null);\r\n  const [secretRevealLoading, setSecretRevealLoading] = useState(false);\r\n  const [secretRevealError, setSecretRevealError] = useState<string | null>(null);\r\n\r\n  const [hintRequestSending, setHintRequestSending] = useState(false);\r\n  const [hintRequestError, setHintRequestError] = useState<string | null>(null);\r\n\r\n  useEffect(() => {\r\n    setSecretUnlockedAt(\r\n      (initialState?.secret_instructions_unlocked_at as string | null | undefined) ?? null\r\n    );\r\n    setSecretUnlockedBy(\r\n      (initialState?.secret_instructions_unlocked_by as string | null | undefined) ?? null\r\n    );\r\n  }, [\r\n    initialState?.secret_instructions_unlocked_at,\r\n    initialState?.secret_instructions_unlocked_by,\r\n  ]);\r\n\r\n  useEffect(() => {\r\n    setSecretRevealedAt(secretRoleRevealedAt ?? null);\r\n  }, [secretRoleRevealedAt]);\r\n\r\n  const handleRevealSecretInstructions = useCallback(async () => {\r\n    if (!participantToken || !sessionCode) return;\r\n    setSecretRevealLoading(true);\r\n    try {\r\n      const res = await fetch(`/api/play/me/role/reveal?session_code=${sessionCode}`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'x-participant-token': participantToken,\r\n        },\r\n      });\r\n\r\n      const data = (await res.json().catch(() => ({}))) as { secretRevealedAt?: string; error?: string };\r\n      if (!res.ok) {\r\n        throw new Error(data.error ?? t('errors.couldNotShowInstructions'));\r\n      }\r\n\r\n      setSecretRevealedAt(data.secretRevealedAt ?? new Date().toISOString());\r\n      setSecretRevealError(null);\r\n    } catch (err) {\r\n      setSecretRevealError(err instanceof Error ? err.message : t('errors.couldNotShowInstructions'));\r\n    } finally {\r\n      setSecretRevealLoading(false);\r\n    }\r\n  }, [participantToken, sessionCode]);\r\n\r\n  const handleRequestHintFromHost = useCallback(async () => {\r\n    if (!participantToken) return;\r\n    if (!role) return;\r\n\r\n    setHintRequestSending(true);\r\n    setHintRequestError(null);\r\n    try {\r\n      const stepTitle = steps[currentStepIndex]?.title;\r\n      const msg = stepTitle\r\n        ? t('hints.needHintWithStep', { step: stepTitle })\r\n        : t('hints.needHint');\r\n\r\n      await sendSessionChatMessage(\r\n        sessionId,\r\n        {\r\n          message: msg,\r\n          visibility: 'host',\r\n          anonymous: false,\r\n        },\r\n        { participantToken }\r\n      );\r\n    } catch (err) {\r\n      setHintRequestError(err instanceof Error ? err.message : t('errors.couldNotRequestHint'));\r\n    } finally {\r\n      setHintRequestSending(false);\r\n    }\r\n  }, [participantToken, role, sessionId, steps, currentStepIndex]);\r\n  \r\n  // Current step data - handle \"not started\" state (index -1)\r\n  const stepNotStarted = currentStepIndex < 0;\r\n  const currentStep = stepNotStarted ? null : (steps[currentStepIndex] || null);\r\n  const totalSteps = steps.length;\r\n\r\n  // Current phase data\r\n  const phaseNotStarted = currentPhaseIndex < 0;\r\n  const currentPhase = phaseNotStarted ? null : (phases[currentPhaseIndex] || null);\r\n  const totalPhases = phases.length;\r\n\r\n  // State for showing artifacts/decisions drawers\r\n  const [showArtifactsDrawer, setShowArtifactsDrawer] = useState(false);\r\n  const [showDecisionsDrawer, setShowDecisionsDrawer] = useState(false);\r\n  \r\n  // Session is paused\r\n  const isPaused = status === 'paused';\r\n  const isEnded = status === 'ended' || status === 'cancelled';\r\n\r\n  const themeAccent = getThemeAccentClasses(boardTheme);\r\n\r\n  const isNextStarter = Boolean(\r\n    participantId && nextStarterParticipantId\r\n      ? nextStarterParticipantId === participantId\r\n      : initialIsNextStarter\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (!participantToken) return;\r\n    if (isEnded) return;\r\n    void loadArtifacts();\r\n    void loadDecisions();\r\n  }, [participantToken, isEnded, loadArtifacts, loadDecisions]);\r\n\r\n  // Lock body scroll when a blocking decision modal is active\r\n  useEffect(() => {\r\n    const openDecision = decisions.find((d) => d.status === 'open');\r\n    const hasVoted = openDecision ? Boolean(submittedVoteByDecisionId[openDecision.id]) : false;\r\n    const shouldLock = Boolean(openDecision) && !hasVoted && !isEnded;\r\n\r\n    if (shouldLock && !bodyLocked) {\r\n      setBodyLocked(true);\r\n      const prev = document.body.style.overflow;\r\n      document.body.dataset.prevOverflow = prev;\r\n      document.body.style.overflow = 'hidden';\r\n    }\r\n\r\n    if ((!shouldLock || isEnded) && bodyLocked) {\r\n      const prev = document.body.dataset.prevOverflow ?? '';\r\n      document.body.style.overflow = prev;\r\n      delete document.body.dataset.prevOverflow;\r\n      setBodyLocked(false);\r\n    }\r\n\r\n    return () => {\r\n      if (bodyLocked) {\r\n        const prev = document.body.dataset.prevOverflow ?? '';\r\n        document.body.style.overflow = prev;\r\n        delete document.body.dataset.prevOverflow;\r\n        setBodyLocked(false);\r\n      }\r\n    };\r\n  }, [decisions, submittedVoteByDecisionId, isEnded, bodyLocked]);\r\n\r\n  const variantsByArtifactId = useMemo(() => {\r\n    const map = new Map<string, ParticipantSessionArtifactVariant[]>();\r\n    for (const v of artifactVariants) {\r\n      const aId = v.session_artifact_id;\r\n      if (!aId) continue;\r\n      const list = map.get(aId) ?? [];\r\n      list.push(v);\r\n      map.set(aId, list);\r\n    }\r\n    for (const list of map.values()) {\r\n      list.sort((a, b) => (a.variant_order ?? 0) - (b.variant_order ?? 0));\r\n    }\r\n    return map;\r\n  }, [artifactVariants]);\r\n\r\n  const handleVote = async (decisionId: string) => {\r\n    if (!participantToken) return;\r\n    const optionKey = selectedOptionByDecisionId[decisionId];\r\n    if (!optionKey) {\r\n      setVoteMessageByDecisionId((prev) => ({ ...prev, [decisionId]: t('errors.selectOptionFirst') }));\r\n      return;\r\n    }\r\n\r\n    setVoteSendingByDecisionId((prev) => ({ ...prev, [decisionId]: true }));\r\n    setVoteMessageByDecisionId((prev) => ({ ...prev, [decisionId]: null }));\r\n    try {\r\n      await castParticipantVote(sessionId, decisionId, { optionKey }, { participantToken });\r\n      setVoteMessageByDecisionId((prev) => ({ ...prev, [decisionId]: t('voting.voteReceived') }));\r\n      setSubmittedVoteByDecisionId((prev) => ({ ...prev, [decisionId]: true }));\r\n      // Refresh decisions (e.g. host might close/reveal)\r\n      void loadDecisions();\r\n    } catch (err) {\r\n      setVoteMessageByDecisionId((prev) => ({\r\n        ...prev,\r\n        [decisionId]: err instanceof Error ? err.message : t('errors.couldNotVote'),\r\n      }));\r\n    } finally {\r\n      setVoteSendingByDecisionId((prev) => ({ ...prev, [decisionId]: false }));\r\n    }\r\n  };\r\n\r\n\r\n  return (\r\n    <div className=\"mx-auto max-w-2xl space-y-6 px-4 pb-24\">\r\n      {signalToast && (\r\n        <div className=\"fixed bottom-4 left-1/2 z-50 w-[min(90%,420px)] -translate-x-1/2\">\r\n          <Card className=\"flex items-center gap-2 border border-primary/20 bg-card/95 p-3 shadow-lg\">\r\n            <SignalIcon className=\"h-4 w-4 text-primary\" />\r\n            <Badge variant=\"secondary\" size=\"sm\">\r\n              {signalToast.channel}\r\n            </Badge>\r\n            <span className=\"text-sm text-foreground\">{signalToast.message}</span>\r\n          </Card>\r\n        </div>\r\n      )}\r\n      {/* Header */}\r\n      <header className=\"space-y-3\">\r\n        <div className=\"flex items-start justify-between gap-4\">\r\n          <div>\r\n            <p className={`text-xs font-bold uppercase tracking-widest ${themeAccent.label}`}>{t('header.play')}</p>\r\n            <h1 className=\"text-xl font-bold text-foreground sm:text-2xl\">{gameTitle}</h1>\r\n          </div>\r\n          <div className=\"flex flex-col items-end gap-1\">\r\n            <StatusIndicator\r\n              status={status}\r\n              connected={connected}\r\n              translations={{\r\n                active: t('status.active'),\r\n                paused: t('status.paused'),\r\n                ended: t('status.ended'),\r\n                cancelled: t('status.cancelled'),\r\n                live: t('status.live'),\r\n                offline: t('status.offline'),\r\n              }}\r\n            />\r\n            {isFeatureEnabled('timeBank') && <ParticipantTimeBankDisplay sessionId={sessionId} />}\r\n          </div>\r\n        </div>\r\n        \r\n        {/* Player info row with artifact/decision buttons */}\r\n        <div className=\"flex items-center justify-between gap-2 flex-wrap\">\r\n          {participantName && (\r\n            <p className=\"text-sm text-muted-foreground\">\r\n              {t('header.playingAs', { name: participantName })}\r\n            </p>\r\n          )}\r\n          \r\n          {/* Small buttons for artifacts and decisions */}\r\n          {!isEnded && participantToken && (\r\n            <div className=\"flex items-center gap-2\">\r\n              <Button\r\n                type=\"button\"\r\n                size=\"sm\"\r\n                variant=\"outline\"\r\n                onClick={() => setShowArtifactsDrawer(!showArtifactsDrawer)}\r\n                className=\"gap-1 h-7 text-xs\"\r\n              >\r\n                ­ƒôª {t('header.artifacts')}\r\n                {artifacts.length > 0 && (\r\n                  <span className=\"rounded-full bg-primary/10 px-1.5 text-primary\">\r\n                    {artifacts.length}\r\n                  </span>\r\n                )}\r\n              </Button>\r\n              <Button\r\n                type=\"button\"\r\n                size=\"sm\"\r\n                variant=\"outline\"\r\n                onClick={() => setShowDecisionsDrawer(!showDecisionsDrawer)}\r\n                className=\"gap-1 h-7 text-xs\"\r\n              >\r\n                ­ƒù│´©Å {t('header.decisions')}\r\n                {decisions.filter(d => d.status === 'open').length > 0 && (\r\n                  <span className=\"rounded-full bg-destructive/10 px-1.5 text-destructive\">\r\n                    {decisions.filter(d => d.status === 'open').length}\r\n                  </span>\r\n                )}\r\n              </Button>\r\n\r\n              {/* Toolbelt (MVP: Dice Roller v1) */}\r\n              <Toolbelt\r\n                sessionId={sessionId}\r\n                role=\"participant\"\r\n                participantToken={participantToken}\r\n                buttonClassName=\"gap-1 h-7 text-xs\"\r\n              />\r\n            </div>\r\n          )}\r\n        </div>\r\n      </header>\r\n      \r\n      {/* Board Message */}\r\n      <BoardMessage message={boardState?.message} />\r\n\r\n      {/* 1-tap Signals */}\r\n      {!isEnded && participantToken && isFeatureEnabled('signals') && (\r\n        <ParticipantSignalMicroUI sessionId={sessionId} participantToken={participantToken} />\r\n      )}\r\n\r\n      {/* Turn Indicator */}\r\n      {isNextStarter && !isEnded && (\r\n        <Card className=\"border-2 border-primary/20 bg-primary/5 p-4\">\r\n          <p className=\"text-sm font-medium text-foreground\">{t('turnIndicator.youStartNext')}</p>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Current Phase Info - show instead of artifacts/decisions on main view */}\r\n      {currentPhase && !isEnded && (\r\n        <Card className=\"p-4 border-2 border-secondary/20 bg-secondary/5\">\r\n          <div className=\"flex items-center justify-between mb-2\">\r\n            <p className=\"text-xs font-bold uppercase tracking-widest text-secondary\">{t('phases.phaseOf', { current: currentPhaseIndex + 1, total: totalPhases })}</p>\r\n          </div>\r\n          <h3 className=\"text-lg font-semibold text-foreground\">{currentPhase.name}</h3>\r\n          {currentPhase.description && (\r\n            <p className=\"mt-2 text-sm text-muted-foreground\">{currentPhase.description}</p>\r\n          )}\r\n        </Card>\r\n      )}\r\n\r\n      {/* Artifacts Drawer (collapsible) */}\r\n      {showArtifactsDrawer && !isEnded && participantToken && (\r\n        <Card className=\"p-4 space-y-3 animate-in slide-in-from-top-2\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <p className=\"text-sm font-semibold text-foreground\">{t('artifactsDrawer.title')}</p>\r\n            <div className=\"flex gap-2\">\r\n              <Button type=\"button\" size=\"sm\" variant=\"ghost\" onClick={() => void loadArtifacts()}>\r\n                Ôå╗\r\n              </Button>\r\n              <Button type=\"button\" size=\"sm\" variant=\"ghost\" onClick={() => setShowArtifactsDrawer(false)}>\r\n                Ô£ò\r\n              </Button>\r\n            </div>\r\n          </div>\r\n\r\n          {artifactsError && <p className=\"text-sm text-destructive\">{artifactsError}</p>}\r\n\r\n          {artifacts.length === 0 ? (\r\n            <p className=\"text-sm text-muted-foreground\">{t('artifactsDrawer.noArtifacts')}</p>\r\n          ) : (\r\n            <div className=\"space-y-3\">\r\n              {artifacts\r\n                .slice()\r\n                .sort((a, b) => (a.artifact_order ?? 0) - (b.artifact_order ?? 0))\r\n                .map((a) => {\r\n                  const vars = variantsByArtifactId.get(a.id) ?? [];\r\n\r\n                  if (a.artifact_type === 'conversation_cards_collection') {\r\n                    return (\r\n                      <ConversationCardsCollectionArtifact\r\n                        key={a.id}\r\n                        sessionId={sessionId}\r\n                        participantToken={participantToken}\r\n                        artifactTitle={a.title ?? null}\r\n                        artifactDescription={a.description ?? null}\r\n                        metadata={(a.metadata ?? null) as Record<string, unknown> | null}\r\n                      />\r\n                    );\r\n                  }\r\n                  \r\n                  // Keypad artifact - special rendering\r\n                  if (a.artifact_type === 'keypad') {\r\n                    const meta = (a.metadata ?? {}) as Partial<SanitizedKeypadMetadata>;\r\n                    const keypadState = meta.keypadState ?? { isUnlocked: false, isLockedOut: false, attemptCount: 0 };\r\n                    const codeLength = meta.codeLength ?? 4;\r\n                    const maxAttempts = meta.maxAttempts;\r\n                    const successMessage = meta.successMessage || t('keypadArtifact.codeCorrect');\r\n                    const lockedMessage = meta.lockedMessage || t('keypadArtifact.keypadLocked');\r\n\r\n                    const isUnlocked = keypadState.isUnlocked;\r\n                    const isLockedOut = keypadState.isLockedOut;\r\n                    const attemptsRemaining = maxAttempts != null ? Math.max(0, maxAttempts - keypadState.attemptCount) : null;\r\n\r\n                    const enteredCode = keypadCodes[a.id] || '';\r\n                    const isSubmitting = Boolean(keypadSubmitting[a.id]);\r\n                    const message = keypadMessages[a.id];\r\n\r\n                    return (\r\n                      <div key={a.id} className=\"rounded-md border border-border p-3 space-y-2\">\r\n                        <div className=\"flex items-center justify-between\">\r\n                          <div className=\"flex items-center gap-2\">\r\n                            <span>{isLockedOut ? '­ƒöÆ' : isUnlocked ? '­ƒöô' : '­ƒöÉ'}</span>\r\n                            <p className=\"text-sm font-medium text-foreground\">{a.title ?? 'Keypad'}</p>\r\n                          </div>\r\n                          <Badge variant={isUnlocked ? 'default' : isLockedOut ? 'destructive' : 'secondary'}>\r\n                            {isUnlocked ? t('keypad.unlocked') : isLockedOut ? t('keypad.locked') : t('keypad.lock')}\r\n                          </Badge>\r\n                        </div>\r\n                        {a.description && <p className=\"text-xs text-muted-foreground\">{a.description}</p>}\r\n\r\n                        {isUnlocked ? (\r\n                          <div className=\"rounded bg-green-500/10 border border-green-500/30 p-2 text-center\">\r\n                            <p className=\"text-xs font-medium text-green-600 dark:text-green-400\">Ô£ô {successMessage}</p>\r\n                            {vars.length > 0 && (\r\n                              <div className=\"mt-2 space-y-1 text-left\">\r\n                                {vars.map((v) => (\r\n                                  <div key={v.id} className=\"rounded bg-muted/30 p-2\">\r\n                                    <p className=\"text-sm font-medium\">{v.title || t('keypad.unlocked')}</p>\r\n                                    {v.body && <p className=\"text-xs text-muted-foreground\">{v.body}</p>}\r\n                                  </div>\r\n                                ))}\r\n                              </div>\r\n                            )}\r\n                          </div>\r\n                        ) : isLockedOut ? (\r\n                          <div className=\"rounded bg-destructive/10 border border-destructive/30 p-2 text-center\">\r\n                            <p className=\"text-xs font-medium text-destructive\">­ƒöÆ {lockedMessage}</p>\r\n                          </div>\r\n                        ) : (\r\n                          <div className=\"space-y-2\">\r\n                            <div className=\"flex gap-2\">\r\n                              <Input\r\n                                type=\"text\"\r\n                                inputMode=\"numeric\"\r\n                                pattern=\"[0-9]*\"\r\n                                maxLength={codeLength}\r\n                                placeholder={'ÔÇó'.repeat(codeLength)}\r\n                                value={enteredCode}\r\n                                onChange={(e) => {\r\n                                  const val = e.target.value.replace(/\\D/g, '').slice(0, codeLength);\r\n                                  setKeypadCodes((prev) => ({ ...prev, [a.id]: val }));\r\n                                  // Clear error on input\r\n                                  if (message?.type === 'error') {\r\n                                    setKeypadMessages((prev) => ({ ...prev, [a.id]: null }));\r\n                                  }\r\n                                }}\r\n                                onKeyDown={(e) => {\r\n                                  if (e.key === 'Enter' && enteredCode.length === codeLength && !isSubmitting) {\r\n                                    void handleKeypadSubmit(a.id, enteredCode);\r\n                                  }\r\n                                }}\r\n                                disabled={isSubmitting}\r\n                                className={`text-center text-lg tracking-[0.3em] font-mono h-9 ${\r\n                                  message?.type === 'error' ? 'animate-shake border-destructive' : ''\r\n                                }`}\r\n                              />\r\n                              <Button\r\n                                type=\"button\"\r\n                                size=\"sm\"\r\n                                onClick={() => handleKeypadSubmit(a.id, enteredCode)}\r\n                                disabled={enteredCode.length !== codeLength || isSubmitting}\r\n                              >\r\n                                {isSubmitting ? '...' : 'ÔåÆ'}\r\n                              </Button>\r\n                            </div>\r\n                            {attemptsRemaining !== null && (\r\n                              <p className=\"text-xs text-muted-foreground text-center\">{t('keypadArtifact.attemptsRemaining', { count: attemptsRemaining })}</p>\r\n                            )}\r\n                            {message && (\r\n                              <p className={`text-xs text-center ${message.type === 'success' ? 'text-green-600' : 'text-destructive'}`}>\r\n                                {message.text}\r\n                              </p>\r\n                            )}\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    );\r\n                  }\r\n\r\n                  // Puzzle artifacts - use PuzzleArtifactRenderer\r\n                  const puzzleTypes = [\r\n                    'riddle', 'counter', 'audio', 'multi_answer', 'qr_gate',\r\n                    'hint_container', 'hotspot', 'tile_puzzle', 'cipher',\r\n                    'logic_grid', 'prop_confirmation', 'location_check',\r\n                    'sound_level', 'replay_marker',\r\n                  ];\r\n                  if (puzzleTypes.includes(a.artifact_type ?? '')) {\r\n                    return (\r\n                      <PuzzleArtifactRenderer\r\n                        key={a.id}\r\n                        artifact={{\r\n                          id: a.id,\r\n                          title: a.title ?? null,\r\n                          description: a.description ?? null,\r\n                          artifact_type: a.artifact_type ?? null,\r\n                          artifact_order: a.artifact_order ?? undefined,\r\n                          metadata: a.metadata as Record<string, unknown> | null,\r\n                        }}\r\n                        sessionId={sessionId}\r\n                        participantToken={participantToken || ''}\r\n                        onStateChange={loadArtifacts}\r\n                      />\r\n                    );\r\n                  }\r\n\r\n                  // Standard artifact - skip if no variants\r\n                  if (vars.length === 0) return null;\r\n\r\n                  return (\r\n                    <div key={a.id} className=\"rounded-md border border-border p-3 space-y-2\">\r\n                      <p className=\"text-sm font-medium text-foreground\">{a.title ?? 'Artefakt'}</p>\r\n                      <div className=\"space-y-2\">\r\n                        {vars.map((v) => {\r\n                          const visibility = v.visibility ?? 'public';\r\n                          const isPublicRevealed = visibility === 'public' && Boolean(v.revealed_at);\r\n                          const isHighlighted = Boolean(v.highlighted_at);\r\n\r\n                          return (\r\n                            <div key={v.id} className=\"rounded-md bg-muted/30 p-2\">\r\n                              <div className=\"flex flex-wrap items-center gap-2\">\r\n                                <p className=\"text-sm font-medium text-foreground\">{v.title ?? 'Kort'}</p>\r\n                                {isPublicRevealed ? (\r\n                                  <Badge variant=\"secondary\">Offentlig</Badge>\r\n                                ) : visibility === 'role_private' ? (\r\n                                  <Badge variant=\"secondary\">Roll</Badge>\r\n                                ) : (\r\n                                  <Badge variant=\"secondary\">Privat</Badge>\r\n                                )}\r\n                                {isHighlighted && <Badge variant=\"default\">Markerad</Badge>}\r\n                              </div>\r\n                              {v.body && <p className=\"mt-1 text-sm text-muted-foreground\">{v.body}</p>}\r\n                            </div>\r\n                          );\r\n                        })}\r\n                      </div>\r\n                    </div>\r\n                  );\r\n                })}\r\n            </div>\r\n          )}\r\n        </Card>\r\n      )}\r\n\r\n      {/* Decisions Drawer (collapsible) */}\r\n      {showDecisionsDrawer && !isEnded && participantToken && (\r\n        <Card className=\"p-4 space-y-3 animate-in slide-in-from-top-2\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <p className=\"text-sm font-semibold text-foreground\">{t('decisionsDrawer.title')}</p>\r\n            <div className=\"flex gap-2\">\r\n              <Button type=\"button\" size=\"sm\" variant=\"ghost\" onClick={() => void loadDecisions()}>\r\n                Ôå╗\r\n              </Button>\r\n              <Button type=\"button\" size=\"sm\" variant=\"ghost\" onClick={() => setShowDecisionsDrawer(false)}>\r\n                Ô£ò\r\n              </Button>\r\n            </div>\r\n          </div>\r\n\r\n          {decisionsError && <p className=\"text-sm text-destructive\">{decisionsError}</p>}\r\n\r\n          {decisions.length === 0 ? (\r\n            <p className=\"text-sm text-muted-foreground\">{t('decisionsDrawer.noDecisions')}</p>\r\n          ) : (\r\n            <div className=\"space-y-3\">\r\n              {decisions.map((d) => {\r\n                const selected = selectedOptionByDecisionId[d.id] ?? '';\r\n                const sending = Boolean(voteSendingByDecisionId[d.id]);\r\n                const msg = voteMessageByDecisionId[d.id];\r\n                const options = d.options ?? [];\r\n                const isOpen = d.status === 'open';\r\n                const isRevealed = d.status === 'revealed';\r\n                const results = resultsByDecisionId[d.id]?.results ?? null;\r\n\r\n                return (\r\n                  <div key={d.id} className=\"rounded-md border border-border p-3 space-y-2\">\r\n                    <div className=\"flex items-center justify-between gap-3\">\r\n                      <div>\r\n                        <p className=\"text-sm font-medium text-foreground\">{d.title}</p>\r\n                        {d.prompt && <p className=\"text-sm text-muted-foreground\">{d.prompt}</p>}\r\n                      </div>\r\n                      <Badge variant={isOpen ? 'default' : 'secondary'}>{d.status}</Badge>\r\n                    </div>\r\n\r\n                    {isOpen && options.length > 0 && (\r\n                      <div className=\"space-y-2\">\r\n                        <div className=\"space-y-1\">\r\n                          {options.map((o) => (\r\n                            <label key={o.key} className=\"flex items-center gap-2 text-sm\">\r\n                              <input\r\n                                type=\"radio\"\r\n                                name={`decision-${d.id}`}\r\n                                value={o.key}\r\n                                checked={selected === o.key}\r\n                                onChange={() =>\r\n                                  setSelectedOptionByDecisionId((prev) => ({ ...prev, [d.id]: o.key }))\r\n                                }\r\n                                disabled={sending}\r\n                              />\r\n                              <span className=\"text-foreground\">{o.label}</span>\r\n                            </label>\r\n                          ))}\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <Button\r\n                            type=\"button\"\r\n                            size=\"sm\"\r\n                            onClick={() => void handleVote(d.id)}\r\n                            disabled={sending}\r\n                          >\r\n                            {t('voting.vote')}\r\n                          </Button>\r\n                          {msg && (\r\n                            <p className={`text-sm ${msg.includes('!') ? 'text-green-600' : 'text-muted-foreground'}`}>\r\n                              {msg}\r\n                            </p>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    )}\r\n\r\n                    {isRevealed && (\r\n                      <div className=\"space-y-2\">\r\n                        <p className=\"text-sm text-muted-foreground\">{t('decisionsDrawer.results')}</p>\r\n                        {results ? (\r\n                          <div className=\"space-y-1\">\r\n                            {results.map((r) => (\r\n                              <div key={r.key ?? r.label} className=\"flex items-center justify-between text-sm\">\r\n                                <span className=\"text-foreground\">{r.label ?? r.key}</span>\r\n                                <span className=\"text-muted-foreground\">{r.count}</span>\r\n                              </div>\r\n                            ))}\r\n                          </div>\r\n                        ) : (\r\n                          <p className=\"text-sm text-muted-foreground\">{t('decisionsDrawer.resultsShown')}</p>\r\n                        )}\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                );\r\n              })}\r\n            </div>\r\n          )}\r\n        </Card>\r\n      )}\r\n      \r\n      {/* Pause Overlay */}\r\n      {isPaused && (\r\n        <Card className=\"border-2 border-yellow-200 bg-yellow-50 p-6 text-center dark:bg-yellow-900/20\">\r\n          <PauseCircleIcon className=\"mx-auto h-12 w-12 text-yellow-500\" />\r\n          <h2 className=\"mt-3 text-lg font-semibold text-yellow-700 dark:text-yellow-400\">\r\n            {t('session.paused')}\r\n          </h2>\r\n          <p className=\"mt-1 text-sm text-yellow-600 dark:text-yellow-500\">\r\n            {t('session.waitingForLeader')}\r\n          </p>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Waiting for host to start - when step index is -1 */}\r\n      {stepNotStarted && !isEnded && !isPaused && (\r\n        <Card className=\"border-2 border-primary/20 bg-primary/5 p-6 text-center\">\r\n          <div className=\"mx-auto h-12 w-12 rounded-full bg-primary/10 flex items-center justify-center animate-pulse\">\r\n            <ClockIcon className=\"h-6 w-6 text-primary\" />\r\n          </div>\r\n          <h2 className=\"mt-4 text-lg font-semibold text-foreground\">\r\n            {t('session.waitingForHost')}\r\n          </h2>\r\n          <p className=\"mt-2 text-sm text-muted-foreground\">\r\n            {t('session.waitingDescription')}\r\n          </p>\r\n        </Card>\r\n      )}\r\n      \r\n      {/* Ended State */}\r\n      {isEnded && (\r\n        <Card className=\"border-2 border-gray-200 bg-gray-50 p-6 text-center dark:bg-gray-800/50\">\r\n          <CheckCircleIcon className=\"mx-auto h-12 w-12 text-gray-400\" />\r\n          <h2 className=\"mt-3 text-lg font-semibold text-gray-700 dark:text-gray-300\">\r\n            {t('session.ended')}\r\n          </h2>\r\n          <p className=\"mt-1 text-sm text-gray-500\">\r\n            {t('session.thanksForParticipating')}\r\n          </p>\r\n        </Card>\r\n      )}\r\n      \r\n      {/* Timer */}\r\n      {!isEnded && (\r\n        <TimerDisplay\r\n          timerState={timerState}\r\n          translations={{\r\n            paused: t('timer.paused'),\r\n            timeUp: t('timer.timeUp'),\r\n            timeRemaining: t('timer.timeRemaining'),\r\n          }}\r\n        />\r\n      )}\r\n      \r\n      {/* Current Step */}\r\n      {currentStep && !isEnded && (\r\n        <Card className=\"overflow-hidden\">\r\n          <div className=\"border-b border-border bg-muted/50 p-4\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <span className={`flex h-7 w-7 items-center justify-center rounded-full text-xs font-bold ${themeAccent.badge}`}>\r\n                  {currentStepIndex + 1}\r\n                </span>\r\n                <span className=\"text-sm font-medium text-muted-foreground\">\r\n                  Steg {currentStepIndex + 1} av {totalSteps}\r\n                </span>\r\n              </div>\r\n              {currentStep.tag && (\r\n                <Badge variant=\"default\">{currentStep.tag}</Badge>\r\n              )}\r\n            </div>\r\n          </div>\r\n          \r\n          <div className=\"p-4 space-y-4\">\r\n            <h2 className=\"text-lg font-semibold text-foreground\">{currentStep.title}</h2>\r\n            {currentStep.display_mode && currentStep.display_mode !== 'instant' ? (\r\n              <TypewriterText\r\n                key={`step-${currentStep.id}-${currentStepIndex}`}\r\n                text={currentStep.description}\r\n                speed={currentStep.display_mode === 'dramatic' ? 'dramatic' : 'normal'}\r\n                variant=\"default\"\r\n                showProgress\r\n                allowSkip\r\n                className=\"text-sm leading-relaxed text-muted-foreground\"\r\n              />\r\n            ) : (\r\n              <p className=\"text-sm leading-relaxed text-muted-foreground\">{currentStep.description}</p>\r\n            )}\r\n\r\n            {/* Instruction media (read-only) */}\r\n            {currentStep.media?.url && (\r\n              <div className=\"overflow-hidden rounded-xl border bg-muted/20\">\r\n                {/* eslint-disable-next-line @next/next/no-img-element */}\r\n                <img\r\n                  src={currentStep.media.url}\r\n                  alt={currentStep.media.altText ?? currentStep.title}\r\n                  className=\"h-auto w-full\"\r\n                />\r\n              </div>\r\n            )}\r\n            \r\n            {/* Materials */}\r\n            {currentStep.materials && currentStep.materials.length > 0 && (\r\n              <div className=\"rounded-xl bg-muted/50 p-3\">\r\n                <p className=\"mb-2 text-xs font-bold uppercase tracking-wider text-muted-foreground\">\r\n                  Material\r\n                </p>\r\n                <ul className=\"space-y-1 text-sm\">\r\n                  {currentStep.materials.map((item, i) => (\r\n                    <li key={i} className=\"flex items-start gap-2\">\r\n                      <span className=\"mt-1.5 h-1.5 w-1.5 shrink-0 rounded-full bg-primary\" />\r\n                      <span>{item}</span>\r\n                    </li>\r\n                  ))}\r\n                </ul>\r\n              </div>\r\n            )}\r\n            \r\n            {/* Safety note */}\r\n            {currentStep.safety && (\r\n              <div className=\"rounded-xl bg-red-50 p-3 dark:bg-red-900/20\">\r\n                <div className=\"flex items-start gap-2\">\r\n                  <ExclamationTriangleIcon className=\"mt-0.5 h-4 w-4 shrink-0 text-red-500\" />\r\n                  <div>\r\n                    <p className=\"text-xs font-bold uppercase tracking-wider text-red-700 dark:text-red-400\">\r\n                      {t('safety.title')}\r\n                    </p>\r\n                    <p className=\"mt-1 text-sm text-red-600 dark:text-red-400\">\r\n                      {currentStep.safety}\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n            \r\n            {/* Note */}\r\n            {currentStep.note && (\r\n              <p className=\"rounded-xl bg-blue-50 p-3 text-sm text-blue-700 dark:bg-blue-900/20 dark:text-blue-400\">\r\n                ­ƒÆí {currentStep.note}\r\n              </p>\r\n            )}\r\n          </div>\r\n        </Card>\r\n      )}\r\n      \r\n      {/* Step Progress Dots */}\r\n      {!isEnded && (\r\n        <div className=\"flex justify-center\">\r\n          <div className=\"flex items-center gap-1.5\">\r\n            {Array.from({ length: totalSteps }).map((_, i) => (\r\n              <span\r\n                key={i}\r\n                className={`h-2 w-2 rounded-full transition-all ${\r\n                  i === currentStepIndex\r\n                    ? 'bg-primary scale-125'\r\n                    : i < currentStepIndex\r\n                      ? 'bg-primary/40'\r\n                      : 'bg-muted'\r\n                }`}\r\n              />\r\n            ))}\r\n          </div>\r\n        </div>\r\n      )}\r\n      \r\n      {/* Role Card */}\r\n      {showRole && role && !isEnded && (\r\n        <div className=\"pt-4\">\r\n          {(() => {\r\n            const secretsUnlocked = Boolean(secretUnlockedAt);\r\n            const secretsRevealed = Boolean(secretRevealedAt);\r\n\r\n            return (\r\n              <div className=\"space-y-3\">\r\n                {!secretsUnlocked && (\r\n                  <Card className=\"p-4\">\r\n                    <p className=\"text-sm text-muted-foreground\">\r\n                      {t('secretsLocked.message')}\r\n                    </p>\r\n                  </Card>\r\n                )}\r\n\r\n                {secretsUnlocked && !secretsRevealed && (\r\n                  <Card className=\"p-4\">\r\n                    <div className=\"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between\">\r\n                      <div>\r\n                        <p className=\"text-sm font-medium text-foreground\">{t('secrets.title')}</p>\r\n                        <p className=\"text-sm text-muted-foreground\">\r\n                          {t('secrets.clickToShow')}\r\n                        </p>\r\n                        {secretUnlockedBy && (\r\n                          <p className=\"mt-1 text-xs text-muted-foreground\">\r\n                            {t('secrets.unlockedAt', { time: secretUnlockedAt ? new Date(secretUnlockedAt).toLocaleTimeString() : '' })}\r\n                          </p>\r\n                        )}\r\n                      </div>\r\n                      <Button\r\n                        onClick={() => void handleRevealSecretInstructions()}\r\n                        disabled={secretRevealLoading || !participantToken || !sessionCode}\r\n                      >\r\n                        {secretRevealLoading ? t('secrets.showing') : t('secrets.show')}\r\n                      </Button>\r\n                    </div>\r\n                    {secretRevealError && (\r\n                      <div className=\"mt-2 text-sm text-destructive\">{secretRevealError}</div>\r\n                    )}\r\n                  </Card>\r\n                )}\r\n\r\n                <RoleCard\r\n                  role={role}\r\n                  variant=\"full\"\r\n                  showPrivate={secretsUnlocked && secretsRevealed}\r\n                  onRequestHint={secretsUnlocked && secretsRevealed && role.private_hints ? () => void handleRequestHintFromHost() : undefined}\r\n                  interactive={!hintRequestSending}\r\n                />\r\n                {hintRequestError && (\r\n                  <div className=\"text-sm text-destructive\">{hintRequestError}</div>\r\n                )}\r\n              </div>\r\n            );\r\n          })()}\r\n        </div>\r\n      )}\r\n\r\n      {/* Decision Modal - shows automatically for open decisions (blocking) */}\r\n      {(() => {\r\n        const openDecision = decisions.find((d) => d.status === 'open');\r\n        if (!openDecision || !participantToken || isEnded) return null;\r\n\r\n        const selected = selectedOptionByDecisionId[openDecision.id] ?? '';\r\n        const sending = Boolean(voteSendingByDecisionId[openDecision.id]);\r\n        const msg = voteMessageByDecisionId[openDecision.id];\r\n        const options = openDecision.options ?? [];\r\n        const hasVoted = Boolean(submittedVoteByDecisionId[openDecision.id]);\r\n\r\n        if (hasVoted) return null;\r\n\r\n        return (\r\n          <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/60 px-4 backdrop-blur-sm\">\r\n            <div className=\"w-full max-w-md rounded-2xl border border-border bg-card p-6 shadow-2xl\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-full bg-primary/10 text-xl\">­ƒù│´©Å</div>\r\n                <div>\r\n                  <p className=\"text-xs font-bold uppercase tracking-widest text-primary\">{t('decisionsDrawer.title')}</p>\r\n                  <p className=\"text-lg font-semibold text-foreground\">{openDecision.title}</p>\r\n                </div>\r\n              </div>\r\n\r\n              {openDecision.prompt && (\r\n                <p className=\"mt-2 text-sm text-muted-foreground\">{openDecision.prompt}</p>\r\n              )}\r\n\r\n              <div className=\"mt-4 space-y-3\">\r\n                {options.length === 0 && (\r\n                  <div className=\"rounded-lg border border-border/60 bg-muted/40 p-3 text-sm text-muted-foreground\">\r\n                    {t('decisionsDrawer.noOptions')}\r\n                  </div>\r\n                )}\r\n\r\n                {options.map((o) => (\r\n                  <label\r\n                    key={o.key}\r\n                    className={`flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-colors ${\r\n                      selected === o.key\r\n                        ? 'border-primary bg-primary/5'\r\n                        : 'border-border hover:border-muted-foreground/50'\r\n                    }`}\r\n                  >\r\n                    <input\r\n                      type=\"radio\"\r\n                      name={`modal-decision-${openDecision.id}`}\r\n                      value={o.key}\r\n                      checked={selected === o.key}\r\n                      onChange={() =>\r\n                        setSelectedOptionByDecisionId((prev) => ({ ...prev, [openDecision.id]: o.key }))\r\n                      }\r\n                      disabled={sending}\r\n                      className=\"sr-only\"\r\n                    />\r\n                    <div className={`h-5 w-5 rounded-full border-2 flex items-center justify-center ${\r\n                      selected === o.key ? 'border-primary' : 'border-muted-foreground/30'\r\n                    }`}>\r\n                      {selected === o.key && (\r\n                        <div className=\"h-2.5 w-2.5 rounded-full bg-primary\" />\r\n                      )}\r\n                    </div>\r\n                    <span className=\"text-foreground font-medium\">{o.label}</span>\r\n                  </label>\r\n                ))}\r\n              </div>\r\n\r\n              {msg && !msg.includes('!') && (\r\n                <p className=\"mt-3 text-sm text-destructive\">{msg}</p>\r\n              )}\r\n\r\n              <div className=\"mt-5\">\r\n                <Button\r\n                  onClick={() => void handleVote(openDecision.id)}\r\n                  disabled={sending || !selected || options.length === 0}\r\n                  className=\"w-full\"\r\n                  size=\"lg\"\r\n                >\r\n                  {sending ? t('voting.voting') : t('voting.submitVote')}\r\n                </Button>\r\n                {options.length === 0 && (\r\n                  <p className=\"mt-2 text-xs text-muted-foreground\">\r\n                    {t('voting.hostNeedsToAddOptions')}\r\n                  </p>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        );\r\n      })()}\r\n\r\n      {/* Countdown Overlay - triggered by host */}\r\n      <CountdownOverlay\r\n        duration={countdownDuration}\r\n        message={countdownMessage}\r\n        variant={countdownVariant}\r\n        isOpen={countdownOpen}\r\n        onComplete={() => setCountdownOpen(false)}\r\n        onSkip={() => setCountdownOpen(false)}\r\n      />\r\n\r\n      {/* Story Overlay - triggered by host */}\r\n      <StoryOverlay\r\n        isOpen={storyOverlayOpen}\r\n        text={storyOverlayText}\r\n        title={storyOverlayTitle}\r\n        speed={storyOverlaySpeed}\r\n        theme={storyOverlayTheme}\r\n        showProgress={storyOverlayShowProgress}\r\n        allowSkip={storyOverlayAllowSkip}\r\n        allowParticipantSkip={storyOverlayAllowParticipantSkip}\r\n        allowClose={storyOverlayAllowClose}\r\n        isHost={false}\r\n        onClose={() => setStoryOverlayOpen(false)}\r\n        onSkip={() => setStoryOverlayOpen(false)}\r\n        onComplete={() => undefined}\r\n      />\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\ParticipantSessionWithPlay.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 't'. Either include it or remove the dependency array.","line":100,"column":6,"nodeType":"ArrayExpression","endLine":100,"endColumn":31,"suggestions":[{"desc":"Update the dependencies array to be: [code, getToken, session, t]","fix":{"range":[3461,3486],"text":"[code, getToken, session, t]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Participant Session Client with Play Mode Integration\r\n * \r\n * Extended version of the participant session client that includes\r\n * ParticipantPlayView for live gameplay.\r\n */\r\n\r\n'use client';\r\n\r\nimport { useEffect, useMemo, useState, useCallback } from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport { useTranslations } from 'next-intl';\r\nimport { \r\n  getPublicSession, \r\n  getParticipantMe, \r\n  heartbeat, \r\n  rejoinSession,\r\n  type PlaySession,\r\n  type Participant,\r\n} from '@/features/play-participant/api';\r\nimport { \r\n  SessionStatusBadge, \r\n  ReconnectingBanner,\r\n  SessionStatusMessage,\r\n} from '@/components/play';\r\nimport { ParticipantPlayMode } from './ParticipantPlayMode';\r\nimport { ActiveSessionShell } from './ActiveSessionShell';\r\nimport { SessionChatDrawer } from '@/features/play/components/SessionChatDrawer';\r\nimport { useSessionChat } from '@/features/play/hooks/useSessionChat';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Skeleton } from '@/components/ui/skeleton';\r\nimport { \r\n  UserGroupIcon, \r\n  ClockIcon,\r\n  ArrowLeftIcon,\r\n  ExclamationCircleIcon,\r\n} from '@heroicons/react/24/outline';\r\n\r\nconst SESSION_STORAGE_KEY = 'lekbanken_participant_token';\r\nconst ACTIVE_JOIN_PREF_KEY = 'lekbanken_active_join_pref';\r\nconst HEARTBEAT_INTERVAL = 10000; // 10 seconds\r\nconst POLL_INTERVAL = 3000; // 3 seconds\r\n\r\ntype ParticipantSessionWithPlayProps = {\r\n  code: string;\r\n};\r\n\r\nexport function ParticipantSessionWithPlayClient({ code }: ParticipantSessionWithPlayProps) {\r\n  const router = useRouter();\r\n  const t = useTranslations('play.participantView.lobby');\r\n  const [session, setSession] = useState<PlaySession | null>(null);\r\n  const [participant, setParticipant] = useState<Participant | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [isReconnecting, setIsReconnecting] = useState(false);\r\n  const [reconnectAttempts, setReconnectAttempts] = useState(0);\r\n\r\n  // Active session mode UI state\r\n  const [activeSessionOpen, setActiveSessionOpen] = useState(false);\r\n  const [joinGateSecondsLeft, setJoinGateSecondsLeft] = useState<number | null>(null);\r\n  const [chatOpen, setChatOpen] = useState(false);\r\n\r\n  const joinPrefKey = useMemo(() => `${ACTIVE_JOIN_PREF_KEY}_${code}`, [code]);\r\n\r\n  const getToken = useCallback(() => {\r\n    if (typeof window === 'undefined') return null;\r\n    return sessionStorage.getItem(`${SESSION_STORAGE_KEY}_${code}`);\r\n  }, [code]);\r\n\r\n  // Load session and participant data\r\n  const loadData = useCallback(async () => {\r\n    const token = getToken();\r\n    \r\n    try {\r\n      // Get public session info\r\n      const sessionRes = await getPublicSession(code);\r\n      setSession(sessionRes.session);\r\n\r\n      // If we have a token, get our participant info\r\n      if (token) {\r\n        const meRes = await getParticipantMe(code, token);\r\n        setParticipant(meRes.participant);\r\n      }\r\n\r\n      setError(null);\r\n      setIsReconnecting(false);\r\n      setReconnectAttempts(0);\r\n    } catch (err) {\r\n      // If we were connected before, show reconnecting state\r\n      if (session) {\r\n        setIsReconnecting(true);\r\n        setReconnectAttempts((prev) => prev + 1);\r\n      } else {\r\n        setError(err instanceof Error ? err.message : t('couldNotGetSession'));\r\n      }\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [code, getToken, session]);\r\n\r\n  // Send heartbeat\r\n  const sendHeartbeat = useCallback(async () => {\r\n    const token = getToken();\r\n    if (!token) return;\r\n\r\n    try {\r\n      await heartbeat(code, token);\r\n    } catch {\r\n      // Heartbeat failed, will be handled by polling\r\n    }\r\n  }, [code, getToken]);\r\n\r\n  // Initial load and polling\r\n  useEffect(() => {\r\n    void loadData();\r\n\r\n    const pollInterval = setInterval(() => void loadData(), POLL_INTERVAL);\r\n    const heartbeatInterval = setInterval(() => void sendHeartbeat(), HEARTBEAT_INTERVAL);\r\n\r\n    return () => {\r\n      clearInterval(pollInterval);\r\n      clearInterval(heartbeatInterval);\r\n    };\r\n  }, [loadData, sendHeartbeat]);\r\n\r\n  // Try to rejoin if we have a token but no participant\r\n  useEffect(() => {\r\n    const token = getToken();\r\n    if (session && token && !participant && !loading) {\r\n      void (async () => {\r\n        try {\r\n          await rejoinSession({ sessionCode: code, participantToken: token });\r\n          await loadData();\r\n        } catch {\r\n          // Token might be invalid, clear it\r\n          if (typeof window !== 'undefined') {\r\n            sessionStorage.removeItem(`${SESSION_STORAGE_KEY}_${code}`);\r\n          }\r\n        }\r\n      })();\r\n    }\r\n  }, [session, participant, loading, code, getToken, loadData]);\r\n\r\n  const handleRetry = () => {\r\n    setReconnectAttempts(0);\r\n    void loadData();\r\n  };\r\n\r\n  const handleLeave = () => {\r\n    if (typeof window !== 'undefined') {\r\n      sessionStorage.removeItem(`${SESSION_STORAGE_KEY}_${code}`);\r\n    }\r\n    router.push('/play');\r\n  };\r\n\r\n  const setJoinPreference = useCallback((value: 'join' | 'later') => {\r\n    if (typeof window === 'undefined') return;\r\n    try {\r\n      sessionStorage.setItem(joinPrefKey, value);\r\n    } catch {\r\n      // ignore\r\n    }\r\n  }, [joinPrefKey]);\r\n\r\n  const getJoinPreference = useCallback((): 'join' | 'later' | null => {\r\n    if (typeof window === 'undefined') return null;\r\n    try {\r\n      const v = sessionStorage.getItem(joinPrefKey);\r\n      if (v === 'join' || v === 'later') return v;\r\n      return null;\r\n    } catch {\r\n      return null;\r\n    }\r\n  }, [joinPrefKey]);\r\n\r\n  // Check if we should offer Active Session Mode (game linked and participant joined)\r\n  const hasGame = Boolean(session?.gameId);\r\n  const token = getToken();\r\n  const isSessionActive = session?.status === 'active';\r\n  const canEnterActiveSession = Boolean(hasGame && participant && token && isSessionActive);\r\n\r\n  const shouldRenderActiveSessionShell = Boolean(token && canEnterActiveSession && activeSessionOpen);\r\n\r\n  const chat = useSessionChat({\r\n    sessionId: session?.id ?? '',\r\n    role: 'participant',\r\n    participantToken: token ?? undefined,\r\n    isOpen: chatOpen,\r\n    enabled: Boolean(shouldRenderActiveSessionShell && token && session?.id),\r\n  });\r\n\r\n  const { markAllRead } = chat;\r\n  useEffect(() => {\r\n    if (chatOpen) markAllRead();\r\n  }, [chatOpen, markAllRead]);\r\n\r\n  // Gate: when host starts session, show 5s countdown + choices.\r\n  useEffect(() => {\r\n    if (!canEnterActiveSession) {\r\n      setActiveSessionOpen(false);\r\n      setJoinGateSecondsLeft(null);\r\n      return;\r\n    }\r\n\r\n    const pref = getJoinPreference();\r\n    if (pref === 'later') {\r\n      setActiveSessionOpen(false);\r\n      setJoinGateSecondsLeft(null);\r\n      return;\r\n    }\r\n\r\n    if (activeSessionOpen) return;\r\n    setJoinGateSecondsLeft(5);\r\n  }, [activeSessionOpen, canEnterActiveSession, getJoinPreference]);\r\n\r\n  useEffect(() => {\r\n    if (joinGateSecondsLeft === null) return;\r\n    if (joinGateSecondsLeft <= 0) {\r\n      setJoinPreference('join');\r\n      setJoinGateSecondsLeft(null);\r\n      setActiveSessionOpen(true);\r\n      return;\r\n    }\r\n    const t = window.setTimeout(() => setJoinGateSecondsLeft((s) => (s === null ? s : s - 1)), 1000);\r\n    return () => window.clearTimeout(t);\r\n  }, [joinGateSecondsLeft, setJoinPreference]);\r\n\r\n  // Loading state\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-[80vh] flex flex-col items-center justify-center px-4 py-12\">\r\n        <Card variant=\"elevated\" className=\"w-full max-w-lg p-8 space-y-6\">\r\n          <Skeleton className=\"h-8 w-32 mx-auto\" />\r\n          <Skeleton className=\"h-4 w-48 mx-auto\" />\r\n          <div className=\"space-y-3\">\r\n            <Skeleton className=\"h-24 w-full\" />\r\n            <Skeleton className=\"h-12 w-full\" />\r\n          </div>\r\n        </Card>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Error state - session not found\r\n  if (error && !session) {\r\n    return (\r\n      <div className=\"min-h-[80vh] flex flex-col items-center justify-center px-4 py-12\">\r\n        <Card variant=\"elevated\" className=\"w-full max-w-md p-8 text-center space-y-4\">\r\n          <div className=\"mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-destructive/10\">\r\n            <ExclamationCircleIcon className=\"h-6 w-6 text-destructive\" />\r\n          </div>\r\n          <h1 className=\"text-xl font-semibold text-foreground\">\r\n            {t('sessionNotFound')}\r\n          </h1>\r\n          <p className=\"text-muted-foreground\">\r\n            {t('checkCodeAndRetry')}\r\n          </p>\r\n          <Button variant=\"primary\" onClick={() => router.push('/play')}>\r\n            <ArrowLeftIcon className=\"h-4 w-4\" />\r\n            {t('backToStart')}\r\n          </Button>\r\n        </Card>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Session ended state\r\n  if (session?.status === 'ended' || session?.status === 'cancelled') {\r\n    return (\r\n      <div className=\"min-h-[80vh] flex flex-col items-center justify-center px-4 py-12\">\r\n        <Card variant=\"elevated\" className=\"w-full max-w-md p-8 text-center space-y-4\">\r\n          <SessionStatusBadge status={session.status} size=\"lg\" showIcon />\r\n          <h1 className=\"text-xl font-semibold text-foreground\">\r\n            {t('sessionEnded')}\r\n          </h1>\r\n          <p className=\"text-muted-foreground\">\r\n            {t('thanksForParticipating')}\r\n          </p>\r\n          <Button variant=\"primary\" onClick={() => router.push('/play')}>\r\n            <ArrowLeftIcon className=\"h-4 w-4\" />\r\n            {t('joinNewSession')}\r\n          </Button>\r\n        </Card>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Regular lobby view (no game or waiting)\r\n  return (\r\n    <div className=\"min-h-[80vh] flex flex-col px-4 py-6\">\r\n      {/* Reconnecting banner */}\r\n      <ReconnectingBanner\r\n        isReconnecting={isReconnecting}\r\n        attemptCount={reconnectAttempts}\r\n        maxAttempts={5}\r\n        onRetry={handleRetry}\r\n      />\r\n\r\n      {/* Session header */}\r\n      <div className=\"text-center mb-6\">\r\n        <div className=\"flex items-center justify-center gap-2 mb-2\">\r\n          <span className=\"font-mono text-lg font-bold text-primary tracking-wider\">\r\n            {code}\r\n          </span>\r\n          <SessionStatusBadge status={session?.status ?? 'active'} size=\"sm\" />\r\n        </div>\r\n        <h1 className=\"text-2xl font-bold text-foreground\">\r\n          {session?.displayName}\r\n        </h1>\r\n      </div>\r\n\r\n      {/* Participant info */}\r\n      {participant && (\r\n        <Card variant=\"elevated\" className=\"max-w-lg mx-auto w-full p-6 mb-6\">\r\n          <div className=\"text-center\">\r\n            <p className=\"text-sm text-muted-foreground mb-1\">{t('participatingAs')}</p>\r\n            <p className=\"text-xl font-semibold text-foreground\">\r\n              {participant.displayName}\r\n            </p>\r\n            <p className=\"text-sm text-muted-foreground capitalize\">\r\n              {participant.role === 'player' && t('rolePlayer')}\r\n              {participant.role === 'observer' && t('roleObserver')}\r\n              {participant.role === 'team_lead' && t('roleTeamLead')}\r\n              {participant.role === 'facilitator' && t('roleFacilitator')}\r\n            </p>\r\n          </div>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Session status */}\r\n      {session?.status === 'paused' && (\r\n        <SessionStatusMessage\r\n          type=\"warning\"\r\n          title={t('sessionPaused')}\r\n          message={t('awaitInstructions')}\r\n          className=\"max-w-lg mx-auto w-full mb-6\"\r\n        />\r\n      )}\r\n\r\n      {session?.status === 'locked' && (\r\n        <SessionStatusMessage\r\n          type=\"info\"\r\n          title={t('sessionLocked')}\r\n          message={t('noNewParticipants')}\r\n          className=\"max-w-lg mx-auto w-full mb-6\"\r\n        />\r\n      )}\r\n\r\n      {/* Stats */}\r\n      <div className=\"flex items-center justify-center gap-6 text-muted-foreground mb-8\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <UserGroupIcon className=\"h-5 w-5\" />\r\n          <span>{t('participants', { count: session?.participantCount ?? 0 })}</span>\r\n        </div>\r\n        {session?.createdAt && (\r\n          <div className=\"flex items-center gap-2\">\r\n            <ClockIcon className=\"h-5 w-5\" />\r\n            <span>{t('started')}</span>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Main content area - waiting message */}\r\n      <Card variant=\"default\" className=\"max-w-2xl mx-auto w-full flex-1 p-8 flex items-center justify-center\">\r\n        <div className=\"text-center text-muted-foreground\">\r\n          <p className=\"text-lg\">{t('waitingForActivity')}</p>\r\n          <p className=\"text-sm mt-2\">\r\n            {hasGame \r\n              ? t('gameContentWillShow')\r\n              : t('contentWillShow')}\r\n          </p>\r\n\r\n          {canEnterActiveSession && !activeSessionOpen && getJoinPreference() === 'later' && (\r\n            <div className=\"mt-6\">\r\n              <Button variant=\"primary\" onClick={() => {\r\n                setJoinPreference('join');\r\n                setActiveSessionOpen(true);\r\n              }}>\r\n                {t('joinSession')}\r\n              </Button>\r\n            </div>\r\n          )}\r\n\r\n          {canEnterActiveSession && !activeSessionOpen && joinGateSecondsLeft !== null && (\r\n            <div className=\"mt-6 space-y-3\">\r\n              <div className=\"text-sm text-muted-foreground\">{t('sessionIsActive')}</div>\r\n              <div className=\"text-2xl font-semibold text-foreground\">{joinGateSecondsLeft}s</div>\r\n              <div className=\"grid grid-cols-2 gap-3\">\r\n                <Button\r\n                  variant=\"primary\"\r\n                  onClick={() => {\r\n                    setJoinPreference('join');\r\n                    setJoinGateSecondsLeft(null);\r\n                    setActiveSessionOpen(true);\r\n                  }}\r\n                >\r\n                  {t('joinNow')}\r\n                </Button>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  onClick={() => {\r\n                    setJoinPreference('later');\r\n                    setJoinGateSecondsLeft(null);\r\n                    setActiveSessionOpen(false);\r\n                  }}\r\n                >\r\n                  {t('notYet')}\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </Card>\r\n\r\n      {/* Leave button */}\r\n      <div className=\"mt-8 text-center\">\r\n        <Button variant=\"ghost\" size=\"sm\" onClick={handleLeave}>\r\n          {t('leaveSession')}\r\n        </Button>\r\n      </div>\r\n\r\n      {shouldRenderActiveSessionShell && token && (\r\n        <ActiveSessionShell\r\n          role=\"participant\"\r\n          open\r\n          title={session?.displayName ?? t('activeSession')}\r\n          onRequestClose={() => setActiveSessionOpen(false)}\r\n          chatUnreadCount={chat.unreadCount}\r\n          onOpenChat={() => setChatOpen(true)}\r\n        >\r\n          <ReconnectingBanner\r\n            isReconnecting={isReconnecting}\r\n            attemptCount={reconnectAttempts}\r\n            maxAttempts={5}\r\n            onRetry={handleRetry}\r\n          />\r\n\r\n          <ParticipantPlayMode\r\n            sessionCode={code}\r\n            participantToken={token}\r\n            showRole={true}\r\n          />\r\n\r\n          <SessionChatDrawer\r\n            open={chatOpen}\r\n            onClose={() => setChatOpen(false)}\r\n            role=\"participant\"\r\n            messages={chat.messages}\r\n            error={chat.error}\r\n            sending={chat.sending}\r\n            onSend={chat.send}\r\n          />\r\n        </ActiveSessionShell>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\ParticipantSignalMicroUI.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":190,"column":62,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":190,"endColumn":67},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":210,"column":59,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":212,"endColumn":9}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { sendSessionSignal } from '@/features/play/api/signals-api';\r\n\r\ntype ParticipantSignalMicroUIProps = {\r\n  sessionId: string;\r\n  participantToken: string;\r\n  disabled?: boolean;\r\n};\r\n\r\ntype QueuedSignal = {\r\n  id: string;\r\n  channel: string;\r\n  message: string;\r\n  createdAt: string;\r\n};\r\n\r\nfunction makeQueueKey(sessionId: string, participantToken: string): string {\r\n  // Avoid storing the whole token as key suffix\r\n  const suffix = participantToken.slice(0, 12);\r\n  return `lekbanken:signal-queue:${sessionId}:${suffix}`;\r\n}\r\n\r\nfunction safeParseQueue(raw: string | null): QueuedSignal[] {\r\n  if (!raw) return [];\r\n  try {\r\n    const value = JSON.parse(raw) as unknown;\r\n    if (!Array.isArray(value)) return [];\r\n    const result: QueuedSignal[] = [];\r\n    for (const item of value) {\r\n      if (!item || typeof item !== 'object') continue;\r\n      const rec = item as Record<string, unknown>;\r\n      if (typeof rec.id !== 'string') continue;\r\n      if (typeof rec.channel !== 'string') continue;\r\n      if (typeof rec.message !== 'string') continue;\r\n      if (typeof rec.createdAt !== 'string') continue;\r\n      result.push({\r\n        id: rec.id,\r\n        channel: rec.channel,\r\n        message: rec.message,\r\n        createdAt: rec.createdAt,\r\n      });\r\n    }\r\n    return result.slice(0, 50);\r\n  } catch {\r\n    return [];\r\n  }\r\n}\r\n\r\nfunction isNetworkError(err: unknown): boolean {\r\n  // fetch() network failures often throw TypeError in browsers\r\n  if (err instanceof TypeError) return true;\r\n  return false;\r\n}\r\n\r\nexport function ParticipantSignalMicroUI({\r\n  sessionId,\r\n  participantToken,\r\n  disabled = false,\r\n}: ParticipantSignalMicroUIProps) {\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [sending, setSending] = useState(false);\r\n\r\n  const queueKey = useMemo(() => makeQueueKey(sessionId, participantToken), [sessionId, participantToken]);\r\n  const [queue, setQueue] = useState<QueuedSignal[]>(() => {\r\n    if (typeof window === 'undefined') return [];\r\n    return safeParseQueue(window.localStorage.getItem(queueKey));\r\n  });\r\n\r\n  const updateQueue = useCallback((updater: (prev: QueuedSignal[]) => QueuedSignal[]) => {\r\n    setQueue((prev) => {\r\n      const next = updater(prev).slice(0, 50);\r\n      try {\r\n        window.localStorage.setItem(queueKey, JSON.stringify(next));\r\n      } catch {\r\n        // ignore\r\n      }\r\n      return next;\r\n    });\r\n  }, [queueKey]);\r\n\r\n  const enqueue = useCallback((item: QueuedSignal) => {\r\n    updateQueue((prev) => [item, ...prev]);\r\n  }, [updateQueue]);\r\n\r\n  const dequeueById = useCallback((id: string) => {\r\n    updateQueue((prev) => prev.filter((q) => q.id !== id));\r\n  }, [updateQueue]);\r\n\r\n  useEffect(() => {\r\n    // Reload queue when session/token changes.\r\n    setQueue(safeParseQueue(window.localStorage.getItem(queueKey)));\r\n  }, [queueKey]);\r\n\r\n  // Keep a ref to avoid stale closures in retry timer\r\n  const queueRef = useRef(queue);\r\n  useEffect(() => {\r\n    queueRef.current = queue;\r\n  }, [queue]);\r\n\r\n  const sendNow = useCallback(async (channel: string, message: string) => {\r\n    setSending(true);\r\n    setError(null);\r\n    try {\r\n      await sendSessionSignal(\r\n        sessionId,\r\n        { channel, message },\r\n        { participantToken }\r\n      );\r\n      return true;\r\n    } catch (err) {\r\n      if (isNetworkError(err) || (typeof navigator !== 'undefined' && navigator.onLine === false)) {\r\n        return false;\r\n      }\r\n      setError(err instanceof Error ? err.message : 'Kunde inte skicka signal');\r\n      return true; // non-network error: donÔÇÖt queue infinitely\r\n    } finally {\r\n      setSending(false);\r\n    }\r\n  }, [sessionId, participantToken]);\r\n\r\n  const handleTap = useCallback(async (channel: string) => {\r\n    if (disabled || sending) return;\r\n\r\n    const item: QueuedSignal = {\r\n      id: (typeof crypto !== 'undefined' && 'randomUUID' in crypto) ? crypto.randomUUID() : String(Date.now()),\r\n      channel,\r\n      message: 'tap',\r\n      createdAt: new Date().toISOString(),\r\n    };\r\n\r\n    const ok = await sendNow(channel, item.message);\r\n    if (!ok) {\r\n      enqueue(item);\r\n      setError(null);\r\n    }\r\n  }, [disabled, sending, sendNow, enqueue]);\r\n\r\n  const retryQueueOnce = useCallback(async () => {\r\n    const pending = queueRef.current;\r\n    if (pending.length === 0) return;\r\n    if (typeof navigator !== 'undefined' && navigator.onLine === false) return;\r\n\r\n    // Retry oldest last (FIFO-ish): take the last item in the array\r\n    const next = pending[pending.length - 1];\r\n    if (!next) return;\r\n\r\n    const ok = await sendNow(next.channel, next.message);\r\n    if (ok) {\r\n      dequeueById(next.id);\r\n    }\r\n  }, [sendNow, dequeueById]);\r\n\r\n  useEffect(() => {\r\n    if (queue.length === 0) return;\r\n\r\n    const interval = window.setInterval(() => {\r\n      void retryQueueOnce();\r\n    }, 5000);\r\n\r\n    return () => window.clearInterval(interval);\r\n  }, [queue.length, retryQueueOnce]);\r\n\r\n  useEffect(() => {\r\n    const onOnline = () => {\r\n      void retryQueueOnce();\r\n    };\r\n    window.addEventListener('online', onOnline);\r\n    return () => window.removeEventListener('online', onOnline);\r\n  }, [retryQueueOnce]);\r\n\r\n  const buttons = useMemo(\r\n    () => [\r\n      { channel: 'READY', label: 'READY' },\r\n      { channel: 'SOS', label: 'SOS' },\r\n      { channel: 'FOUND', label: 'FOUND' },\r\n    ],\r\n    []\r\n  );\r\n\r\n  return (\r\n    <Card className=\"p-4\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div className=\"text-sm font-semibold uppercase tracking-wider text-muted-foreground\">Signals</div>\r\n        {queue.length > 0 && (\r\n          <Badge variant=\"secondary\" size=\"sm\">{queue.length} i k├Â</Badge>\r\n        )}\r\n      </div>\r\n\r\n      {error && <div className=\"mt-2 text-sm text-destructive\">{error}</div>}\r\n\r\n      <div className=\"mt-3 grid grid-cols-3 gap-2\">\r\n        {buttons.map((b) => (\r\n          <Button\r\n            key={b.channel}\r\n            type=\"button\"\r\n            onClick={() => void handleTap(b.channel)}\r\n            disabled={disabled || sending}\r\n          >\r\n            {b.label}\r\n          </Button>\r\n        ))}\r\n      </div>\r\n\r\n      {queue.length > 0 && (\r\n        <p className=\"mt-2 text-xs text-muted-foreground\">\r\n          Skickas automatiskt n├ñr du ├ñr online.\r\n        </p>\r\n      )}\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\ParticipantTimeBankDisplay.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\PreflightChecklist.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":127,"column":65,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":129,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":130,"column":56,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":132,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":157,"column":49,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":159,"endColumn":11}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * PreflightChecklist Component\r\n *\r\n * Shows a readiness checklist before starting a session.\r\n * Helps host verify all prerequisites are met before entering active play.\r\n */\r\n\r\n'use client';\r\n\r\nimport {\r\n  CheckCircleIcon,\r\n  ExclamationTriangleIcon,\r\n  XCircleIcon,\r\n} from '@heroicons/react/24/solid';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { cn } from '@/lib/utils';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport type ChecklistItemStatus = 'ready' | 'warning' | 'error' | 'pending';\r\n\r\nexport interface ChecklistItem {\r\n  id: string;\r\n  label: string;\r\n  status: ChecklistItemStatus;\r\n  detail?: string;\r\n  action?: {\r\n    label: string;\r\n    onClick: () => void;\r\n  };\r\n}\r\n\r\nexport interface PreflightChecklistProps {\r\n  /** List of checklist items */\r\n  items: ChecklistItem[];\r\n  /** Can the session be started? */\r\n  canStart: boolean;\r\n  /** Called when user clicks start */\r\n  onStart: () => void;\r\n  /** Is start action pending? */\r\n  isStarting?: boolean;\r\n  /** Optional class name */\r\n  className?: string;\r\n}\r\n\r\n// =============================================================================\r\n// Helper Components\r\n// =============================================================================\r\n\r\nfunction StatusIcon({ status }: { status: ChecklistItemStatus }) {\r\n  switch (status) {\r\n    case 'ready':\r\n      return <CheckCircleIcon className=\"h-5 w-5 text-green-500\" />;\r\n    case 'warning':\r\n      return <ExclamationTriangleIcon className=\"h-5 w-5 text-yellow-500\" />;\r\n    case 'error':\r\n      return <XCircleIcon className=\"h-5 w-5 text-destructive\" />;\r\n    case 'pending':\r\n    default:\r\n      return (\r\n        <div className=\"h-5 w-5 rounded-full border-2 border-muted-foreground/30\" />\r\n      );\r\n  }\r\n}\r\n\r\nfunction ChecklistItemRow({ item }: { item: ChecklistItem }) {\r\n  return (\r\n    <div\r\n      className={cn(\r\n        'flex items-start gap-3 rounded-lg border p-3 transition-colors',\r\n        item.status === 'ready' && 'border-green-200 bg-green-50/50',\r\n        item.status === 'warning' && 'border-yellow-200 bg-yellow-50/50',\r\n        item.status === 'error' && 'border-destructive/20 bg-destructive/5',\r\n        item.status === 'pending' && 'border-border bg-muted/30'\r\n      )}\r\n    >\r\n      <StatusIcon status={item.status} />\r\n      <div className=\"min-w-0 flex-1\">\r\n        <div className=\"font-medium text-foreground\">{item.label}</div>\r\n        {item.detail && (\r\n          <div className=\"mt-0.5 text-sm text-muted-foreground\">{item.detail}</div>\r\n        )}\r\n      </div>\r\n      {item.action && (\r\n        <Button\r\n          variant=\"outline\"\r\n          size=\"sm\"\r\n          onClick={item.action.onClick}\r\n          className=\"shrink-0\"\r\n        >\r\n          {item.action.label}\r\n        </Button>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function PreflightChecklist({\r\n  items,\r\n  canStart,\r\n  onStart,\r\n  isStarting = false,\r\n  className,\r\n}: PreflightChecklistProps) {\r\n  const readyCount = items.filter((i) => i.status === 'ready').length;\r\n  const hasErrors = items.some((i) => i.status === 'error');\r\n  const hasWarnings = items.some((i) => i.status === 'warning');\r\n\r\n  return (\r\n    <Card\r\n      className={cn(\r\n        'p-6 border-2',\r\n        canStart ? 'border-green-200 bg-green-50/30' : 'border-yellow-200 bg-yellow-50/30',\r\n        className\r\n      )}\r\n    >\r\n      <div className=\"mb-4 flex items-center justify-between\">\r\n        <div>\r\n          <h2 className=\"text-lg font-semibold text-foreground\">\r\n            Redo att starta?\r\n          </h2>\r\n          <p className=\"text-sm text-muted-foreground\">\r\n            Kontrollera att allt ├ñr p├Ñ plats innan du startar spell├ñget.\r\n          </p>\r\n        </div>\r\n        <Badge\r\n          variant={hasErrors ? 'error' : hasWarnings ? 'warning' : 'success'}\r\n          size=\"lg\"\r\n        >\r\n          {readyCount} / {items.length} klara\r\n        </Badge>\r\n      </div>\r\n\r\n      <div className=\"space-y-2\">\r\n        {items.map((item) => (\r\n          <ChecklistItemRow key={item.id} item={item} />\r\n        ))}\r\n      </div>\r\n\r\n      <div className=\"mt-6 flex items-center justify-between border-t border-border pt-4\">\r\n        {!canStart && (\r\n          <p className=\"text-sm text-muted-foreground\">\r\n            {hasErrors\r\n              ? '├àtg├ñrda felen ovan f├Âr att kunna starta.'\r\n              : 'Kontrollera varningarna innan du startar.'}\r\n          </p>\r\n        )}\r\n        {canStart && (\r\n          <p className=\"text-sm text-green-700\">\r\n            Ô£ô Allt ser bra ut! Du kan starta sessionen.\r\n          </p>\r\n        )}\r\n\r\n        <Button\r\n          variant=\"primary\"\r\n          size=\"lg\"\r\n          onClick={onStart}\r\n          disabled={!canStart || isStarting}\r\n          className=\"shrink-0\"\r\n        >\r\n          {isStarting ? 'Startar...' : 'Starta spell├ñge'}\r\n        </Button>\r\n      </div>\r\n    </Card>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Helper: Build checklist items from session state\r\n// =============================================================================\r\n\r\nexport interface SessionChecklistState {\r\n  participantCount: number;\r\n  hasGame: boolean;\r\n  rolesSnapshotted: boolean;\r\n  rolesAssignedCount: number;\r\n  totalRoles: number;\r\n  artifactsSnapshotted?: boolean;\r\n  secretsUnlocked?: boolean;\r\n  // Extended checks (Task 1.5)\r\n  hasSecretInstructions?: boolean;\r\n  secretsRevealedCount?: number;\r\n  hasTriggers?: boolean;\r\n  triggersSnapshotted?: boolean;\r\n  armedTriggersCount?: number;\r\n  signalCapabilitiesTested?: boolean;\r\n  roleMinCountsStatus?: Array<{ roleId: string; name: string; min: number; assigned: number; met: boolean }>;\r\n}\r\n\r\nexport function buildPreflightItems(\r\n  state: SessionChecklistState,\r\n  actions: {\r\n    onSnapshotRoles?: () => void;\r\n    onAssignRoles?: () => void;\r\n    onUnlockSecrets?: () => void;\r\n    onTestSignals?: () => void;\r\n  }\r\n): ChecklistItem[] {\r\n  const items: ChecklistItem[] = [];\r\n\r\n  // 1. Participants check\r\n  items.push({\r\n    id: 'participants',\r\n    label: 'Deltagare',\r\n    status: state.participantCount > 0 ? 'ready' : 'warning',\r\n    detail:\r\n      state.participantCount > 0\r\n        ? `${state.participantCount} deltagare har g├Ñtt med`\r\n        : 'Inga deltagare har g├Ñtt med ├ñnnu',\r\n  });\r\n\r\n  // 2. Game check\r\n  if (!state.hasGame) {\r\n    items.push({\r\n      id: 'game',\r\n      label: 'Spel kopplat',\r\n      status: 'error',\r\n      detail: 'Sessionen har inget spel kopplat',\r\n    });\r\n    return items; // Early return - can't continue without game\r\n  }\r\n\r\n  // 3. Roles snapshot check\r\n  if (!state.rolesSnapshotted) {\r\n    items.push({\r\n      id: 'roles-snapshot',\r\n      label: 'Roller kopierade',\r\n      status: 'error',\r\n      detail: 'Kopiera roller fr├Ñn spelet innan du kan tilldela dem',\r\n      action: actions.onSnapshotRoles\r\n        ? { label: 'Kopiera roller', onClick: actions.onSnapshotRoles }\r\n        : undefined,\r\n    });\r\n  } else {\r\n    items.push({\r\n      id: 'roles-snapshot',\r\n      label: 'Roller kopierade',\r\n      status: 'ready',\r\n      detail: `${state.totalRoles} roller kopierade fr├Ñn spelet`,\r\n    });\r\n\r\n    // 4. Roles assignment check\r\n    if (state.roleMinCountsStatus && state.roleMinCountsStatus.length > 0) {\r\n      const minCountsMet = state.roleMinCountsStatus.every((r) => r.met);\r\n      const someAssigned = state.rolesAssignedCount > 0;\r\n\r\n      items.push({\r\n        id: 'roles-assigned',\r\n        label: 'Roller tilldelade',\r\n        status: minCountsMet ? 'ready' : someAssigned ? 'warning' : 'pending',\r\n        detail: minCountsMet\r\n          ? 'Alla minimikrav uppfyllda'\r\n          : state.roleMinCountsStatus\r\n              .filter((r) => !r.met)\r\n              .map((r) => `${r.name}: ${r.assigned}/${r.min}`)\r\n              .join(', '),\r\n        action:\r\n          !minCountsMet && actions.onAssignRoles\r\n            ? { label: 'Tilldela roller', onClick: actions.onAssignRoles }\r\n            : undefined,\r\n      });\r\n    } else {\r\n      // Fallback for simpler role check\r\n      const allAssigned =\r\n        state.participantCount > 0 &&\r\n        state.rolesAssignedCount >= state.participantCount;\r\n      const someAssigned = state.rolesAssignedCount > 0;\r\n\r\n      items.push({\r\n        id: 'roles-assigned',\r\n        label: 'Roller tilldelade',\r\n        status: allAssigned ? 'ready' : someAssigned ? 'warning' : 'pending',\r\n        detail: allAssigned\r\n          ? 'Alla deltagare har f├Ñtt roller'\r\n          : someAssigned\r\n            ? `${state.rolesAssignedCount} av ${state.participantCount} deltagare har roller`\r\n            : 'Ingen deltagare har tilldelats roll ├ñn',\r\n        action:\r\n          !allAssigned && actions.onAssignRoles\r\n            ? { label: 'Tilldela roller', onClick: actions.onAssignRoles }\r\n            : undefined,\r\n      });\r\n    }\r\n  }\r\n\r\n  // 5. Secrets check (if applicable)\r\n  if (state.hasSecretInstructions) {\r\n    const allRolesAssigned = state.rolesAssignedCount >= state.participantCount;\r\n    const secretsRevealedCount = state.secretsRevealedCount ?? 0;\r\n\r\n    items.push({\r\n      id: 'secrets',\r\n      label: 'Hemliga instruktioner',\r\n      status: state.secretsUnlocked\r\n        ? 'ready'\r\n        : allRolesAssigned\r\n          ? 'warning'\r\n          : 'pending',\r\n      detail: state.secretsUnlocked\r\n        ? `Uppl├Ñsta (${secretsRevealedCount}/${state.participantCount} har visat)`\r\n        : allRolesAssigned\r\n          ? 'Redo att l├Ñsas upp'\r\n          : 'Tilldela roller f├Ârst',\r\n      action:\r\n        !state.secretsUnlocked && allRolesAssigned && actions.onUnlockSecrets\r\n          ? { label: 'L├Ñs upp', onClick: actions.onUnlockSecrets }\r\n          : undefined,\r\n    });\r\n  }\r\n\r\n  // 6. Artifacts check\r\n  if (state.artifactsSnapshotted !== undefined) {\r\n    items.push({\r\n      id: 'artifacts',\r\n      label: 'Artefakter',\r\n      status: state.artifactsSnapshotted ? 'ready' : 'pending',\r\n      detail: state.artifactsSnapshotted\r\n        ? 'Artefakter redo f├Âr sessionen'\r\n        : 'Artefakter laddas automatiskt vid start',\r\n    });\r\n  }\r\n\r\n  // 7. Triggers check\r\n  if (state.hasTriggers) {\r\n    items.push({\r\n      id: 'triggers',\r\n      label: 'Triggers',\r\n      status: state.triggersSnapshotted ? 'ready' : 'pending',\r\n      detail: state.triggersSnapshotted\r\n        ? `${state.armedTriggersCount ?? 0} triggers redo`\r\n        : 'Triggers laddas automatiskt vid start',\r\n    });\r\n  }\r\n\r\n  // 8. Signal capabilities check\r\n  if (state.signalCapabilitiesTested !== undefined) {\r\n    items.push({\r\n      id: 'signals',\r\n      label: 'Signaler',\r\n      status: state.signalCapabilitiesTested ? 'ready' : 'pending',\r\n      detail: state.signalCapabilitiesTested\r\n        ? 'Signalk├ñllor testade'\r\n        : 'Testa signalk├ñllor (valfritt)',\r\n      action:\r\n        !state.signalCapabilitiesTested && actions.onTestSignals\r\n          ? { label: 'Testa', onClick: actions.onTestSignals }\r\n          : undefined,\r\n    });\r\n  }\r\n\r\n  return items;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\PropConfirmationManager.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":168,"column":17,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":168,"endColumn":45},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":181,"column":43,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":181,"endColumn":60},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":184,"column":41,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":185,"endColumn":15},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":207,"column":68,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":209,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"T.ex. 'Bra jobbat!' eller 'Ej korrekt f├Ârem├Ñl'\". Consider using useTranslations() or t() for internationalization.","line":268,"column":29,"nodeType":"Literal","messageId":"hardcodedString","endLine":268,"endColumn":77},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":287,"column":19,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":289,"endColumn":15},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":296,"column":57,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":298,"endColumn":15},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":308,"column":91,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":309,"endColumn":40}],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":252,"column":19,"nodeType":"JSXOpeningElement","endLine":256,"endColumn":21,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\n/**\r\n * PropConfirmationManager Component\r\n * \r\n * Host-facing panel for managing prop confirmation requests.\r\n * Allows host to approve, reject, or request photo evidence.\r\n */\r\n\r\nimport { useCallback, useEffect, useState } from 'react';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport {\r\n  CheckCircleIcon,\r\n  XCircleIcon,\r\n  ClockIcon,\r\n  CameraIcon,\r\n  ArrowPathIcon,\r\n  ExclamationTriangleIcon,\r\n  CubeIcon,\r\n  ChatBubbleLeftIcon,\r\n} from '@heroicons/react/24/solid';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface PropRequest {\r\n  id: string;\r\n  artifactId: string;\r\n  artifactTitle: string;\r\n  participantId: string;\r\n  participantName: string;\r\n  teamId?: string;\r\n  teamName?: string;\r\n  propDescription: string;\r\n  propImageUrl?: string;\r\n  status: 'pending' | 'waiting' | 'confirmed' | 'rejected';\r\n  requestedAt: string;\r\n  photoUrl?: string;\r\n  hostNotes?: string;\r\n}\r\n\r\nexport interface PropConfirmationManagerProps {\r\n  sessionId: string;\r\n  /** Refresh interval in ms (default: 3000) */\r\n  refreshInterval?: number;\r\n  /** Callback when a request is handled */\r\n  onRequestHandled?: (requestId: string, action: 'confirm' | 'reject') => void;\r\n}\r\n\r\n// =============================================================================\r\n// Component\r\n// =============================================================================\r\n\r\nexport function PropConfirmationManager({\r\n  sessionId,\r\n  refreshInterval = 3000,\r\n  onRequestHandled,\r\n}: PropConfirmationManagerProps) {\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [requests, setRequests] = useState<PropRequest[]>([]);\r\n  const [actionLoading, setActionLoading] = useState<Set<string>>(new Set());\r\n  const [notes, setNotes] = useState<Map<string, string>>(new Map());\r\n  const [expandedPhoto, setExpandedPhoto] = useState<string | null>(null);\r\n\r\n  // Load pending requests\r\n  const loadRequests = useCallback(async () => {\r\n    try {\r\n      const res = await fetch(`/api/play/sessions/${sessionId}/puzzles/props`, {\r\n        cache: 'no-store',\r\n      });\r\n      \r\n      if (!res.ok) {\r\n        throw new Error('Kunde inte ladda prop-f├Ârfr├Ñgningar');\r\n      }\r\n      \r\n      const data = await res.json();\r\n      setRequests(data.requests || []);\r\n      setError(null);\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : 'Fel vid laddning');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [sessionId]);\r\n\r\n  // Initial load and polling\r\n  useEffect(() => {\r\n    void loadRequests();\r\n    \r\n    const interval = setInterval(() => {\r\n      void loadRequests();\r\n    }, refreshInterval);\r\n    \r\n    return () => clearInterval(interval);\r\n  }, [loadRequests, refreshInterval]);\r\n\r\n  // Handle confirm/reject action\r\n  const handleAction = useCallback(async (requestId: string, action: 'confirm' | 'reject') => {\r\n    setActionLoading(prev => new Set([...prev, requestId]));\r\n    \r\n    try {\r\n      const hostNotes = notes.get(requestId);\r\n      \r\n      const res = await fetch(`/api/play/sessions/${sessionId}/puzzles/props`, {\r\n        method: 'PATCH',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ \r\n          requestId, \r\n          action,\r\n          hostNotes,\r\n        }),\r\n      });\r\n      \r\n      if (!res.ok) {\r\n        throw new Error('Kunde inte uppdatera f├Ârfr├Ñgan');\r\n      }\r\n      \r\n      // Update local state\r\n      setRequests(prev => prev.map(r => \r\n        r.id === requestId \r\n          ? { ...r, status: action === 'confirm' ? 'confirmed' : 'rejected', hostNotes }\r\n          : r\r\n      ));\r\n      \r\n      // Clear notes\r\n      setNotes(prev => {\r\n        const next = new Map(prev);\r\n        next.delete(requestId);\r\n        return next;\r\n      });\r\n      \r\n      onRequestHandled?.(requestId, action);\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : 'Fel vid uppdatering');\r\n    } finally {\r\n      setActionLoading(prev => {\r\n        const next = new Set(prev);\r\n        next.delete(requestId);\r\n        return next;\r\n      });\r\n    }\r\n  }, [sessionId, notes, onRequestHandled]);\r\n\r\n  // Filter pending requests\r\n  const pendingRequests = requests.filter(r => r.status === 'pending' || r.status === 'waiting');\r\n  const handledRequests = requests.filter(r => r.status === 'confirmed' || r.status === 'rejected');\r\n\r\n  // Time since request\r\n  const getTimeAgo = (timestamp: string) => {\r\n    const diff = Date.now() - new Date(timestamp).getTime();\r\n    const minutes = Math.floor(diff / 60000);\r\n    if (minutes < 1) return 'Just nu';\r\n    if (minutes < 60) return `${minutes} min sedan`;\r\n    const hours = Math.floor(minutes / 60);\r\n    return `${hours}h ${minutes % 60}m sedan`;\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <Card className=\"p-4\">\r\n        <div className=\"flex items-center gap-2 text-muted-foreground\">\r\n          <ArrowPathIcon className=\"h-5 w-5 animate-spin\" />\r\n          <span>Laddar prop-f├Ârfr├Ñgningar...</span>\r\n        </div>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {/* Header */}\r\n      <Card className=\"p-4\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <CubeIcon className=\"h-5 w-5 text-primary\" />\r\n            <h3 className=\"font-semibold\">Prop-bekr├ñftelser</h3>\r\n            {pendingRequests.length > 0 && (\r\n              <Badge variant=\"destructive\" className=\"animate-pulse\">\r\n                {pendingRequests.length} v├ñntande\r\n              </Badge>\r\n            )}\r\n          </div>\r\n          <Button variant=\"ghost\" size=\"sm\" onClick={loadRequests}>\r\n            <ArrowPathIcon className=\"h-4 w-4\" />\r\n          </Button>\r\n        </div>\r\n      </Card>\r\n\r\n      {/* Error message */}\r\n      {error && (\r\n        <Card className=\"p-4 border-destructive\">\r\n          <div className=\"flex items-center gap-2 text-destructive\">\r\n            <ExclamationTriangleIcon className=\"h-5 w-5\" />\r\n            <span className=\"text-sm\">{error}</span>\r\n          </div>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Pending requests */}\r\n      {pendingRequests.length === 0 ? (\r\n        <Card className=\"p-6\">\r\n          <p className=\"text-sm text-muted-foreground text-center\">\r\n            Inga v├ñntande prop-f├Ârfr├Ñgningar\r\n          </p>\r\n        </Card>\r\n      ) : (\r\n        pendingRequests.map((request) => (\r\n          <Card key={request.id} className=\"p-4 border-amber-500/50 bg-amber-500/5\">\r\n            {/* Request header */}\r\n            <div className=\"flex items-start justify-between mb-3\">\r\n              <div>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <span className=\"font-medium\">{request.participantName}</span>\r\n                  {request.teamName && (\r\n                    <Badge variant=\"outline\" className=\"text-xs\">\r\n                      {request.teamName}\r\n                    </Badge>\r\n                  )}\r\n                </div>\r\n                <p className=\"text-sm text-muted-foreground\">{request.artifactTitle}</p>\r\n              </div>\r\n              <div className=\"flex items-center gap-1 text-xs text-muted-foreground\">\r\n                <ClockIcon className=\"h-3 w-3\" />\r\n                {getTimeAgo(request.requestedAt)}\r\n              </div>\r\n            </div>\r\n\r\n            {/* Prop description */}\r\n            <div className=\"p-3 rounded bg-muted/50 mb-3\">\r\n              <p className=\"text-sm\">{request.propDescription}</p>\r\n            </div>\r\n\r\n            {/* Photo evidence (if provided) */}\r\n            {request.photoUrl && (\r\n              <div className=\"mb-3\">\r\n                <button\r\n                  onClick={() => setExpandedPhoto(\r\n                    expandedPhoto === request.id ? null : request.id\r\n                  )}\r\n                  className=\"flex items-center gap-1 text-xs text-primary hover:underline\"\r\n                >\r\n                  <CameraIcon className=\"h-3 w-3\" />\r\n                  {expandedPhoto === request.id ? 'D├Âlj foto' : 'Visa foto'}\r\n                </button>\r\n                {expandedPhoto === request.id && (\r\n                  // eslint-disable-next-line @next/next/no-img-element\r\n                  <img\r\n                    src={request.photoUrl}\r\n                    alt=\"Prop-bevis\"\r\n                    className=\"mt-2 rounded max-h-48 object-contain\"\r\n                  />\r\n                )}\r\n              </div>\r\n            )}\r\n\r\n            {/* Host notes input */}\r\n            <div className=\"mb-3\">\r\n              <div className=\"flex items-center gap-1 text-xs text-muted-foreground mb-1\">\r\n                <ChatBubbleLeftIcon className=\"h-3 w-3\" />\r\n                <span>Anteckning (valfritt)</span>\r\n              </div>\r\n              <Input\r\n                placeholder=\"T.ex. 'Bra jobbat!' eller 'Ej korrekt f├Ârem├Ñl'\"\r\n                value={notes.get(request.id) || ''}\r\n                onChange={(e) => setNotes(prev => new Map(prev).set(request.id, e.target.value))}\r\n                className=\"text-sm\"\r\n              />\r\n            </div>\r\n\r\n            {/* Action buttons */}\r\n            <div className=\"flex gap-2\">\r\n              <Button\r\n                variant=\"default\"\r\n                className=\"flex-1 bg-green-600 hover:bg-green-700\"\r\n                onClick={() => handleAction(request.id, 'confirm')}\r\n                disabled={actionLoading.has(request.id)}\r\n              >\r\n                {actionLoading.has(request.id) ? (\r\n                  <ArrowPathIcon className=\"h-4 w-4 animate-spin mr-1\" />\r\n                ) : (\r\n                  <CheckCircleIcon className=\"h-4 w-4 mr-1\" />\r\n                )}\r\n                Godk├ñnn\r\n              </Button>\r\n              <Button\r\n                variant=\"destructive\"\r\n                className=\"flex-1\"\r\n                onClick={() => handleAction(request.id, 'reject')}\r\n                disabled={actionLoading.has(request.id)}\r\n              >\r\n                <XCircleIcon className=\"h-4 w-4 mr-1\" />\r\n                Avsl├Ñ\r\n              </Button>\r\n            </div>\r\n          </Card>\r\n        ))\r\n      )}\r\n\r\n      {/* Handled requests (collapsible history) */}\r\n      {handledRequests.length > 0 && (\r\n        <Card className=\"p-4\">\r\n          <details>\r\n            <summary className=\"cursor-pointer text-sm font-medium text-muted-foreground\">\r\n              Hanterade f├Ârfr├Ñgningar ({handledRequests.length})\r\n            </summary>\r\n            <div className=\"mt-3 space-y-2\">\r\n              {handledRequests.map((request) => (\r\n                <div \r\n                  key={request.id}\r\n                  className={`flex items-center justify-between p-2 rounded text-sm ${\r\n                    request.status === 'confirmed' \r\n                      ? 'bg-green-500/10' \r\n                      : 'bg-red-500/10'\r\n                  }`}\r\n                >\r\n                  <div className=\"flex items-center gap-2\">\r\n                    {request.status === 'confirmed' ? (\r\n                      <CheckCircleIcon className=\"h-4 w-4 text-green-600\" />\r\n                    ) : (\r\n                      <XCircleIcon className=\"h-4 w-4 text-red-600\" />\r\n                    )}\r\n                    <span>{request.participantName}</span>\r\n                    <span className=\"text-muted-foreground\">- {request.artifactTitle}</span>\r\n                  </div>\r\n                  <span className=\"text-xs text-muted-foreground\">\r\n                    {request.status === 'confirmed' ? 'Godk├ñnd' : 'Avslagen'}\r\n                  </span>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </details>\r\n        </Card>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\PuzzleArtifactRenderer.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":256,"column":63,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":256,"endColumn":75},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":260,"column":53,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":260,"endColumn":79},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":434,"column":61,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":434,"endColumn":74},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":620,"column":61,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":620,"endColumn":76},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":668,"column":61,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":668,"endColumn":66},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":778,"column":60,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":778,"endColumn":65},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":984,"column":37,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":984,"endColumn":50},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":1042,"column":67,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":1044,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":1109,"column":36,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":1109,"endColumn":60}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\n/**\r\n * PuzzleArtifactRenderer Component\r\n * \r\n * Renders puzzle artifacts based on their type.\r\n * Acts as a dispatcher for all puzzle module components.\r\n * \r\n * Each component uses config/state patterns from @/types/puzzle-modules.\r\n * Integrates with real-time sync via usePuzzleRealtime hook.\r\n */\r\n\r\nimport { useCallback, useState, useMemo } from 'react';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Button } from '@/components/ui/button';\r\nimport {\r\n  RiddleInput,\r\n  CounterDisplay,\r\n  AudioPlayer,\r\n  MultiAnswerForm,\r\n  QRScanner,\r\n  HintPanel,\r\n  HotspotImage,\r\n  TilePuzzle,\r\n  CipherDecoder,\r\n  PropRequest,\r\n  LocationCheck,\r\n  LogicGrid,\r\n  SoundLevelMeter,\r\n} from '@/components/play';\r\nimport { usePuzzleRealtime } from '@/features/play/hooks';\r\nimport type { ArtifactType } from '@/types/games';\r\nimport type {\r\n  RiddleConfig,\r\n  RiddleState,\r\n  AudioConfig,\r\n  AudioState,\r\n  MultiAnswerConfig,\r\n  MultiAnswerState,\r\n  ScanGateConfig,\r\n  ScanGateState,\r\n  HintConfig,\r\n  HintState,\r\n  HotspotConfig,\r\n  HotspotState,\r\n  TilePuzzleConfig,\r\n  TilePuzzleState,\r\n  CipherConfig,\r\n  CipherState,\r\n  LogicGridConfig,\r\n  LogicGridState,\r\n  PropConfirmationConfig,\r\n  PropConfirmationState,\r\n  LocationCheckConfig,\r\n  LocationCheckState,\r\n  SoundLevelConfig,\r\n  SoundLevelState,\r\n  Tile,\r\n  LogicGridCell,\r\n  GeoCoordinate,\r\n} from '@/types/puzzle-modules';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface PuzzleArtifactData {\r\n  id: string;\r\n  title: string | null;\r\n  description: string | null;\r\n  artifact_type: string | null;\r\n  artifact_order?: number;\r\n  metadata?: Record<string, unknown> | null;\r\n}\r\n\r\nexport interface PuzzleState {\r\n  solved?: boolean;\r\n  locked?: boolean;\r\n  currentValue?: number;\r\n  checked?: string[];\r\n  verified?: boolean;\r\n  // Add more as needed\r\n  [key: string]: unknown;\r\n}\r\n\r\nexport interface PuzzleArtifactRendererProps {\r\n  artifact: PuzzleArtifactData;\r\n  sessionId: string;\r\n  participantToken: string;\r\n  participantId?: string;\r\n  teamId?: string;\r\n  /** Enable real-time sync (default: true) */\r\n  enableRealtime?: boolean;\r\n  onStateChange?: () => void;\r\n}\r\n\r\n// =============================================================================\r\n// API Helpers\r\n// =============================================================================\r\n\r\nasync function submitPuzzle(\r\n  sessionId: string,\r\n  artifactId: string,\r\n  body: Record<string, unknown>,\r\n  participantToken: string\r\n) {\r\n  const res = await fetch(`/api/play/sessions/${sessionId}/artifacts/${artifactId}/puzzle`, {\r\n    method: 'POST',\r\n    headers: {\r\n      'Content-Type': 'application/json',\r\n      'x-participant-token': participantToken,\r\n    },\r\n    body: JSON.stringify(body),\r\n  });\r\n  return res.json();\r\n}\r\n\r\n// =============================================================================\r\n// Component\r\n// =============================================================================\r\n\r\nexport function PuzzleArtifactRenderer({\r\n  artifact,\r\n  sessionId,\r\n  participantToken,\r\n  participantId,\r\n  teamId,\r\n  enableRealtime = true,\r\n  onStateChange,\r\n}: PuzzleArtifactRendererProps) {\r\n  const [loading, setLoading] = useState(false);\r\n  const [message, setMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null);\r\n  \r\n  // Initial state from artifact metadata\r\n  const initialPuzzleState = useMemo(() => \r\n    (artifact.metadata?.puzzleState as PuzzleState) || {},\r\n    [artifact.metadata?.puzzleState]\r\n  );\r\n\r\n  // Real-time puzzle state sync\r\n  const {\r\n    state: realtimeState,\r\n    connected: realtimeConnected,\r\n    updateState: updateRealtimeState,\r\n    broadcastStateChange,\r\n    isSolved: _isSolved,\r\n    isLocked,\r\n  } = usePuzzleRealtime({\r\n    sessionId,\r\n    artifactId: artifact.id,\r\n    participantId,\r\n    teamId,\r\n    initialState: initialPuzzleState,\r\n    onStateChange: onStateChange ? () => onStateChange() : undefined,\r\n    onSolved: onStateChange ? () => onStateChange() : undefined,\r\n    enabled: enableRealtime,\r\n  });\r\n\r\n  // Use realtime state if enabled, otherwise local state\r\n  const [localPuzzleState, setLocalPuzzleState] = useState<PuzzleState>(initialPuzzleState);\r\n  const puzzleState = enableRealtime ? (realtimeState as PuzzleState) : localPuzzleState;\r\n  \r\n  // Memoize setPuzzleState to avoid changing dependency on every render\r\n  const setPuzzleState = useMemo(() => {\r\n    if (enableRealtime) {\r\n      return (state: PuzzleState | ((prev: PuzzleState) => PuzzleState)) => {\r\n        const newState = typeof state === 'function' ? state(puzzleState) : state;\r\n        updateRealtimeState(newState);\r\n      };\r\n    }\r\n    return setLocalPuzzleState;\r\n  }, [enableRealtime, puzzleState, updateRealtimeState]);\r\n\r\n  const meta = artifact.metadata || {};\r\n  const artifactType = artifact.artifact_type as ArtifactType | null;\r\n\r\n  // Generic submit handler\r\n  const handleSubmit = useCallback(\r\n    async (puzzleType: string, payload: Record<string, unknown>) => {\r\n      // Don't allow submission if locked\r\n      if (isLocked) {\r\n        setMessage({ type: 'error', text: 'Pusslet ├ñr l├Ñst av spelledaren' });\r\n        return;\r\n      }\r\n      \r\n      setLoading(true);\r\n      setMessage(null);\r\n      try {\r\n        const result = await submitPuzzle(sessionId, artifact.id, { puzzleType, ...payload }, participantToken);\r\n        if (result.state) {\r\n          const newState = result.state as PuzzleState;\r\n          setPuzzleState(newState);\r\n          \r\n          // Broadcast state change if realtime is enabled\r\n          if (enableRealtime && realtimeConnected) {\r\n            await broadcastStateChange(newState);\r\n          }\r\n        }\r\n        setMessage({\r\n          type: result.status === 'success' || result.status === 'already_solved' ? 'success' : 'error',\r\n          text: result.message,\r\n        });\r\n        if (result.status === 'success') {\r\n          onStateChange?.();\r\n        }\r\n      } catch (err) {\r\n        setMessage({ type: 'error', text: err instanceof Error ? err.message : 'Serverfel' });\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    },\r\n    [sessionId, artifact.id, participantToken, onStateChange, isLocked, enableRealtime, realtimeConnected, broadcastStateChange, setPuzzleState]\r\n  );\r\n\r\n  // ==========================================================================\r\n  // Riddle\r\n  // ==========================================================================\r\n  if (artifactType === 'riddle') {\r\n    // Build config from metadata\r\n    const promptText = (meta.prompt as string) || (meta.promptText as string) || '';\r\n    const riddleConfig: RiddleConfig = {\r\n      acceptedAnswers: (meta.correctAnswers as string[]) || (meta.acceptedAnswers as string[]) || [meta.correctAnswer as string].filter(Boolean),\r\n      normalizeMode: (meta.normalizeMode as RiddleConfig['normalizeMode']) || 'fuzzy',\r\n      maxAttempts: typeof meta.maxAttempts === 'number' ? meta.maxAttempts : undefined,\r\n      hintText: meta.hintText as string | undefined,\r\n      showHintAfterAttempts: typeof meta.showHintAfterAttempts === 'number' ? meta.showHintAfterAttempts : undefined,\r\n      promptText,\r\n    };\r\n\r\n    // Build state from puzzleState\r\n    const riddleState: RiddleState = {\r\n      isCorrect: puzzleState.solved === true,\r\n      attemptsUsed: (puzzleState.attempts as unknown[])?.length ?? 0,\r\n      attempts: (puzzleState.attempts as Array<{ answer: string; correct: boolean; timestamp: string }>) || [],\r\n      showHint: puzzleState.showHint === true,\r\n    };\r\n\r\n    const isLocked = riddleConfig.maxAttempts !== undefined && riddleState.attemptsUsed >= riddleConfig.maxAttempts;\r\n\r\n    return (\r\n      <Card className=\"p-4 space-y-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <span className=\"text-lg\">ÔØô</span>\r\n            <p className=\"font-medium\">{artifact.title || 'G├Ñta'}</p>\r\n          </div>\r\n          <Badge variant={riddleState.isCorrect ? 'default' : isLocked ? 'destructive' : 'secondary'}>\r\n            {riddleState.isCorrect ? 'L├Âst' : isLocked ? 'L├Ñst' : 'Ol├Âst'}\r\n          </Badge>\r\n        </div>\r\n        {promptText && <p className=\"text-sm text-muted-foreground italic\">{promptText}</p>}\r\n\r\n        {riddleState.isCorrect ? (\r\n          <div className=\"rounded bg-green-500/10 border border-green-500/30 p-3 text-center\">\r\n            <p className=\"text-sm font-medium text-green-600\">Ô£ô R├ñtt svar!</p>\r\n          </div>\r\n        ) : isLocked ? (\r\n          <div className=\"rounded bg-destructive/10 border border-destructive/30 p-3 text-center\">\r\n            <p className=\"text-sm text-destructive\">­ƒöÆ L├Ñst - f├Âr m├Ñnga f├Ârs├Âk</p>\r\n          </div>\r\n        ) : (\r\n          <RiddleInput\r\n            config={riddleConfig}\r\n            state={riddleState}\r\n            onSubmit={(answer) => handleSubmit('riddle', { answer })}\r\n            onCorrect={() => onStateChange?.()}\r\n            disabled={loading}\r\n          />\r\n        )}\r\n\r\n        {message && (\r\n          <p className={`text-xs text-center ${message.type === 'success' ? 'text-green-600' : 'text-destructive'}`}>\r\n            {message.text}\r\n          </p>\r\n        )}\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Counter\r\n  // ==========================================================================\r\n  if (artifactType === 'counter') {\r\n    const target = typeof meta.target === 'number' ? meta.target : 1;\r\n    const label = (meta.label as string) || 'R├ñknare';\r\n    const currentValue = typeof puzzleState.currentValue === 'number' ? puzzleState.currentValue : 0;\r\n    const isCompleted = puzzleState.completed === true || currentValue >= target;\r\n\r\n    return (\r\n      <Card className=\"p-4 space-y-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <span className=\"text-lg\">­ƒöó</span>\r\n            <p className=\"font-medium\">{artifact.title || label}</p>\r\n          </div>\r\n          {isCompleted && <Badge variant=\"default\">Klart!</Badge>}\r\n        </div>\r\n\r\n        <div className=\"flex items-center justify-center gap-4\">\r\n          <CounterDisplay value={currentValue} target={target} label={label} isComplete={isCompleted} />\r\n        </div>\r\n\r\n        {!isCompleted && (\r\n          <div className=\"flex justify-center gap-2\">\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              onClick={() => handleSubmit('counter', { action: 'decrement' })}\r\n              disabled={loading || currentValue <= 0}\r\n            >\r\n              ÔêÆ\r\n            </Button>\r\n            <Button\r\n              variant=\"default\"\r\n              size=\"sm\"\r\n              onClick={() => handleSubmit('counter', { action: 'increment' })}\r\n              disabled={loading}\r\n            >\r\n              +\r\n            </Button>\r\n          </div>\r\n        )}\r\n\r\n        {message && (\r\n          <p className={`text-xs text-center ${message.type === 'success' ? 'text-green-600' : 'text-destructive'}`}>\r\n            {message.text}\r\n          </p>\r\n        )}\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Audio\r\n  // ==========================================================================\r\n  if (artifactType === 'audio') {\r\n    const audioUrl = (meta.audioUrl as string) || (meta.src as string) || '';\r\n    const audioConfig: Partial<AudioConfig> = {\r\n      autoPlay: meta.autoplay === true || meta.autoPlay === true,\r\n      loop: meta.loop === true,\r\n      requireAck: meta.requireAck === true,\r\n      showTranscript: meta.showTranscript === true,\r\n      transcriptText: (meta.transcript as string) || (meta.transcriptText as string),\r\n    };\r\n    const audioState: AudioState = {\r\n      isPlaying: false,\r\n      hasPlayed: puzzleState.hasPlayed === true,\r\n      hasAcknowledged: puzzleState.acknowledged === true,\r\n    };\r\n\r\n    if (!audioUrl) {\r\n      return (\r\n        <Card className=\"p-4\">\r\n          <p className=\"text-sm text-muted-foreground\">Ljudklipp ej konfigurerat</p>\r\n        </Card>\r\n      );\r\n    }\r\n\r\n    return (\r\n      <Card className=\"p-4 space-y-3\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <span className=\"text-lg\">­ƒöè</span>\r\n          <p className=\"font-medium\">{artifact.title || 'Ljudklipp'}</p>\r\n        </div>\r\n\r\n        <AudioPlayer\r\n          src={audioUrl}\r\n          config={audioConfig}\r\n          state={audioState}\r\n          title={artifact.title || undefined}\r\n          onAcknowledge={() => {\r\n            setPuzzleState((prev) => ({ ...prev, acknowledged: true, hasPlayed: true }));\r\n            onStateChange?.();\r\n          }}\r\n        />\r\n\r\n        {audioConfig.requireAck && audioState.hasAcknowledged && (\r\n          <p className=\"text-xs text-green-600 text-center\">Ô£ô Lyssnat</p>\r\n        )}\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Multi-Answer (Checklist)\r\n  // ==========================================================================\r\n  if (artifactType === 'multi_answer') {\r\n    // Build config from metadata\r\n    const checks = (meta.checks as MultiAnswerConfig['checks']) || \r\n      (meta.items as string[])?.map((label, i) => ({\r\n        id: String(i),\r\n        type: 'checkbox' as const,\r\n        label,\r\n        required: true,\r\n      })) || [];\r\n    \r\n    const multiConfig: MultiAnswerConfig = {\r\n      checks,\r\n      requireAll: meta.requireAll !== false,\r\n      showProgress: meta.showProgress !== false,\r\n    };\r\n\r\n    const multiState: MultiAnswerState = {\r\n      results: (puzzleState.results as MultiAnswerState['results']) || [],\r\n      isComplete: puzzleState.completed === true,\r\n      passedCount: (puzzleState.checked as string[])?.length || 0,\r\n      totalCount: checks.length,\r\n    };\r\n\r\n    const requiredCount = typeof meta.requiredCount === 'number' ? meta.requiredCount : checks.length;\r\n\r\n    return (\r\n      <Card className=\"p-4 space-y-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <span className=\"text-lg\">Ô£à</span>\r\n            <p className=\"font-medium\">{artifact.title || 'Checklista'}</p>\r\n          </div>\r\n          <Badge variant={multiState.isComplete ? 'default' : 'secondary'}>\r\n            {multiState.passedCount}/{requiredCount}\r\n          </Badge>\r\n        </div>\r\n\r\n        <MultiAnswerForm\r\n          config={multiConfig}\r\n          state={multiState}\r\n          onCheckResult={(checkId, passed) => handleSubmit('multi_answer', { checkId, passed })}\r\n          onComplete={() => onStateChange?.()}\r\n          disabled={loading || multiState.isComplete}\r\n        />\r\n\r\n        {multiState.isComplete && (\r\n          <p className=\"text-xs text-green-600 text-center\">Ô£ô Alla klara!</p>\r\n        )}\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // ==========================================================================\r\n  // QR Gate\r\n  // ==========================================================================\r\n  if (artifactType === 'qr_gate') {\r\n    // Build config from metadata\r\n    const expectedValue = (meta.expectedValue as string) || (meta.correctAnswer as string) || '';\r\n    const qrConfig: ScanGateConfig = {\r\n      mode: (meta.mode as ScanGateConfig['mode']) || 'qr',\r\n      allowedValues: (meta.allowedValues as string[]) || [expectedValue].filter(Boolean),\r\n      fallbackCode: meta.fallbackCode as string | undefined,\r\n      allowManualFallback: meta.allowManualFallback !== false,\r\n      promptText: (meta.instruction as string) || (meta.promptText as string) || 'Skanna QR-koden',\r\n    };\r\n\r\n    const qrState: ScanGateState = {\r\n      isVerified: puzzleState.verified === true,\r\n      usedFallback: puzzleState.usedFallback === true,\r\n      scanAttempts: typeof puzzleState.scanAttempts === 'number' ? puzzleState.scanAttempts : 0,\r\n    };\r\n\r\n    return (\r\n      <Card className=\"p-4 space-y-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <span className=\"text-lg\">­ƒô▒</span>\r\n            <p className=\"font-medium\">{artifact.title || 'Skanna QR-kod'}</p>\r\n          </div>\r\n          {qrState.isVerified && <Badge variant=\"default\">Verifierad</Badge>}\r\n        </div>\r\n\r\n        {qrState.isVerified ? (\r\n          <div className=\"rounded bg-green-500/10 border border-green-500/30 p-3 text-center\">\r\n            <p className=\"text-sm font-medium text-green-600\">Ô£ô QR-kod verifierad!</p>\r\n          </div>\r\n        ) : (\r\n          <QRScanner\r\n            config={qrConfig}\r\n            state={qrState}\r\n            onSuccess={(value) => handleSubmit('qr_gate', { answer: value })}\r\n            disabled={loading}\r\n          />\r\n        )}\r\n\r\n        {message && (\r\n          <p className={`text-xs text-center ${message.type === 'success' ? 'text-green-600' : 'text-destructive'}`}>\r\n            {message.text}\r\n          </p>\r\n        )}\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Hint Container\r\n  // ==========================================================================\r\n  if (artifactType === 'hint_container') {\r\n    // Build config from metadata\r\n    const hintsData = (meta.hints as Array<{ id?: string; text: string; penaltySeconds?: number }>) || \r\n      (meta.hints as string[])?.map((text, i) => ({ id: String(i), text })) || [];\r\n    \r\n    const hintConfig: HintConfig = {\r\n      hints: hintsData.map((h, i) => ({\r\n        id: h.id || String(i),\r\n        content: h.text || (h as unknown as string),\r\n        penaltySeconds: h.penaltySeconds || (meta.penaltyPerHint as number) || 0,\r\n      })),\r\n      maxHints: typeof meta.maxHints === 'number' ? meta.maxHints : hintsData.length,\r\n      cooldownSeconds: typeof meta.cooldownSeconds === 'number' ? meta.cooldownSeconds : 0,\r\n    };\r\n\r\n    const revealedCount = typeof puzzleState.revealedCount === 'number' ? puzzleState.revealedCount : 0;\r\n    const hintState: HintState = {\r\n      revealedHintIds: (puzzleState.revealedHintIds as string[]) || \r\n        hintConfig.hints.slice(0, revealedCount).map(h => h.id),\r\n      totalPenaltyTime: typeof puzzleState.totalPenaltyTime === 'number' ? puzzleState.totalPenaltyTime : 0,\r\n      totalPenaltyPoints: typeof puzzleState.totalPenaltyPoints === 'number' ? puzzleState.totalPenaltyPoints : 0,\r\n      cooldownRemaining: typeof puzzleState.cooldownRemaining === 'number' ? puzzleState.cooldownRemaining : 0,\r\n      hintsAvailable: hintConfig.hints.length - revealedCount,\r\n    };\r\n\r\n    return (\r\n      <Card className=\"p-4 space-y-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <span className=\"text-lg\">­ƒÆí</span>\r\n            <p className=\"font-medium\">{artifact.title || 'Tips'}</p>\r\n          </div>\r\n          <Badge variant=\"secondary\">\r\n            {hintState.revealedHintIds.length}/{hintConfig.hints.length} tips\r\n          </Badge>\r\n        </div>\r\n\r\n        <HintPanel\r\n          config={hintConfig}\r\n          state={hintState}\r\n          onRequestHint={(hintId) => {\r\n            // Local state update + could call API\r\n            setPuzzleState((prev) => ({\r\n              ...prev,\r\n              revealedCount: (prev.revealedCount as number ?? 0) + 1,\r\n              revealedHintIds: [...(prev.revealedHintIds as string[] ?? []), hintId],\r\n            }));\r\n          }}\r\n        />\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Hotspot Image\r\n  // ==========================================================================\r\n  if (artifactType === 'hotspot') {\r\n    const imageUrl = (meta.imageUrl as string) || '';\r\n    const zones = (meta.zones as Array<{ id: string; x: number; y: number; radius: number; label?: string; required?: boolean }>) || \r\n      (meta.hotspots as Array<{ id: string; x: number; y: number; radius: number; label?: string; required?: boolean }>) || [];\r\n    \r\n    const hotspotConfig: HotspotConfig = {\r\n      imageArtifactId: (meta.imageArtifactId as string) || '',\r\n      imageUrl,\r\n      hotspots: zones.map((z, i) => ({\r\n        id: z.id || String(i),\r\n        x: z.x,\r\n        y: z.y,\r\n        radius: z.radius || 10,\r\n        label: z.label,\r\n        required: z.required !== false,\r\n      })),\r\n      showProgress: meta.showFeedback !== false || meta.showProgress !== false,\r\n      hapticFeedback: meta.hapticFeedback !== false,\r\n      requireAll: meta.requireAll !== false,\r\n    };\r\n\r\n    const foundIds = (puzzleState.foundIds as string[]) || (puzzleState.foundHotspotIds as string[]) || [];\r\n    const requiredHotspots = hotspotConfig.hotspots.filter(h => h.required !== false);\r\n    const hotspotState: HotspotState = {\r\n      foundHotspotIds: foundIds,\r\n      isComplete: foundIds.length >= requiredHotspots.length,\r\n      foundCount: foundIds.length,\r\n      requiredCount: requiredHotspots.length,\r\n    };\r\n\r\n    const requiredCount = hotspotConfig.hotspots.filter(h => h.required !== false).length;\r\n    const isComplete = foundIds.length >= requiredCount;\r\n\r\n    if (!imageUrl) {\r\n      return (\r\n        <Card className=\"p-4\">\r\n          <p className=\"text-sm text-muted-foreground\">Hotspot-bild ej konfigurerad</p>\r\n        </Card>\r\n      );\r\n    }\r\n\r\n    return (\r\n      <Card className=\"p-4 space-y-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <span className=\"text-lg\">­ƒÄ»</span>\r\n            <p className=\"font-medium\">{artifact.title || 'Hitta i bilden'}</p>\r\n          </div>\r\n          <Badge variant={isComplete ? 'default' : 'secondary'}>\r\n            {foundIds.length}/{requiredCount}\r\n          </Badge>\r\n        </div>\r\n\r\n        <HotspotImage\r\n          config={hotspotConfig}\r\n          state={hotspotState}\r\n          onHotspotFound={(hotspotId) => {\r\n            if (!foundIds.includes(hotspotId)) {\r\n              setPuzzleState((prev) => ({\r\n                ...prev,\r\n                foundHotspotIds: [...(prev.foundHotspotIds as string[] ?? []), hotspotId],\r\n                foundIds: [...(prev.foundIds as string[] ?? []), hotspotId],\r\n              }));\r\n            }\r\n          }}\r\n          onComplete={() => onStateChange?.()}\r\n        />\r\n\r\n        {isComplete && (\r\n          <p className=\"text-xs text-green-600 text-center\">Ô£ô Alla hittade!</p>\r\n        )}\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Tile Puzzle\r\n  // ==========================================================================\r\n  if (artifactType === 'tile_puzzle') {\r\n    const imageUrl = (meta.imageUrl as string) || '';\r\n    const gridSizeRaw = (meta.gridSize as string) || `${meta.rows || 3}x${meta.cols || 3}`;\r\n    // Validate and default to 3x3 if invalid\r\n    const validSizes: TilePuzzleConfig['gridSize'][] = ['2x2', '3x3', '4x4', '3x2', '4x3'];\r\n    const gridSize = validSizes.includes(gridSizeRaw as TilePuzzleConfig['gridSize']) \r\n      ? (gridSizeRaw as TilePuzzleConfig['gridSize']) \r\n      : '3x3';\r\n    \r\n    const tileConfig: TilePuzzleConfig = {\r\n      imageArtifactId: (meta.imageArtifactId as string) || '',\r\n      imageUrl,\r\n      gridSize,\r\n      showPreview: meta.showPreview === true || meta.allowPreview === true,\r\n    };\r\n\r\n    // Build tile state (if stored, otherwise we let component handle it)\r\n    const tiles = (puzzleState.tiles as Tile[]) || [];\r\n    const tileState: TilePuzzleState = {\r\n      tiles,\r\n      moveCount: typeof puzzleState.moveCount === 'number' ? puzzleState.moveCount : 0,\r\n      isComplete: puzzleState.solved === true,\r\n    };\r\n\r\n    if (!imageUrl) {\r\n      return (\r\n        <Card className=\"p-4\">\r\n          <p className=\"text-sm text-muted-foreground\">Pusselspel ej konfigurerat</p>\r\n        </Card>\r\n      );\r\n    }\r\n\r\n    return (\r\n      <Card className=\"p-4 space-y-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <span className=\"text-lg\">­ƒº®</span>\r\n            <p className=\"font-medium\">{artifact.title || 'Pusselspel'}</p>\r\n          </div>\r\n          {tileState.isComplete && <Badge variant=\"default\">L├Âst!</Badge>}\r\n        </div>\r\n\r\n        <TilePuzzle\r\n          config={tileConfig}\r\n          state={tileState}\r\n          onTileMove={(tileId, newPosition) => {\r\n            // Update local state - in full implementation would sync with server\r\n            setPuzzleState((prev) => {\r\n              const tiles = (prev.tiles as Tile[]) || [];\r\n              return {\r\n                ...prev,\r\n                tiles: tiles.map(t => t.id === tileId ? { ...t, currentPosition: newPosition } : t),\r\n                moveCount: ((prev.moveCount as number) ?? 0) + 1,\r\n              };\r\n            });\r\n          }}\r\n          onComplete={() => {\r\n            setPuzzleState((prev) => ({ ...prev, solved: true }));\r\n            onStateChange?.();\r\n          }}\r\n        />\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Cipher\r\n  // ==========================================================================\r\n  if (artifactType === 'cipher') {\r\n    const cipherConfig: CipherConfig = {\r\n      cipherType: (meta.cipherMethod as CipherConfig['cipherType']) || \r\n                  (meta.cipherType as CipherConfig['cipherType']) || 'caesar',\r\n      encodedMessage: (meta.encodedMessage as string) || (meta.cipherText as string) || '',\r\n      expectedPlaintext: (meta.plaintext as string) || (meta.expectedPlaintext as string) || '',\r\n      caesarShift: typeof meta.caesarShift === 'number' ? meta.caesarShift : \r\n                   typeof meta.cipherKey === 'number' ? meta.cipherKey : 3,\r\n      substitutionMap: meta.substitutionMap as Record<string, string> | undefined,\r\n      showDecoderUI: meta.showDecoderHelper !== false && meta.showDecoderUI !== false,\r\n      normalizeMode: (meta.normalizeMode as CipherConfig['normalizeMode']) || 'fuzzy',\r\n    };\r\n\r\n    const cipherState: CipherState = {\r\n      currentGuess: (puzzleState.currentGuess as string) || '',\r\n      attemptsUsed: typeof puzzleState.attemptsUsed === 'number' ? puzzleState.attemptsUsed : 0,\r\n      isDecoded: puzzleState.solved === true,\r\n    };\r\n\r\n    return (\r\n      <Card className=\"p-4 space-y-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <span className=\"text-lg\">­ƒöñ</span>\r\n            <p className=\"font-medium\">{artifact.title || 'Krypterat meddelande'}</p>\r\n          </div>\r\n          {cipherState.isDecoded && <Badge variant=\"default\">Dekrypterat!</Badge>}\r\n        </div>\r\n\r\n        <CipherDecoder\r\n          config={cipherConfig}\r\n          state={cipherState}\r\n          onGuess={(guess) => {\r\n            setPuzzleState((prev) => ({\r\n              ...prev,\r\n              currentGuess: guess,\r\n              guessCount: ((prev.guessCount as number) ?? 0) + 1,\r\n            }));\r\n          }}\r\n          onDecoded={() => {\r\n            setPuzzleState((prev) => ({ ...prev, solved: true }));\r\n            onStateChange?.();\r\n          }}\r\n        />\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Logic Grid\r\n  // ==========================================================================\r\n  if (artifactType === 'logic_grid') {\r\n    // Build categories from metadata\r\n    const categories = (meta.categories as LogicGridConfig['categories']) || \r\n      ((meta.rows as string[]) && (meta.columns as string[]) ? [\r\n        { id: 'rows', name: 'Rader', items: (meta.rows as string[]) },\r\n        { id: 'cols', name: 'Kolumner', items: (meta.columns as string[]) },\r\n      ] : []);\r\n    \r\n    const logicConfig: LogicGridConfig = {\r\n      title: (meta.title as string) || artifact.title || 'Logikpussel',\r\n      categories,\r\n      clues: (meta.clues as LogicGridConfig['clues']) || [],\r\n      solution: (meta.solution as LogicGridConfig['solution']) || [],\r\n    };\r\n\r\n    const cells = (puzzleState.cells as LogicGridCell[]) || [];\r\n    const logicState: LogicGridState = {\r\n      cells,\r\n      revealedClueIds: (puzzleState.revealedClueIds as string[]) || [],\r\n      isSolved: puzzleState.solved === true,\r\n      moveCount: typeof puzzleState.moveCount === 'number' ? puzzleState.moveCount : 0,\r\n    };\r\n\r\n    return (\r\n      <Card className=\"p-4 space-y-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <span className=\"text-lg\">­ƒºá</span>\r\n            <p className=\"font-medium\">{artifact.title || 'Logikrutn├ñt'}</p>\r\n          </div>\r\n          {logicState.isSolved && <Badge variant=\"default\">L├Âst!</Badge>}\r\n        </div>\r\n\r\n        <LogicGrid\r\n          config={logicConfig}\r\n          state={logicState}\r\n          onCellChange={(cell) => {\r\n            setPuzzleState((prev) => {\r\n              const cells = (prev.cells as LogicGridCell[]) || [];\r\n              const existingIdx = cells.findIndex(\r\n                c => c.rowCategoryId === cell.rowCategoryId && \r\n                     c.rowItemIndex === cell.rowItemIndex &&\r\n                     c.colCategoryId === cell.colCategoryId &&\r\n                     c.colItemIndex === cell.colItemIndex\r\n              );\r\n              const newCells = existingIdx >= 0 \r\n                ? cells.map((c, i) => i === existingIdx ? cell : c)\r\n                : [...cells, cell];\r\n              return { ...prev, cells: newCells };\r\n            });\r\n          }}\r\n          onSolved={() => {\r\n            setPuzzleState((prev) => ({ ...prev, solved: true }));\r\n            onStateChange?.();\r\n          }}\r\n        />\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Prop Confirmation\r\n  // ==========================================================================\r\n  if (artifactType === 'prop_confirmation') {\r\n    const propConfig: PropConfirmationConfig = {\r\n      propId: (meta.propId as string) || artifact.id,\r\n      propDescription: (meta.propName as string) || (meta.instruction as string) || 'F├Ârem├Ñl',\r\n      propImageUrl: meta.propImageUrl as string | undefined,\r\n      instructions: (meta.instructions as string) || (meta.instruction as string) || 'Visa upp f├Ârem├Ñlet f├Âr spelledaren.',\r\n      requirePhoto: meta.requirePhoto === true,\r\n    };\r\n\r\n    const propState: PropConfirmationState = {\r\n      status: puzzleState.confirmed === true ? 'confirmed' as const : \r\n              puzzleState.pending === true ? 'pending' as const : 'pending' as const,\r\n      requestedAt: puzzleState.requestedAt as string | undefined,\r\n      photoUrl: puzzleState.photoUrl as string | undefined,\r\n    };\r\n\r\n    return (\r\n      <Card className=\"p-4 space-y-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <span className=\"text-lg\">­ƒôª</span>\r\n            <p className=\"font-medium\">{artifact.title || propConfig.propDescription}</p>\r\n          </div>\r\n          <Badge variant={propState.status === 'confirmed' ? 'default' : propState.status === 'pending' ? 'secondary' : 'outline'}>\r\n            {propState.status === 'confirmed' ? 'Bekr├ñftad' : propState.status === 'pending' ? 'V├ñntar...' : 'Ej bekr├ñftad'}\r\n          </Badge>\r\n        </div>\r\n\r\n        <PropRequest\r\n          config={propConfig}\r\n          state={propState}\r\n          onRequest={() => {\r\n            setPuzzleState((prev) => ({ \r\n              ...prev, \r\n              pending: true,\r\n              requestedAt: new Date().toISOString(),\r\n            }));\r\n            // Real implementation would call API\r\n          }}\r\n          onPhotoCapture={(photoUrl) => {\r\n            setPuzzleState((prev) => ({ ...prev, photoUrl }));\r\n          }}\r\n        />\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Location Check\r\n  // ==========================================================================\r\n  if (artifactType === 'location_check') {\r\n    const latitude = typeof meta.latitude === 'number' ? meta.latitude : 0;\r\n    const longitude = typeof meta.longitude === 'number' ? meta.longitude : 0;\r\n    const radius = typeof meta.radius === 'number' ? meta.radius : 50;\r\n    const locationName = (meta.locationName as string) || '';\r\n    \r\n    const locationConfig: LocationCheckConfig = {\r\n      locationId: (meta.locationId as string) || artifact.id,\r\n      locationName,\r\n      checkType: (meta.checkType as LocationCheckConfig['checkType']) || (meta.method as LocationCheckConfig['checkType']) || 'gps',\r\n      targetCoordinates: { latitude, longitude },\r\n      radiusMeters: radius,\r\n      qrCodeValue: (meta.qrCode as string) || (meta.qrCodeValue as string),\r\n      showDistance: meta.showDistance !== false,\r\n      showCompass: meta.showCompass !== false,\r\n    };\r\n\r\n    const locationState: LocationCheckState = {\r\n      isVerified: puzzleState.verified === true,\r\n      currentCoordinates: puzzleState.currentCoordinates as GeoCoordinate | undefined,\r\n      distanceMeters: puzzleState.distanceMeters as number | undefined,\r\n    };\r\n\r\n    return (\r\n      <Card className=\"p-4 space-y-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <span className=\"text-lg\">­ƒôì</span>\r\n            <p className=\"font-medium\">{artifact.title || locationName || 'Platsverifiering'}</p>\r\n          </div>\r\n          {locationState.isVerified && <Badge variant=\"default\">Verifierad!</Badge>}\r\n        </div>\r\n\r\n        <LocationCheck\r\n          config={locationConfig}\r\n          state={locationState}\r\n          onLocationUpdate={(coords) => {\r\n            setPuzzleState((prev) => ({ ...prev, currentCoordinates: coords }));\r\n          }}\r\n          onVerified={() => {\r\n            setPuzzleState((prev) => ({ ...prev, verified: true }));\r\n            onStateChange?.();\r\n          }}\r\n        />\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Sound Level\r\n  // ==========================================================================\r\n  if (artifactType === 'sound_level') {\r\n    const soundInstructions = (meta.instruction as string) || (meta.instructions as string) || 'G├Âr ljud!';\r\n    const soundConfig: SoundLevelConfig = {\r\n      triggerMode: (meta.triggerMode as SoundLevelConfig['triggerMode']) || 'threshold',\r\n      thresholdLevel: typeof meta.threshold === 'number' ? meta.threshold : \r\n                      typeof meta.thresholdLevel === 'number' ? meta.thresholdLevel : 70,\r\n      sustainDuration: typeof meta.holdDuration === 'number' ? meta.holdDuration : \r\n                       typeof meta.sustainDuration === 'number' ? meta.sustainDuration : 2,\r\n      activityLabel: (meta.activityLabel as string) || artifact.title || 'Ljudaktivering',\r\n      instructions: soundInstructions,\r\n      showMeter: meta.showMeter !== false,\r\n    };\r\n\r\n    const soundState: SoundLevelState = {\r\n      currentLevel: typeof puzzleState.currentLevel === 'number' ? puzzleState.currentLevel : 0,\r\n      peakLevel: typeof puzzleState.peakLevel === 'number' ? puzzleState.peakLevel : 0,\r\n      isTriggered: puzzleState.triggered === true,\r\n      sustainedSeconds: typeof puzzleState.sustainedSeconds === 'number' ? puzzleState.sustainedSeconds : 0,\r\n    };\r\n\r\n    return (\r\n      <Card className=\"p-4 space-y-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <span className=\"text-lg\">­ƒÄñ</span>\r\n            <p className=\"font-medium\">{artifact.title || 'Ljudaktivering'}</p>\r\n          </div>\r\n          {soundState.isTriggered && <Badge variant=\"default\">Aktiverad!</Badge>}\r\n        </div>\r\n\r\n        {soundInstructions && <p className=\"text-sm text-muted-foreground italic\">{soundInstructions}</p>}\r\n\r\n        <SoundLevelMeter\r\n          config={soundConfig}\r\n          state={soundState}\r\n          onLevelChange={(level) => {\r\n            setPuzzleState((prev) => ({ ...prev, currentLevel: level, isListening: true }));\r\n          }}\r\n          onTriggered={() => {\r\n            setPuzzleState((prev) => ({ ...prev, triggered: true }));\r\n            onStateChange?.();\r\n          }}\r\n        />\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Replay Marker - Skip in participant view (host-only analysis)\r\n  // ==========================================================================\r\n  if (artifactType === 'replay_marker') {\r\n    return null; // Replay markers are typically for post-session analysis\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Signal Generator (Task 2.1) - Displays signal trigger UI\r\n  // ==========================================================================\r\n  if (artifactType === 'signal_generator') {\r\n    const config = (artifact.metadata as { signalConfig?: { label?: string; outputs?: string[] } })?.signalConfig;\r\n    const label = config?.label ?? 'Signal';\r\n    const outputs = config?.outputs ?? ['visual'];\r\n    \r\n    return (\r\n      <Card className=\"p-4 border-l-4 border-l-primary\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <div className=\"font-medium text-foreground\">{artifact.title ?? label}</div>\r\n            <div className=\"text-sm text-muted-foreground flex items-center gap-2 mt-1\">\r\n              {outputs.includes('audio') && <span>­ƒöè</span>}\r\n              {outputs.includes('vibration') && <span>­ƒô│</span>}\r\n              {outputs.includes('visual') && <span>­ƒÆí</span>}\r\n              {outputs.includes('notification') && <span>­ƒöö</span>}\r\n              <span>{outputs.length} signalk├ñllor</span>\r\n            </div>\r\n          </div>\r\n          <Badge variant=\"secondary\" size=\"sm\">Signal</Badge>\r\n        </div>\r\n        {artifact.description && (\r\n          <p className=\"text-sm text-muted-foreground mt-2\">{artifact.description}</p>\r\n        )}\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Time Bank Step (Task 2.2) - Displays countdown timer\r\n  // ==========================================================================\r\n  if (artifactType === 'time_bank_step') {\r\n    const config = (artifact.metadata as { \r\n      timerConfig?: { \r\n        initialSeconds?: number; \r\n        displayStyle?: string;\r\n        warningThreshold?: number;\r\n        criticalThreshold?: number;\r\n      } \r\n    })?.timerConfig;\r\n    \r\n    const initialSeconds = config?.initialSeconds ?? 300;\r\n    const displayStyle = config?.displayStyle ?? 'countdown';\r\n    const warningThreshold = config?.warningThreshold ?? 60;\r\n    const criticalThreshold = config?.criticalThreshold ?? 30;\r\n    \r\n    // Get remaining from state (or use initial)\r\n    const remaining = (puzzleState as { remainingSeconds?: number })?.remainingSeconds ?? initialSeconds;\r\n    const isPaused = (puzzleState as { isPaused?: boolean })?.isPaused ?? false;\r\n    const isExpired = remaining <= 0;\r\n    \r\n    // Format time\r\n    const minutes = Math.floor(remaining / 60);\r\n    const seconds = remaining % 60;\r\n    const timeDisplay = `${minutes}:${seconds.toString().padStart(2, '0')}`;\r\n    \r\n    // Determine visual state\r\n    const isCritical = remaining <= criticalThreshold;\r\n    const isWarning = remaining <= warningThreshold && !isCritical;\r\n    \r\n    return (\r\n      <Card className={`p-6 text-center ${isCritical ? 'border-destructive bg-destructive/5' : isWarning ? 'border-warning bg-warning/5' : ''}`}>\r\n        <div className=\"text-sm text-muted-foreground mb-2\">\r\n          {artifact.title ?? 'Tid kvar'}\r\n        </div>\r\n        <div className={`text-4xl font-mono font-bold ${isCritical ? 'text-destructive animate-pulse' : isWarning ? 'text-warning' : 'text-foreground'}`}>\r\n          {isExpired ? '0:00' : timeDisplay}\r\n        </div>\r\n        {isPaused && (\r\n          <Badge variant=\"warning\" size=\"sm\" className=\"mt-2\">\r\n            ÔÅ©´©Å Pausad\r\n          </Badge>\r\n        )}\r\n        {isExpired && (\r\n          <Badge variant=\"destructive\" size=\"sm\" className=\"mt-2\">\r\n            ÔÅ░ Tiden ├ñr ute!\r\n          </Badge>\r\n        )}\r\n        {displayStyle === 'progress' && !isExpired && (\r\n          <div className=\"mt-4 h-2 bg-muted rounded-full overflow-hidden\">\r\n            <div \r\n              className={`h-full transition-all duration-1000 ${isCritical ? 'bg-destructive' : isWarning ? 'bg-warning' : 'bg-primary'}`}\r\n              style={{ width: `${(remaining / initialSeconds) * 100}%` }}\r\n            />\r\n          </div>\r\n        )}\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Empty Artifact (Task 2.3) - Placeholder or custom slot\r\n  // ==========================================================================\r\n  if (artifactType === 'empty_artifact') {\r\n    const config = (artifact.metadata as { \r\n      emptyConfig?: { \r\n        purpose?: string;\r\n        placeholderText?: string;\r\n        backgroundColor?: string;\r\n        minHeight?: number;\r\n        showBorder?: boolean;\r\n        icon?: string;\r\n      } \r\n    })?.emptyConfig;\r\n    \r\n    const purpose = config?.purpose ?? 'placeholder';\r\n    const placeholderText = config?.placeholderText ?? '';\r\n    const minHeight = config?.minHeight ?? 100;\r\n    const showBorder = config?.showBorder ?? true;\r\n    const icon = config?.icon ?? '­ƒôª';\r\n    \r\n    // Host notes are not rendered for participants\r\n    if (purpose === 'host_note') {\r\n      return null;\r\n    }\r\n    \r\n    // Break markers render as a visual divider\r\n    if (purpose === 'break_marker') {\r\n      return (\r\n        <div className=\"py-4 flex items-center gap-4\">\r\n          <div className=\"flex-1 h-px bg-border\" />\r\n          {placeholderText && (\r\n            <span className=\"text-sm text-muted-foreground\">{placeholderText}</span>\r\n          )}\r\n          <div className=\"flex-1 h-px bg-border\" />\r\n        </div>\r\n      );\r\n    }\r\n    \r\n    return (\r\n      <Card \r\n        className={`flex items-center justify-center ${showBorder ? 'border-dashed border-2' : 'border-0'}`}\r\n        style={{ \r\n          minHeight: `${minHeight}px`,\r\n          backgroundColor: config?.backgroundColor ?? undefined,\r\n        }}\r\n      >\r\n        <div className=\"text-center text-muted-foreground p-4\">\r\n          <span className=\"text-2xl block mb-2\">{icon}</span>\r\n          {placeholderText && <p className=\"text-sm\">{placeholderText}</p>}\r\n          {!placeholderText && purpose === 'placeholder' && (\r\n            <p className=\"text-sm\">Inneh├Ñll kommer snart...</p>\r\n          )}\r\n        </div>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Unsupported/Unknown artifact type\r\n  // ==========================================================================\r\n  return null;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\PuzzleProgressPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\ReadinessIndicator.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":288,"column":66,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":290,"endColumn":13},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":305,"column":69,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":307,"endColumn":13},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":340,"column":45,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":340,"endColumn":87}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * ReadinessIndicator Component\r\n * \r\n * Visual indicator showing session readiness percentage with\r\n * detailed breakdown by category.\r\n * \r\n * Backlog B.4: Confidence indicator (\"95% ready\")\r\n */\r\n\r\n'use client';\r\n\r\nimport React, { useState } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Progress } from '@/components/ui/progress';\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from '@/components/ui/card';\r\nimport {\r\n  Popover,\r\n  PopoverContent,\r\n  PopoverTrigger,\r\n} from '@/components/ui/popover';\r\nimport {\r\n  Collapsible,\r\n  CollapsibleContent,\r\n  CollapsibleTrigger,\r\n} from '@/components/ui/collapsible';\r\nimport {\r\n  CheckCircleIcon,\r\n  ExclamationTriangleIcon,\r\n  XCircleIcon,\r\n  ChevronDownIcon,\r\n  ChevronRightIcon,\r\n  UsersIcon,\r\n  DocumentTextIcon,\r\n  BoltIcon,\r\n  PuzzlePieceIcon,\r\n  RadioIcon,\r\n  CogIcon,\r\n  ChartBarSquareIcon,\r\n  MinusCircleIcon,\r\n} from '@heroicons/react/24/outline';\r\nimport type {\r\n  ReadinessCheck,\r\n  ReadinessCategory,\r\n  UseSessionReadinessReturn,\r\n} from '@/features/play/hooks/useSessionReadiness';\r\nimport { READINESS_CATEGORY_LABELS } from '@/features/play/hooks/useSessionReadiness';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface ReadinessIndicatorProps {\r\n  /** Readiness data from useSessionReadiness */\r\n  readiness: UseSessionReadinessReturn;\r\n  /** Display variant */\r\n  variant?: 'compact' | 'detailed' | 'inline';\r\n  /** Optional className */\r\n  className?: string;\r\n}\r\n\r\n// =============================================================================\r\n// Constants\r\n// =============================================================================\r\n\r\nconst CATEGORY_ICONS: Record<ReadinessCategory, React.ReactNode> = {\r\n  participants: <UsersIcon className=\"h-4 w-4\" />,\r\n  content: <DocumentTextIcon className=\"h-4 w-4\" />,\r\n  triggers: <BoltIcon className=\"h-4 w-4\" />,\r\n  artifacts: <PuzzlePieceIcon className=\"h-4 w-4\" />,\r\n  signals: <RadioIcon className=\"h-4 w-4\" />,\r\n  configuration: <CogIcon className=\"h-4 w-4\" />,\r\n};\r\n\r\nconst STATUS_ICONS: Record<ReadinessCheck['status'], React.ReactNode> = {\r\n  pass: <CheckCircleIcon className=\"h-4 w-4 text-green-500\" />,\r\n  warning: <ExclamationTriangleIcon className=\"h-4 w-4 text-yellow-500\" />,\r\n  fail: <XCircleIcon className=\"h-4 w-4 text-red-500\" />,\r\n  skip: <MinusCircleIcon className=\"h-4 w-4 text-muted-foreground\" />,\r\n};\r\n\r\nconst COLOR_CLASSES = {\r\n  green: {\r\n    bg: 'bg-green-500',\r\n    text: 'text-green-600',\r\n    border: 'border-green-500',\r\n    light: 'bg-green-500/10',\r\n  },\r\n  yellow: {\r\n    bg: 'bg-yellow-500',\r\n    text: 'text-yellow-600',\r\n    border: 'border-yellow-500',\r\n    light: 'bg-yellow-500/10',\r\n  },\r\n  red: {\r\n    bg: 'bg-red-500',\r\n    text: 'text-red-600',\r\n    border: 'border-red-500',\r\n    light: 'bg-red-500/10',\r\n  },\r\n};\r\n\r\n// =============================================================================\r\n// Sub-Component: CheckRow\r\n// =============================================================================\r\n\r\ninterface CheckRowProps {\r\n  check: ReadinessCheck;\r\n}\r\n\r\nfunction CheckRow({ check }: CheckRowProps) {\r\n  return (\r\n    <div className=\"flex items-center gap-2 py-1.5\">\r\n      {STATUS_ICONS[check.status]}\r\n      <span className=\"flex-1 text-sm\">{check.name}</span>\r\n      {check.status !== 'skip' && (\r\n        <span className=\"text-xs text-muted-foreground\">\r\n          {check.current}/{check.target}\r\n        </span>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: CategorySection\r\n// =============================================================================\r\n\r\ninterface CategorySectionProps {\r\n  category: ReadinessCategory;\r\n  checks: ReadinessCheck[];\r\n}\r\n\r\nfunction CategorySection({ category, checks }: CategorySectionProps) {\r\n  const [isOpen, setIsOpen] = useState(true);\r\n  \r\n  if (checks.length === 0) return null;\r\n  \r\n  const passCount = checks.filter((c) => c.status === 'pass').length;\r\n  const hasIssues = checks.some((c) => c.status === 'fail' || c.status === 'warning');\r\n  \r\n  return (\r\n    <Collapsible open={isOpen} onOpenChange={setIsOpen}>\r\n      <CollapsibleTrigger className=\"flex items-center gap-2 w-full py-2 hover:bg-muted/50 rounded px-2 transition-colors\">\r\n        {isOpen ? <ChevronDownIcon className=\"h-4 w-4\" /> : <ChevronRightIcon className=\"h-4 w-4\" />}\r\n        {CATEGORY_ICONS[category]}\r\n        <span className=\"font-medium text-sm flex-1 text-left\">\r\n          {READINESS_CATEGORY_LABELS[category]}\r\n        </span>\r\n        <Badge variant={hasIssues ? 'outline' : 'default'} className=\"text-xs\">\r\n          {passCount}/{checks.length}\r\n        </Badge>\r\n      </CollapsibleTrigger>\r\n      <CollapsibleContent className=\"pl-8 pr-2\">\r\n        {checks.map((check) => (\r\n          <CheckRow key={check.id} check={check} />\r\n        ))}\r\n      </CollapsibleContent>\r\n    </Collapsible>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Variant: Inline (just the percentage badge)\r\n// =============================================================================\r\n\r\nfunction InlineIndicator({ readiness, className }: ReadinessIndicatorProps) {\r\n  const colors = COLOR_CLASSES[readiness.readinessColor];\r\n  \r\n  return (\r\n    <Popover>\r\n      <PopoverTrigger asChild>\r\n        <Button\r\n          variant=\"outline\"\r\n          size=\"sm\"\r\n          className={`gap-2 ${colors.border} ${className}`}\r\n        >\r\n          <ChartBarSquareIcon className={`h-4 w-4 ${colors.text}`} />\r\n          <span className={colors.text}>{readiness.readinessPercent}%</span>\r\n        </Button>\r\n      </PopoverTrigger>\r\n      <PopoverContent className=\"w-80\">\r\n        <div className=\"space-y-3\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <span className=\"font-medium\">{readiness.readinessLabel}</span>\r\n            <Badge className={colors.bg}>{readiness.readinessPercent}%</Badge>\r\n          </div>\r\n          <Progress value={readiness.readinessPercent} className=\"h-2\" />\r\n          <p className=\"text-sm text-muted-foreground\">{readiness.summary}</p>\r\n          \r\n          {readiness.criticalIssues.length > 0 && (\r\n            <div className=\"space-y-1 pt-2 border-t\">\r\n              <p className=\"text-xs font-medium text-red-600\">Kritiska problem:</p>\r\n              {readiness.criticalIssues.map((issue) => (\r\n                <div key={issue.id} className=\"flex items-center gap-2 text-sm\">\r\n                  <XCircleIcon className=\"h-3 w-3 text-red-500\" />\r\n                  {issue.details}\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </PopoverContent>\r\n    </Popover>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Variant: Compact (progress bar with popover)\r\n// =============================================================================\r\n\r\nfunction CompactIndicator({ readiness, className }: ReadinessIndicatorProps) {\r\n  const colors = COLOR_CLASSES[readiness.readinessColor];\r\n  \r\n  return (\r\n    <Popover>\r\n      <PopoverTrigger asChild>\r\n        <div className={`cursor-pointer ${className}`}>\r\n          <div className=\"flex items-center justify-between mb-1\">\r\n            <span className=\"text-sm font-medium flex items-center gap-2\">\r\n              <ChartBarSquareIcon className={`h-4 w-4 ${colors.text}`} />\r\n              {readiness.readinessLabel}\r\n            </span>\r\n            <span className={`text-sm font-bold ${colors.text}`}>\r\n              {readiness.readinessPercent}%\r\n            </span>\r\n          </div>\r\n          <Progress value={readiness.readinessPercent} className=\"h-2\" />\r\n        </div>\r\n      </PopoverTrigger>\r\n      <PopoverContent className=\"w-96\" align=\"start\">\r\n        <div className=\"space-y-2\">\r\n          <p className=\"text-sm text-muted-foreground\">{readiness.summary}</p>\r\n          \r\n          <div className=\"space-y-1 pt-2 border-t\">\r\n            {Object.entries(readiness.checksByCategory).map(([cat, checks]) => (\r\n              <CategorySection\r\n                key={cat}\r\n                category={cat as ReadinessCategory}\r\n                checks={checks}\r\n              />\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </PopoverContent>\r\n    </Popover>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Variant: Detailed (full card)\r\n// =============================================================================\r\n\r\nfunction DetailedIndicator({ readiness, className }: ReadinessIndicatorProps) {\r\n  const colors = COLOR_CLASSES[readiness.readinessColor];\r\n  \r\n  return (\r\n    <Card className={className}>\r\n      <CardHeader className=\"pb-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <CardTitle className=\"flex items-center gap-2 text-base\">\r\n            <ChartBarSquareIcon className={`h-5 w-5 ${colors.text}`} />\r\n            Sessionsberedskap\r\n          </CardTitle>\r\n          <Badge className={`${colors.bg} text-white`}>\r\n            {readiness.readinessPercent}%\r\n          </Badge>\r\n        </div>\r\n        <CardDescription>{readiness.readinessLabel}</CardDescription>\r\n      </CardHeader>\r\n      \r\n      <CardContent className=\"space-y-4\">\r\n        {/* Progress bar */}\r\n        <Progress value={readiness.readinessPercent} className=\"h-3\" />\r\n        \r\n        {/* Summary */}\r\n        <p className=\"text-sm\">{readiness.summary}</p>\r\n        \r\n        {/* Critical issues */}\r\n        {readiness.criticalIssues.length > 0 && (\r\n          <div className={`p-3 rounded-lg ${COLOR_CLASSES.red.light}`}>\r\n            <p className=\"text-sm font-medium text-red-600 mb-2\">\r\n              M├Ñste ├Ñtg├ñrdas innan start:\r\n            </p>\r\n            <div className=\"space-y-1\">\r\n              {readiness.criticalIssues.map((issue) => (\r\n                <div key={issue.id} className=\"flex items-center gap-2 text-sm\">\r\n                  <XCircleIcon className=\"h-4 w-4 text-red-500\" />\r\n                  {issue.details}\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        )}\r\n        \r\n        {/* Warnings */}\r\n        {readiness.warnings.length > 0 && (\r\n          <div className={`p-3 rounded-lg ${COLOR_CLASSES.yellow.light}`}>\r\n            <p className=\"text-sm font-medium text-yellow-600 mb-2\">\r\n              Rekommenderas att ├Ñtg├ñrda:\r\n            </p>\r\n            <div className=\"space-y-1\">\r\n              {readiness.warnings.map((warning) => (\r\n                <div key={warning.id} className=\"flex items-center gap-2 text-sm\">\r\n                  <ExclamationTriangleIcon className=\"h-4 w-4 text-yellow-500\" />\r\n                  {warning.details}\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        )}\r\n        \r\n        {/* Category breakdown */}\r\n        <div className=\"space-y-1 pt-2 border-t\">\r\n          {Object.entries(readiness.checksByCategory).map(([cat, checks]) => (\r\n            <CategorySection\r\n              key={cat}\r\n              category={cat as ReadinessCategory}\r\n              checks={checks}\r\n            />\r\n          ))}\r\n        </div>\r\n        \r\n        {/* Can start indicator */}\r\n        <div className=\"pt-3 border-t\">\r\n          {readiness.canStart ? (\r\n            <div className=\"flex items-center gap-2 text-green-600\">\r\n              <CheckCircleIcon className=\"h-5 w-5\" />\r\n              <span className=\"font-medium\">Redo att starta session</span>\r\n            </div>\r\n          ) : (\r\n            <div className=\"flex items-center gap-2 text-red-600\">\r\n              <XCircleIcon className=\"h-5 w-5\" />\r\n              <span className=\"font-medium\">Kan inte starta - ├Ñtg├ñrda kritiska problem</span>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function ReadinessIndicator({\r\n  readiness,\r\n  variant = 'compact',\r\n  className,\r\n}: ReadinessIndicatorProps) {\r\n  switch (variant) {\r\n    case 'inline':\r\n      return <InlineIndicator readiness={readiness} className={className} />;\r\n    case 'compact':\r\n      return <CompactIndicator readiness={readiness} className={className} />;\r\n    case 'detailed':\r\n      return <DetailedIndicator readiness={readiness} className={className} />;\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\RoleAssigner.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":321,"column":40,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":322,"endColumn":17},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":358,"column":70,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":359,"endColumn":31},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":373,"column":71,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":375,"endColumn":19},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":438,"column":55,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":439,"endColumn":30},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":445,"column":69,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":447,"endColumn":17}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * RoleAssigner Component\r\n * \r\n * UI for facilitators to assign roles to participants.\r\n * Supports both manual assignment and random assignment.\r\n */\r\n\r\n'use client';\r\n\r\nimport { useState, useCallback, useMemo } from 'react';\r\nimport {\r\n  UserCircleIcon,\r\n  SparklesIcon,\r\n  ArrowPathIcon,\r\n  CheckIcon,\r\n  XMarkIcon,\r\n  ExclamationTriangleIcon,\r\n  UsersIcon,\r\n  PlusIcon,\r\n} from '@heroicons/react/24/solid';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport {\r\n  randomAssignRoles,\r\n  getAvailableRolesForParticipant,\r\n  getUnassignedParticipants,\r\n  checkMinimumCounts,\r\n  type Participant,\r\n  type AssignmentResult,\r\n} from '@/lib/utils/role-assignment';\r\nimport type { SessionRole, RoleAssignment } from '@/types/play-runtime';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface RoleAssignerProps {\r\n  /** Session ID */\r\n  sessionId: string;\r\n  /** Available roles */\r\n  roles: SessionRole[];\r\n  /** Current participants */\r\n  participants: Participant[];\r\n  /** Current assignments */\r\n  assignments: RoleAssignment[];\r\n  /** Called when roles are assigned */\r\n  onAssign: (assignments: Array<{ participantId: string; roleId: string }>) => Promise<void>;\r\n  /** Called when an assignment is removed */\r\n  onUnassign?: (participantId: string, roleId: string) => Promise<void>;\r\n  /** Whether actions are disabled */\r\n  disabled?: boolean;\r\n  /** Show compact view */\r\n  compact?: boolean;\r\n}\r\n\r\n// =============================================================================\r\n// Helper Components\r\n// =============================================================================\r\n\r\ninterface RoleColorClasses {\r\n  bg: string;\r\n  border: string;\r\n  text: string;\r\n}\r\n\r\nfunction getRoleColorClasses(color: string | null): RoleColorClasses {\r\n  const colorMap: Record<string, RoleColorClasses> = {\r\n    red: { bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-700' },\r\n    orange: { bg: 'bg-orange-50', border: 'border-orange-200', text: 'text-orange-700' },\r\n    yellow: { bg: 'bg-yellow-50', border: 'border-yellow-200', text: 'text-yellow-700' },\r\n    green: { bg: 'bg-green-50', border: 'border-green-200', text: 'text-green-700' },\r\n    blue: { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-700' },\r\n    indigo: { bg: 'bg-indigo-50', border: 'border-indigo-200', text: 'text-indigo-700' },\r\n    purple: { bg: 'bg-purple-50', border: 'border-purple-200', text: 'text-purple-700' },\r\n    pink: { bg: 'bg-pink-50', border: 'border-pink-200', text: 'text-pink-700' },\r\n  };\r\n  return colorMap[color || ''] || { bg: 'bg-muted/50', border: 'border-border', text: 'text-foreground' };\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function RoleAssigner({\r\n  sessionId: _sessionId,\r\n  roles,\r\n  participants,\r\n  assignments,\r\n  onAssign,\r\n  onUnassign,\r\n  disabled = false,\r\n  compact = false,\r\n}: RoleAssignerProps) {\r\n  const [isAssigning, setIsAssigning] = useState(false);\r\n  const [lastResult, setLastResult] = useState<AssignmentResult | null>(null);\r\n  const [selectedParticipant, setSelectedParticipant] = useState<string | null>(null);\r\n  \r\n  // Build assignment maps\r\n  const participantToRole = useMemo(() => {\r\n    const map = new Map<string, SessionRole>();\r\n    for (const assignment of assignments) {\r\n      const role = roles.find((r) => r.id === assignment.session_role_id);\r\n      if (role) {\r\n        map.set(assignment.participant_id, role);\r\n      }\r\n    }\r\n    return map;\r\n  }, [assignments, roles]);\r\n  \r\n  const roleToParticipants = useMemo(() => {\r\n    const map = new Map<string, string[]>();\r\n    for (const role of roles) {\r\n      map.set(role.id, []);\r\n    }\r\n    for (const assignment of assignments) {\r\n      const current = map.get(assignment.session_role_id) || [];\r\n      current.push(assignment.participant_id);\r\n      map.set(assignment.session_role_id, current);\r\n    }\r\n    return map;\r\n  }, [assignments, roles]);\r\n  \r\n  // Get unassigned participants\r\n  const unassigned = useMemo(() => \r\n    getUnassignedParticipants(participants, assignments),\r\n    [participants, assignments]\r\n  );\r\n  \r\n  // Check minimum requirements\r\n  const minCheck = useMemo(() => {\r\n    const rolesWithCounts = roles.map((r) => ({\r\n      ...r,\r\n      assigned_count: (roleToParticipants.get(r.id) || []).length,\r\n    }));\r\n    return checkMinimumCounts(rolesWithCounts);\r\n  }, [roles, roleToParticipants]);\r\n  \r\n  // ==========================================================================\r\n  // Handlers\r\n  // ==========================================================================\r\n  \r\n  const handleRandomAssign = useCallback(async () => {\r\n    setIsAssigning(true);\r\n    setLastResult(null);\r\n    \r\n    try {\r\n      // Build current assignments map\r\n      const currentAssignments = new Map<string, string>();\r\n      for (const assignment of assignments) {\r\n        currentAssignments.set(assignment.participant_id, assignment.session_role_id);\r\n      }\r\n      \r\n      // Update role counts for algorithm\r\n      const rolesWithCounts = roles.map((r) => ({\r\n        ...r,\r\n        assigned_count: (roleToParticipants.get(r.id) || []).length,\r\n      }));\r\n      \r\n      const result = randomAssignRoles({\r\n        participants,\r\n        roles: rolesWithCounts,\r\n        currentAssignments,\r\n        respectMinimums: true,\r\n        skipAssigned: true,\r\n      });\r\n      \r\n      setLastResult(result);\r\n      \r\n      if (result.assignments.length > 0) {\r\n        await onAssign(result.assignments);\r\n      }\r\n    } catch (error) {\r\n      console.error('[RoleAssigner] Random assignment failed:', error);\r\n      setLastResult({\r\n        success: false,\r\n        assignments: [],\r\n        errors: ['Ett fel uppstod vid slumpm├ñssig tilldelning'],\r\n        warnings: [],\r\n      });\r\n    } finally {\r\n      setIsAssigning(false);\r\n    }\r\n  }, [assignments, participants, roles, roleToParticipants, onAssign]);\r\n  \r\n  const handleManualAssign = useCallback(async (participantId: string, roleId: string) => {\r\n    setIsAssigning(true);\r\n    try {\r\n      await onAssign([{ participantId, roleId }]);\r\n      setSelectedParticipant(null);\r\n    } catch (error) {\r\n      console.error('[RoleAssigner] Manual assignment failed:', error);\r\n    } finally {\r\n      setIsAssigning(false);\r\n    }\r\n  }, [onAssign]);\r\n  \r\n  const handleUnassign = useCallback(async (participantId: string, roleId: string) => {\r\n    if (!onUnassign) return;\r\n    setIsAssigning(true);\r\n    try {\r\n      await onUnassign(participantId, roleId);\r\n    } catch (error) {\r\n      console.error('[RoleAssigner] Unassign failed:', error);\r\n    } finally {\r\n      setIsAssigning(false);\r\n    }\r\n  }, [onUnassign]);\r\n  \r\n  // Get available roles for selected participant\r\n  const availableRoles = useMemo(() => {\r\n    if (!selectedParticipant) return [];\r\n    return getAvailableRolesForParticipant(\r\n      selectedParticipant,\r\n      roles.map((r) => ({\r\n        ...r,\r\n        assigned_count: (roleToParticipants.get(r.id) || []).length,\r\n      })),\r\n      participantToRole\r\n    );\r\n  }, [selectedParticipant, roles, roleToParticipants, participantToRole]);\r\n\r\n  // ==========================================================================\r\n  // Render\r\n  // ==========================================================================\r\n  \r\n  if (compact) {\r\n    return (\r\n      <Card className=\"p-4\">\r\n        <div className=\"flex items-center justify-between gap-4\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <UsersIcon className=\"h-5 w-5 text-muted-foreground\" />\r\n            <span className=\"text-sm font-medium\">\r\n              {assignments.length} av {participants.length} tilldelade\r\n            </span>\r\n          </div>\r\n          <Button\r\n            size=\"sm\"\r\n            onClick={handleRandomAssign}\r\n            disabled={disabled || isAssigning || unassigned.length === 0}\r\n            className=\"gap-1.5\"\r\n          >\r\n            <SparklesIcon className=\"h-4 w-4\" />\r\n            Slumpa roller\r\n          </Button>\r\n        </div>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header with random assign button */}\r\n      <div className=\"flex items-center justify-between gap-4\">\r\n        <div>\r\n          <h3 className=\"text-sm font-semibold uppercase tracking-wider text-muted-foreground\">\r\n            Rolltilldelning\r\n          </h3>\r\n          <p className=\"mt-1 text-sm text-muted-foreground\">\r\n            {assignments.length} av {participants.length} deltagare har roller\r\n          </p>\r\n        </div>\r\n        \r\n        <Button\r\n          onClick={handleRandomAssign}\r\n          disabled={disabled || isAssigning || unassigned.length === 0}\r\n          className=\"gap-2\"\r\n        >\r\n          {isAssigning ? (\r\n            <ArrowPathIcon className=\"h-4 w-4 animate-spin\" />\r\n          ) : (\r\n            <SparklesIcon className=\"h-4 w-4\" />\r\n          )}\r\n          Slumpa {unassigned.length > 0 ? `(${unassigned.length})` : 'roller'}\r\n        </Button>\r\n      </div>\r\n      \r\n      {/* Result message */}\r\n      {lastResult && (\r\n        <div className={`rounded-lg p-3 ${\r\n          lastResult.errors.length > 0 \r\n            ? 'bg-red-50 text-red-700' \r\n            : lastResult.warnings.length > 0 \r\n              ? 'bg-yellow-50 text-yellow-700'\r\n              : 'bg-green-50 text-green-700'\r\n        }`}>\r\n          <div className=\"flex items-start gap-2\">\r\n            {lastResult.errors.length > 0 ? (\r\n              <XMarkIcon className=\"h-5 w-5 shrink-0\" />\r\n            ) : lastResult.warnings.length > 0 ? (\r\n              <ExclamationTriangleIcon className=\"h-5 w-5 shrink-0\" />\r\n            ) : (\r\n              <CheckIcon className=\"h-5 w-5 shrink-0\" />\r\n            )}\r\n            <div className=\"text-sm\">\r\n              {lastResult.assignments.length > 0 && (\r\n                <p className=\"font-medium\">\r\n                  {lastResult.assignments.length} roller tilldelade\r\n                </p>\r\n              )}\r\n              {lastResult.errors.map((err, i) => (\r\n                <p key={`err-${i}`}>{err}</p>\r\n              ))}\r\n              {lastResult.warnings.map((warn, i) => (\r\n                <p key={`warn-${i}`}>{warn}</p>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n      \r\n      {/* Minimum requirements warning */}\r\n      {!minCheck.satisfied && (\r\n        <div className=\"rounded-lg bg-yellow-50 p-3 text-yellow-700\">\r\n          <div className=\"flex items-start gap-2\">\r\n            <ExclamationTriangleIcon className=\"h-5 w-5 shrink-0\" />\r\n            <div className=\"text-sm\">\r\n              <p className=\"font-medium\">Minimikrav ej uppfyllt</p>\r\n              {minCheck.unsatisfied.map(({ role, needed }) => (\r\n                <p key={role.id}>\r\n                  {role.name}: {needed} fler beh├Âvs\r\n                </p>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n      \r\n      {/* Roles Grid */}\r\n      <div className=\"grid gap-4 sm:grid-cols-2\">\r\n        {roles.map((role) => {\r\n          const assignedParticipantIds = roleToParticipants.get(role.id) || [];\r\n          const assignedParticipants = assignedParticipantIds\r\n            .map((id) => participants.find((p) => p.id === id))\r\n            .filter((p): p is Participant => !!p);\r\n          const isFull = role.max_count !== null && assignedParticipants.length >= role.max_count;\r\n          const needsMore = assignedParticipants.length < role.min_count;\r\n          const colors = getRoleColorClasses(role.color);\r\n          \r\n          return (\r\n            <Card key={role.id} className={`overflow-hidden ${colors.border} border-2`}>\r\n              {/* Role header */}\r\n              <div className={`p-3 ${colors.bg}`}>\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <span className=\"text-xl\">{role.icon || '­ƒæñ'}</span>\r\n                    <div>\r\n                      <h4 className={`font-semibold ${colors.text}`}>{role.name}</h4>\r\n                      <p className=\"text-xs text-muted-foreground\">\r\n                        {assignedParticipants.length}\r\n                        {role.max_count !== null ? ` / ${role.max_count}` : ''} tilldelade\r\n                        {role.min_count > 1 && ` (min ${role.min_count})`}\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                  \r\n                  {needsMore && (\r\n                    <Badge variant=\"destructive\" className=\"text-xs\">\r\n                      Beh├Âver {role.min_count - assignedParticipants.length}\r\n                    </Badge>\r\n                  )}\r\n                  {isFull && (\r\n                    <Badge variant=\"default\" className=\"text-xs bg-green-600\">\r\n                      Full\r\n                    </Badge>\r\n                  )}\r\n                </div>\r\n              </div>\r\n              \r\n              {/* Assigned participants */}\r\n              <div className=\"p-3 space-y-2\">\r\n                {assignedParticipants.length === 0 ? (\r\n                  <p className=\"text-sm text-muted-foreground italic\">\r\n                    Ingen tilldelad ├ñnnu\r\n                  </p>\r\n                ) : (\r\n                  assignedParticipants.map((p) => (\r\n                    <div\r\n                      key={p.id}\r\n                      className=\"flex items-center justify-between rounded-lg bg-muted/50 px-3 py-2\"\r\n                    >\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <UserCircleIcon className=\"h-5 w-5 text-muted-foreground\" />\r\n                        <span className=\"text-sm font-medium\">{p.display_name}</span>\r\n                      </div>\r\n                      {onUnassign && (\r\n                        <Button\r\n                          variant=\"ghost\"\r\n                          size=\"sm\"\r\n                          onClick={() => handleUnassign(p.id, role.id)}\r\n                          disabled={disabled || isAssigning}\r\n                          className=\"h-7 w-7 p-0 text-muted-foreground hover:text-destructive\"\r\n                        >\r\n                          <XMarkIcon className=\"h-4 w-4\" />\r\n                        </Button>\r\n                      )}\r\n                    </div>\r\n                  ))\r\n                )}\r\n              </div>\r\n            </Card>\r\n          );\r\n        })}\r\n      </div>\r\n      \r\n      {/* Unassigned Participants */}\r\n      {unassigned.length > 0 && (\r\n        <Card className=\"p-4\">\r\n          <h4 className=\"mb-3 text-sm font-semibold uppercase tracking-wider text-muted-foreground\">\r\n            Deltagare utan roll ({unassigned.length})\r\n          </h4>\r\n          <div className=\"flex flex-wrap gap-2\">\r\n            {unassigned.map((p) => (\r\n              <button\r\n                key={p.id}\r\n                onClick={() => setSelectedParticipant(\r\n                  selectedParticipant === p.id ? null : p.id\r\n                )}\r\n                disabled={disabled || isAssigning}\r\n                className={`inline-flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium transition-colors ${\r\n                  selectedParticipant === p.id\r\n                    ? 'bg-primary text-primary-foreground'\r\n                    : 'bg-muted hover:bg-muted/80'\r\n                }`}\r\n              >\r\n                <UserCircleIcon className=\"h-4 w-4\" />\r\n                {p.display_name}\r\n                {selectedParticipant !== p.id && (\r\n                  <PlusIcon className=\"h-3 w-3 opacity-50\" />\r\n                )}\r\n              </button>\r\n            ))}\r\n          </div>\r\n          \r\n          {/* Role selection for selected participant */}\r\n          {selectedParticipant && (\r\n            <div className=\"mt-4 rounded-lg border border-primary/20 bg-primary/5 p-4\">\r\n              <p className=\"mb-3 text-sm font-medium\">\r\n                V├ñlj roll f├Âr{' '}\r\n                <span className=\"text-primary\">\r\n                  {participants.find((p) => p.id === selectedParticipant)?.display_name}\r\n                </span>\r\n              </p>\r\n              {availableRoles.length === 0 ? (\r\n                <p className=\"text-sm text-muted-foreground italic\">\r\n                  Inga roller tillg├ñngliga (alla fulla eller konflikt)\r\n                </p>\r\n              ) : (\r\n                <div className=\"flex flex-wrap gap-2\">\r\n                  {availableRoles.map((role) => {\r\n                    const colors = getRoleColorClasses(role.color);\r\n                    return (\r\n                      <button\r\n                        key={role.id}\r\n                        onClick={() => handleManualAssign(selectedParticipant, role.id)}\r\n                        disabled={disabled || isAssigning}\r\n                        className={`inline-flex items-center gap-1.5 rounded-lg px-3 py-2 text-sm font-medium transition-colors hover:ring-2 hover:ring-primary/50 ${colors.bg} ${colors.border} ${colors.text} border`}\r\n                      >\r\n                        {role.icon && <span>{role.icon}</span>}\r\n                        {role.name}\r\n                      </button>\r\n                    );\r\n                  })}\r\n                </div>\r\n              )}\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={() => setSelectedParticipant(null)}\r\n                className=\"mt-3\"\r\n              >\r\n                Avbryt\r\n              </Button>\r\n            </div>\r\n          )}\r\n        </Card>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\RoleAssignerContainer.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":158,"column":63,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":158,"endColumn":89},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":159,"column":54,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":160,"endColumn":21},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":160,"column":51,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":160,"endColumn":89},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":160,"column":96,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":161,"endColumn":9},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":162,"column":54,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":164,"endColumn":9}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * RoleAssignerContainer Component\r\n * \r\n * Container that loads participants and assignments data,\r\n * then renders RoleAssigner with the correct props.\r\n */\r\n\r\n'use client';\r\n\r\nimport { useState, useEffect, useCallback } from 'react';\r\nimport { RoleAssigner } from './RoleAssigner';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Skeleton } from '@/components/ui/skeleton';\r\nimport type { SessionRole, RoleAssignment } from '@/types/play-runtime';\r\nimport type { Participant } from '@/lib/utils/role-assignment';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface RoleAssignerContainerProps {\r\n  /** Session ID */\r\n  sessionId: string;\r\n  /** Available session roles */\r\n  sessionRoles: SessionRole[];\r\n  /** Called when assignment is complete */\r\n  onAssignmentComplete?: () => void;\r\n}\r\n\r\n// =============================================================================\r\n// Component\r\n// =============================================================================\r\n\r\nexport function RoleAssignerContainer({\r\n  sessionId,\r\n  sessionRoles,\r\n  onAssignmentComplete,\r\n}: RoleAssignerContainerProps) {\r\n  const [participants, setParticipants] = useState<Participant[]>([]);\r\n  const [assignments, setAssignments] = useState<RoleAssignment[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  // Load participants and assignments\r\n  const loadData = useCallback(async () => {\r\n    try {\r\n      // Fetch participants\r\n      const participantsRes = await fetch(`/api/play/sessions/${sessionId}/participants`, {\r\n        cache: 'no-store',\r\n      });\r\n      \r\n      if (participantsRes.ok) {\r\n        const data = await participantsRes.json();\r\n        // Map to Participant format expected by RoleAssigner\r\n        setParticipants((data.participants || []).map((p: { id: string; displayName: string }) => ({\r\n          id: p.id,\r\n          display_name: p.displayName,\r\n        })));\r\n      }\r\n      \r\n      // Fetch assignments\r\n      const assignmentsRes = await fetch(`/api/play/sessions/${sessionId}/assignments`, {\r\n        cache: 'no-store',\r\n      });\r\n      \r\n      if (assignmentsRes.ok) {\r\n        const data = await assignmentsRes.json();\r\n        setAssignments(data.assignments || []);\r\n      }\r\n      \r\n      setError(null);\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : 'Kunde inte ladda data');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [sessionId]);\r\n\r\n  useEffect(() => {\r\n    void loadData();\r\n  }, [loadData]);\r\n\r\n  // Handle assignment\r\n  const handleAssign = useCallback(async (\r\n    newAssignments: Array<{ participantId: string; roleId: string }>\r\n  ) => {\r\n    try {\r\n      const res = await fetch(`/api/play/sessions/${sessionId}/assignments`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ assignments: newAssignments }),\r\n      });\r\n      \r\n      if (!res.ok) {\r\n        throw new Error('Kunde inte tilldela roller');\r\n      }\r\n      \r\n      // Reload data\r\n      await loadData();\r\n      onAssignmentComplete?.();\r\n    } catch (err) {\r\n      console.error('[RoleAssignerContainer] Assign error:', err);\r\n      throw err;\r\n    }\r\n  }, [sessionId, loadData, onAssignmentComplete]);\r\n\r\n  // Handle unassign\r\n  const handleUnassign = useCallback(async (participantId: string, roleId: string) => {\r\n    try {\r\n      const res = await fetch(`/api/play/sessions/${sessionId}/assignments`, {\r\n        method: 'DELETE',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ participantId, roleId }),\r\n      });\r\n      \r\n      if (!res.ok) {\r\n        throw new Error('Kunde inte ta bort rolltilldelning');\r\n      }\r\n      \r\n      // Reload data and notify parent\r\n      await loadData();\r\n      onAssignmentComplete?.();\r\n    } catch (err) {\r\n      console.error('[RoleAssignerContainer] Unassign error:', err);\r\n      throw err;\r\n    }\r\n  }, [sessionId, loadData, onAssignmentComplete]);\r\n\r\n  // Loading state\r\n  if (loading) {\r\n    return (\r\n      <Card className=\"p-6 space-y-4\">\r\n        <Skeleton className=\"h-8 w-48\" />\r\n        <Skeleton className=\"h-32 w-full\" />\r\n        <Skeleton className=\"h-24 w-full\" />\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // Error state\r\n  if (error) {\r\n    return (\r\n      <Card className=\"p-6 text-center\">\r\n        <p className=\"text-destructive\">{error}</p>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // No roles available in session yet\r\n  if (sessionRoles.length === 0) {\r\n    return (\r\n      <Card className=\"p-6 text-center space-y-3\">\r\n        <div className=\"mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-muted\">\r\n          <svg className=\"h-6 w-6 text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z\" />\r\n          </svg>\r\n        </div>\r\n        <h2 className=\"text-lg font-semibold text-foreground\">Inga roller kopierade ├ñnnu</h2>\r\n        <p className=\"text-sm text-muted-foreground\">\r\n          Klicka p├Ñ <span className=\"font-medium\">&ldquo;Kopiera roller fr├Ñn spel&rdquo;</span> ovan f├Âr att h├ñmta rollerna fr├Ñn spelets mall.\r\n        </p>\r\n        <p className=\"text-xs text-muted-foreground\">\r\n          Efter kopiering kan du tilldela roller till deltagare manuellt eller slumpm├ñssigt.\r\n        </p>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <RoleAssigner\r\n      sessionId={sessionId}\r\n      roles={sessionRoles}\r\n      participants={participants}\r\n      assignments={assignments}\r\n      onAssign={handleAssign}\r\n      onUnassign={handleUnassign}\r\n    />\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\RoleCard.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":245,"column":54,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":247,"endColumn":15},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":256,"column":18,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":258,"endColumn":17}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * RoleCard Component\r\n * \r\n * Displays a participant's assigned role with identity, instructions, and hints.\r\n * Supports different views: compact (icon only), summary, and full.\r\n */\r\n\r\n'use client';\r\n\r\nimport { useState } from 'react';\r\nimport {\r\n  EyeIcon,\r\n  EyeSlashIcon,\r\n  LightBulbIcon,\r\n  UserCircleIcon,\r\n  SparklesIcon,\r\n} from '@heroicons/react/24/solid';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Badge } from '@/components/ui/badge';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface RoleCardData {\r\n  id: string;\r\n  name: string;\r\n  icon: string | null;\r\n  color: string | null;\r\n  public_description: string | null;\r\n  private_instructions: string;\r\n  private_hints: string | null;\r\n}\r\n\r\nexport interface RoleCardProps {\r\n  /** Role data */\r\n  role: RoleCardData;\r\n  /** Display variant */\r\n  variant?: 'compact' | 'summary' | 'full';\r\n  /** Whether to show private info (instructions/hints) */\r\n  showPrivate?: boolean;\r\n  /** Whether hints are revealed */\r\n  hintsRevealed?: boolean;\r\n  /** Called when user requests to reveal hints */\r\n  onRevealHints?: () => void;\r\n  /** Called when user requests a hint from the host */\r\n  onRequestHint?: () => void;\r\n  /** Whether the card is interactive */\r\n  interactive?: boolean;\r\n  /** Custom class name */\r\n  className?: string;\r\n}\r\n\r\n// =============================================================================\r\n// Helper: Get color classes from role color\r\n// =============================================================================\r\n\r\nfunction getRoleColorClasses(color: string | null): {\r\n  bg: string;\r\n  border: string;\r\n  text: string;\r\n  iconBg: string;\r\n} {\r\n  // Map role colors to Tailwind classes\r\n  const colorMap: Record<string, { bg: string; border: string; text: string; iconBg: string }> = {\r\n    red: { bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-700', iconBg: 'bg-red-100' },\r\n    orange: { bg: 'bg-orange-50', border: 'border-orange-200', text: 'text-orange-700', iconBg: 'bg-orange-100' },\r\n    yellow: { bg: 'bg-yellow-50', border: 'border-yellow-200', text: 'text-yellow-700', iconBg: 'bg-yellow-100' },\r\n    green: { bg: 'bg-green-50', border: 'border-green-200', text: 'text-green-700', iconBg: 'bg-green-100' },\r\n    blue: { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-700', iconBg: 'bg-blue-100' },\r\n    indigo: { bg: 'bg-indigo-50', border: 'border-indigo-200', text: 'text-indigo-700', iconBg: 'bg-indigo-100' },\r\n    purple: { bg: 'bg-purple-50', border: 'border-purple-200', text: 'text-purple-700', iconBg: 'bg-purple-100' },\r\n    pink: { bg: 'bg-pink-50', border: 'border-pink-200', text: 'text-pink-700', iconBg: 'bg-pink-100' },\r\n  };\r\n  \r\n  return colorMap[color || ''] || {\r\n    bg: 'bg-muted/50',\r\n    border: 'border-border',\r\n    text: 'text-foreground',\r\n    iconBg: 'bg-muted',\r\n  };\r\n}\r\n\r\n// =============================================================================\r\n// Component\r\n// =============================================================================\r\n\r\nexport function RoleCard({\r\n  role,\r\n  variant = 'full',\r\n  showPrivate = true,\r\n  hintsRevealed = false,\r\n  onRevealHints,\r\n  onRequestHint,\r\n  interactive = true,\r\n  className = '',\r\n}: RoleCardProps) {\r\n  const [showInstructions, setShowInstructions] = useState(true);\r\n  const [localHintsRevealed, setLocalHintsRevealed] = useState(hintsRevealed);\r\n  \r\n  const colors = getRoleColorClasses(role.color);\r\n  const hasHints = !!role.private_hints;\r\n  const hintsVisible = hintsRevealed || localHintsRevealed;\r\n  \r\n  const handleRevealHints = () => {\r\n    setLocalHintsRevealed(true);\r\n    onRevealHints?.();\r\n  };\r\n\r\n  // ==========================================================================\r\n  // Compact variant (icon + name only)\r\n  // ==========================================================================\r\n  if (variant === 'compact') {\r\n    return (\r\n      <div className={`inline-flex items-center gap-2 rounded-full px-3 py-1.5 ${colors.bg} ${colors.border} border ${className}`}>\r\n        <span className={`flex h-6 w-6 items-center justify-center rounded-full ${colors.iconBg}`}>\r\n          {role.icon ? (\r\n            <span className=\"text-sm\">{role.icon}</span>\r\n          ) : (\r\n            <UserCircleIcon className={`h-4 w-4 ${colors.text}`} />\r\n          )}\r\n        </span>\r\n        <span className={`text-sm font-medium ${colors.text}`}>{role.name}</span>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Summary variant (name + description, no instructions)\r\n  // ==========================================================================\r\n  if (variant === 'summary') {\r\n    return (\r\n      <Card className={`overflow-hidden ${colors.border} border-2 ${className}`}>\r\n        <div className={`p-4 ${colors.bg}`}>\r\n          <div className=\"flex items-center gap-3\">\r\n            <span className={`flex h-10 w-10 items-center justify-center rounded-xl ${colors.iconBg}`}>\r\n              {role.icon ? (\r\n                <span className=\"text-xl\">{role.icon}</span>\r\n              ) : (\r\n                <UserCircleIcon className={`h-6 w-6 ${colors.text}`} />\r\n              )}\r\n            </span>\r\n            <div>\r\n              <h3 className={`font-semibold ${colors.text}`}>{role.name}</h3>\r\n              {role.public_description && (\r\n                <p className=\"text-sm text-muted-foreground\">{role.public_description}</p>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Full variant (everything)\r\n  // ==========================================================================\r\n  return (\r\n    <Card className={`overflow-hidden ${colors.border} border-2 ${className}`}>\r\n      {/* Header */}\r\n      <div className={`p-4 ${colors.bg}`}>\r\n        <div className=\"flex items-start justify-between gap-3\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <span className={`flex h-12 w-12 items-center justify-center rounded-xl ${colors.iconBg} shadow-sm`}>\r\n              {role.icon ? (\r\n                <span className=\"text-2xl\">{role.icon}</span>\r\n              ) : (\r\n                <UserCircleIcon className={`h-7 w-7 ${colors.text}`} />\r\n              )}\r\n            </span>\r\n            <div>\r\n              <Badge variant=\"default\" className={`mb-1 ${colors.bg} ${colors.text} border ${colors.border}`}>\r\n                Din roll\r\n              </Badge>\r\n              <h2 className={`text-xl font-bold ${colors.text}`}>{role.name}</h2>\r\n            </div>\r\n          </div>\r\n          \r\n          {/* Toggle instructions visibility */}\r\n          {showPrivate && interactive && (\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"sm\"\r\n              onClick={() => setShowInstructions(!showInstructions)}\r\n              className=\"shrink-0\"\r\n            >\r\n              {showInstructions ? (\r\n                <EyeSlashIcon className=\"h-5 w-5\" />\r\n              ) : (\r\n                <EyeIcon className=\"h-5 w-5\" />\r\n              )}\r\n            </Button>\r\n          )}\r\n        </div>\r\n        \r\n        {/* Public description */}\r\n        {role.public_description && (\r\n          <p className=\"mt-3 text-sm text-muted-foreground\">{role.public_description}</p>\r\n        )}\r\n      </div>\r\n      \r\n      {/* Private Instructions */}\r\n      {showPrivate && showInstructions && (\r\n        <div className=\"border-t border-border p-4\">\r\n          <div className=\"mb-2 flex items-center gap-2\">\r\n            <SparklesIcon className=\"h-4 w-4 text-primary\" />\r\n            <h3 className=\"text-sm font-semibold uppercase tracking-wider text-muted-foreground\">\r\n              Dina instruktioner\r\n            </h3>\r\n          </div>\r\n          <div className=\"rounded-xl bg-muted/50 p-4\">\r\n            <p className=\"whitespace-pre-wrap text-sm leading-relaxed text-foreground\">\r\n              {role.private_instructions}\r\n            </p>\r\n          </div>\r\n        </div>\r\n      )}\r\n      \r\n      {/* Hints Section */}\r\n      {showPrivate && hasHints && (\r\n        <div className=\"border-t border-border p-4\">\r\n          <div className=\"mb-2 flex items-center gap-2\">\r\n            <LightBulbIcon className=\"h-4 w-4 text-yellow-500\" />\r\n            <h3 className=\"text-sm font-semibold uppercase tracking-wider text-muted-foreground\">\r\n              Tips\r\n            </h3>\r\n          </div>\r\n          \r\n          {hintsVisible ? (\r\n            <div className=\"rounded-xl bg-yellow-50 p-4 dark:bg-yellow-900/20\">\r\n              <p className=\"whitespace-pre-wrap text-sm leading-relaxed text-foreground\">\r\n                {role.private_hints}\r\n              </p>\r\n            </div>\r\n          ) : (\r\n            <div className=\"space-y-2\">\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={handleRevealHints}\r\n                disabled={!interactive}\r\n                className=\"w-full gap-2\"\r\n              >\r\n                <LightBulbIcon className=\"h-4 w-4\" />\r\n                Visa tips (om du k├Âr fast)\r\n              </Button>\r\n\r\n              {onRequestHint && (\r\n                <Button\r\n                  variant=\"ghost\"\r\n                  size=\"sm\"\r\n                  onClick={onRequestHint}\r\n                  disabled={!interactive}\r\n                  className=\"w-full\"\r\n                >\r\n                  Be om ledtr├Ñd av lekledaren\r\n                </Button>\r\n              )}\r\n            </div>\r\n          )}\r\n        </div>\r\n      )}\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\SessionChatDrawer.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":71,"column":67,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":73,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":82,"column":12,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":84,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":101,"column":60,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":101,"endColumn":82},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":137,"column":62,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":139,"endColumn":17}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useMemo, useState } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { cn } from '@/lib/utils';\r\nimport type { ChatMessage } from '@/features/play/api/chat-api';\r\nimport type { SessionChatRole } from '@/features/play/hooks/useSessionChat';\r\n\r\nexport interface SessionChatDrawerProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  role: SessionChatRole;\r\n  messages: ChatMessage[];\r\n  error: string | null;\r\n  sending: boolean;\r\n  onSend: (payload: { message: string; visibility: 'public' | 'host'; anonymous?: boolean }) => Promise<void>;\r\n}\r\n\r\nfunction formatTimeShort(iso: string) {\r\n  try {\r\n    return new Date(iso).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n  } catch {\r\n    return '';\r\n  }\r\n}\r\n\r\nexport function SessionChatDrawer({\r\n  open,\r\n  onClose,\r\n  role,\r\n  messages,\r\n  error,\r\n  sending,\r\n  onSend,\r\n}: SessionChatDrawerProps) {\r\n  const [tab, setTab] = useState<'public' | 'host'>('public');\r\n  const [input, setInput] = useState('');\r\n  const [anonymous, setAnonymous] = useState(false);\r\n\r\n  const handleClose = () => {\r\n    setInput('');\r\n    setAnonymous(false);\r\n    setTab('public');\r\n    onClose();\r\n  };\r\n\r\n  const visibleMessages = useMemo(() => {\r\n    return messages.filter((m) => (tab === 'public' ? m.visibility === 'public' : m.visibility === 'host'));\r\n  }, [messages, tab]);\r\n\r\n  if (!open) return null;\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-[75]\">\r\n      <div className=\"absolute inset-0 bg-black/50\" onClick={handleClose} aria-hidden=\"true\" />\r\n\r\n      <div\r\n        className={cn(\r\n          'absolute inset-x-0 bottom-0 max-h-[85vh] overflow-hidden rounded-t-2xl bg-background shadow-lg',\r\n          'lg:inset-y-0 lg:right-0 lg:left-auto lg:bottom-auto lg:max-h-none lg:w-[420px] lg:rounded-none lg:rounded-l-2xl',\r\n        )}\r\n        role=\"dialog\"\r\n        aria-modal=\"true\"\r\n        aria-label=\"Chatt\"\r\n      >\r\n        <div className=\"flex items-center justify-between border-b border-border px-4 py-3\">\r\n          <div className=\"text-sm font-semibold text-foreground\">Chatt</div>\r\n          <Button variant=\"ghost\" size=\"sm\" onClick={handleClose}>\r\n            St├ñng\r\n          </Button>\r\n        </div>\r\n\r\n        <div className=\"flex items-center gap-2 border-b border-border px-4 py-3\">\r\n          <Button\r\n            type=\"button\"\r\n            size=\"sm\"\r\n            variant={tab === 'public' ? 'primary' : 'outline'}\r\n            onClick={() => setTab('public')}\r\n          >\r\n            V├ñgg\r\n          </Button>\r\n          <Button\r\n            type=\"button\"\r\n            size=\"sm\"\r\n            variant={tab === 'host' ? 'primary' : 'outline'}\r\n            onClick={() => setTab('host')}\r\n          >\r\n            Privat\r\n          </Button>\r\n          <div className=\"ml-auto text-xs text-muted-foreground\">\r\n            {tab === 'public' ? 'Till alla' : role === 'host' ? 'Till lekledare' : 'Till lekledare'}\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"flex min-h-0 flex-col\">\r\n          <div className=\"min-h-0 flex-1 overflow-auto px-4 py-3\">\r\n            {visibleMessages.length === 0 ? (\r\n              <p className=\"text-sm text-muted-foreground\">Inga meddelanden ├ñnnu.</p>\r\n            ) : (\r\n              <div className=\"space-y-3\">\r\n                {visibleMessages.map((m) => (\r\n                  <div key={m.id} className={cn('text-sm', m.isMine ? 'text-right' : 'text-left')}>\r\n                    <div className={cn('flex items-center gap-2', m.isMine ? 'justify-end' : 'justify-start')}>\r\n                      {!m.isMine && <span className=\"font-medium text-foreground\">{m.senderLabel}</span>}\r\n                      {m.visibility === 'host' && <Badge variant=\"secondary\">Privat</Badge>}\r\n                      <span className=\"text-xs text-muted-foreground\">{formatTimeShort(m.createdAt)}</span>\r\n                      {m.isMine && <span className=\"font-medium text-foreground\">Du</span>}\r\n                    </div>\r\n                    <p className=\"text-muted-foreground whitespace-pre-wrap\">{m.message}</p>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {error && (\r\n            <div className=\"border-t border-border px-4 py-2 text-sm text-destructive\">{error}</div>\r\n          )}\r\n\r\n          <div className=\"border-t border-border px-4 py-3\">\r\n            {role === 'participant' && tab === 'host' && (\r\n              <label className=\"mb-2 flex items-center gap-2 text-sm text-muted-foreground\">\r\n                <input\r\n                  type=\"checkbox\"\r\n                  checked={anonymous}\r\n                  onChange={(e) => setAnonymous(e.target.checked)}\r\n                />\r\n                Skicka anonymt\r\n              </label>\r\n            )}\r\n\r\n            {role === 'host' && tab === 'host' && (\r\n              <Card className=\"mb-3 p-3\">\r\n                <p className=\"text-sm text-muted-foreground\">\r\n                  Privat-chatten ├ñr till f├Âr deltagare ÔåÆ lekledare. Du kan svara p├Ñ v├ñggen.\r\n                </p>\r\n              </Card>\r\n            )}\r\n\r\n            <div className=\"flex gap-2\">\r\n              <Input\r\n                value={input}\r\n                onChange={(e) => setInput(e.target.value)}\r\n                placeholder={tab === 'public' ? 'Skriv till allaÔÇª' : 'Skriv privat till lekledarenÔÇª'}\r\n                onKeyDown={(e) => {\r\n                  if (e.key === 'Enter') {\r\n                    e.preventDefault();\r\n                    void onSend({ message: input, visibility: tab, anonymous });\r\n                    setInput('');\r\n                    setAnonymous(false);\r\n                  }\r\n                }}\r\n                disabled={sending || (role === 'host' && tab === 'host')}\r\n              />\r\n              <Button\r\n                type=\"button\"\r\n                onClick={() => {\r\n                  void onSend({ message: input, visibility: tab, anonymous });\r\n                  setInput('');\r\n                  setAnonymous(false);\r\n                }}\r\n                disabled={sending || (role === 'host' && tab === 'host')}\r\n              >\r\n                Skicka\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\SessionCockpit.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":169,"column":39,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":169,"endColumn":50},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":405,"column":67,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":405,"endColumn":93},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":406,"column":56,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":408,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":422,"column":57,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":422,"endColumn":71},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":424,"column":50,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":424,"endColumn":77},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":468,"column":16,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":468,"endColumn":49},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":469,"column":41,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":471,"endColumn":13},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":501,"column":12,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":501,"endColumn":42},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":1194,"column":64,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":1196,"endColumn":19},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":1387,"column":47,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":1387,"endColumn":67}],"suppressedMessages":[],"errorCount":10,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * SessionCockpit Component\r\n * \r\n * Unified shell for host session management.\r\n * Combines Lobby tabs with Director Mode overlay.\r\n * \"Two modes of the same control panel, not two different worlds.\"\r\n */\r\n\r\n'use client';\r\n\r\nimport { createContext, useContext, useMemo, useState, useCallback, useEffect, type ReactNode } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Tabs, TabPanel } from '@/components/ui/tabs';\r\nimport { useToast } from '@/components/ui/toast';\r\nimport { cn } from '@/lib/utils';\r\nimport { isFeatureEnabled } from '@/lib/config/env';\r\nimport {\r\n  PlayIcon,\r\n  UserGroupIcon,\r\n  BoltIcon,\r\n  ExclamationTriangleIcon,\r\n  CheckCircleIcon,\r\n  ChevronRightIcon,\r\n  ClipboardDocumentCheckIcon,\r\n  ChatBubbleLeftRightIcon,\r\n  FlagIcon,\r\n  UserMinusIcon,\r\n} from '@heroicons/react/24/outline';\r\nimport { useSessionState } from '../hooks/useSessionState';\r\nimport { useSignalCapabilities } from '../hooks/useSignalCapabilities';\r\nimport { useSessionChat } from '../hooks/useSessionChat';\r\nimport { useSessionEvents } from '../hooks/useSessionEvents';\r\nimport { DirectorModeDrawer } from './DirectorModeDrawer';\r\nimport { PreflightChecklist, type ChecklistItem } from './PreflightChecklist';\r\nimport { ArtifactsPanel } from './ArtifactsPanel';\r\nimport { SignalPanel } from './SignalPanel';\r\nimport { TimeBankPanel } from './TimeBankPanel';\r\nimport { EventFeedPanel } from './EventFeedPanel';\r\nimport { SessionChatDrawer } from './SessionChatDrawer';\r\nimport { SessionStoryPanel } from './SessionStoryPanel';\r\nimport { LobbyHub } from '@/components/play';\r\nimport { StoryViewModal } from './StoryViewModal';\r\nimport { Toolbelt } from '@/features/tools/components/Toolbelt';\r\nimport { updateSessionRoles, type SessionRoleUpdate } from '@/features/play/api/session-api';\r\nimport { kickParticipant, setNextStarter } from '@/features/play-participant/api';\r\nimport type { SessionCockpitState, CockpitParticipant, UseSessionStateReturn, SessionEvent as CockpitEvent } from '@/types/session-cockpit';\r\nimport type { SessionEvent as EventFeedEvent } from '@/types/session-event';\r\nimport type { SessionRole } from '@/types/play-runtime';\r\nimport type { LobbyState, SectionReadiness, ReadinessLevel } from '@/types/lobby';\r\nimport { DEFAULT_SESSION_SETTINGS } from '@/types/lobby';\r\n\r\n// =============================================================================\r\n// Context\r\n// =============================================================================\r\n\r\nconst SessionCockpitContext = createContext<UseSessionStateReturn | null>(null);\r\n\r\nexport function useSessionCockpit(): UseSessionStateReturn {\r\n  const ctx = useContext(SessionCockpitContext);\r\n  if (!ctx) {\r\n    throw new Error('useSessionCockpit must be used within a SessionCockpitProvider');\r\n  }\r\n  return ctx;\r\n}\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface SessionCockpitProps {\r\n  /** Session ID */\r\n  sessionId: string;\r\n  /** Optional host ID override */\r\n  hostId?: string;\r\n  /** Optional tenant ID */\r\n  tenantId?: string;\r\n  /** Render prop for custom lobby tabs content */\r\n  children?: ReactNode;\r\n  /** Class name */\r\n  className?: string;\r\n}\r\n\r\ntype CockpitTab =\r\n  | 'overview'\r\n  | 'story'\r\n  | 'participants'\r\n  | 'artifacts'\r\n  | 'triggers'\r\n  | 'signals'\r\n  | 'timebank'\r\n  | 'events'\r\n  | 'settings';\r\n\r\n// Session info for display\r\ninterface SessionInfo {\r\n  name: string;\r\n  code: string;\r\n}\r\n\r\ninterface LobbyCheckInput {\r\n  id: string;\r\n  label: string;\r\n  status: 'ready' | 'warning' | 'error' | 'pending';\r\n  detail?: string;\r\n}\r\n\r\n// =============================================================================\r\n// Sub-components\r\n// =============================================================================\r\n\r\nfunction SessionHeader({\r\n  session,\r\n  status,\r\n  participantCount,\r\n  sessionId,\r\n  onEnterDirectorMode,\r\n  isPending,\r\n  onOpenChat,\r\n  chatUnreadCount,\r\n}: {\r\n  session: SessionInfo | null;\r\n  status: SessionCockpitState['status'];\r\n  participantCount: number;\r\n  sessionId: string;\r\n  onEnterDirectorMode: () => void;\r\n  isPending: boolean;\r\n  onOpenChat?: () => void;\r\n  chatUnreadCount?: number;\r\n}) {\r\n  if (!session) return null;\r\n\r\n  return (\r\n    <header className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between p-4 border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/80\">\r\n      <div className=\"min-w-0\">\r\n        <h1 className=\"text-xl font-semibold text-foreground truncate\">\r\n          {session.name}\r\n        </h1>\r\n        <div className=\"flex items-center gap-3 text-sm text-muted-foreground mt-1\">\r\n          <span className=\"font-mono tracking-wider\">{session.code}</span>\r\n          <span>ÔÇó</span>\r\n          <span className=\"flex items-center gap-1\">\r\n            <UserGroupIcon className=\"h-4 w-4\" />\r\n            {participantCount} deltagare\r\n          </span>\r\n          {status === 'active' && (\r\n            <Badge variant=\"success\" size=\"sm\">\r\n              ÔùÅ LIVE\r\n            </Badge>\r\n          )}\r\n          {status === 'paused' && (\r\n            <Badge variant=\"warning\" size=\"sm\">\r\n              ÔÅ© PAUSAD\r\n            </Badge>\r\n          )}\r\n        </div>\r\n      </div>\r\n      \r\n      <div className=\"flex items-center gap-2\">\r\n        {onOpenChat && (\r\n          <Button\r\n            onClick={onOpenChat}\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            className=\"relative\"\r\n          >\r\n            <ChatBubbleLeftRightIcon className=\"h-4 w-4\" />\r\n            <span className=\"sr-only\">├ûppna chatt</span>\r\n            {chatUnreadCount && chatUnreadCount > 0 && (\r\n              <span className=\"absolute -right-1 -top-1 min-w-[18px] rounded-full bg-primary px-1 text-[10px] font-semibold text-primary-foreground\">\r\n                {chatUnreadCount}\r\n              </span>\r\n            )}\r\n          </Button>\r\n        )}\r\n\r\n        <Toolbelt\r\n          sessionId={sessionId}\r\n          role=\"host\"\r\n          buttonLabel=\"­ƒº░\"\r\n        />\r\n\r\n        {status === 'lobby' && (\r\n          <Button\r\n            onClick={onEnterDirectorMode}\r\n            disabled={isPending}\r\n            size=\"lg\"\r\n          >\r\n            <PlayIcon className=\"h-5 w-5 mr-2\" />\r\n            Starta session\r\n          </Button>\r\n        )}\r\n        {(status === 'active' || status === 'paused') && (\r\n          <Button\r\n            onClick={onEnterDirectorMode}\r\n            variant=\"outline\"\r\n          >\r\n            <ChevronRightIcon className=\"h-5 w-5 mr-1\" />\r\n            Director Mode\r\n          </Button>\r\n        )}\r\n      </div>\r\n    </header>\r\n  );\r\n}\r\n\r\ninterface PreflightState {\r\n  ready: boolean;\r\n  items: ChecklistItem[];\r\n}\r\n\r\nfunction ReadinessIndicator({\r\n  preflight,\r\n  onShowChecklist,\r\n}: {\r\n  preflight: PreflightState;\r\n  onShowChecklist: () => void;\r\n}) {\r\n  const { ready, items } = preflight;\r\n  const pendingCount = items.filter((i: ChecklistItem) => i.status === 'pending').length;\r\n  const errorCount = items.filter((i: ChecklistItem) => i.status === 'error').length;\r\n  const warningCount = items.filter((i: ChecklistItem) => i.status === 'warning').length;\r\n  \r\n  return (\r\n    <Card\r\n      className={cn(\r\n        'p-4 cursor-pointer transition-colors hover:bg-muted/50',\r\n        ready \r\n          ? 'border-green-300 bg-green-50 dark:border-green-800 dark:bg-green-950/20' \r\n          : errorCount > 0 \r\n            ? 'border-destructive/50 bg-destructive/10' \r\n            : 'border-amber-300 bg-amber-50 dark:border-amber-800 dark:bg-amber-950/20'\r\n      )}\r\n      onClick={onShowChecklist}\r\n    >\r\n      <div className=\"flex items-center justify-between\">\r\n        <div className=\"flex items-center gap-3\">\r\n          {ready ? (\r\n            <CheckCircleIcon className=\"h-6 w-6 text-green-600\" />\r\n          ) : (\r\n            <ClipboardDocumentCheckIcon className=\"h-6 w-6 text-amber-600\" />\r\n          )}\r\n          <div>\r\n            <div className=\"font-medium text-foreground\">\r\n              {ready ? 'Redo att starta' : 'F├Ârbereda session'}\r\n            </div>\r\n            <div className=\"text-sm text-muted-foreground\">\r\n              {ready \r\n                ? 'Alla kontroller godk├ñnda'\r\n                : `${pendingCount} v├ñntande${warningCount > 0 ? `, ${warningCount} varningar` : ''}${errorCount > 0 ? `, ${errorCount} fel` : ''}`\r\n              }\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <ChevronRightIcon className=\"h-5 w-5 text-muted-foreground\" />\r\n      </div>\r\n    </Card>\r\n  );\r\n}\r\n\r\nfunction ParticipantWithRoleRow({\r\n  participant,\r\n  roles,\r\n  onAssignRole,\r\n  onUnassignRole,\r\n  onKick,\r\n  onMarkNext,\r\n  isDisabled,\r\n}: {\r\n  participant: CockpitParticipant;\r\n  roles: SessionRole[];\r\n  onAssignRole: (participantId: string, roleId: string | null) => void;\r\n  onUnassignRole: (participantId: string) => void;\r\n  onKick: (participantId: string, displayName?: string) => void;\r\n  onMarkNext: (participantId: string) => void;\r\n  isDisabled: boolean;\r\n}) {\r\n  const currentRole = roles.find((r) => r.id === participant.assignedRoleId);\r\n\r\n  // Map status to connection state\r\n  const isConnected = participant.status === 'active' || participant.status === 'joined';\r\n\r\n  return (\r\n    <div className=\"flex items-center justify-between p-3 border rounded-lg bg-card\">\r\n      <div className=\"flex items-center gap-3 min-w-0\">\r\n        <div className=\"w-8 h-8 rounded-full bg-muted flex items-center justify-center text-sm font-medium\">\r\n          {participant.displayName?.charAt(0)?.toUpperCase() ?? '?'}\r\n        </div>\r\n        <div className=\"min-w-0\">\r\n          <div className=\"font-medium text-foreground truncate\">\r\n            {participant.displayName ?? 'Anonym deltagare'}\r\n          </div>\r\n          {participant.isNextStarter && (\r\n            <Badge variant=\"outline\" className=\"mt-1 w-fit text-[10px]\">\r\n              Nasta tur\r\n            </Badge>\r\n          )}\r\n          <div className=\"text-xs text-muted-foreground flex items-center gap-1\">\r\n            {isConnected ? (\r\n              <span className=\"text-green-600\">ÔùÅ Online</span>\r\n            ) : (\r\n              <span className=\"text-muted-foreground\">Ôùï Offline</span>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n      \r\n      <div className=\"flex items-center gap-2\">\r\n        {currentRole ? (\r\n          <Badge\r\n            variant=\"secondary\"\r\n            className=\"cursor-pointer\"\r\n            onClick={() => !isDisabled && onUnassignRole(participant.id)}\r\n          >\r\n            {currentRole.name}\r\n            <span className=\"ml-1 opacity-60\">├ù</span>\r\n          </Badge>\r\n        ) : (\r\n          <select\r\n            className=\"text-sm border rounded-lg px-2 py-1 bg-background\"\r\n            value=\"\"\r\n            onChange={(e) => e.target.value && onAssignRole(participant.id, e.target.value)}\r\n            disabled={isDisabled}\r\n          >\r\n            <option value=\"\">Tilldela roll...</option>\r\n            {roles.map((role) => (\r\n              <option key={role.id} value={role.id}>\r\n                {role.name}\r\n              </option>\r\n            ))}\r\n          </select>\r\n        )}\r\n        <Button\r\n          variant={participant.isNextStarter ? 'primary' : 'outline'}\r\n          size=\"sm\"\r\n          onClick={() => onMarkNext(participant.id)}\r\n          disabled={isDisabled}\r\n          className=\"px-2\"\r\n        >\r\n          <FlagIcon className=\"h-4 w-4\" />\r\n        </Button>\r\n        <Button\r\n          variant=\"destructive\"\r\n          size=\"sm\"\r\n          onClick={() => onKick(participant.id, participant.displayName)}\r\n          disabled={isDisabled}\r\n          className=\"px-2\"\r\n        >\r\n          <UserMinusIcon className=\"h-4 w-4\" />\r\n        </Button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction ParticipantsTab({\r\n  participants,\r\n  roles,\r\n  onAssignRole,\r\n  onUnassignRole,\r\n  onSnapshotRoles,\r\n  onKickParticipant,\r\n  onMarkNext,\r\n  isReadOnly,\r\n  isLoading,\r\n}: {\r\n  participants: CockpitParticipant[];\r\n  roles: SessionRole[];\r\n  onAssignRole: (participantId: string, roleId: string | null) => void;\r\n  onUnassignRole: (participantId: string) => void;\r\n  onSnapshotRoles?: () => void;\r\n  onKickParticipant: (participantId: string, displayName?: string) => void;\r\n  onMarkNext: (participantId: string) => void;\r\n  isReadOnly: boolean;\r\n  isLoading: boolean;\r\n}) {\r\n  const connectedCount = participants.filter((p) => p.status === 'active' || p.status === 'joined').length;\r\n  const assignedCount = participants.filter((p) => p.assignedRoleId).length;\r\n  \r\n  // Calculate role distribution\r\n  const roleDistribution = roles.map((role) => {\r\n    const assigned = participants.filter((p) => p.assignedRoleId === role.id).length;\r\n    const min = (role as { min_count?: number }).min_count ?? 0;\r\n    const max = (role as { max_count?: number | null }).max_count;\r\n    const maxLabel = max === null || max === undefined ? '+' : `-${max}`;\r\n    return {\r\n      id: role.id,\r\n      name: role.name,\r\n      assigned,\r\n      min,\r\n      max,\r\n      maxLabel,\r\n      isSatisfied: assigned >= min,\r\n    };\r\n  });\r\n\r\n  const allMinsSatisfied = roleDistribution.every((r) => r.isSatisfied);\r\n  const unassignedParticipants = participants.filter((p) => !p.assignedRoleId);\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {roles.length === 0 && (\r\n        <Card className=\"p-6 text-center space-y-3\">\r\n          <h3 className=\"text-base font-semibold text-foreground\">Inga roller kopierade ├ñnnu</h3>\r\n          <p className=\"text-sm text-muted-foreground\">\r\n            Kopiera roller fr├Ñn spelet f├Âr att kunna tilldela dem till deltagare.\r\n          </p>\r\n          <Button\r\n            size=\"sm\"\r\n            onClick={onSnapshotRoles}\r\n            disabled={!onSnapshotRoles || isReadOnly || isLoading}\r\n          >\r\n            Kopiera roller\r\n          </Button>\r\n        </Card>\r\n      )}\r\n      {/* Role summary section */}\r\n      {roles.length > 0 && (\r\n        <Card className=\"p-4 border-l-4 border-l-primary\">\r\n          <div className=\"flex items-center justify-between mb-3\">\r\n            <h4 className=\"font-medium text-foreground\">Rollf├Ârdelning</h4>\r\n            {allMinsSatisfied ? (\r\n              <Badge variant=\"success\" size=\"sm\">Ô£ô Alla minimikrav uppfyllda</Badge>\r\n            ) : (\r\n              <Badge variant=\"warning\" size=\"sm\">ÔÜá Minimikrav ej uppfyllda</Badge>\r\n            )}\r\n          </div>\r\n          <div className=\"grid gap-2 sm:grid-cols-2 md:grid-cols-3\">\r\n            {roleDistribution.map((role) => (\r\n              <div\r\n                key={role.id}\r\n                className={cn(\r\n                  'flex items-center justify-between p-2 rounded-lg text-sm',\r\n                  role.isSatisfied ? 'bg-muted/50' : 'bg-warning/10 border border-warning/30'\r\n                )}\r\n              >\r\n                <span className=\"font-medium truncate\">{role.name}</span>\r\n                <span className={cn(\r\n                  'ml-2 whitespace-nowrap',\r\n                  role.isSatisfied ? 'text-muted-foreground' : 'text-warning font-medium'\r\n                )}>\r\n                  {role.assigned}/{role.min}{role.maxLabel}\r\n                </span>\r\n              </div>\r\n            ))}\r\n          </div>\r\n          {unassignedParticipants.length > 0 && (\r\n            <div className=\"mt-3 text-sm text-muted-foreground\">\r\n              {unassignedParticipants.length} deltagare saknar roll\r\n            </div>\r\n          )}\r\n        </Card>\r\n      )}\r\n\r\n      {/* Summary stats */}\r\n      <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\r\n        <span>{connectedCount} av {participants.length} online</span>\r\n        <span>ÔÇó</span>\r\n        <span>{assignedCount} av {participants.length} har roller</span>\r\n      </div>\r\n      \r\n      {/* Participant list */}\r\n      <div className=\"space-y-2\">\r\n        {participants.length === 0 ? (\r\n          <Card className=\"p-8 text-center text-muted-foreground\">\r\n            <UserGroupIcon className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\r\n            <p>Inga deltagare har anslutit ├ñnnu.</p>\r\n            <p className=\"text-sm mt-2\">\r\n              Dela sessionskoden f├Âr att bjuda in deltagare.\r\n            </p>\r\n          </Card>\r\n        ) : (\r\n          participants.map((p) => (\r\n            <ParticipantWithRoleRow\r\n              key={p.id}\r\n              participant={p}\r\n              roles={roles}\r\n              onAssignRole={onAssignRole}\r\n              onUnassignRole={onUnassignRole}\r\n              onKick={onKickParticipant}\r\n              onMarkNext={onMarkNext}\r\n              isDisabled={isReadOnly}\r\n            />\r\n          ))\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction TriggersTab({\r\n  triggers,\r\n}: {\r\n  triggers: SessionCockpitState['triggers'];\r\n}) {\r\n  if (triggers.length === 0) {\r\n    return (\r\n      <Card className=\"p-8 text-center text-muted-foreground\">\r\n        <BoltIcon className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\r\n        <p>Inga triggers i denna session.</p>\r\n        <p className=\"text-sm mt-2\">\r\n          Triggers konfigureras via Spel-byggaren.\r\n        </p>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  const armed = triggers.filter((t) => t.status === 'armed');\r\n  const fired = triggers.filter((t) => t.status === 'fired');\r\n  // Note: disabled triggers can be added in future iteration for \"show all\" toggle\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {armed.length > 0 && (\r\n        <div>\r\n          <div className=\"text-sm font-medium text-muted-foreground mb-2\">\r\n            ­ƒƒó Armed ({armed.length})\r\n          </div>\r\n          <div className=\"space-y-2\">\r\n            {armed.map((t) => (\r\n              <Card key={t.id} className=\"p-3 border-green-200 dark:border-green-800\">\r\n                <div className=\"font-medium\">{t.name}</div>\r\n                <div className=\"text-sm text-muted-foreground\">\r\n                  {t.conditionSummary} ÔåÆ {t.actionSummary}\r\n                </div>\r\n              </Card>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      )}\r\n      \r\n      {fired.length > 0 && (\r\n        <div>\r\n          <div className=\"text-sm font-medium text-muted-foreground mb-2\">\r\n            Ô£à Fired ({fired.length})\r\n          </div>\r\n          <div className=\"space-y-2\">\r\n            {fired.map((t) => (\r\n              <Card key={t.id} className=\"p-3 bg-muted/50\">\r\n                <div className=\"font-medium text-muted-foreground\">{t.name}</div>\r\n              </Card>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function SessionCockpit({\r\n  sessionId,\r\n  children,\r\n  className,\r\n}: SessionCockpitProps) {\r\n  const sessionState = useSessionState({ sessionId });\r\n  const {\r\n    // State\r\n    displayName,\r\n    sessionCode,\r\n    status,\r\n    isLoading,\r\n    error,\r\n    participants,\r\n    sessionRoles,\r\n    steps,\r\n    phases,\r\n    currentStepIndex,\r\n    currentPhaseIndex,\r\n    artifacts,\r\n    triggers,\r\n    recentSignals,\r\n    timeBankBalance,\r\n    timeBankPaused,\r\n    preflightItems,\r\n    canStartDirectorMode,\r\n    // Actions\r\n    enterDirectorMode,\r\n    exitDirectorMode,\r\n    startSession,\r\n    pauseSession,\r\n    resumeSession,\r\n    goToStep,\r\n    nextStep,\r\n    previousStep,\r\n    assignRole,\r\n    unassignRole,\r\n    snapshotRoles,\r\n    fireTrigger,\r\n    disableAllTriggers,\r\n    sendSignal,\r\n    applyTimeBankDelta,\r\n    refresh,\r\n  } = sessionState;\r\n\r\n  const showSignals = isFeatureEnabled('signals');\r\n  const showTimeBank = isFeatureEnabled('timeBank');\r\n  const showEvents = isFeatureEnabled('eventLogging');\r\n\r\n  const {\r\n    capabilities,\r\n    flashScreen,\r\n    playSound,\r\n    vibrate,\r\n    flashTorch,\r\n    sendNotification,\r\n    activateAudioGate,\r\n    audioGateActive,\r\n  } = useSignalCapabilities({ autoDetect: showSignals });\r\n\r\n  const toast = useToast();\r\n\r\n  const signalPresets = useMemo(() => {\r\n    const presets: Array<{\r\n      id: string;\r\n      name: string;\r\n      type: 'torch' | 'audio' | 'vibration' | 'screen_flash' | 'notification';\r\n      color?: string;\r\n      disabled?: boolean;\r\n      disabledReason?: string;\r\n    }> = [];\r\n\r\n    if (capabilities.screenFlash.status === 'available') {\r\n      presets.push({ id: 'screen_flash', name: 'Skarmblink', type: 'screen_flash', color: '#ffffff' });\r\n    }\r\n    if (capabilities.vibration.status === 'available') {\r\n      presets.push({ id: 'vibration', name: 'Vibration', type: 'vibration' });\r\n    }\r\n    if (capabilities.torch.status === 'available') {\r\n      presets.push({ id: 'torch', name: 'Ficklampa', type: 'torch' });\r\n    }\r\n    if (capabilities.audio.status === 'available') {\r\n      presets.push({ id: 'audio', name: 'Ljudsignal', type: 'audio' });\r\n    }\r\n    const notificationStatus = capabilities.notification.status;\r\n    const notificationDisabled = notificationStatus !== 'available';\r\n    let notificationReason: string | undefined;\r\n    if (notificationDisabled) {\r\n      switch (notificationStatus) {\r\n        case 'denied':\r\n          notificationReason = 'blocked in browser';\r\n          break;\r\n        case 'unavailable':\r\n          notificationReason = 'not supported in browser';\r\n          break;\r\n        case 'error':\r\n          notificationReason = 'permission error';\r\n          break;\r\n        case 'unknown':\r\n          notificationReason = 'permission pending';\r\n          break;\r\n        default:\r\n          notificationReason = 'not available';\r\n          break;\r\n      }\r\n    }\r\n    presets.push({\r\n      id: 'notification',\r\n      name: 'Notis',\r\n      type: 'notification',\r\n      disabled: notificationDisabled,\r\n      disabledReason: notificationReason,\r\n    });\r\n\r\n    return presets;\r\n  }, [capabilities]);\r\n\r\n  const [activeTab, setActiveTab] = useState<CockpitTab>('overview');\r\n  const [showChecklist, setShowChecklist] = useState(false);\r\n  const [chatOpen, setChatOpen] = useState(false);\r\n  const [storyOpen, setStoryOpen] = useState(false);\r\n  const [roleDrafts, setRoleDrafts] = useState<Record<string, SessionRoleUpdate>>({});\r\n  const [rolesSaving, setRolesSaving] = useState(false);\r\n  const [rolesSaveError, setRolesSaveError] = useState<string | null>(null);\r\n  \r\n  // Initialize director mode state based on session status\r\n  const [directorModeOpen, setDirectorModeOpen] = useState(\r\n    status === 'active' || status === 'paused'\r\n  );\r\n\r\n  // Session info for header\r\n  const session: SessionInfo | null = displayName ? { name: displayName, code: sessionCode } : null;\r\n\r\n  const chatEnabled = status === 'active' || status === 'paused';\r\n\r\n  const chat = useSessionChat({\r\n    sessionId,\r\n    role: 'host',\r\n    isOpen: chatOpen,\r\n    enabled: chatEnabled,\r\n  });\r\n\r\n  const { markAllRead } = chat;\r\n  useEffect(() => {\r\n    if (chatOpen) markAllRead();\r\n  }, [chatOpen, markAllRead]);\r\n\r\n  const {\r\n    events: sessionEvents,\r\n    stats: eventStats,\r\n    isLoading: eventsLoading,\r\n    error: eventsError,\r\n    refresh: refreshEvents,\r\n  } = useSessionEvents({\r\n    sessionId,\r\n    realtime: showEvents,\r\n  });\r\n\r\n  useEffect(() => {\r\n    if (sessionRoles.length === 0) {\r\n      setRoleDrafts({});\r\n      return;\r\n    }\r\n\r\n    setRoleDrafts((prev) => {\r\n      const next: Record<string, SessionRoleUpdate> = {};\r\n      for (const role of sessionRoles) {\r\n        next[role.id] = prev[role.id] ?? {\r\n          id: role.id,\r\n          name: role.name,\r\n          public_description: role.public_description ?? '',\r\n          private_instructions: role.private_instructions ?? '',\r\n          min_count: role.min_count,\r\n          max_count: role.max_count ?? null,\r\n          icon: role.icon ?? '',\r\n          color: role.color ?? '',\r\n        };\r\n      }\r\n      return next;\r\n    });\r\n  }, [sessionRoles]);\r\n\r\n  const handleSaveRoleEdits = useCallback(async () => {\r\n    if (sessionRoles.length === 0) return;\r\n    setRolesSaving(true);\r\n    setRolesSaveError(null);\r\n    try {\r\n      const updates = Object.values(roleDrafts);\r\n      const ok = await updateSessionRoles(sessionId, updates);\r\n      if (!ok) {\r\n        throw new Error('Failed to save session roles');\r\n      }\r\n      await refresh();\r\n    } catch (error) {\r\n      setRolesSaveError(\r\n        error instanceof Error ? error.message : 'Failed to save session roles'\r\n      );\r\n    } finally {\r\n      setRolesSaving(false);\r\n    }\r\n  }, [refresh, roleDrafts, sessionId, sessionRoles.length]);\r\n\r\n  const handleExecuteSignal = useCallback(async (type: string, config: Record<string, unknown>) => {\r\n    switch (type) {\r\n      case 'screen_flash': {\r\n        const color = typeof config.color === 'string' ? config.color : '#ffffff';\r\n        const duration = typeof config.durationMs === 'number' ? config.durationMs : undefined;\r\n        await flashScreen(color, duration);\r\n        break;\r\n      }\r\n      case 'vibration': {\r\n        const pattern = Array.isArray(config.pattern)\r\n          ? (config.pattern.filter((p) => typeof p === 'number') as number[])\r\n          : undefined;\r\n        await vibrate(pattern);\r\n        break;\r\n      }\r\n      case 'torch': {\r\n        const duration = typeof config.durationMs === 'number' ? config.durationMs : undefined;\r\n        await flashTorch(duration);\r\n        break;\r\n      }\r\n      case 'audio': {\r\n        if (!audioGateActive) {\r\n          await activateAudioGate();\r\n        }\r\n        const url = typeof config.url === 'string' ? config.url : undefined;\r\n        await playSound(url);\r\n        break;\r\n      }\r\n      case 'notification': {\r\n        const title = typeof config.title === 'string' ? config.title : 'Signal';\r\n        const body = typeof config.body === 'string' ? config.body : undefined;\r\n        const forceToast = config.forceToast === true;\r\n        const notificationStatus = capabilities.notification.status;\r\n        let sent = false;\r\n        if (!forceToast && notificationStatus === 'available') {\r\n          sent = await sendNotification(title, body);\r\n        }\r\n        if (!sent) {\r\n          let fallbackTitle = 'In-app notification';\r\n          if (!forceToast) {\r\n            switch (notificationStatus) {\r\n              case 'denied':\r\n                fallbackTitle = 'Notifications blocked';\r\n                break;\r\n              case 'unavailable':\r\n                fallbackTitle = 'Notifications not supported';\r\n                break;\r\n              case 'error':\r\n                fallbackTitle = 'Notification error';\r\n                break;\r\n              case 'unknown':\r\n                fallbackTitle = 'Notification pending';\r\n                break;\r\n              default:\r\n                fallbackTitle = 'Notification';\r\n                break;\r\n            }\r\n          }\r\n          const fallbackMessage = body ? `${title}: ${body}` : title;\r\n          toast.info(fallbackMessage, fallbackTitle);\r\n        }\r\n        break;\r\n      }\r\n    }\r\n  }, [activateAudioGate, audioGateActive, capabilities.notification.status, flashScreen, flashTorch, playSound, sendNotification, toast, vibrate]);\r\n\r\n  const handleKickParticipant = useCallback(async (participantId: string, displayName?: string) => {\r\n    if (typeof window !== 'undefined') {\r\n      const label = displayName ? `Ta bort ${displayName} fran sessionen?` : 'Ta bort deltagaren fran sessionen?';\r\n      if (!window.confirm(label)) return;\r\n    }\r\n    try {\r\n      await kickParticipant(sessionId, participantId);\r\n      await refresh();\r\n    } catch (error) {\r\n      console.warn('Failed to remove participant', error);\r\n    }\r\n  }, [refresh, sessionId]);\r\n\r\n  const handleMarkNext = useCallback(async (participantId: string) => {\r\n    try {\r\n      await setNextStarter(sessionId, participantId);\r\n      await refresh();\r\n    } catch (error) {\r\n      console.warn('Failed to mark next starter', error);\r\n    }\r\n  }, [refresh, sessionId]);\r\n\r\n  const drawerEvents = useMemo<CockpitEvent[]>(() => {\r\n    if (!showEvents) return [];\r\n    return sessionEvents.map((event: EventFeedEvent) => ({\r\n      id: event.id,\r\n      sessionId: event.sessionId,\r\n      type: event.eventType as unknown as CockpitEvent['type'],\r\n      timestamp: event.createdAt.toISOString(),\r\n      actorType: event.actorType,\r\n      actorId: event.actorId,\r\n      actorName: event.actorName,\r\n      payload: event.payload,\r\n      correlationId: event.correlationId,\r\n      parentEventId: event.parentEventId,\r\n      stepId: event.targetType === 'step' ? event.targetId : undefined,\r\n      phaseId: event.targetType === 'phase' ? event.targetId : undefined,\r\n      artifactId: event.targetType === 'artifact' ? event.targetId : undefined,\r\n      triggerId: event.targetType === 'trigger' ? event.targetId : undefined,\r\n    }));\r\n  }, [sessionEvents, showEvents]);\r\n\r\n  const lobbyState = useMemo<LobbyState>(() => {\r\n    const mapStatus = (status: LobbyCheckInput['status']): ReadinessLevel => {\r\n      switch (status) {\r\n        case 'ready':\r\n          return 'ready';\r\n        case 'error':\r\n          return 'error';\r\n        case 'warning':\r\n        case 'pending':\r\n        default:\r\n          return 'warning';\r\n      }\r\n    };\r\n\r\n    const buildSection = (section: string, items: LobbyCheckInput[]): SectionReadiness => {\r\n      const checks = items.map((item) => ({\r\n        key: item.id,\r\n        label: item.label,\r\n        status: mapStatus(item.status),\r\n        message: item.detail,\r\n      }));\r\n\r\n      const level = checks.reduce<ReadinessLevel>((acc, check) => {\r\n        if (check.status === 'error') return 'error';\r\n        if (check.status === 'warning' && acc !== 'error') return 'warning';\r\n        if (check.status === 'ready' && acc === 'unknown') return 'ready';\r\n        return acc;\r\n      }, 'unknown');\r\n\r\n      return {\r\n        section,\r\n        level,\r\n        checks,\r\n      };\r\n    };\r\n\r\n    const participantsChecks: LobbyCheckInput[] = [\r\n      {\r\n        id: 'participants',\r\n        label: 'Deltagare',\r\n        status: participants.length > 0 ? 'ready' : 'warning',\r\n        detail: participants.length > 0\r\n          ? `${participants.length} deltagare anslutna`\r\n          : 'Inga deltagare har anslutit ├ñn',\r\n      },\r\n    ];\r\n\r\n    const rolesChecks: LobbyCheckInput[] = preflightItems.filter((item) =>\r\n      ['roles-snapshot', 'roles-assigned', 'secrets'].includes(item.id)\r\n    );\r\n\r\n    const contentChecks: LobbyCheckInput[] = [\r\n      {\r\n        id: 'steps',\r\n        label: 'Steg & faser',\r\n        status: steps.length > 0 ? 'ready' : 'error',\r\n        detail: steps.length > 0\r\n          ? `${steps.length} steg definierade`\r\n          : 'Inga steg definierade',\r\n      },\r\n      ...preflightItems.filter((item) => item.id === 'artifacts'),\r\n    ];\r\n\r\n    const triggerChecks: LobbyCheckInput[] = preflightItems.filter((item) => item.id === 'triggers');\r\n\r\n    const settingsChecks: LobbyCheckInput[] = [\r\n      {\r\n        id: 'session-code',\r\n        label: 'Sessionskod',\r\n        status: sessionCode ? 'ready' : 'error',\r\n        detail: sessionCode ? 'Kod genererad' : 'Ingen kod genererad',\r\n      },\r\n    ];\r\n\r\n    const phaseMap = new Map<string, { id: string; title: string; steps: LobbyState['phases'][number]['steps'] }>();\r\n\r\n    phases.forEach((phase) => {\r\n      phaseMap.set(phase.id, {\r\n        id: phase.id,\r\n        title: phase.name,\r\n        steps: [],\r\n      });\r\n    });\r\n\r\n    const fallbackPhaseId = phases[0]?.id ?? 'phase-default';\r\n    const fallbackPhaseTitle = phases[0]?.name ?? 'Steg';\r\n\r\n    steps.forEach((step) => {\r\n      const missingTitle = !step.title?.trim();\r\n      const missingDescription = !step.description?.trim();\r\n      const targetPhaseId = step.phaseId && phaseMap.has(step.phaseId) ? step.phaseId : fallbackPhaseId;\r\n      if (!phaseMap.has(targetPhaseId)) {\r\n        phaseMap.set(targetPhaseId, {\r\n          id: targetPhaseId,\r\n          title: fallbackPhaseTitle,\r\n          steps: [],\r\n        });\r\n      }\r\n\r\n      phaseMap.get(targetPhaseId)!.steps.push({\r\n        id: step.id,\r\n        title: step.title || 'Namnl├Âst steg',\r\n        type: 'activity',\r\n        isReady: !missingTitle && !missingDescription,\r\n        issues: [\r\n          ...(missingTitle ? ['Saknar rubrik'] : []),\r\n          ...(missingDescription ? ['Saknar beskrivning'] : []),\r\n        ],\r\n      });\r\n    });\r\n\r\n    const lobbyPhases = Array.from(phaseMap.values());\r\n\r\n    return {\r\n      sessionId,\r\n      sessionName: displayName || 'Session',\r\n      sessionStatus: status === 'ended' ? 'completed' : status === 'active' || status === 'paused' ? 'active' : 'lobby',\r\n      participants: participants.map((participant) => ({\r\n        id: participant.id,\r\n        name: participant.displayName || 'Anonym deltagare',\r\n        roleId: participant.assignedRoleId,\r\n        isConnected: participant.status === 'active' || participant.status === 'joined',\r\n        joinedAt: new Date(participant.joinedAt),\r\n      })),\r\n      roles: sessionRoles.map((role) => ({\r\n        id: role.id,\r\n        name: role.name,\r\n        description: (role as { public_description?: string | null }).public_description ?? undefined,\r\n        color: role.color ?? undefined,\r\n        icon: role.icon ?? undefined,\r\n      })),\r\n      phases: lobbyPhases,\r\n      triggerCount: triggers.length,\r\n      settings: {\r\n        ...DEFAULT_SESSION_SETTINGS,\r\n        maxParticipants: Math.max(DEFAULT_SESSION_SETTINGS.maxParticipants, participants.length),\r\n      },\r\n      readiness: [\r\n        buildSection('participants', participantsChecks),\r\n        buildSection('roles', rolesChecks),\r\n        buildSection('content', contentChecks),\r\n        buildSection('triggers', triggerChecks),\r\n        buildSection('settings', settingsChecks),\r\n      ],\r\n    };\r\n  }, [sessionId, displayName, status, participants, sessionRoles, phases, steps, triggers, preflightItems, sessionCode]);\r\n\r\n  // Enter director mode\r\n  const handleEnterDirectorMode = useCallback(async () => {\r\n    if (status === 'lobby') {\r\n      // Start session first\r\n      await startSession();\r\n    }\r\n    enterDirectorMode();\r\n    setDirectorModeOpen(true);\r\n  }, [status, startSession, enterDirectorMode]);\r\n\r\n  // Exit director mode\r\n  const handleExitDirectorMode = useCallback(() => {\r\n    exitDirectorMode();\r\n    setDirectorModeOpen(false);\r\n  }, [exitDirectorMode]);\r\n\r\n  // Build checklist items for display\r\n  const checklistData: PreflightState = useMemo(() => {\r\n    return {\r\n      ready: canStartDirectorMode,\r\n      items: preflightItems.map((item) => ({\r\n        ...item,\r\n        status: item.status,\r\n      } as ChecklistItem)),\r\n    };\r\n  }, [canStartDirectorMode, preflightItems]);\r\n\r\n  // Tabs configuration\r\n  const tabs = [\r\n    { id: 'overview', label: '├ûversikt' },\r\n    { id: 'story', label: 'Berattelse' },\r\n    { id: 'participants', label: 'Deltagare', badge: participants.length },\r\n    { id: 'artifacts', label: 'Artefakter', badge: artifacts.length },\r\n    { id: 'triggers', label: 'Triggers', badge: triggers.filter((t) => t.status === 'armed').length || undefined },\r\n    showSignals ? { id: 'signals', label: 'Signaler' } : null,\r\n    showTimeBank ? { id: 'timebank', label: 'Tidsbank' } : null,\r\n    showEvents ? { id: 'events', label: 'H├ñndelser', badge: sessionEvents.length || undefined } : null,\r\n    { id: 'settings', label: 'Inst├ñllningar' },\r\n  ].filter(Boolean) as Array<{ id: CockpitTab; label: string; badge?: number }>;\r\n\r\n  // Map status for drawer\r\n  const drawerStatus: 'active' | 'paused' | 'ended' = \r\n    status === 'active' ? 'active' : \r\n    status === 'paused' ? 'paused' : \r\n    status === 'ended' ? 'ended' : 'active';\r\n\r\n  return (\r\n    <SessionCockpitContext.Provider value={sessionState}>\r\n      <div className={cn('flex flex-col min-h-screen bg-muted/30', className)}>\r\n        {/* Header */}\r\n        <SessionHeader\r\n          session={session}\r\n          status={status}\r\n          participantCount={participants.length}\r\n          sessionId={sessionId}\r\n          onEnterDirectorMode={handleEnterDirectorMode}\r\n          isPending={isLoading}\r\n          onOpenChat={chatEnabled ? () => setChatOpen(true) : undefined}\r\n          chatUnreadCount={chat.unreadCount}\r\n        />\r\n        \r\n        {/* Main content */}\r\n        <main className=\"flex-1 container max-w-5xl mx-auto py-6 px-4\">\r\n          {/* Error banner */}\r\n          {error && (\r\n            <Card className=\"p-4 mb-6 border-destructive bg-destructive/10\">\r\n              <div className=\"flex items-center gap-2 text-destructive\">\r\n                <ExclamationTriangleIcon className=\"h-5 w-5\" />\r\n                <span className=\"font-medium\">Fel:</span>\r\n                <span>{error}</span>\r\n              </div>\r\n            </Card>\r\n          )}\r\n          \r\n          {/* Readiness */}\r\n          {status === 'lobby' && (\r\n            <div className=\"mb-6\">\r\n              <ReadinessIndicator\r\n                preflight={checklistData}\r\n                onShowChecklist={() => setShowChecklist(true)}\r\n              />\r\n            </div>\r\n          )}\r\n          \r\n          {/* Tabs */}\r\n          <Tabs\r\n            tabs={tabs}\r\n            activeTab={activeTab}\r\n            onChange={(id) => setActiveTab(id as CockpitTab)}\r\n            variant=\"underline\"\r\n            className=\"mb-6\"\r\n          />\r\n          \r\n          <TabPanel id=\"overview\" activeTab={activeTab} className=\"space-y-6\">\r\n            <LobbyHub\r\n              state={lobbyState}\r\n              onParticipantsClick={() => setActiveTab('participants')}\r\n              onRolesClick={() => setActiveTab('participants')}\r\n              onContentClick={() => setActiveTab('story')}\r\n              onTriggersClick={() => setActiveTab('triggers')}\r\n              onSettingsClick={() => setActiveTab('settings')}\r\n              onStartSession={handleEnterDirectorMode}\r\n              isStarting={isLoading}\r\n            />\r\n\r\n            {children}\r\n          </TabPanel>\r\n\r\n          <TabPanel id=\"story\" activeTab={activeTab} className=\"space-y-6\">\r\n            <SessionStoryPanel\r\n              sessionId={sessionId}\r\n              onPreview={() => setStoryOpen(true)}\r\n            />\r\n          </TabPanel>\r\n          \r\n          <TabPanel id=\"participants\" activeTab={activeTab}>\r\n            <ParticipantsTab\r\n              participants={participants}\r\n              roles={sessionRoles}\r\n              onAssignRole={(participantId, roleId) => {\r\n                if (roleId) {\r\n                  assignRole(participantId, roleId);\r\n                }\r\n              }}\r\n              onUnassignRole={(participantId) => {\r\n                unassignRole(participantId);\r\n              }}\r\n              onSnapshotRoles={snapshotRoles}\r\n              isReadOnly={status === 'ended'}\r\n              onKickParticipant={handleKickParticipant}\r\n              onMarkNext={handleMarkNext}\r\n              isLoading={isLoading}\r\n            />\r\n          </TabPanel>\r\n          \r\n          <TabPanel id=\"artifacts\" activeTab={activeTab}>\r\n            <ArtifactsPanel sessionId={sessionId} />\r\n          </TabPanel>\r\n          \r\n          <TabPanel id=\"triggers\" activeTab={activeTab}>\r\n            <TriggersTab triggers={triggers} />\r\n          </TabPanel>\r\n\r\n          {showSignals && (\r\n            <TabPanel id=\"signals\" activeTab={activeTab}>\r\n              <SignalPanel sessionId={sessionId} disabled={isLoading || status === 'ended'} />\r\n            </TabPanel>\r\n          )}\r\n\r\n          {showTimeBank && (\r\n            <TabPanel id=\"timebank\" activeTab={activeTab}>\r\n              <TimeBankPanel sessionId={sessionId} disabled={isLoading || status === 'ended'} />\r\n            </TabPanel>\r\n          )}\r\n\r\n          {showEvents && (\r\n            <TabPanel id=\"events\" activeTab={activeTab}>\r\n              <EventFeedPanel\r\n                events={sessionEvents}\r\n                stats={eventStats}\r\n                isLoading={eventsLoading}\r\n                error={eventsError}\r\n                onRefresh={refreshEvents}\r\n              />\r\n            </TabPanel>\r\n          )}\r\n          \r\n          <TabPanel id=\"settings\" activeTab={activeTab} className=\"space-y-6\">\r\n            <Card className=\"p-6\">\r\n              <h3 className=\"font-medium mb-4\">Session settings</h3>\r\n              <p className=\"text-sm text-muted-foreground\">\r\n                Story and phase text overrides live under the Story tab. More session settings can be restored here next.\r\n              </p>\r\n              <Button variant=\"outline\" size=\"sm\" className=\"mt-4\" onClick={() => setActiveTab('story')}>\r\n                Open Story\r\n              </Button>\r\n            </Card>\r\n\r\n            <Card className=\"p-6 space-y-4\">\r\n              <div className=\"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between\">\r\n                <div>\r\n                  <h3 className=\"font-medium\">Session roles (session copy)</h3>\r\n                  <p className=\"text-sm text-muted-foreground\">\r\n                    Update role text and limits for this session without changing the game template.\r\n                  </p>\r\n                </div>\r\n                <Button\r\n                  onClick={() => void handleSaveRoleEdits()}\r\n                  disabled={rolesSaving || sessionRoles.length === 0}\r\n                >\r\n                  Save roles\r\n                </Button>\r\n              </div>\r\n\r\n              {rolesSaveError && (\r\n                <div className=\"text-sm text-destructive\">{rolesSaveError}</div>\r\n              )}\r\n\r\n              {sessionRoles.length === 0 ? (\r\n                <div className=\"space-y-2\">\r\n                  <p className=\"text-sm text-muted-foreground\">\r\n                    No roles snapshotted yet. Copy roles in the Roles tab to enable edits here.\r\n                  </p>\r\n                  <Button variant=\"outline\" size=\"sm\" onClick={() => void snapshotRoles()}>\r\n                    Copy roles\r\n                  </Button>\r\n                </div>\r\n              ) : (\r\n                <div className=\"space-y-3 max-h-[360px] overflow-y-auto pr-1\">\r\n                  {sessionRoles.map((role) => {\r\n                    const draft = roleDrafts[role.id] ?? { id: role.id };\r\n                    return (\r\n                      <div key={role.id} className=\"rounded-md border border-border/60 p-3 space-y-2 bg-muted/30\">\r\n                        <div className=\"flex flex-col gap-2 md:flex-row md:items-center md:justify-between\">\r\n                          <input\r\n                            type=\"text\"\r\n                            className=\"w-full md:w-1/2 rounded border border-input bg-background px-3 py-2 text-sm\"\r\n                            value={draft.name ?? ''}\r\n                            placeholder={role.name}\r\n                            onChange={(e) => setRoleDrafts((prev) => ({\r\n                              ...prev,\r\n                              [role.id]: { ...prev[role.id], id: role.id, name: e.target.value },\r\n                            }))}\r\n                          />\r\n                          <div className=\"flex gap-2 text-xs text-muted-foreground\">\r\n                            <label className=\"flex items-center gap-1\">\r\n                              Min\r\n                              <input\r\n                                type=\"number\"\r\n                                className=\"w-16 rounded border border-input bg-background px-2 py-1 text-sm\"\r\n                                value={draft.min_count ?? ''}\r\n                                placeholder={role.min_count?.toString() ?? ''}\r\n                                onChange={(e) => {\r\n                                  const value = e.target.value === '' ? undefined : Number(e.target.value);\r\n                                  setRoleDrafts((prev) => ({\r\n                                    ...prev,\r\n                                    [role.id]: {\r\n                                      ...prev[role.id],\r\n                                      id: role.id,\r\n                                      min_count: Number.isFinite(value as number) ? (value as number) : undefined,\r\n                                    },\r\n                                  }));\r\n                                }}\r\n                              />\r\n                            </label>\r\n                            <label className=\"flex items-center gap-1\">\r\n                              Max\r\n                              <input\r\n                                type=\"number\"\r\n                                className=\"w-16 rounded border border-input bg-background px-2 py-1 text-sm\"\r\n                                value={draft.max_count ?? ''}\r\n                                placeholder={role.max_count?.toString() ?? ''}\r\n                                onChange={(e) => {\r\n                                  const value = e.target.value === '' ? undefined : Number(e.target.value);\r\n                                  setRoleDrafts((prev) => ({\r\n                                    ...prev,\r\n                                    [role.id]: {\r\n                                      ...prev[role.id],\r\n                                      id: role.id,\r\n                                      max_count: Number.isFinite(value as number) ? (value as number) : null,\r\n                                    },\r\n                                  }));\r\n                                }}\r\n                              />\r\n                            </label>\r\n                            <label className=\"flex items-center gap-1\">\r\n                              Icon\r\n                              <input\r\n                                type=\"text\"\r\n                                className=\"w-24 rounded border border-input bg-background px-2 py-1 text-sm\"\r\n                                value={draft.icon ?? ''}\r\n                                placeholder={role.icon ?? ''}\r\n                                onChange={(e) => setRoleDrafts((prev) => ({\r\n                                  ...prev,\r\n                                  [role.id]: { ...prev[role.id], id: role.id, icon: e.target.value },\r\n                                }))}\r\n                              />\r\n                            </label>\r\n                            <label className=\"flex items-center gap-1\">\r\n                              Color\r\n                              <input\r\n                                type=\"text\"\r\n                                className=\"w-24 rounded border border-input bg-background px-2 py-1 text-sm\"\r\n                                value={draft.color ?? ''}\r\n                                placeholder={role.color ?? ''}\r\n                                onChange={(e) => setRoleDrafts((prev) => ({\r\n                                  ...prev,\r\n                                  [role.id]: { ...prev[role.id], id: role.id, color: e.target.value },\r\n                                }))}\r\n                              />\r\n                            </label>\r\n                          </div>\r\n                        </div>\r\n                        <textarea\r\n                          className=\"w-full rounded border border-input bg-background px-3 py-2 text-sm\"\r\n                          rows={2}\r\n                          value={draft.public_description ?? ''}\r\n                          placeholder={role.public_description ?? ''}\r\n                          onChange={(e) => setRoleDrafts((prev) => ({\r\n                            ...prev,\r\n                            [role.id]: { ...prev[role.id], id: role.id, public_description: e.target.value },\r\n                          }))}\r\n                        />\r\n                        <textarea\r\n                          className=\"w-full rounded border border-input bg-background px-3 py-2 text-sm\"\r\n                          rows={3}\r\n                          value={draft.private_instructions ?? ''}\r\n                          placeholder={role.private_instructions ?? ''}\r\n                          onChange={(e) => setRoleDrafts((prev) => ({\r\n                            ...prev,\r\n                            [role.id]: { ...prev[role.id], id: role.id, private_instructions: e.target.value },\r\n                          }))}\r\n                        />\r\n                      </div>\r\n                    );\r\n                  })}\r\n                </div>\r\n              )}\r\n            </Card>\r\n          </TabPanel>\r\n        </main>\r\n        \r\n        {/* Director Mode Drawer */}\r\n        <DirectorModeDrawer\r\n          open={directorModeOpen}\r\n          onClose={handleExitDirectorMode}\r\n          sessionName={displayName ?? ''}\r\n          sessionCode={sessionCode ?? ''}\r\n          status={drawerStatus}\r\n          steps={steps}\r\n          currentStepIndex={currentStepIndex}\r\n          phases={phases}\r\n          currentPhaseIndex={currentPhaseIndex}\r\n          triggers={triggers}\r\n          recentSignals={recentSignals}\r\n          signalPresets={signalPresets}\r\n          events={drawerEvents}\r\n          timeBankBalance={timeBankBalance}\r\n          timeBankPaused={timeBankPaused}\r\n          participantCount={participants.length}\r\n          onPause={pauseSession}\r\n          onResume={resumeSession}\r\n          onNextStep={nextStep}\r\n          onPreviousStep={previousStep}\r\n          onFireTrigger={fireTrigger}\r\n          onDisableAllTriggers={disableAllTriggers}\r\n          onSendSignal={sendSignal}\r\n          onExecuteSignal={handleExecuteSignal}\r\n          onTimeBankDelta={applyTimeBankDelta}\r\n        />\r\n\r\n        <SessionChatDrawer\r\n          open={chatOpen}\r\n          onClose={() => setChatOpen(false)}\r\n          role=\"host\"\r\n          messages={chat.messages}\r\n          error={chat.error}\r\n          sending={chat.sending}\r\n          onSend={chat.send}\r\n        />\r\n\r\n        <StoryViewModal\r\n          open={storyOpen}\r\n          onClose={() => setStoryOpen(false)}\r\n          steps={steps}\r\n          currentStepIndex={currentStepIndex}\r\n          title={displayName ?? 'Ber├ñttelsen'}\r\n          onNavigateToStep={(index) => void goToStep(index)}\r\n        />\r\n        \r\n        {/* Preflight Checklist Modal */}\r\n        {showChecklist && (\r\n          <div className=\"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4\">\r\n            <Card className=\"w-full max-w-lg max-h-[80vh] overflow-y-auto\">\r\n              <div className=\"p-4 border-b flex items-center justify-between\">\r\n                <h2 className=\"font-semibold\">F├Ârberedelsekontroll</h2>\r\n                <Button variant=\"ghost\" size=\"sm\" onClick={() => setShowChecklist(false)}>\r\n                  ├ù\r\n                </Button>\r\n              </div>\r\n              <PreflightChecklist\r\n                items={checklistData.items}\r\n                canStart={canStartDirectorMode}\r\n                onStart={() => {\r\n                  setShowChecklist(false);\r\n                  handleEnterDirectorMode();\r\n                }}\r\n                isStarting={isLoading}\r\n              />\r\n            </Card>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </SessionCockpitContext.Provider>\r\n  );\r\n}\r\n\r\nexport default SessionCockpit;\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\SessionHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\SessionStoryPanel.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":253,"column":58,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":255,"endColumn":13}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * SessionStoryPanel Component\n *\n * Session-local editor for story content (steps + phases).\n * Writes overrides to participant_sessions.settings.admin_overrides.\n */\n\n'use client';\n\nimport { useCallback, useEffect, useMemo, useState } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Switch } from '@/components/ui/switch';\nimport { Textarea } from '@/components/ui/textarea';\nimport { cn } from '@/lib/utils';\nimport { ArrowPathIcon, PencilSquareIcon } from '@heroicons/react/24/outline';\nimport { usePlayBroadcast } from '@/features/play/hooks/usePlayBroadcast';\nimport {\n  getSessionOverrides,\n  updateSessionOverrides,\n  type StepInfo,\n  type PhaseInfo,\n  type AdminOverrides,\n} from '@/features/play/api/session-api';\n\ntype StepDraft = {\n  title?: string;\n  description?: string;\n  durationMinutes?: number;\n  display_mode?: 'instant' | 'typewriter' | 'dramatic' | null;\n};\n\ntype PhaseDraft = {\n  name?: string;\n  description?: string;\n  duration?: number | null;\n};\n\nconst DISPLAY_MODE_LABELS: Record<'instant' | 'typewriter' | 'dramatic', string> = {\n  instant: 'Instant',\n  typewriter: 'Typewriter',\n  dramatic: 'Dramatic',\n};\n\nexport interface SessionStoryPanelProps {\n  sessionId: string;\n  className?: string;\n  onPreview?: () => void;\n}\n\nexport function SessionStoryPanel({ sessionId, className, onPreview }: SessionStoryPanelProps) {\n  const [loading, setLoading] = useState(true);\n  const [saving, setSaving] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  const { connected: broadcastConnected, broadcastCountdown, broadcastStoryOverlay } = usePlayBroadcast({\n    sessionId,\n    enabled: Boolean(sessionId),\n  });\n\n  const [steps, setSteps] = useState<StepInfo[]>([]);\n  const [phases, setPhases] = useState<PhaseInfo[]>([]);\n  const [overrides, setOverrides] = useState<AdminOverrides | null>(null);\n\n  const [stepDrafts, setStepDrafts] = useState<Record<string, StepDraft>>({});\n  const [phaseDrafts, setPhaseDrafts] = useState<Record<string, PhaseDraft>>({});\n\n  const [countdownDuration, setCountdownDuration] = useState(5);\n  const [countdownMessage, setCountdownMessage] = useState('');\n  const [countdownVariant, setCountdownVariant] = useState<'default' | 'dramatic'>('default');\n\n  const [storySource, setStorySource] = useState<'step' | 'phase' | 'custom'>('step');\n  const [storyStepId, setStoryStepId] = useState('');\n  const [storyPhaseId, setStoryPhaseId] = useState('');\n  const [storyTitle, setStoryTitle] = useState('');\n  const [storyText, setStoryText] = useState('');\n  const [storySpeed, setStorySpeed] = useState<'fast' | 'normal' | 'dramatic' | 'instant'>('dramatic');\n  const [storyTheme, setStoryTheme] = useState<'dark' | 'light' | 'dramatic'>('dramatic');\n  const [storyShowProgress, setStoryShowProgress] = useState(true);\n  const [storyAllowSkip, setStoryAllowSkip] = useState(true);\n  const [storyAllowParticipantSkip, setStoryAllowParticipantSkip] = useState(false);\n  const [storyAllowClose, setStoryAllowClose] = useState(true);\n\n  const stepOverrideMap = useMemo(\n    () => new Map((overrides?.steps ?? []).map((o) => [o.id, o])),\n    [overrides]\n  );\n  const phaseOverrideMap = useMemo(\n    () => new Map((overrides?.phases ?? []).map((o) => [o.id, o])),\n    [overrides]\n  );\n\n  const loadContent = useCallback(async () => {\n    setLoading(true);\n    setError(null);\n    try {\n      const [gameRes, overridesRes] = await Promise.all([\n        fetch(`/api/play/sessions/${sessionId}/game`, { cache: 'no-store' }),\n        getSessionOverrides(sessionId),\n      ]);\n\n      if (!gameRes.ok) {\n        throw new Error('Failed to load story content');\n      }\n\n      const data = (await gameRes.json()) as {\n        steps?: StepInfo[];\n        phases?: PhaseInfo[];\n      };\n\n      const nextSteps = data.steps ?? [];\n      const nextPhases = data.phases ?? [];\n\n      setSteps(nextSteps);\n      setPhases(nextPhases);\n      setOverrides(overridesRes ?? null);\n\n      const nextStepDrafts: Record<string, StepDraft> = {};\n      nextSteps.forEach((step) => {\n        nextStepDrafts[step.id] = {\n          title: step.title,\n          description: step.description,\n          durationMinutes: step.durationMinutes,\n          display_mode: step.display_mode ?? null,\n        };\n      });\n      setStepDrafts(nextStepDrafts);\n\n      const nextPhaseDrafts: Record<string, PhaseDraft> = {};\n      nextPhases.forEach((phase) => {\n        nextPhaseDrafts[phase.id] = {\n          name: phase.name,\n          description: phase.description ?? '',\n          duration: phase.duration ?? null,\n        };\n      });\n      setPhaseDrafts(nextPhaseDrafts);\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to load story content');\n    } finally {\n      setLoading(false);\n    }\n  }, [sessionId]);\n\n  useEffect(() => {\n    void loadContent();\n  }, [loadContent]);\n\n  useEffect(() => {\n    if (!storyStepId && steps.length > 0) {\n      setStoryStepId(steps[0].id);\n    }\n  }, [steps, storyStepId]);\n\n  useEffect(() => {\n    if (!storyPhaseId && phases.length > 0) {\n      setStoryPhaseId(phases[0].id);\n    }\n  }, [phases, storyPhaseId]);\n\n  useEffect(() => {\n    if (storySource !== 'step') return;\n    const step = steps.find((item) => item.id === storyStepId);\n    if (!step) return;\n    setStoryTitle(step.title ?? '');\n    setStoryText(step.description ?? '');\n  }, [storySource, storyStepId, steps]);\n\n  useEffect(() => {\n    if (storySource !== 'phase') return;\n    const phase = phases.find((item) => item.id === storyPhaseId);\n    if (!phase) return;\n    setStoryTitle(phase.name ?? '');\n    setStoryText(phase.description ?? '');\n  }, [storySource, storyPhaseId, phases]);\n\n  const handleSave = useCallback(async () => {\n    setSaving(true);\n    setError(null);\n    try {\n      const payload: AdminOverrides = {\n        steps: steps.map((step, index) => {\n          const draft = stepDrafts[step.id] ?? {};\n          const existing = stepOverrideMap.get(step.id);\n\n          return {\n            id: step.id,\n            title: draft.title,\n            description: draft.description,\n            durationMinutes: typeof draft.durationMinutes === 'number' ? draft.durationMinutes : undefined,\n            order: existing?.order ?? index,\n            display_mode: draft.display_mode ?? null,\n          };\n        }),\n        phases: phases.map((phase, index) => {\n          const draft = phaseDrafts[phase.id] ?? {};\n          const existing = phaseOverrideMap.get(phase.id);\n\n          return {\n            id: phase.id,\n            name: draft.name,\n            description: draft.description,\n            duration: draft.duration ?? undefined,\n            order: existing?.order ?? index,\n          };\n        }),\n        safety: overrides?.safety,\n      };\n\n      const ok = await updateSessionOverrides(sessionId, payload);\n      if (!ok) throw new Error('Failed to save story overrides');\n\n      await loadContent();\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to save story overrides');\n    } finally {\n      setSaving(false);\n    }\n  }, [\n    sessionId,\n    steps,\n    phases,\n    stepDrafts,\n    phaseDrafts,\n    overrides?.safety,\n    stepOverrideMap,\n    phaseOverrideMap,\n    loadContent,\n  ]);\n\n  const handleReset = useCallback(async () => {\n    setSaving(true);\n    setError(null);\n    try {\n      const ok = await updateSessionOverrides(sessionId, {});\n      if (!ok) throw new Error('Failed to reset overrides');\n      await loadContent();\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to reset overrides');\n    } finally {\n      setSaving(false);\n    }\n  }, [sessionId, loadContent]);\n\n  return (\n    <div className={cn('space-y-6', className)}>\n      <Card className=\"p-4\">\n        <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n          <div>\n            <h3 className=\"text-base font-semibold text-foreground\">Story content</h3>\n            <p className=\"text-sm text-muted-foreground\">\n              Edit steps and phases for this session only. Changes do not affect the base game.\n            </p>\n          </div>\n          <div className=\"flex flex-wrap gap-2\">\n            {onPreview && (\n              <Button variant=\"outline\" size=\"sm\" onClick={onPreview} disabled={loading || saving}>\n                Preview story\n              </Button>\n            )}\n            <Button variant=\"outline\" size=\"sm\" onClick={() => void loadContent()} disabled={loading || saving}>\n              <ArrowPathIcon className={cn('h-4 w-4', loading ? 'animate-spin' : '')} />\n            </Button>\n            <Button variant=\"outline\" size=\"sm\" onClick={() => void handleReset()} disabled={loading || saving}>\n              Reset overrides\n            </Button>\n            <Button size=\"sm\" onClick={() => void handleSave()} disabled={loading || saving}>\n              Save changes\n            </Button>\n          </div>\n        </div>\n      </Card>\n\n      {error && (\n        <Card className=\"p-4 border-destructive bg-destructive/10 text-destructive\">\n          {error}\n        </Card>\n      )}\n\n      <Card className=\"p-4 space-y-3\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h4 className=\"text-sm font-semibold text-foreground\">Countdown overlay</h4>\n            <p className=\"text-xs text-muted-foreground\">Broadcast a participant countdown from the lobby.</p>\n          </div>\n          <span className=\"text-xs text-muted-foreground\">\n            {broadcastConnected ? 'Live' : 'Offline'}\n          </span>\n        </div>\n        <div className=\"grid gap-3 md:grid-cols-3\">\n          <label className=\"text-xs text-muted-foreground space-y-1\">\n            Duration (sec)\n            <Input\n              type=\"number\"\n              value={countdownDuration}\n              onChange={(e) => {\n                const value = Number(e.target.value);\n                setCountdownDuration(Number.isFinite(value) ? value : 5);\n              }}\n              min={1}\n            />\n          </label>\n          <label className=\"text-xs text-muted-foreground space-y-1 md:col-span-2\">\n            Message (optional)\n            <Input\n              value={countdownMessage}\n              onChange={(e) => setCountdownMessage(e.target.value)}\n              placeholder=\"Next moment starts in...\"\n            />\n          </label>\n        </div>\n        <div className=\"flex flex-wrap items-center gap-3 text-xs text-muted-foreground\">\n          <label className=\"flex items-center gap-2\">\n            Variant\n            <select\n              className=\"h-9 rounded-md border border-input bg-background px-3 text-sm text-foreground\"\n              value={countdownVariant}\n              onChange={(e) => setCountdownVariant(e.target.value as 'default' | 'dramatic')}\n            >\n              <option value=\"default\">Default</option>\n              <option value=\"dramatic\">Dramatic</option>\n            </select>\n          </label>\n          <div className=\"ml-auto flex gap-2\">\n            <Button\n              size=\"sm\"\n              onClick={() =>\n                void broadcastCountdown(\n                  'show',\n                  countdownDuration,\n                  countdownMessage.trim() ? countdownMessage.trim() : undefined,\n                  countdownVariant\n                )\n              }\n              disabled={!broadcastConnected}\n            >\n              Show\n            </Button>\n            <Button\n              size=\"sm\"\n              variant=\"outline\"\n              onClick={() => void broadcastCountdown('skip', 0)}\n              disabled={!broadcastConnected}\n            >\n              Skip\n            </Button>\n          </div>\n        </div>\n      </Card>\n\n      <Card className=\"p-4 space-y-3\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h4 className=\"text-sm font-semibold text-foreground\">Story overlay</h4>\n            <p className=\"text-xs text-muted-foreground\">Send a full-screen story overlay to participants.</p>\n          </div>\n          <span className=\"text-xs text-muted-foreground\">\n            {broadcastConnected ? 'Live' : 'Offline'}\n          </span>\n        </div>\n\n        <div className=\"grid gap-3 md:grid-cols-3\">\n          <label className=\"text-xs text-muted-foreground space-y-1\">\n            Source\n            <select\n              className=\"h-9 w-full rounded-md border border-input bg-background px-3 text-sm text-foreground\"\n              value={storySource}\n              onChange={(e) => setStorySource(e.target.value as 'step' | 'phase' | 'custom')}\n            >\n              <option value=\"step\">Step</option>\n              <option value=\"phase\">Phase</option>\n              <option value=\"custom\">Custom</option>\n            </select>\n          </label>\n\n          {storySource === 'step' && (\n            <label className=\"text-xs text-muted-foreground space-y-1 md:col-span-2\">\n              Step\n              <select\n                className=\"h-9 w-full rounded-md border border-input bg-background px-3 text-sm text-foreground\"\n                value={storyStepId}\n                onChange={(e) => setStoryStepId(e.target.value)}\n              >\n                {steps.map((step, index) => (\n                  <option key={step.id} value={step.id}>\n                    {index + 1}. {step.title}\n                  </option>\n                ))}\n              </select>\n            </label>\n          )}\n\n          {storySource === 'phase' && (\n            <label className=\"text-xs text-muted-foreground space-y-1 md:col-span-2\">\n              Phase\n              <select\n                className=\"h-9 w-full rounded-md border border-input bg-background px-3 text-sm text-foreground\"\n                value={storyPhaseId}\n                onChange={(e) => setStoryPhaseId(e.target.value)}\n              >\n                {phases.map((phase, index) => (\n                  <option key={phase.id} value={phase.id}>\n                    {index + 1}. {phase.name}\n                  </option>\n                ))}\n              </select>\n            </label>\n          )}\n        </div>\n\n        <label className=\"text-xs text-muted-foreground space-y-1\">\n          Title\n          <Input\n            value={storyTitle}\n            onChange={(e) => setStoryTitle(e.target.value)}\n            placeholder=\"Optional title\"\n          />\n        </label>\n\n        <label className=\"text-xs text-muted-foreground space-y-1\">\n          Text\n          <Textarea\n            value={storyText}\n            onChange={(e) => setStoryText(e.target.value)}\n            placeholder=\"Story text to display\"\n            rows={4}\n          />\n        </label>\n\n        <div className=\"flex flex-wrap items-center gap-4 text-xs text-muted-foreground\">\n          <label className=\"flex items-center gap-2\">\n            Speed\n            <select\n              className=\"h-9 rounded-md border border-input bg-background px-3 text-sm text-foreground\"\n              value={storySpeed}\n              onChange={(e) =>\n                setStorySpeed(e.target.value as 'fast' | 'normal' | 'dramatic' | 'instant')\n              }\n            >\n              <option value=\"instant\">Instant</option>\n              <option value=\"fast\">Fast</option>\n              <option value=\"normal\">Normal</option>\n              <option value=\"dramatic\">Dramatic</option>\n            </select>\n          </label>\n          <label className=\"flex items-center gap-2\">\n            Theme\n            <select\n              className=\"h-9 rounded-md border border-input bg-background px-3 text-sm text-foreground\"\n              value={storyTheme}\n              onChange={(e) => setStoryTheme(e.target.value as 'dark' | 'light' | 'dramatic')}\n            >\n              <option value=\"dark\">Dark</option>\n              <option value=\"light\">Light</option>\n              <option value=\"dramatic\">Dramatic</option>\n            </select>\n          </label>\n          <div className=\"flex items-center gap-2\">\n            <Switch\n              id=\"story-progress\"\n              checked={storyShowProgress}\n              onCheckedChange={(value) => setStoryShowProgress(Boolean(value))}\n            />\n            <Label htmlFor=\"story-progress\" className=\"text-xs\">\n              Show progress\n            </Label>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Switch\n              id=\"story-skip\"\n              checked={storyAllowSkip}\n              onCheckedChange={(value) => setStoryAllowSkip(Boolean(value))}\n            />\n            <Label htmlFor=\"story-skip\" className=\"text-xs\">\n              Allow skip\n            </Label>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Switch\n              id=\"story-participant-skip\"\n              checked={storyAllowParticipantSkip}\n              onCheckedChange={(value) => setStoryAllowParticipantSkip(Boolean(value))}\n            />\n            <Label htmlFor=\"story-participant-skip\" className=\"text-xs\">\n              Participant skip\n            </Label>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Switch\n              id=\"story-close\"\n              checked={storyAllowClose}\n              onCheckedChange={(value) => setStoryAllowClose(Boolean(value))}\n            />\n            <Label htmlFor=\"story-close\" className=\"text-xs\">\n              Allow close\n            </Label>\n          </div>\n\n          <div className=\"ml-auto flex gap-2\">\n            <Button\n              size=\"sm\"\n              onClick={() =>\n                void broadcastStoryOverlay({\n                  action: 'show',\n                  text: storyText.trim() ? storyText.trim() : undefined,\n                  title: storyTitle.trim() ? storyTitle.trim() : undefined,\n                  speed: storySpeed,\n                  theme: storyTheme,\n                  showProgress: storyShowProgress,\n                  allowSkip: storyAllowSkip,\n                  allowParticipantSkip: storyAllowParticipantSkip,\n                  allowClose: storyAllowClose,\n                })\n              }\n              disabled={!broadcastConnected || !storyText.trim()}\n            >\n              Show\n            </Button>\n            <Button\n              size=\"sm\"\n              variant=\"outline\"\n              onClick={() => void broadcastStoryOverlay({ action: 'close' })}\n              disabled={!broadcastConnected}\n            >\n              Close\n            </Button>\n          </div>\n        </div>\n      </Card>\n\n      <div className=\"space-y-3\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h4 className=\"text-sm font-semibold text-foreground\">Phases</h4>\n            <p className=\"text-xs text-muted-foreground\">Name, description, duration</p>\n          </div>\n        </div>\n        <div className=\"space-y-3\">\n          {phases.length === 0 && (\n            <Card className=\"p-6 text-sm text-muted-foreground\">No phases defined.</Card>\n          )}\n          {phases.map((phase, index) => {\n            const draft = phaseDrafts[phase.id] ?? {};\n            return (\n              <Card key={phase.id} className=\"p-4 space-y-3\">\n                <div className=\"flex items-center gap-2 text-sm font-medium text-foreground\">\n                  <PencilSquareIcon className=\"h-4 w-4 text-muted-foreground\" />\n                  <span>Phase {index + 1}</span>\n                </div>\n                <Input\n                  value={draft.name ?? ''}\n                  onChange={(e) =>\n                    setPhaseDrafts((prev) => ({\n                      ...prev,\n                      [phase.id]: { ...prev[phase.id], name: e.target.value },\n                    }))\n                  }\n                  placeholder={phase.name}\n                />\n                <Textarea\n                  value={draft.description ?? ''}\n                  onChange={(e) =>\n                    setPhaseDrafts((prev) => ({\n                      ...prev,\n                      [phase.id]: { ...prev[phase.id], description: e.target.value },\n                    }))\n                  }\n                  placeholder={phase.description ?? ''}\n                  rows={2}\n                />\n                <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                  <span>Duration (sec)</span>\n                  <Input\n                    type=\"number\"\n                    className=\"w-24\"\n                    value={draft.duration ?? ''}\n                    placeholder={phase.duration?.toString() ?? ''}\n                    onChange={(e) => {\n                      const value = e.target.value === '' ? null : Number(e.target.value);\n                      setPhaseDrafts((prev) => ({\n                        ...prev,\n                        [phase.id]: {\n                          ...prev[phase.id],\n                          duration: value !== null && Number.isFinite(value) ? value : null,\n                        },\n                      }));\n                    }}\n                  />\n                </div>\n              </Card>\n            );\n          })}\n        </div>\n      </div>\n\n      <div className=\"space-y-3\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h4 className=\"text-sm font-semibold text-foreground\">Steps</h4>\n            <p className=\"text-xs text-muted-foreground\">Title, description, duration, display mode</p>\n          </div>\n        </div>\n        <div className=\"space-y-3\">\n          {steps.length === 0 && (\n            <Card className=\"p-6 text-sm text-muted-foreground\">No steps defined.</Card>\n          )}\n          {steps.map((step, index) => {\n            const draft = stepDrafts[step.id] ?? {};\n            const displayMode = draft.display_mode ?? step.display_mode ?? 'instant';\n            return (\n              <Card key={step.id} className=\"p-4 space-y-3\">\n                <div className=\"flex items-center gap-2 text-sm font-medium text-foreground\">\n                  <PencilSquareIcon className=\"h-4 w-4 text-muted-foreground\" />\n                  <span>Step {index + 1}</span>\n                </div>\n                <Input\n                  value={draft.title ?? ''}\n                  onChange={(e) =>\n                    setStepDrafts((prev) => ({\n                      ...prev,\n                      [step.id]: { ...prev[step.id], title: e.target.value },\n                    }))\n                  }\n                  placeholder={step.title}\n                />\n                <Textarea\n                  value={draft.description ?? ''}\n                  onChange={(e) =>\n                    setStepDrafts((prev) => ({\n                      ...prev,\n                      [step.id]: { ...prev[step.id], description: e.target.value },\n                    }))\n                  }\n                  placeholder={step.description}\n                  rows={3}\n                />\n                <div className=\"flex flex-wrap items-center gap-4 text-xs text-muted-foreground\">\n                  <label className=\"flex items-center gap-2\">\n                    Duration (min)\n                    <Input\n                      type=\"number\"\n                      className=\"w-20\"\n                      value={draft.durationMinutes ?? ''}\n                      placeholder={step.durationMinutes?.toString() ?? ''}\n                      onChange={(e) => {\n                        const value = e.target.value === '' ? undefined : Number(e.target.value);\n                        setStepDrafts((prev) => ({\n                          ...prev,\n                          [step.id]: {\n                            ...prev[step.id],\n                            durationMinutes: Number.isFinite(value as number) ? (value as number) : undefined,\n                          },\n                        }));\n                      }}\n                    />\n                  </label>\n                  <label className=\"flex items-center gap-2\">\n                    Display\n                    <select\n                      className=\"h-9 rounded-md border border-input bg-background px-3 text-sm text-foreground\"\n                      value={displayMode ?? 'instant'}\n                      onChange={(e) =>\n                        setStepDrafts((prev) => ({\n                          ...prev,\n                          [step.id]: {\n                            ...prev[step.id],\n                            display_mode: e.target.value as StepDraft['display_mode'],\n                          },\n                        }))\n                      }\n                    >\n                      {Object.entries(DISPLAY_MODE_LABELS).map(([value, label]) => (\n                        <option key={value} value={value}>\n                          {label}\n                        </option>\n                      ))}\n                    </select>\n                  </label>\n                </div>\n              </Card>\n            );\n          })}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default SessionStoryPanel;\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\SessionTimeline.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":384,"column":55,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":385,"endColumn":9},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":426,"column":42,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":426,"endColumn":55},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":503,"column":71,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":504,"endColumn":13},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":545,"column":45,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":547,"endColumn":9},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":570,"column":73,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":572,"endColumn":9}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * SessionTimeline Component\r\n * \r\n * Visual timeline for session events with zoom, filtering, and navigation.\r\n * Shows events grouped by step with markers for different event types.\r\n * \r\n * Backlog B.3: Session timeline visualization\r\n */\r\n\r\n'use client';\r\n\r\nimport React, { useRef, useState } from 'react';\r\nimport {\r\n  ClockIcon,\r\n  MagnifyingGlassPlusIcon,\r\n  MagnifyingGlassMinusIcon,\r\n  ArrowPathIcon,\r\n  ExclamationCircleIcon,\r\n  CheckCircleIcon,\r\n  ExclamationTriangleIcon,\r\n  InformationCircleIcon,\r\n  SignalIcon,\r\n} from '@heroicons/react/24/outline';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Select } from '@/components/ui/select';\r\nimport { Tooltip } from '@/components/ui/tooltip';\r\nimport { ScrollArea } from '@/components/ui/scroll-area';\r\nimport type { SessionEventType } from '@/types/session-event';\r\nimport type {\r\n  UseSessionTimelineReturn,\r\n  TimelineMarker,\r\n  TimelineSegment,\r\n} from '../hooks/useSessionTimeline';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface SessionTimelineProps {\r\n  /** Timeline data from useSessionTimeline */\r\n  timeline: UseSessionTimelineReturn;\r\n  /** Additional CSS classes */\r\n  className?: string;\r\n  /** Compact mode for limited space */\r\n  compact?: boolean;\r\n  /** Timeline height in pixels */\r\n  height?: number;\r\n  /** Callback when marker is clicked */\r\n  onMarkerClick?: (marker: TimelineMarker) => void;\r\n  /** Callback when segment is clicked */\r\n  onSegmentClick?: (segment: TimelineSegment) => void;\r\n  /** Show stats panel */\r\n  showStats?: boolean;\r\n}\r\n\r\n// =============================================================================\r\n// Constants\r\n// =============================================================================\r\n\r\nconst ZOOM_LEVELS = [0.25, 0.5, 0.75, 1, 1.5, 2, 3, 4];\r\n\r\nconst SEVERITY_COLORS: Record<TimelineMarker['severity'], string> = {\r\n  info: 'bg-blue-500',\r\n  success: 'bg-green-500',\r\n  warning: 'bg-yellow-500',\r\n  error: 'bg-red-500',\r\n};\r\n\r\nconst SEVERITY_ICONS: Record<TimelineMarker['severity'], React.ReactNode> = {\r\n  info: <InformationCircleIcon className=\"h-3 w-3 text-blue-500\" />,\r\n  success: <CheckCircleIcon className=\"h-3 w-3 text-green-500\" />,\r\n  warning: <ExclamationTriangleIcon className=\"h-3 w-3 text-yellow-500\" />,\r\n  error: <ExclamationCircleIcon className=\"h-3 w-3 text-red-500\" />,\r\n};\r\n\r\n// Event type groups for filtering - using valid SessionEventType values\r\nconst EVENT_TYPE_GROUPS: Record<string, SessionEventType[]> = {\r\n  'Triggers': ['trigger_armed', 'trigger_fired', 'trigger_disabled', 'trigger_error'],\r\n  'Artefakter': ['artifact_revealed', 'artifact_hidden', 'artifact_solved', 'artifact_failed', 'artifact_state_changed'],\r\n  'Navigation': ['step_started', 'step_completed', 'phase_started', 'phase_completed'],\r\n  'TimeBank': ['timebank_started', 'timebank_paused', 'timebank_expired', 'timebank_delta_applied'],\r\n  'Signaler': ['signal_sent', 'signal_received'],\r\n  'Deltagare': ['participant_joined', 'participant_left', 'participant_action'],\r\n  'Spelledare': ['host_action', 'host_hint_sent', 'host_message_sent'],\r\n};\r\n\r\n// =============================================================================\r\n// Helpers\r\n// =============================================================================\r\n\r\nfunction formatTime(date: Date): string {\r\n  return date.toLocaleTimeString('sv-SE', { \r\n    hour: '2-digit', \r\n    minute: '2-digit',\r\n    second: '2-digit',\r\n  });\r\n}\r\n\r\nfunction formatDuration(ms: number): string {\r\n  if (ms < 1000) return `${ms}ms`;\r\n  if (ms < 60000) return `${Math.round(ms / 1000)}s`;\r\n  const mins = Math.floor(ms / 60000);\r\n  const secs = Math.round((ms % 60000) / 1000);\r\n  return secs > 0 ? `${mins}m ${secs}s` : `${mins}m`;\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: TimelineMarkerDot\r\n// =============================================================================\r\n\r\ninterface TimelineMarkerDotProps {\r\n  marker: TimelineMarker;\r\n  onClick?: () => void;\r\n}\r\n\r\nfunction TimelineMarkerDot({ marker, onClick }: TimelineMarkerDotProps) {\r\n  return (\r\n    <Tooltip\r\n      content={\r\n        <div className=\"space-y-1\">\r\n          <div className=\"font-medium flex items-center gap-1\">\r\n            {SEVERITY_ICONS[marker.severity]}\r\n            {marker.label}\r\n          </div>\r\n          <div className=\"text-xs text-muted-foreground\">\r\n            {formatTime(marker.timestamp)}\r\n          </div>\r\n          {marker.description && (\r\n            <div className=\"text-xs\">{marker.description}</div>\r\n          )}\r\n        </div>\r\n      }\r\n    >\r\n      <button\r\n        onClick={onClick}\r\n        className={`\r\n          w-3 h-3 rounded-full transition-transform hover:scale-150 cursor-pointer\r\n          ${SEVERITY_COLORS[marker.severity]}\r\n        `}\r\n      />\r\n    </Tooltip>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: SegmentBar\r\n// =============================================================================\r\n\r\ninterface SegmentBarProps {\r\n  segment: TimelineSegment;\r\n  totalDuration: number;\r\n  zoom: number;\r\n  onClick?: () => void;\r\n  onMarkerClick?: (marker: TimelineMarker) => void;\r\n}\r\n\r\nfunction SegmentBar({\r\n  segment,\r\n  totalDuration,\r\n  zoom,\r\n  onClick,\r\n  onMarkerClick,\r\n}: SegmentBarProps) {\r\n  const widthPercent = (segment.duration / totalDuration) * 100 * zoom;\r\n  \r\n  // Distribute markers across segment width\r\n  const markerPositions = segment.markers.map((marker) => {\r\n    const offset = marker.timestamp.getTime() - segment.startTime.getTime();\r\n    return {\r\n      marker,\r\n      position: segment.duration > 0 ? (offset / segment.duration) * 100 : 0,\r\n    };\r\n  });\r\n\r\n  return (\r\n    <div\r\n      className=\"relative flex-shrink-0 group\"\r\n      style={{ width: `${Math.max(widthPercent, 3)}%`, minWidth: '60px' }}\r\n    >\r\n      {/* Segment background */}\r\n      <button\r\n        onClick={onClick}\r\n        className={`\r\n          w-full h-8 rounded-md transition-colors cursor-pointer\r\n          ${segment.isCurrent\r\n            ? 'bg-primary/20 border-2 border-primary'\r\n            : 'bg-muted/50 hover:bg-muted border border-border'\r\n          }\r\n        `}\r\n      >\r\n        {/* Segment label */}\r\n        <div className=\"absolute inset-x-1 top-1 text-xs font-medium truncate\">\r\n          Steg {segment.stepIndex + 1}\r\n        </div>\r\n        \r\n        {/* Duration */}\r\n        <div className=\"absolute inset-x-1 bottom-0.5 text-[10px] text-muted-foreground truncate\">\r\n          {formatDuration(segment.duration)}\r\n        </div>\r\n      </button>\r\n\r\n      {/* Markers track */}\r\n      <div className=\"relative h-4 mt-1\">\r\n        {markerPositions.map(({ marker, position }) => (\r\n          <div\r\n            key={marker.id}\r\n            className=\"absolute top-0.5 -translate-x-1/2\"\r\n            style={{ left: `${position}%` }}\r\n          >\r\n            <TimelineMarkerDot\r\n              marker={marker}\r\n              onClick={() => onMarkerClick?.(marker)}\r\n            />\r\n          </div>\r\n        ))}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: FilterPanel\r\n// =============================================================================\r\n\r\ninterface FilterPanelProps {\r\n  selectedGroup: string;\r\n  onGroupChange: (group: string) => void;\r\n}\r\n\r\nfunction FilterPanel({ selectedGroup, onGroupChange }: FilterPanelProps) {\r\n  const options = [\r\n    { value: 'all', label: 'Alla h├ñndelser' },\r\n    ...Object.keys(EVENT_TYPE_GROUPS).map((group) => ({\r\n      value: group,\r\n      label: group,\r\n    })),\r\n  ];\r\n\r\n  return (\r\n    <Select\r\n      options={options}\r\n      value={selectedGroup}\r\n      onChange={(e) => onGroupChange(e.target.value)}\r\n      className=\"w-[140px] h-8 text-sm\"\r\n    />\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: ZoomControls\r\n// =============================================================================\r\n\r\ninterface ZoomControlsProps {\r\n  zoom: number;\r\n  onZoomChange: (zoom: number) => void;\r\n}\r\n\r\nfunction ZoomControls({ zoom, onZoomChange }: ZoomControlsProps) {\r\n  const zoomIn = () => {\r\n    const idx = ZOOM_LEVELS.indexOf(zoom);\r\n    if (idx < ZOOM_LEVELS.length - 1) {\r\n      onZoomChange(ZOOM_LEVELS[idx + 1]);\r\n    }\r\n  };\r\n\r\n  const zoomOut = () => {\r\n    const idx = ZOOM_LEVELS.indexOf(zoom);\r\n    if (idx > 0) {\r\n      onZoomChange(ZOOM_LEVELS[idx - 1]);\r\n    }\r\n  };\r\n\r\n  const reset = () => onZoomChange(1);\r\n\r\n  return (\r\n    <div className=\"flex items-center gap-1\">\r\n      <Button\r\n        variant=\"ghost\"\r\n        size=\"sm\"\r\n        className=\"h-7 w-7 p-0\"\r\n        onClick={zoomOut}\r\n        disabled={zoom === ZOOM_LEVELS[0]}\r\n      >\r\n        <MagnifyingGlassMinusIcon className=\"h-4 w-4\" />\r\n      </Button>\r\n      <span className=\"text-xs text-muted-foreground w-10 text-center\">\r\n        {Math.round(zoom * 100)}%\r\n      </span>\r\n      <Button\r\n        variant=\"ghost\"\r\n        size=\"sm\"\r\n        className=\"h-7 w-7 p-0\"\r\n        onClick={zoomIn}\r\n        disabled={zoom === ZOOM_LEVELS[ZOOM_LEVELS.length - 1]}\r\n      >\r\n        <MagnifyingGlassPlusIcon className=\"h-4 w-4\" />\r\n      </Button>\r\n      <Button\r\n        variant=\"ghost\"\r\n        size=\"sm\"\r\n        className=\"h-7 w-7 p-0\"\r\n        onClick={reset}\r\n      >\r\n        <ArrowPathIcon className=\"h-3 w-3\" />\r\n      </Button>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: StatsPanel\r\n// =============================================================================\r\n\r\ninterface StatsPanelProps {\r\n  stats: UseSessionTimelineReturn['stats'];\r\n}\r\n\r\nfunction StatsPanel({ stats }: StatsPanelProps) {\r\n  return (\r\n    <div className=\"grid grid-cols-2 md:grid-cols-4 gap-3 p-3 bg-muted/30 rounded-lg\">\r\n      <div className=\"space-y-1\">\r\n        <div className=\"text-xs text-muted-foreground\">Total tid</div>\r\n        <div className=\"font-semibold\">{formatDuration(stats.totalDuration)}</div>\r\n      </div>\r\n      <div className=\"space-y-1\">\r\n        <div className=\"text-xs text-muted-foreground\">Snitt/steg</div>\r\n        <div className=\"font-semibold\">{formatDuration(stats.avgStepDuration)}</div>\r\n      </div>\r\n      <div className=\"space-y-1\">\r\n        <div className=\"text-xs text-muted-foreground\">Mest aktivt steg</div>\r\n        <div className=\"font-semibold\">Steg {stats.mostActiveStep + 1}</div>\r\n      </div>\r\n      <div className=\"space-y-1\">\r\n        <div className=\"text-xs text-muted-foreground flex items-center gap-1\">\r\n          <ExclamationCircleIcon className=\"h-3 w-3 text-red-500\" />\r\n          Fel\r\n        </div>\r\n        <div className={`font-semibold ${stats.errorCount > 0 ? 'text-red-500' : ''}`}>\r\n          {stats.errorCount}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: MarkerList\r\n// =============================================================================\r\n\r\ninterface MarkerListProps {\r\n  markers: TimelineMarker[];\r\n  onMarkerClick?: (marker: TimelineMarker) => void;\r\n  maxItems?: number;\r\n}\r\n\r\nfunction MarkerList({ markers, onMarkerClick, maxItems = 50 }: MarkerListProps) {\r\n  const displayMarkers = markers.slice(-maxItems);\r\n\r\n  return (\r\n    <div className=\"space-y-1\">\r\n      {displayMarkers.map((marker) => (\r\n        <button\r\n          key={marker.id}\r\n          onClick={() => onMarkerClick?.(marker)}\r\n          className={`\r\n            w-full flex items-center gap-2 p-2 rounded-md text-left text-sm\r\n            hover:bg-muted/50 transition-colors\r\n          `}\r\n        >\r\n          <div className={`w-2 h-2 rounded-full ${SEVERITY_COLORS[marker.severity]}`} />\r\n          <span className=\"flex-1 truncate\">{marker.label}</span>\r\n          <span className=\"text-xs text-muted-foreground\">\r\n            {formatTime(marker.timestamp)}\r\n          </span>\r\n          <Badge variant=\"outline\" className=\"text-xs\">\r\n            Steg {marker.stepIndex + 1}\r\n          </Badge>\r\n        </button>\r\n      ))}\r\n      {markers.length > maxItems && (\r\n        <div className=\"text-xs text-muted-foreground text-center py-1\">\r\n          Visar senaste {maxItems} av {markers.length} h├ñndelser\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function SessionTimeline({\r\n  timeline,\r\n  className,\r\n  compact = false,\r\n  height = 160,\r\n  onMarkerClick,\r\n  onSegmentClick,\r\n  showStats = true,\r\n}: SessionTimelineProps) {\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n  const [filterGroup, setFilterGroup] = useState('all');\r\n  const [showList, setShowList] = useState(false);\r\n\r\n  // Filter markers by group\r\n  const filteredMarkers = filterGroup === 'all'\r\n    ? timeline.filteredMarkers\r\n    : timeline.filteredMarkers.filter((m) =>\r\n        EVENT_TYPE_GROUPS[filterGroup]?.includes(m.type)\r\n      );\r\n\r\n  return (\r\n    <Card className={className}>\r\n      <CardHeader className={compact ? 'pb-2' : 'pb-3'}>\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <CardTitle className=\"flex items-center gap-2 text-base\">\r\n              <SignalIcon className=\"h-5 w-5\" />\r\n              Session Timeline\r\n            </CardTitle>\r\n            {!compact && (\r\n              <CardDescription>\r\n                {timeline.markers.length} h├ñndelser ┬À {timeline.segments.length} steg\r\n              </CardDescription>\r\n            )}\r\n          </div>\r\n          <div className=\"flex items-center gap-2\">\r\n            <FilterPanel selectedGroup={filterGroup} onGroupChange={setFilterGroup} />\r\n            <ZoomControls zoom={timeline.zoom} onZoomChange={timeline.setZoom} />\r\n            <Button\r\n              variant={showList ? 'default' : 'outline'}\r\n              size=\"sm\"\r\n              onClick={() => setShowList(!showList)}\r\n            >\r\n              Lista\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </CardHeader>\r\n\r\n      <CardContent className=\"space-y-3\">\r\n        {/* Stats panel */}\r\n        {showStats && !compact && <StatsPanel stats={timeline.stats} />}\r\n\r\n        {/* Timeline visualization */}\r\n        <div \r\n          ref={containerRef}\r\n          className=\"relative border rounded-lg p-2 bg-background\"\r\n          style={{ height: compact ? height * 0.6 : height }}\r\n        >\r\n          {/* Time axis labels */}\r\n          <div className=\"absolute top-0 left-0 right-0 h-5 flex items-center px-2 text-[10px] text-muted-foreground border-b\">\r\n            <span>Start</span>\r\n            <span className=\"flex-1 text-center\">\r\n              {formatDuration(timeline.stats.totalDuration)}\r\n            </span>\r\n            <span>Nu</span>\r\n          </div>\r\n\r\n          {/* Segments container */}\r\n          <ScrollArea maxHeight={`${compact ? height * 0.4 : height - 40}px`} className=\"pt-5\">\r\n            <div className=\"flex gap-1 p-1 min-w-full\">\r\n              {timeline.segments.map((segment) => (\r\n                <SegmentBar\r\n                  key={segment.id}\r\n                  segment={segment}\r\n                  totalDuration={timeline.stats.totalDuration}\r\n                  zoom={timeline.zoom}\r\n                  onClick={() => onSegmentClick?.(segment)}\r\n                  onMarkerClick={onMarkerClick}\r\n                />\r\n              ))}\r\n            </div>\r\n          </ScrollArea>\r\n\r\n          {/* Live indicator */}\r\n          <div className=\"absolute top-6 right-2 flex items-center gap-1\">\r\n            <SignalIcon className=\"h-3 w-3 text-red-500 animate-pulse\" />\r\n            <span className=\"text-xs text-red-500\">LIVE</span>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Event list view */}\r\n        {showList && (\r\n          <div className=\"border rounded-lg\">\r\n            <ScrollArea maxHeight=\"200px\">\r\n              <MarkerList\r\n                markers={filteredMarkers}\r\n                onMarkerClick={onMarkerClick}\r\n              />\r\n            </ScrollArea>\r\n          </div>\r\n        )}\r\n\r\n        {/* Quick stats footer */}\r\n        <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <span className=\"flex items-center gap-1\">\r\n              <div className=\"w-2 h-2 rounded-full bg-green-500\" />\r\n              {timeline.stats.eventCounts.get('artifact_solved') ?? 0} l├Âsta\r\n            </span>\r\n            <span className=\"flex items-center gap-1\">\r\n              <div className=\"w-2 h-2 rounded-full bg-yellow-500\" />\r\n              {timeline.stats.eventCounts.get('trigger_fired') ?? 0} triggers\r\n            </span>\r\n            <span className=\"flex items-center gap-1\">\r\n              <div className=\"w-2 h-2 rounded-full bg-red-500\" />\r\n              {timeline.stats.errorCount} fel\r\n            </span>\r\n          </div>\r\n          <div className=\"flex items-center gap-1\">\r\n            <ClockIcon className=\"h-3 w-3\" />\r\n            Uppdateras live\r\n          </div>\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Compact Timeline (for sidebar)\r\n// =============================================================================\r\n\r\nexport interface CompactTimelineProps {\r\n  timeline: UseSessionTimelineReturn;\r\n  onMarkerClick?: (marker: TimelineMarker) => void;\r\n  className?: string;\r\n}\r\n\r\nexport function CompactTimeline({\r\n  timeline,\r\n  onMarkerClick,\r\n  className,\r\n}: CompactTimelineProps) {\r\n  const recentMarkers = timeline.markers.slice(-10).reverse();\r\n\r\n  return (\r\n    <div className={`space-y-2 ${className}`}>\r\n      <div className=\"flex items-center justify-between\">\r\n        <span className=\"text-sm font-medium flex items-center gap-1\">\r\n          <SignalIcon className=\"h-4 w-4\" />\r\n          Senaste h├ñndelser\r\n        </span>\r\n        <Badge variant=\"outline\" className=\"text-xs\">\r\n          {timeline.markers.length}\r\n        </Badge>\r\n      </div>\r\n\r\n      <div className=\"space-y-1\">\r\n        {recentMarkers.map((marker) => (\r\n          <button\r\n            key={marker.id}\r\n            onClick={() => onMarkerClick?.(marker)}\r\n            className=\"w-full flex items-center gap-2 p-1.5 rounded text-xs hover:bg-muted/50 text-left\"\r\n          >\r\n            <div className={`w-1.5 h-1.5 rounded-full flex-shrink-0 ${SEVERITY_COLORS[marker.severity]}`} />\r\n            <span className=\"truncate flex-1\">{marker.label}</span>\r\n            <span className=\"text-muted-foreground flex-shrink-0\">\r\n              {formatTime(marker.timestamp)}\r\n            </span>\r\n          </button>\r\n        ))}\r\n      </div>\r\n\r\n      {timeline.markers.length === 0 && (\r\n        <div className=\"text-xs text-muted-foreground text-center py-2\">\r\n          Inga h├ñndelser ├ñn\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\ShortcutHelpPanel.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":214,"column":30,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":216,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":233,"column":92,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":234,"endColumn":11}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * ShortcutHelpPanel Component\r\n * \r\n * Modal/panel showing all available keyboard shortcuts for Director Mode.\r\n * Organized by category for easy reference.\r\n * \r\n * Backlog B.2: Keyboard shortcuts for Director Mode\r\n */\r\n\r\n'use client';\r\n\r\nimport React from 'react';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { ScrollArea } from '@/components/ui/scroll-area';\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from '@/components/ui/dialog';\r\nimport {\r\n  CommandLineIcon,\r\n  ArrowRightIcon,\r\n  PlayIcon,\r\n  BoltIcon,\r\n  RadioIcon,\r\n  EyeIcon,\r\n  CogIcon,\r\n} from '@heroicons/react/24/outline';\r\nimport type {\r\n  DirectorShortcut,\r\n  ShortcutCategory,\r\n} from '@/features/play/hooks/useDirectorShortcuts';\r\nimport { SHORTCUT_CATEGORY_LABELS } from '@/features/play/hooks/useDirectorShortcuts';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface ShortcutHelpPanelProps {\r\n  /** Whether the panel is open */\r\n  open: boolean;\r\n  /** Callback when open state changes */\r\n  onOpenChange: (open: boolean) => void;\r\n  /** All available shortcuts */\r\n  shortcuts: DirectorShortcut[];\r\n  /** Optional className */\r\n  className?: string;\r\n}\r\n\r\n// =============================================================================\r\n// Constants\r\n// =============================================================================\r\n\r\nconst CATEGORY_ICONS: Record<ShortcutCategory, React.ReactNode> = {\r\n  navigation: <ArrowRightIcon className=\"h-4 w-4\" />,\r\n  playback: <PlayIcon className=\"h-4 w-4\" />,\r\n  triggers: <BoltIcon className=\"h-4 w-4\" />,\r\n  signals: <RadioIcon className=\"h-4 w-4\" />,\r\n  artifacts: <EyeIcon className=\"h-4 w-4\" />,\r\n  view: <EyeIcon className=\"h-4 w-4\" />,\r\n  system: <CogIcon className=\"h-4 w-4\" />,\r\n};\r\n\r\nconst CATEGORY_ORDER: ShortcutCategory[] = [\r\n  'navigation',\r\n  'playback',\r\n  'triggers',\r\n  'signals',\r\n  'artifacts',\r\n  'view',\r\n  'system',\r\n];\r\n\r\n// =============================================================================\r\n// Helper: Format shortcut key display\r\n// =============================================================================\r\n\r\nfunction formatKey(shortcut: DirectorShortcut): React.ReactNode {\r\n  const parts: React.ReactNode[] = [];\r\n  \r\n  if (shortcut.modifiers.ctrl) {\r\n    parts.push(\r\n      <kbd key=\"ctrl\" className=\"px-1.5 py-0.5 bg-muted rounded text-xs font-mono\">\r\n        Ctrl\r\n      </kbd>\r\n    );\r\n  }\r\n  if (shortcut.modifiers.alt) {\r\n    parts.push(\r\n      <kbd key=\"alt\" className=\"px-1.5 py-0.5 bg-muted rounded text-xs font-mono\">\r\n        Alt\r\n      </kbd>\r\n    );\r\n  }\r\n  if (shortcut.modifiers.shift) {\r\n    parts.push(\r\n      <kbd key=\"shift\" className=\"px-1.5 py-0.5 bg-muted rounded text-xs font-mono\">\r\n        Ôçº\r\n      </kbd>\r\n    );\r\n  }\r\n  if (shortcut.modifiers.meta) {\r\n    parts.push(\r\n      <kbd key=\"meta\" className=\"px-1.5 py-0.5 bg-muted rounded text-xs font-mono\">\r\n        Ôîÿ\r\n      </kbd>\r\n    );\r\n  }\r\n  \r\n  // Format the key nicely\r\n  let keyDisplay = shortcut.key;\r\n  if (keyDisplay === 'ArrowRight') keyDisplay = 'ÔåÆ';\r\n  else if (keyDisplay === 'ArrowLeft') keyDisplay = 'ÔåÉ';\r\n  else if (keyDisplay === 'ArrowUp') keyDisplay = 'Ôåæ';\r\n  else if (keyDisplay === 'ArrowDown') keyDisplay = 'Ôåô';\r\n  else if (keyDisplay === 'Space') keyDisplay = 'Space';\r\n  else if (keyDisplay === 'Escape') keyDisplay = 'Esc';\r\n  else if (keyDisplay === 'Enter') keyDisplay = 'Enter';\r\n  \r\n  parts.push(\r\n    <kbd key=\"key\" className=\"px-1.5 py-0.5 bg-muted rounded text-xs font-mono\">\r\n      {keyDisplay}\r\n    </kbd>\r\n  );\r\n  \r\n  return (\r\n    <div className=\"flex items-center gap-1\">\r\n      {parts.map((part, i) => (\r\n        <React.Fragment key={i}>\r\n          {i > 0 && <span className=\"text-muted-foreground text-xs\">+</span>}\r\n          {part}\r\n        </React.Fragment>\r\n      ))}\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: ShortcutRow\r\n// =============================================================================\r\n\r\ninterface ShortcutRowProps {\r\n  shortcut: DirectorShortcut;\r\n}\r\n\r\nfunction ShortcutRow({ shortcut }: ShortcutRowProps) {\r\n  return (\r\n    <div className=\"flex items-center justify-between py-2 px-2 hover:bg-muted/50 rounded\">\r\n      <span className=\"text-sm\">{shortcut.description}</span>\r\n      {formatKey(shortcut)}\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: CategorySection\r\n// =============================================================================\r\n\r\ninterface CategorySectionProps {\r\n  category: ShortcutCategory;\r\n  shortcuts: DirectorShortcut[];\r\n}\r\n\r\nfunction CategorySection({ category, shortcuts }: CategorySectionProps) {\r\n  if (shortcuts.length === 0) return null;\r\n  \r\n  return (\r\n    <div className=\"space-y-2\">\r\n      <div className=\"flex items-center gap-2 text-sm font-medium text-muted-foreground\">\r\n        {CATEGORY_ICONS[category]}\r\n        {SHORTCUT_CATEGORY_LABELS[category]}\r\n        <Badge variant=\"default\" className=\"text-xs\">\r\n          {shortcuts.length}\r\n        </Badge>\r\n      </div>\r\n      <div className=\"border rounded-lg divide-y\">\r\n        {shortcuts.map((shortcut) => (\r\n          <ShortcutRow key={shortcut.action} shortcut={shortcut} />\r\n        ))}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function ShortcutHelpPanel({\r\n  open,\r\n  onOpenChange,\r\n  shortcuts,\r\n  className,\r\n}: ShortcutHelpPanelProps) {\r\n  // Group shortcuts by category\r\n  const groupedShortcuts = CATEGORY_ORDER.reduce(\r\n    (acc, category) => {\r\n      acc[category] = shortcuts.filter((s) => s.category === category);\r\n      return acc;\r\n    },\r\n    {} as Record<ShortcutCategory, DirectorShortcut[]>\r\n  );\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className={`max-w-2xl ${className}`}>\r\n        <DialogHeader>\r\n          <DialogTitle className=\"flex items-center gap-2\">\r\n            <CommandLineIcon className=\"h-5 w-5\" />\r\n            Kortkommandon\r\n          </DialogTitle>\r\n          <DialogDescription>\r\n            Snabb├Ñtkomst till Director Mode-funktioner\r\n          </DialogDescription>\r\n        </DialogHeader>\r\n\r\n        <ScrollArea maxHeight=\"60vh\" className=\"pr-4\">\r\n          <div className=\"space-y-6\">\r\n            {CATEGORY_ORDER.map((category) => (\r\n              <CategorySection\r\n                key={category}\r\n                category={category}\r\n                shortcuts={groupedShortcuts[category]}\r\n              />\r\n            ))}\r\n          </div>\r\n        </ScrollArea>\r\n\r\n        <div className=\"flex items-center justify-center pt-4 border-t\">\r\n          <p className=\"text-sm text-muted-foreground\">\r\n            Tryck <kbd className=\"px-1.5 py-0.5 bg-muted rounded text-xs font-mono\">?</kbd> f├Âr att visa denna hj├ñlp\r\n          </p>\r\n        </div>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// KeyboardShortcutIndicator - For inline display on buttons\r\n// =============================================================================\r\n\r\nexport interface KeyboardShortcutIndicatorProps {\r\n  /** The keyboard shortcut to display */\r\n  shortcut: DirectorShortcut;\r\n  /** Size variant */\r\n  size?: 'sm' | 'md';\r\n  /** Optional className */\r\n  className?: string;\r\n}\r\n\r\nexport function KeyboardShortcutIndicator({\r\n  shortcut,\r\n  size = 'sm',\r\n  className,\r\n}: KeyboardShortcutIndicatorProps) {\r\n  const parts: string[] = [];\r\n  \r\n  if (shortcut.modifiers.ctrl) parts.push('Ôîâ');\r\n  if (shortcut.modifiers.alt) parts.push('ÔîÑ');\r\n  if (shortcut.modifiers.shift) parts.push('Ôçº');\r\n  if (shortcut.modifiers.meta) parts.push('Ôîÿ');\r\n  \r\n  // Format the key\r\n  let keyDisplay = shortcut.key;\r\n  if (keyDisplay === 'ArrowRight') keyDisplay = 'ÔåÆ';\r\n  else if (keyDisplay === 'ArrowLeft') keyDisplay = 'ÔåÉ';\r\n  else if (keyDisplay === 'ArrowUp') keyDisplay = 'Ôåæ';\r\n  else if (keyDisplay === 'ArrowDown') keyDisplay = 'Ôåô';\r\n  else if (keyDisplay === 'Space') keyDisplay = 'ÔÉú';\r\n  else if (keyDisplay === 'Escape') keyDisplay = 'Esc';\r\n  else if (keyDisplay === 'Enter') keyDisplay = 'ÔåÁ';\r\n  \r\n  parts.push(keyDisplay);\r\n  \r\n  const sizeClasses = size === 'sm' \r\n    ? 'text-[10px] px-1 py-0.5' \r\n    : 'text-xs px-1.5 py-0.5';\r\n  \r\n  return (\r\n    <span\r\n      className={`\r\n        inline-flex items-center font-mono bg-muted text-muted-foreground rounded\r\n        ${sizeClasses}\r\n        ${className}\r\n      `}\r\n    >\r\n      {parts.join('')}\r\n    </span>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\SignalCapabilityTest.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":133,"column":97,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":135,"endColumn":9},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":139,"column":34,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":141,"endColumn":9},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":145,"column":83,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":147,"endColumn":9},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":399,"column":47,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":401,"endColumn":13},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":450,"column":23,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":450,"endColumn":37},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":450,"column":46,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":452,"endColumn":13},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":467,"column":44,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":467,"endColumn":90},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":473,"column":44,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":473,"endColumn":85},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":479,"column":44,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":479,"endColumn":80},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":483,"column":31,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":484,"endColumn":13}],"suppressedMessages":[],"errorCount":10,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * SignalCapabilityTest Component\r\n * \r\n * Lobby component that allows hosts and participants to test\r\n * their device's signal capabilities before starting a game.\r\n * \r\n * Task 4.3 - Session Cockpit Architecture\r\n */\r\n\r\n'use client';\r\n\r\nimport React, { useCallback, useState } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from '@/components/ui/card';\r\nimport { Tooltip } from '@/components/ui/tooltip';\r\nimport {\r\n  LightBulbIcon,\r\n  SpeakerWaveIcon,\r\n  DevicePhoneMobileIcon,\r\n  ComputerDesktopIcon,\r\n  BellIcon,\r\n  CheckIcon,\r\n  XMarkIcon,\r\n  ExclamationTriangleIcon,\r\n  ArrowPathIcon,\r\n  QuestionMarkCircleIcon,\r\n} from '@heroicons/react/24/outline';\r\nimport {\r\n  useSignalCapabilities,\r\n  type SignalCapability,\r\n  type SignalCapabilityStatus,\r\n} from '../hooks/useSignalCapabilities';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface SignalCapabilityTestProps {\r\n  /** Callback when all tests are complete */\r\n  onComplete?: (availableCount: number, totalCount: number) => void;\r\n  /** Show compact version */\r\n  compact?: boolean;\r\n  /** Optional className */\r\n  className?: string;\r\n}\r\n\r\n// =============================================================================\r\n// Constants\r\n// =============================================================================\r\n\r\nconst CAPABILITY_CONFIG: Record<\r\n  SignalCapability['type'],\r\n  {\r\n    icon: React.ReactNode;\r\n    label: string;\r\n    description: string;\r\n    testButtonLabel: string;\r\n    fallbackInfo: string;\r\n  }\r\n> = {\r\n  torch: {\r\n    icon: <LightBulbIcon className=\"h-5 w-5\" />,\r\n    label: 'Ficklampa',\r\n    description: 'Anv├ñnd telefonens ficklampa som signal',\r\n    testButtonLabel: 'Blinka',\r\n    fallbackInfo: 'Kr├ñver kamera-tillg├Ñng och en enhet med ficklampa (de flesta smartphones)',\r\n  },\r\n  audio: {\r\n    icon: <SpeakerWaveIcon className=\"h-5 w-5\" />,\r\n    label: 'Ljud',\r\n    description: 'Spela upp ljud som signal',\r\n    testButtonLabel: 'Pip',\r\n    fallbackInfo: 'Fungerar i de flesta webbl├ñsare. P├Ñ iOS kan du beh├Âva trycka p├Ñ sk├ñrmen f├Ârst.',\r\n  },\r\n  vibration: {\r\n    icon: <DevicePhoneMobileIcon className=\"h-5 w-5\" />,\r\n    label: 'Vibration',\r\n    description: 'Vibrera enheten som signal',\r\n    testButtonLabel: 'Vibrera',\r\n    fallbackInfo: 'Fungerar p├Ñ de flesta smartphones. Desktop-datorer st├Âdjer inte vibration.',\r\n  },\r\n  screen_flash: {\r\n    icon: <ComputerDesktopIcon className=\"h-5 w-5\" />,\r\n    label: 'Sk├ñrmbl├ñnk',\r\n    description: 'Blinka sk├ñrmen i olika f├ñrger',\r\n    testButtonLabel: 'Blinka',\r\n    fallbackInfo: 'Fungerar i alla webbl├ñsare. B├ñst effekt i ett m├Ârkt rum.',\r\n  },\r\n  notification: {\r\n    icon: <BellIcon className=\"h-5 w-5\" />,\r\n    label: 'Notifikation',\r\n    description: 'Visa push-notifikationer',\r\n    testButtonLabel: 'Testa',\r\n    fallbackInfo: 'Kr├ñver att du till├Ñter notifikationer. Fungerar b├ñst p├Ñ mobila enheter.',\r\n  },\r\n};\r\n\r\n// =============================================================================\r\n// Helper: Status Icon\r\n// =============================================================================\r\n\r\nfunction StatusIcon({ status }: { status: SignalCapabilityStatus }) {\r\n  switch (status) {\r\n    case 'available':\r\n      return <CheckIcon className=\"h-4 w-4 text-green-500\" />;\r\n    case 'unavailable':\r\n      return <XMarkIcon className=\"h-4 w-4 text-muted-foreground\" />;\r\n    case 'denied':\r\n      return <ExclamationTriangleIcon className=\"h-4 w-4 text-yellow-500\" />;\r\n    case 'error':\r\n      return <ExclamationTriangleIcon className=\"h-4 w-4 text-red-500\" />;\r\n    case 'unknown':\r\n    default:\r\n      return <QuestionMarkCircleIcon className=\"h-4 w-4 text-muted-foreground\" />;\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// Helper: Status Badge\r\n// =============================================================================\r\n\r\nfunction StatusBadge({ status }: { status: SignalCapabilityStatus }) {\r\n  switch (status) {\r\n    case 'available':\r\n      return (\r\n        <Badge variant=\"default\" className=\"bg-green-500/10 text-green-600 border-green-500/20\">\r\n          Tillg├ñnglig\r\n        </Badge>\r\n      );\r\n    case 'unavailable':\r\n      return (\r\n        <Badge variant=\"outline\">\r\n          Ej tillg├ñnglig\r\n        </Badge>\r\n      );\r\n    case 'denied':\r\n      return (\r\n        <Badge variant=\"outline\" className=\"border-yellow-500/50 text-yellow-600\">\r\n          Beh├Ârighet nekad\r\n        </Badge>\r\n      );\r\n    case 'error':\r\n      return (\r\n        <Badge variant=\"destructive\">\r\n          Fel\r\n        </Badge>\r\n      );\r\n    case 'unknown':\r\n    default:\r\n      return (\r\n        <Badge variant=\"outline\">\r\n          Ej testad\r\n        </Badge>\r\n      );\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// Loading Spinner\r\n// =============================================================================\r\n\r\nfunction Spinner({ className }: { className?: string }) {\r\n  return (\r\n    <ArrowPathIcon className={`animate-spin ${className}`} />\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: CapabilityRow\r\n// =============================================================================\r\n\r\ninterface CapabilityRowProps {\r\n  capability: SignalCapability;\r\n  config: typeof CAPABILITY_CONFIG['torch'];\r\n  onTest: () => Promise<void>;\r\n  isTesting: boolean;\r\n  compact?: boolean;\r\n}\r\n\r\nfunction CapabilityRow({\r\n  capability,\r\n  config,\r\n  onTest,\r\n  isTesting,\r\n  compact,\r\n}: CapabilityRowProps) {\r\n  if (compact) {\r\n    return (\r\n      <div className=\"flex items-center justify-between py-2\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <StatusIcon status={capability.status} />\r\n          <span className=\"text-sm\">{config.label}</span>\r\n        </div>\r\n        <Button\r\n          variant=\"ghost\"\r\n          size=\"sm\"\r\n          onClick={onTest}\r\n          disabled={isTesting || capability.status === 'unavailable' || capability.status === 'denied'}\r\n          className=\"h-7 px-2\"\r\n        >\r\n          {isTesting ? (\r\n            <Spinner className=\"h-3 w-3\" />\r\n          ) : (\r\n            config.testButtonLabel\r\n          )}\r\n        </Button>\r\n      </div>\r\n    );\r\n  }\r\n  \r\n  const tooltipContent = capability.status === 'unavailable'\r\n    ? 'Denna funktion st├Âds inte p├Ñ din enhet'\r\n    : capability.status === 'denied'\r\n    ? 'Du beh├Âver ge beh├Ârighet f├Âr denna funktion'\r\n    : `Testa ${config.label.toLowerCase()}`;\r\n  \r\n  return (\r\n    <div className=\"flex items-start gap-4 p-4 border rounded-lg bg-card\">\r\n      <div className={`\r\n        p-2 rounded-lg\r\n        ${capability.status === 'available' ? 'bg-green-500/10 text-green-600' : ''}\r\n        ${capability.status === 'unavailable' ? 'bg-muted text-muted-foreground' : ''}\r\n        ${capability.status === 'denied' ? 'bg-yellow-500/10 text-yellow-600' : ''}\r\n        ${capability.status === 'error' ? 'bg-red-500/10 text-red-600' : ''}\r\n        ${capability.status === 'unknown' ? 'bg-muted text-muted-foreground' : ''}\r\n      `}>\r\n        {config.icon}\r\n      </div>\r\n      \r\n      <div className=\"flex-1 min-w-0\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <h4 className=\"font-medium\">{config.label}</h4>\r\n          <StatusBadge status={capability.status} />\r\n        </div>\r\n        <p className=\"text-sm text-muted-foreground mt-1\">\r\n          {config.description}\r\n        </p>\r\n        \r\n        {/* Show fallback info if unavailable or denied */}\r\n        {(capability.status === 'unavailable' || capability.status === 'denied') && (\r\n          <div className=\"mt-2 text-xs text-muted-foreground flex items-start gap-1\">\r\n            <QuestionMarkCircleIcon className=\"h-3 w-3 mt-0.5 flex-shrink-0\" />\r\n            <span>{config.fallbackInfo}</span>\r\n          </div>\r\n        )}\r\n      </div>\r\n      \r\n      <Tooltip content={tooltipContent}>\r\n        <Button\r\n          variant={capability.status === 'available' ? 'outline' : 'default'}\r\n          size=\"sm\"\r\n          onClick={onTest}\r\n          disabled={isTesting || capability.status === 'unavailable'}\r\n          className=\"flex-shrink-0\"\r\n        >\r\n          {isTesting ? (\r\n            <>\r\n              <Spinner className=\"h-4 w-4 mr-1\" />\r\n              Testar...\r\n            </>\r\n          ) : (\r\n            config.testButtonLabel\r\n          )}\r\n        </Button>\r\n      </Tooltip>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function SignalCapabilityTest({\r\n  onComplete,\r\n  compact = false,\r\n  className,\r\n}: SignalCapabilityTestProps) {\r\n  const {\r\n    capabilities,\r\n    allTested,\r\n    availableCount,\r\n    isTesting: isTestingAll,\r\n    testAll,\r\n    testCapability,\r\n    flashScreen,\r\n    playSound,\r\n    vibrate,\r\n    flashTorch,\r\n    sendNotification,\r\n    activateAudioGate,\r\n    audioGateActive,\r\n  } = useSignalCapabilities({ autoDetect: true });\r\n  \r\n  const [testingCapability, setTestingCapability] = useState<SignalCapability['type'] | null>(null);\r\n  \r\n  // Handle testing a specific capability\r\n  const handleTest = useCallback(async (type: SignalCapability['type']) => {\r\n    setTestingCapability(type);\r\n    \r\n    try {\r\n      switch (type) {\r\n        case 'torch':\r\n          await flashTorch(300);\r\n          break;\r\n        case 'audio':\r\n          if (!audioGateActive) {\r\n            await activateAudioGate();\r\n          }\r\n          await playSound();\r\n          break;\r\n        case 'vibration':\r\n          await vibrate([100, 50, 100]);\r\n          break;\r\n        case 'screen_flash':\r\n          await flashScreen('#ffffff', 200);\r\n          break;\r\n        case 'notification':\r\n          await sendNotification('Signaltest', 'Notifikationer fungerar!');\r\n          break;\r\n      }\r\n      \r\n      // Re-test to update status\r\n      await testCapability(type);\r\n    } finally {\r\n      setTestingCapability(null);\r\n    }\r\n  }, [\r\n    flashTorch,\r\n    playSound,\r\n    vibrate,\r\n    flashScreen,\r\n    sendNotification,\r\n    activateAudioGate,\r\n    audioGateActive,\r\n    testCapability,\r\n  ]);\r\n  \r\n  // Handle test all\r\n  const handleTestAll = useCallback(async () => {\r\n    await testAll();\r\n    onComplete?.(availableCount, 5);\r\n  }, [testAll, onComplete, availableCount]);\r\n  \r\n  // Capability entries\r\n  const capabilityEntries = [\r\n    { type: 'screen_flash' as const, capability: capabilities.screenFlash },\r\n    { type: 'audio' as const, capability: capabilities.audio },\r\n    { type: 'vibration' as const, capability: capabilities.vibration },\r\n    { type: 'torch' as const, capability: capabilities.torch },\r\n    { type: 'notification' as const, capability: capabilities.notification },\r\n  ];\r\n  \r\n  if (compact) {\r\n    return (\r\n      <div className={className}>\r\n        <div className=\"flex items-center justify-between mb-3\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <DevicePhoneMobileIcon className=\"h-4 w-4 text-muted-foreground\" />\r\n            <span className=\"text-sm font-medium\">Signaler</span>\r\n          </div>\r\n          <Badge variant={availableCount >= 3 ? 'default' : 'outline'}>\r\n            {availableCount}/5\r\n          </Badge>\r\n        </div>\r\n        \r\n        <div className=\"divide-y\">\r\n          {capabilityEntries.map(({ type, capability }) => (\r\n            <CapabilityRow\r\n              key={type}\r\n              capability={capability}\r\n              config={CAPABILITY_CONFIG[type]}\r\n              onTest={() => handleTest(type)}\r\n              isTesting={testingCapability === type}\r\n              compact\r\n            />\r\n          ))}\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n  \r\n  return (\r\n    <Card className={className}>\r\n      <CardHeader>\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <CardTitle className=\"flex items-center gap-2\">\r\n              <DevicePhoneMobileIcon className=\"h-5 w-5\" />\r\n              Signaltest\r\n            </CardTitle>\r\n            <CardDescription className=\"mt-1\">\r\n              Testa vilka signaler din enhet st├Âdjer\r\n            </CardDescription>\r\n          </div>\r\n          \r\n          <div className=\"flex items-center gap-2\">\r\n            <Badge \r\n              variant={availableCount >= 3 ? 'default' : 'outline'}\r\n              className=\"text-base\"\r\n            >\r\n              {availableCount}/5 tillg├ñngliga\r\n            </Badge>\r\n            \r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              onClick={handleTestAll}\r\n              disabled={isTestingAll}\r\n            >\r\n              {isTestingAll ? (\r\n                <>\r\n                  <Spinner className=\"h-4 w-4 mr-1\" />\r\n                  Testar...\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <ArrowPathIcon className=\"h-4 w-4 mr-1\" />\r\n                  Testa alla\r\n                </>\r\n              )}\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </CardHeader>\r\n      \r\n      <CardContent className=\"space-y-3\">\r\n        {capabilityEntries.map(({ type, capability }) => (\r\n          <CapabilityRow\r\n            key={type}\r\n            capability={capability}\r\n            config={CAPABILITY_CONFIG[type]}\r\n            onTest={() => handleTest(type)}\r\n            isTesting={testingCapability === type}\r\n          />\r\n        ))}\r\n        \r\n        {/* iOS Audio Gate Warning */}\r\n        {capabilities.audio.status === 'available' && !audioGateActive && (\r\n          <div className=\"flex items-start gap-2 p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/20 text-yellow-600\">\r\n            <ExclamationTriangleIcon className=\"h-4 w-4 mt-0.5 flex-shrink-0\" />\r\n            <div className=\"text-sm\">\r\n              <strong>iOS-anv├ñndare:</strong> Tryck p├Ñ &quot;Pip&quot;-knappen ovan f├Âr att \r\n              aktivera ljud. Detta beh├Âver bara g├Âras en g├Ñng per session.\r\n            </div>\r\n          </div>\r\n        )}\r\n        \r\n        {/* Summary */}\r\n        {allTested && (\r\n          <div className={`\r\n            p-4 rounded-lg text-center\r\n            ${availableCount >= 4 ? 'bg-green-500/10 text-green-700' : ''}\r\n            ${availableCount >= 2 && availableCount < 4 ? 'bg-yellow-500/10 text-yellow-700' : ''}\r\n            ${availableCount < 2 ? 'bg-red-500/10 text-red-700' : ''}\r\n          `}>\r\n            {availableCount >= 4 && (\r\n              <>\r\n                <CheckIcon className=\"h-6 w-6 mx-auto mb-2\" />\r\n                <p className=\"font-medium\">Utm├ñrkt! Din enhet st├Âdjer de flesta signaler.</p>\r\n              </>\r\n            )}\r\n            {availableCount >= 2 && availableCount < 4 && (\r\n              <>\r\n                <ExclamationTriangleIcon className=\"h-6 w-6 mx-auto mb-2\" />\r\n                <p className=\"font-medium\">Din enhet st├Âdjer grundl├ñggande signaler.</p>\r\n              </>\r\n            )}\r\n            {availableCount < 2 && (\r\n              <>\r\n                <XMarkIcon className=\"h-6 w-6 mx-auto mb-2\" />\r\n                <p className=\"font-medium\">Begr├ñnsat signalst├Âd p├Ñ denna enhet.</p>\r\n              </>\r\n            )}\r\n            <p className=\"text-sm mt-1 opacity-80\">\r\n              {availableCount} av 5 signaltyper tillg├ñngliga\r\n            </p>\r\n          </div>\r\n        )}\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\SignalPanel.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":161,"column":56,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":161,"endColumn":114},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":243,"column":58,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":243,"endColumn":65},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":245,"column":58,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":245,"endColumn":76}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useCallback, useEffect, useMemo, useState } from 'react';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { getSessionSignals, sendSessionSignal, type SessionSignalRow } from '@/features/play/api/signals-api';\r\nimport { useLiveSession } from '@/features/play/hooks/useLiveSession';\r\nimport type { SignalReceivedBroadcast } from '@/types/play-runtime';\r\n\r\ntype SignalPanelProps = {\n  sessionId: string;\n  disabled?: boolean;\n};\n\ntype SignalPreset = {\n  id: string;\n  label: string;\n  channel: string;\n  message?: string;\n};\n\nfunction formatSignalText(payload: unknown): string {\n  if (!payload) return '';\n  if (typeof payload === 'string') return payload;\n  if (typeof payload === 'object' && payload !== null && 'message' in payload) {\r\n    const msg = (payload as { message?: unknown }).message;\r\n    if (typeof msg === 'string') return msg;\r\n  }\r\n  try {\r\n    return JSON.stringify(payload);\r\n  } catch {\r\n    return '';\r\n  }\r\n}\r\n\r\nfunction toRow(p: SignalReceivedBroadcast['payload']): SessionSignalRow {\r\n  return {\r\n    id: p.id,\r\n    session_id: '',\r\n    channel: p.channel,\r\n    payload: p.payload,\r\n    sender_user_id: p.sender_user_id,\r\n    sender_participant_id: p.sender_participant_id,\r\n    created_at: p.created_at,\r\n  };\r\n}\r\n\r\nexport function SignalPanel({ sessionId, disabled = false }: SignalPanelProps) {\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const [signals, setSignals] = useState<SessionSignalRow[]>([]);\r\n\r\n  const [channel, setChannel] = useState('');\n  const [message, setMessage] = useState('');\n  const [sending, setSending] = useState(false);\n\n  const presets: SignalPreset[] = [\n    { id: 'ready', label: 'Redo', channel: 'READY', message: 'Redo' },\n    { id: 'hint', label: 'Ledtr├Ñd', channel: 'HINT', message: 'Ledtr├Ñd tillg├ñnglig' },\n    { id: 'attention', label: 'Fokus', channel: 'ATTENTION', message: 'Samla uppm├ñrksamhet' },\n    { id: 'pause', label: 'Paus', channel: 'PAUSE', message: 'Pausa nu' },\n    { id: 'found', label: 'Hittat', channel: 'FOUND', message: 'Fynd bekr├ñftat' },\n    { id: 'sos', label: 'SOS', channel: 'SOS', message: 'Beh├Âver hj├ñlp' },\n  ];\n\n  const load = useCallback(async () => {\n    setLoading(true);\r\n    setError(null);\r\n    try {\r\n      const res = await getSessionSignals(sessionId);\r\n      setSignals(res.signals ?? []);\n      if (!channel && (res.signals?.[0]?.channel ?? '')) {\n        setChannel(res.signals[0]!.channel);\n      }\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : 'Kunde inte ladda signals');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [sessionId, channel]);\r\n\r\n  useEffect(() => {\r\n    void load();\r\n  }, [load]);\r\n\r\n  const { connected } = useLiveSession({\r\n    sessionId,\r\n    enabled: true,\r\n    onSignalReceived: (payload) => {\r\n      setSignals((prev) => {\r\n        const next = [toRow(payload), ...prev.filter((p) => p.id !== payload.id)];\r\n        return next.slice(0, 20);\r\n      });\r\n      if (!channel) {\r\n        setChannel(payload.channel);\r\n      }\r\n    },\r\n  });\r\n\r\n  const quickChannels = useMemo(() => {\n    const channels: string[] = [];\n    for (const s of signals) {\n      if (!channels.includes(s.channel)) channels.push(s.channel);\n      if (channels.length >= 6) break;\n    }\n    return channels;\n  }, [signals]);\n\n  const suggestedChannels = useMemo(() => {\n    const suggested = ['READY', 'HINT', 'ATTENTION', 'PAUSE', 'FOUND', 'SOS'];\n    const merged = [...quickChannels, ...suggested];\n    return merged.filter((value, index) => merged.indexOf(value) === index).slice(0, 8);\n  }, [quickChannels]);\n\n  const handleSend = useCallback(async () => {\n    const c = channel.trim();\n    const m = message.trim();\n    if (!c || !m) return;\n\r\n    setSending(true);\r\n    setError(null);\r\n    try {\r\n      await sendSessionSignal(sessionId, { channel: c, message: m });\r\n      setMessage('');\r\n      // Rely on realtime, but keep it responsive even if connection is flaky\r\n      void load();\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : 'Kunde inte skicka signal');\r\n    } finally {\n      setSending(false);\n    }\n  }, [sessionId, channel, message, load]);\n\n  const handlePresetSend = useCallback(async (preset: SignalPreset) => {\n    if (disabled || sending) return;\n    setSending(true);\n    setError(null);\n    try {\n      await sendSessionSignal(sessionId, {\n        channel: preset.channel,\n        message: preset.message ?? preset.label,\n      });\n      setChannel(preset.channel);\n      setMessage('');\n      void load();\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Kunde inte skicka signal');\n    } finally {\n      setSending(false);\n    }\n  }, [disabled, sending, sessionId, load]);\n\n  return (\n    <Card variant=\"elevated\" className=\"p-6\">\n      <div className=\"flex items-center justify-between gap-3\">\n        <div>\n          <h2 className=\"text-lg font-semibold text-foreground\">Signals</h2>\n          <p className=\"text-sm text-muted-foreground\">Skicka snabba events med f├ñrdiga knappar eller egen kanal.</p>\n        </div>\n        <Badge variant={connected ? 'success' : 'secondary'} size=\"sm\">\n          {connected ? 'Live' : 'Offline'}\n        </Badge>\n      </div>\n\r\n      {error && <div className=\"mt-3 text-sm text-destructive\">{error}</div>}\r\n\r\n      <div className=\"mt-4 space-y-3\">\n        <div className=\"space-y-2\">\n          <h3 className=\"text-xs font-semibold uppercase tracking-wider text-muted-foreground\">Snabbknappar</h3>\n          <div className=\"flex flex-wrap gap-2\">\n            {presets.map((preset) => (\n              <Button\n                key={preset.id}\n                type=\"button\"\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => void handlePresetSend(preset)}\n                disabled={disabled || sending}\n              >\n                {preset.label}\n              </Button>\n            ))}\n          </div>\n        </div>\n\n        <div className=\"flex flex-col gap-2 sm:flex-row\">\n          <Input\n            value={channel}\n            onChange={(e) => setChannel(e.target.value)}\n            placeholder=\"Kanal (t.ex. READY)\"\n            disabled={disabled || sending}\n          />\n          <Input\r\n            value={message}\r\n            onChange={(e) => setMessage(e.target.value)}\r\n            placeholder=\"Meddelande\"\r\n            disabled={disabled || sending}\r\n            onKeyDown={(e) => {\r\n              if (e.key === 'Enter') {\r\n                e.preventDefault();\r\n                void handleSend();\r\n              }\r\n            }}\r\n          />\r\n          <Button\r\n            type=\"button\"\r\n            onClick={() => void handleSend()}\r\n            disabled={disabled || sending || !channel.trim() || !message.trim()}\n          >\n            Skicka\n          </Button>\n        </div>\n\n        {suggestedChannels.length > 0 && (\n          <div className=\"flex flex-wrap gap-2\">\n            {suggestedChannels.map((c) => (\n              <Button\n                key={c}\n                type=\"button\"\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => setChannel(c)}\n                disabled={disabled || sending}\n              >\n                {c}\n              </Button>\n            ))}\n          </div>\n        )}\n\r\n        <div className=\"flex items-center justify-between\">\r\n          <h3 className=\"text-sm font-semibold uppercase tracking-wider text-muted-foreground\">Senaste</h3>\r\n          <Button type=\"button\" variant=\"ghost\" size=\"sm\" onClick={() => void load()} disabled={loading}>\r\n            Uppdatera\r\n          </Button>\r\n        </div>\r\n\r\n        <div className=\"max-h-64 overflow-auto rounded-md border border-border p-3 space-y-2\">\r\n          {loading ? (\r\n            <p className=\"text-sm text-muted-foreground\">LaddarÔÇª</p>\r\n          ) : signals.length === 0 ? (\r\n            <p className=\"text-sm text-muted-foreground\">Inga signals ├ñnnu.</p>\r\n          ) : (\r\n            signals.map((s) => (\r\n              <div key={s.id} className=\"text-sm\">\r\n                <div className=\"flex items-center justify-between gap-2\">\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <Badge variant=\"secondary\" size=\"sm\">{s.channel}</Badge>\r\n                    <span className=\"text-muted-foreground\">{formatSignalText(s.payload)}</span>\r\n                  </div>\r\n                  <span className=\"text-xs text-muted-foreground\">\r\n                    {new Date(s.created_at).toLocaleTimeString()}\r\n                  </span>\r\n                </div>\r\n              </div>\r\n            ))\r\n          )}\r\n        </div>\r\n      </div>\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\SignalPresetEditor.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":375,"column":18,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":375,"endColumn":25},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":406,"column":20,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":406,"endColumn":24},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":434,"column":22,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":434,"endColumn":31},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":546,"column":48,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":546,"endColumn":63},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":548,"column":48,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":550,"endColumn":9},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":576,"column":65,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":576,"endColumn":67},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":632,"column":56,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":632,"endColumn":71},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"P├Ñ: \". Consider using useTranslations() or t() for internationalization.","line":643,"column":24,"nodeType":"TemplateLiteral","messageId":"hardcodedString","endLine":643,"endColumn":50},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":735,"column":36,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":735,"endColumn":83},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":744,"column":48,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":746,"endColumn":9}],"suppressedMessages":[],"errorCount":10,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * SignalPresetEditor Component\r\n * \r\n * CRUD component for creating and editing signal presets.\r\n * Used in Game Builder to define reusable signal configurations.\r\n * \r\n * Task 4.2 - Session Cockpit Architecture\r\n */\r\n\r\n'use client';\r\n\r\nimport React, { useState, useCallback } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Select } from '@/components/ui/select';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from '@/components/ui/card';\r\nimport { Slider } from '@/components/ui/slider';\r\nimport {\r\n  LightBulbIcon,\r\n  SpeakerWaveIcon,\r\n  DevicePhoneMobileIcon,\r\n  ComputerDesktopIcon,\r\n  BellIcon,\r\n  PlusIcon,\r\n  TrashIcon,\r\n  DocumentDuplicateIcon,\r\n  Bars3Icon,\r\n  PlayIcon,\r\n  PauseIcon,\r\n} from '@heroicons/react/24/outline';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport type SignalType = 'torch' | 'audio' | 'vibration' | 'screen_flash' | 'notification';\r\n\r\nexport type SignalPattern = \r\n  | 'single'     // Single pulse\r\n  | 'double'     // Two quick pulses\r\n  | 'triple'     // Three quick pulses\r\n  | 'sos'        // SOS morse code\r\n  | 'pulse'      // Continuous pulsing\r\n  | 'custom';    // Custom pattern\r\n\r\nexport interface SignalStep {\r\n  id: string;\r\n  /** On duration in ms */\r\n  onDuration: number;\r\n  /** Off duration in ms (before next step) */\r\n  offDuration: number;\r\n}\r\n\r\nexport interface SignalPreset {\r\n  id: string;\r\n  name: string;\r\n  type: SignalType;\r\n  pattern: SignalPattern;\r\n  /** Custom pattern steps (only for 'custom' pattern) */\r\n  customSteps?: SignalStep[];\r\n  /** For audio: URL or 'beep' */\r\n  audioUrl?: string;\r\n  /** For audio: volume 0-1 */\r\n  volume?: number;\r\n  /** For screen_flash: color */\r\n  color?: string;\r\n  /** For notification: title */\r\n  notificationTitle?: string;\r\n  /** For notification: body */\r\n  notificationBody?: string;\r\n  /** How many times to repeat the pattern (1 = play once) */\r\n  repeatCount: number;\r\n  /** Delay between repeats in ms */\r\n  repeatDelay: number;\r\n}\r\n\r\nexport interface SignalPresetEditorProps {\r\n  /** Current presets */\r\n  presets: SignalPreset[];\r\n  /** Callback when presets change */\r\n  onChange: (presets: SignalPreset[]) => void;\r\n  /** Optional: test signal function */\r\n  onTestSignal?: (preset: SignalPreset) => Promise<void>;\r\n  /** Optional: className */\r\n  className?: string;\r\n}\r\n\r\n// =============================================================================\r\n// Constants\r\n// =============================================================================\r\n\r\nconst SIGNAL_TYPE_OPTIONS = [\r\n  { value: 'torch', label: 'Ficklampa' },\r\n  { value: 'audio', label: 'Ljud' },\r\n  { value: 'vibration', label: 'Vibration' },\r\n  { value: 'screen_flash', label: 'Sk├ñrmbl├ñnk' },\r\n  { value: 'notification', label: 'Notifikation' },\r\n];\r\n\r\nconst SIGNAL_TYPE_ICONS: Record<SignalType, React.ReactNode> = {\r\n  torch: <LightBulbIcon className=\"h-4 w-4\" />,\r\n  audio: <SpeakerWaveIcon className=\"h-4 w-4\" />,\r\n  vibration: <DevicePhoneMobileIcon className=\"h-4 w-4\" />,\r\n  screen_flash: <ComputerDesktopIcon className=\"h-4 w-4\" />,\r\n  notification: <BellIcon className=\"h-4 w-4\" />,\r\n};\r\n\r\nconst PATTERN_OPTIONS = [\r\n  { value: 'single', label: 'Enkel' },\r\n  { value: 'double', label: 'Dubbel' },\r\n  { value: 'triple', label: 'Trippel' },\r\n  { value: 'sos', label: 'SOS' },\r\n  { value: 'pulse', label: 'Puls' },\r\n  { value: 'custom', label: 'Anpassad' },\r\n];\r\n\r\nconst PATTERN_DESCRIPTIONS: Record<SignalPattern, string> = {\r\n  single: 'En kort puls',\r\n  double: 'Tv├Ñ snabba pulser',\r\n  triple: 'Tre snabba pulser',\r\n  sos: '... --- ...',\r\n  pulse: 'Kontinuerlig pulsning',\r\n  custom: 'Skapa eget m├Ânster',\r\n};\r\n\r\nconst PRESET_PATTERNS: Record<Exclude<SignalPattern, 'custom'>, SignalStep[]> = {\r\n  single: [{ id: '1', onDuration: 500, offDuration: 0 }],\r\n  double: [\r\n    { id: '1', onDuration: 200, offDuration: 100 },\r\n    { id: '2', onDuration: 200, offDuration: 0 },\r\n  ],\r\n  triple: [\r\n    { id: '1', onDuration: 150, offDuration: 100 },\r\n    { id: '2', onDuration: 150, offDuration: 100 },\r\n    { id: '3', onDuration: 150, offDuration: 0 },\r\n  ],\r\n  sos: [\r\n    // S: ...\r\n    { id: '1', onDuration: 100, offDuration: 100 },\r\n    { id: '2', onDuration: 100, offDuration: 100 },\r\n    { id: '3', onDuration: 100, offDuration: 300 },\r\n    // O: ---\r\n    { id: '4', onDuration: 300, offDuration: 100 },\r\n    { id: '5', onDuration: 300, offDuration: 100 },\r\n    { id: '6', onDuration: 300, offDuration: 300 },\r\n    // S: ...\r\n    { id: '7', onDuration: 100, offDuration: 100 },\r\n    { id: '8', onDuration: 100, offDuration: 100 },\r\n    { id: '9', onDuration: 100, offDuration: 0 },\r\n  ],\r\n  pulse: [\r\n    { id: '1', onDuration: 200, offDuration: 200 },\r\n  ],\r\n};\r\n\r\nconst AUDIO_OPTIONS = [\r\n  { value: 'beep', label: 'Pip (standard)' },\r\n  { value: 'bell', label: 'Ringklocka' },\r\n  { value: 'chime', label: 'Klang' },\r\n  { value: 'alert', label: 'Larm' },\r\n];\r\n\r\nconst REPEAT_OPTIONS = [\r\n  { value: '1', label: '1 g├Ñng' },\r\n  { value: '2', label: '2 g├Ñnger' },\r\n  { value: '3', label: '3 g├Ñnger' },\r\n  { value: '5', label: '5 g├Ñnger' },\r\n  { value: '0', label: 'O├ñndligt' },\r\n];\r\n\r\nconst COLOR_PRESETS = [\r\n  { value: '#ffffff', label: 'Vit' },\r\n  { value: '#ff0000', label: 'R├Âd' },\r\n  { value: '#00ff00', label: 'Gr├Ân' },\r\n  { value: '#0000ff', label: 'Bl├Ñ' },\r\n  { value: '#ffff00', label: 'Gul' },\r\n  { value: '#ff00ff', label: 'Magenta' },\r\n  { value: '#00ffff', label: 'Cyan' },\r\n];\r\n\r\n// =============================================================================\r\n// Helper: Generate ID\r\n// =============================================================================\r\n\r\nconst generateId = () => Math.random().toString(36).substring(2, 10);\r\n\r\n// =============================================================================\r\n// Helper: Create Default Preset\r\n// =============================================================================\r\n\r\nconst createDefaultPreset = (type: SignalType = 'screen_flash'): SignalPreset => ({\r\n  id: generateId(),\r\n  name: 'Ny signal',\r\n  type,\r\n  pattern: 'single',\r\n  repeatCount: 1,\r\n  repeatDelay: 500,\r\n  color: '#ffffff',\r\n  volume: 0.5,\r\n  audioUrl: 'beep',\r\n  notificationTitle: 'Signal',\r\n  notificationBody: '',\r\n});\r\n\r\n// =============================================================================\r\n// Sub-Component: PresetCard\r\n// =============================================================================\r\n\r\ninterface PresetCardProps {\r\n  preset: SignalPreset;\r\n  isEditing: boolean;\r\n  onEdit: () => void;\r\n  onUpdate: (preset: SignalPreset) => void;\r\n  onDelete: () => void;\r\n  onDuplicate: () => void;\r\n  onTest?: () => Promise<void>;\r\n  isTesting: boolean;\r\n}\r\n\r\nfunction PresetCard({\r\n  preset,\r\n  isEditing,\r\n  onEdit,\r\n  onUpdate,\r\n  onDelete,\r\n  onDuplicate,\r\n  onTest,\r\n  isTesting,\r\n}: PresetCardProps) {\r\n  const patternOption = PATTERN_OPTIONS.find((o) => o.value === preset.pattern);\r\n  \r\n  if (!isEditing) {\r\n    // Collapsed view\r\n    return (\r\n      <Card className=\"group cursor-pointer hover:border-primary/50\" onClick={onEdit}>\r\n        <CardContent className=\"p-4\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <Bars3Icon className=\"h-4 w-4 text-muted-foreground opacity-0 group-hover:opacity-100 transition-opacity\" />\r\n            <div className=\"flex items-center gap-2\">\r\n              {SIGNAL_TYPE_ICONS[preset.type]}\r\n              <span className=\"font-medium\">{preset.name}</span>\r\n            </div>\r\n            <Badge variant=\"outline\" className=\"ml-auto\">\r\n              {patternOption?.label || preset.pattern}\r\n            </Badge>\r\n            <div className=\"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity\">\r\n              {onTest && (\r\n                <Button\r\n                  variant=\"ghost\"\r\n                  size=\"sm\"\r\n                  onClick={(e) => {\r\n                    e.stopPropagation();\r\n                    onTest();\r\n                  }}\r\n                  disabled={isTesting}\r\n                  className=\"h-8 w-8 p-0\"\r\n                >\r\n                  {isTesting ? (\r\n                    <PauseIcon className=\"h-4 w-4\" />\r\n                  ) : (\r\n                    <PlayIcon className=\"h-4 w-4\" />\r\n                  )}\r\n                </Button>\r\n              )}\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={(e) => {\r\n                  e.stopPropagation();\r\n                  onDuplicate();\r\n                }}\r\n                className=\"h-8 w-8 p-0\"\r\n              >\r\n                <DocumentDuplicateIcon className=\"h-4 w-4\" />\r\n              </Button>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={(e) => {\r\n                  e.stopPropagation();\r\n                  onDelete();\r\n                }}\r\n                className=\"h-8 w-8 p-0 text-destructive hover:text-destructive\"\r\n              >\r\n                <TrashIcon className=\"h-4 w-4\" />\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    );\r\n  }\r\n  \r\n  // Expanded editing view\r\n  return (\r\n    <Card className=\"border-primary\">\r\n      <CardHeader className=\"pb-2\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <CardTitle className=\"text-base\">Redigera signal</CardTitle>\r\n          <div className=\"flex items-center gap-1\">\r\n            {onTest && (\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={onTest}\r\n                disabled={isTesting}\r\n              >\r\n                {isTesting ? (\r\n                  <>\r\n                    <PauseIcon className=\"h-4 w-4 mr-1\" />\r\n                    Spelar...\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <PlayIcon className=\"h-4 w-4 mr-1\" />\r\n                    Testa\r\n                  </>\r\n                )}\r\n              </Button>\r\n            )}\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"sm\"\r\n              onClick={onDuplicate}\r\n            >\r\n              <DocumentDuplicateIcon className=\"h-4 w-4\" />\r\n            </Button>\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"sm\"\r\n              onClick={onDelete}\r\n              className=\"text-destructive hover:text-destructive\"\r\n            >\r\n              <TrashIcon className=\"h-4 w-4\" />\r\n            </Button>\r\n          </div>\r\n        </div>\r\n        <CardDescription>\r\n          Konfigurera signalens egenskaper\r\n        </CardDescription>\r\n      </CardHeader>\r\n      \r\n      <CardContent className=\"space-y-4\">\r\n        {/* Name */}\r\n        <div className=\"space-y-2\">\r\n          <Label htmlFor={`preset-name-${preset.id}`}>Namn</Label>\r\n          <Input\r\n            id={`preset-name-${preset.id}`}\r\n            value={preset.name}\r\n            onChange={(e) => onUpdate({ ...preset, name: e.target.value })}\r\n            placeholder=\"Signalnamn\"\r\n          />\r\n        </div>\r\n        \r\n        {/* Type */}\r\n        <div className=\"space-y-2\">\r\n          <Label>Signaltyp</Label>\r\n          <Select\r\n            value={preset.type}\r\n            onChange={(e) => onUpdate({ ...preset, type: e.target.value as SignalType })}\r\n            options={SIGNAL_TYPE_OPTIONS}\r\n          />\r\n        </div>\r\n        \r\n        {/* Pattern */}\r\n        <div className=\"space-y-2\">\r\n          <Label>M├Ânster</Label>\r\n          <Select\r\n            value={preset.pattern}\r\n            onChange={(e) => {\r\n              const value = e.target.value as SignalPattern;\r\n              onUpdate({\r\n                ...preset,\r\n                pattern: value,\r\n                customSteps: value === 'custom' \r\n                  ? [{ id: generateId(), onDuration: 200, offDuration: 200 }]\r\n                  : undefined,\r\n              });\r\n            }}\r\n            options={PATTERN_OPTIONS}\r\n          />\r\n          <p className=\"text-xs text-muted-foreground\">\r\n            {PATTERN_DESCRIPTIONS[preset.pattern]}\r\n          </p>\r\n        </div>\r\n        \r\n        {/* Custom Pattern Editor */}\r\n        {preset.pattern === 'custom' && preset.customSteps && (\r\n          <CustomPatternEditor\r\n            steps={preset.customSteps}\r\n            onChange={(steps) => onUpdate({ ...preset, customSteps: steps })}\r\n          />\r\n        )}\r\n        \r\n        {/* Type-specific options */}\r\n        {preset.type === 'screen_flash' && (\r\n          <div className=\"space-y-2\">\r\n            <Label>F├ñrg</Label>\r\n            <div className=\"flex flex-wrap gap-2\">\r\n              {COLOR_PRESETS.map((color) => (\r\n                <button\r\n                  key={color.value}\r\n                  type=\"button\"\r\n                  onClick={() => onUpdate({ ...preset, color: color.value })}\r\n                  className={`\r\n                    w-8 h-8 rounded-full border-2 transition-all\r\n                    ${preset.color === color.value ? 'border-primary scale-110' : 'border-transparent'}\r\n                  `}\r\n                  style={{ backgroundColor: color.value }}\r\n                  title={color.label}\r\n                />\r\n              ))}\r\n              <Input\r\n                type=\"color\"\r\n                value={preset.color || '#ffffff'}\r\n                onChange={(e) => onUpdate({ ...preset, color: e.target.value })}\r\n                className=\"w-8 h-8 p-0 border-0\"\r\n              />\r\n            </div>\r\n          </div>\r\n        )}\r\n        \r\n        {preset.type === 'audio' && (\r\n          <>\r\n            <div className=\"space-y-2\">\r\n              <Label>Ljudk├ñlla</Label>\r\n              <Select\r\n                value={preset.audioUrl || 'beep'}\r\n                onChange={(e) => onUpdate({ ...preset, audioUrl: e.target.value })}\r\n                options={AUDIO_OPTIONS}\r\n              />\r\n            </div>\r\n            \r\n            <div className=\"space-y-2\">\r\n              <Label>Volym: {Math.round((preset.volume || 0.5) * 100)}%</Label>\r\n              <Slider\r\n                value={[(preset.volume || 0.5) * 100]}\r\n                onValueChange={(values) => onUpdate({ ...preset, volume: values[0] / 100 })}\r\n                min={0}\r\n                max={100}\r\n                step={5}\r\n              />\r\n            </div>\r\n          </>\r\n        )}\r\n        \r\n        {preset.type === 'notification' && (\r\n          <>\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor={`preset-notif-title-${preset.id}`}>Rubrik</Label>\r\n              <Input\r\n                id={`preset-notif-title-${preset.id}`}\r\n                value={preset.notificationTitle || ''}\r\n                onChange={(e) => onUpdate({ ...preset, notificationTitle: e.target.value })}\r\n                placeholder=\"Notifikationsrubrik\"\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor={`preset-notif-body-${preset.id}`}>Meddelande</Label>\r\n              <Input\r\n                id={`preset-notif-body-${preset.id}`}\r\n                value={preset.notificationBody || ''}\r\n                onChange={(e) => onUpdate({ ...preset, notificationBody: e.target.value })}\r\n                placeholder=\"Valfritt meddelande\"\r\n              />\r\n            </div>\r\n          </>\r\n        )}\r\n        \r\n        {/* Repeat settings */}\r\n        <div className=\"grid grid-cols-2 gap-4\">\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor={`preset-repeat-${preset.id}`}>Upprepa</Label>\r\n            <Select\r\n              value={preset.repeatCount.toString()}\r\n              onChange={(e) => onUpdate({ ...preset, repeatCount: parseInt(e.target.value) })}\r\n              options={REPEAT_OPTIONS}\r\n            />\r\n          </div>\r\n          \r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor={`preset-delay-${preset.id}`}>Paus (ms)</Label>\r\n            <Input\r\n              id={`preset-delay-${preset.id}`}\r\n              type=\"number\"\r\n              value={preset.repeatDelay}\r\n              onChange={(e) => onUpdate({ ...preset, repeatDelay: parseInt(e.target.value) || 0 })}\r\n              min={0}\r\n              max={5000}\r\n              step={100}\r\n            />\r\n          </div>\r\n        </div>\r\n        \r\n        {/* Done button */}\r\n        <div className=\"pt-2\">\r\n          <Button variant=\"outline\" onClick={onEdit} className=\"w-full\">\r\n            Klar\r\n          </Button>\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: CustomPatternEditor\r\n// =============================================================================\r\n\r\ninterface CustomPatternEditorProps {\r\n  steps: SignalStep[];\r\n  onChange: (steps: SignalStep[]) => void;\r\n}\r\n\r\nfunction CustomPatternEditor({ steps, onChange }: CustomPatternEditorProps) {\r\n  const addStep = () => {\r\n    onChange([\r\n      ...steps,\r\n      { id: generateId(), onDuration: 200, offDuration: 200 },\r\n    ]);\r\n  };\r\n  \r\n  const updateStep = (id: string, updates: Partial<SignalStep>) => {\r\n    onChange(\r\n      steps.map((step) =>\r\n        step.id === id ? { ...step, ...updates } : step\r\n      )\r\n    );\r\n  };\r\n  \r\n  const removeStep = (id: string) => {\r\n    onChange(steps.filter((step) => step.id !== id));\r\n  };\r\n  \r\n  return (\r\n    <div className=\"space-y-3 p-3 border rounded-lg bg-muted/30\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <Label className=\"text-sm font-medium\">Steg i m├Ânstret</Label>\r\n        <Button variant=\"outline\" size=\"sm\" onClick={addStep}>\r\n          <PlusIcon className=\"h-4 w-4 mr-1\" />\r\n          L├ñgg till\r\n        </Button>\r\n      </div>\r\n      \r\n      <div className=\"space-y-2\">\r\n        {steps.map((step, index) => (\r\n          <div\r\n            key={step.id}\r\n            className=\"flex items-center gap-2 p-2 bg-background rounded border\"\r\n          >\r\n            <span className=\"text-sm text-muted-foreground w-6\">\r\n              {index + 1}.\r\n            </span>\r\n            \r\n            <div className=\"flex-1 grid grid-cols-2 gap-2\">\r\n              <div className=\"flex items-center gap-1\">\r\n                <Input\r\n                  type=\"number\"\r\n                  value={step.onDuration}\r\n                  onChange={(e) => updateStep(step.id, {\r\n                    onDuration: parseInt(e.target.value) || 0,\r\n                  })}\r\n                  className=\"h-8\"\r\n                  min={50}\r\n                  max={5000}\r\n                  step={50}\r\n                />\r\n                <span className=\"text-xs text-muted-foreground\">p├Ñ</span>\r\n              </div>\r\n              \r\n              <div className=\"flex items-center gap-1\">\r\n                <Input\r\n                  type=\"number\"\r\n                  value={step.offDuration}\r\n                  onChange={(e) => updateStep(step.id, {\r\n                    offDuration: parseInt(e.target.value) || 0,\r\n                  })}\r\n                  className=\"h-8\"\r\n                  min={0}\r\n                  max={5000}\r\n                  step={50}\r\n                />\r\n                <span className=\"text-xs text-muted-foreground\">av</span>\r\n              </div>\r\n            </div>\r\n            \r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"sm\"\r\n              onClick={() => removeStep(step.id)}\r\n              disabled={steps.length <= 1}\r\n              className=\"h-8 w-8 p-0 text-muted-foreground hover:text-destructive\"\r\n            >\r\n              <TrashIcon className=\"h-4 w-4\" />\r\n            </Button>\r\n          </div>\r\n        ))}\r\n      </div>\r\n      \r\n      {/* Pattern visualization */}\r\n      <PatternVisualization steps={steps} />\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: PatternVisualization\r\n// =============================================================================\r\n\r\ninterface PatternVisualizationProps {\r\n  steps: SignalStep[];\r\n}\r\n\r\nfunction PatternVisualization({ steps }: PatternVisualizationProps) {\r\n  const totalDuration = steps.reduce(\r\n    (sum, step) => sum + step.onDuration + step.offDuration,\r\n    0\r\n  );\r\n  \r\n  if (totalDuration === 0) return null;\r\n  \r\n  return (\r\n    <div className=\"space-y-1\">\r\n      <Label className=\"text-xs text-muted-foreground\">F├Ârhandsvisning</Label>\r\n      <div className=\"flex h-6 bg-muted rounded overflow-hidden\">\r\n        {steps.map((step) => {\r\n          const onWidth = (step.onDuration / totalDuration) * 100;\r\n          const offWidth = (step.offDuration / totalDuration) * 100;\r\n          \r\n          return (\r\n            <React.Fragment key={step.id}>\r\n              <div\r\n                className=\"bg-primary h-full\"\r\n                style={{ width: `${onWidth}%` }}\r\n                title={`P├Ñ: ${step.onDuration}ms`}\r\n              />\r\n              {step.offDuration > 0 && (\r\n                <div\r\n                  className=\"bg-muted-foreground/20 h-full\"\r\n                  style={{ width: `${offWidth}%` }}\r\n                  title={`Av: ${step.offDuration}ms`}\r\n                />\r\n              )}\r\n            </React.Fragment>\r\n          );\r\n        })}\r\n      </div>\r\n      <div className=\"text-xs text-muted-foreground text-right\">\r\n        Total: {totalDuration}ms\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function SignalPresetEditor({\r\n  presets,\r\n  onChange,\r\n  onTestSignal,\r\n  className,\r\n}: SignalPresetEditorProps) {\r\n  const [editingId, setEditingId] = useState<string | null>(null);\r\n  const [testingId, setTestingId] = useState<string | null>(null);\r\n  \r\n  const addPreset = useCallback(() => {\r\n    const newPreset = createDefaultPreset();\r\n    onChange([...presets, newPreset]);\r\n    setEditingId(newPreset.id);\r\n  }, [presets, onChange]);\r\n  \r\n  const updatePreset = useCallback((preset: SignalPreset) => {\r\n    onChange(presets.map((p) => (p.id === preset.id ? preset : p)));\r\n  }, [presets, onChange]);\r\n  \r\n  const deletePreset = useCallback((id: string) => {\r\n    onChange(presets.filter((p) => p.id !== id));\r\n    if (editingId === id) {\r\n      setEditingId(null);\r\n    }\r\n  }, [presets, onChange, editingId]);\r\n  \r\n  const duplicatePreset = useCallback((preset: SignalPreset) => {\r\n    const newPreset: SignalPreset = {\r\n      ...preset,\r\n      id: generateId(),\r\n      name: `${preset.name} (kopia)`,\r\n    };\r\n    onChange([...presets, newPreset]);\r\n    setEditingId(newPreset.id);\r\n  }, [presets, onChange]);\r\n  \r\n  const testPreset = useCallback(async (preset: SignalPreset) => {\r\n    if (!onTestSignal) return;\r\n    \r\n    setTestingId(preset.id);\r\n    try {\r\n      await onTestSignal(preset);\r\n    } finally {\r\n      setTestingId(null);\r\n    }\r\n  }, [onTestSignal]);\r\n  \r\n  return (\r\n    <div className={className}>\r\n      <div className=\"space-y-3\">\r\n        {presets.map((preset) => (\r\n          <PresetCard\r\n            key={preset.id}\r\n            preset={preset}\r\n            isEditing={editingId === preset.id}\r\n            onEdit={() => setEditingId(editingId === preset.id ? null : preset.id)}\r\n            onUpdate={updatePreset}\r\n            onDelete={() => deletePreset(preset.id)}\r\n            onDuplicate={() => duplicatePreset(preset)}\r\n            onTest={onTestSignal ? () => testPreset(preset) : undefined}\r\n            isTesting={testingId === preset.id}\r\n          />\r\n        ))}\r\n        \r\n        {presets.length === 0 && (\r\n          <div className=\"text-center py-8 text-muted-foreground\">\r\n            <SpeakerWaveIcon className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\r\n            <p>Inga signaler definierade</p>\r\n            <p className=\"text-sm\">L├ñgg till signaler som kan triggas under spelet</p>\r\n          </div>\r\n        )}\r\n        \r\n        <Button\r\n          variant=\"outline\"\r\n          onClick={addPreset}\r\n          className=\"w-full\"\r\n        >\r\n          <PlusIcon className=\"h-4 w-4 mr-2\" />\r\n          L├ñgg till signal\r\n        </Button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Exports\r\n// =============================================================================\r\n\r\nexport { PRESET_PATTERNS, SIGNAL_TYPE_OPTIONS, PATTERN_OPTIONS, COLOR_PRESETS };\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\StepPhaseNavigation.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":435,"column":52,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":437,"endColumn":15},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":446,"column":47,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":448,"endColumn":13},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"F├Ârsta steget\". Consider using useTranslations() or t() for internationalization.","line":471,"column":23,"nodeType":"Literal","messageId":"hardcodedString","endLine":471,"endColumn":38},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":483,"column":56,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":485,"endColumn":15},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":491,"column":16,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":493,"endColumn":17},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"G├Ñ till steg \". Consider using useTranslations() or t() for internationalization.","line":521,"column":26,"nodeType":"TemplateLiteral","messageId":"hardcodedString","endLine":521,"endColumn":49},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":545,"column":54,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":547,"endColumn":17},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":556,"column":49,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":558,"endColumn":15},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":583,"column":58,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":585,"endColumn":17},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":591,"column":18,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":593,"endColumn":19},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"G├Ñ till fas \". Consider using useTranslations() or t() for internationalization.","line":611,"column":28,"nodeType":"TemplateLiteral","messageId":"hardcodedString","endLine":611,"endColumn":50}],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":295,"column":19,"nodeType":"JSXOpeningElement","endLine":299,"endColumn":21,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":11,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * StepPhaseNavigation Component\r\n * \r\n * Navigation controls for facilitators to move between steps and phases.\r\n * Supports independent step/phase navigation as per design.\r\n */\r\n\r\n'use client';\r\n\r\nimport { useCallback } from 'react';\r\nimport { \r\n  ChevronLeftIcon, \r\n  ChevronRightIcon,\r\n  ChevronDoubleLeftIcon,\r\n  ChevronDoubleRightIcon,\r\n  PlayIcon,\r\n} from '@heroicons/react/24/solid';\r\nimport { Button } from '@/components/ui/button';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface StepInfo {\r\n  id: string;\r\n  title: string;\r\n  description?: string;\r\n  durationMinutes?: number;\r\n  leaderScript?: string;\r\n  media?: { type: string; url: string; altText?: string };\r\n}\r\n\r\nexport interface PhaseInfo {\r\n  id: string;\r\n  name: string;\r\n  description?: string;\r\n}\r\n\r\nexport interface StepPhaseNavigationProps {\r\n  /** Current step index (0-based) */\r\n  currentStepIndex: number;\r\n  /** Total number of steps */\r\n  totalSteps: number;\r\n  /** Step info for display */\r\n  steps?: StepInfo[];\r\n  /** Current phase index (0-based) */\r\n  currentPhaseIndex: number;\r\n  /** Total number of phases */\r\n  totalPhases: number;\r\n  /** Phase info for display */\r\n  phases?: PhaseInfo[];\r\n  /** Called when step changes */\r\n  onStepChange: (index: number) => void;\r\n  /** Called when phase changes */\r\n  onPhaseChange: (index: number) => void;\r\n  /** Whether controls are disabled */\r\n  disabled?: boolean;\r\n  /** Show phases section */\r\n  showPhases?: boolean;\r\n  /** Compact mode (horizontal layout) */\r\n  compact?: boolean;\r\n  /** Unified mode: dots for steps, lines for phases in one component */\r\n  unified?: boolean;\r\n}\r\n\r\n// =============================================================================\r\n// Component\r\n// =============================================================================\r\n\r\nexport function StepPhaseNavigation({\r\n  currentStepIndex,\r\n  totalSteps,\r\n  steps,\r\n  currentPhaseIndex,\r\n  totalPhases,\r\n  phases,\r\n  onStepChange,\r\n  onPhaseChange,\r\n  disabled = false,\r\n  showPhases = true,\r\n  compact = false,\r\n  unified = false,\r\n}: StepPhaseNavigationProps) {\r\n  // Navigation handlers\r\n  const goToFirstStep = useCallback(() => {\r\n    onStepChange(0);\r\n  }, [onStepChange]);\r\n  \r\n  const goToPrevStep = useCallback(() => {\r\n    if (currentStepIndex > 0) {\r\n      onStepChange(currentStepIndex - 1);\r\n    }\r\n  }, [currentStepIndex, onStepChange]);\r\n  \r\n  const goToNextStep = useCallback(() => {\r\n    if (currentStepIndex < totalSteps - 1) {\r\n      onStepChange(currentStepIndex + 1);\r\n    }\r\n  }, [currentStepIndex, totalSteps, onStepChange]);\r\n  \r\n  const goToLastStep = useCallback(() => {\r\n    onStepChange(totalSteps - 1);\r\n  }, [totalSteps, onStepChange]);\r\n  \r\n  const goToFirstPhase = useCallback(() => {\r\n    onPhaseChange(0);\r\n  }, [onPhaseChange]);\r\n  \r\n  const goToPrevPhase = useCallback(() => {\r\n    if (currentPhaseIndex > 0) {\r\n      onPhaseChange(currentPhaseIndex - 1);\r\n    }\r\n  }, [currentPhaseIndex, onPhaseChange]);\r\n  \r\n  const goToNextPhase = useCallback(() => {\r\n    if (currentPhaseIndex < totalPhases - 1) {\r\n      onPhaseChange(currentPhaseIndex + 1);\r\n    }\r\n  }, [currentPhaseIndex, totalPhases, onPhaseChange]);\r\n  \r\n  // Check if we're in \"not started\" state\r\n  const stepNotStarted = currentStepIndex < 0;\r\n  const phaseNotStarted = currentPhaseIndex < 0;\r\n  \r\n  // Current step/phase info\r\n  const currentStep = stepNotStarted ? null : steps?.[currentStepIndex];\r\n  const currentPhase = phaseNotStarted ? null : phases?.[currentPhaseIndex];\r\n\r\n  if (compact) {\r\n    return (\r\n      <div className=\"flex items-center justify-between gap-4 rounded-xl border border-border bg-card p-3\">\r\n        {/* Steps */}\r\n        <div className=\"flex items-center gap-2\">\r\n          {stepNotStarted ? (\r\n            <Button\r\n              variant=\"primary\"\r\n              size=\"sm\"\r\n              onClick={goToFirstStep}\r\n              disabled={disabled}\r\n              className=\"gap-1.5\"\r\n            >\r\n              <PlayIcon className=\"h-4 w-4\" />\r\n              Starta\r\n            </Button>\r\n          ) : (\r\n            <>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={goToPrevStep}\r\n                disabled={disabled || currentStepIndex === 0}\r\n                className=\"h-8 w-8 p-0\"\r\n              >\r\n                <ChevronLeftIcon className=\"h-4 w-4\" />\r\n              </Button>\r\n              <div className=\"text-center\">\r\n                <p className=\"text-xs font-medium text-muted-foreground\">Steg</p>\r\n                <p className=\"text-sm font-bold\">{currentStepIndex + 1} / {totalSteps}</p>\r\n              </div>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={goToNextStep}\r\n                disabled={disabled || currentStepIndex === totalSteps - 1}\r\n                className=\"h-8 w-8 p-0\"\r\n              >\r\n                <ChevronRightIcon className=\"h-4 w-4\" />\r\n              </Button>\r\n            </>\r\n          )}\r\n        </div>\r\n        \r\n        {/* Phases */}\r\n        {showPhases && totalPhases > 0 && (\r\n          <div className=\"flex items-center gap-2\">\r\n            {phaseNotStarted ? (\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={goToFirstPhase}\r\n                disabled={disabled}\r\n                className=\"gap-1.5\"\r\n              >\r\n                <PlayIcon className=\"h-4 w-4\" />\r\n                Starta fas\r\n              </Button>\r\n            ) : (\r\n              <>\r\n                <Button\r\n                  variant=\"ghost\"\r\n                  size=\"sm\"\r\n                  onClick={goToPrevPhase}\r\n                  disabled={disabled || currentPhaseIndex === 0}\r\n                  className=\"h-8 w-8 p-0\"\r\n                >\r\n                  <ChevronLeftIcon className=\"h-4 w-4\" />\r\n                </Button>\r\n                <div className=\"text-center\">\r\n                  <p className=\"text-xs font-medium text-muted-foreground\">Fas</p>\r\n                  <p className=\"text-sm font-bold\">{currentPhaseIndex + 1} / {totalPhases}</p>\r\n                </div>\r\n                <Button\r\n                  variant=\"ghost\"\r\n                  size=\"sm\"\r\n                  onClick={goToNextPhase}\r\n                  disabled={disabled || currentPhaseIndex === totalPhases - 1}\r\n                  className=\"h-8 w-8 p-0\"\r\n                >\r\n                  <ChevronRightIcon className=\"h-4 w-4\" />\r\n                </Button>\r\n              </>\r\n            )}\r\n          </div>\r\n        )}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Unified mode: combined step dots + phase lines in one card\r\n  if (unified) {\r\n    return (\r\n      <div className=\"rounded-2xl border border-border bg-card p-4 space-y-4\">\r\n        {/* Header row with step info */}\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <h3 className=\"text-sm font-semibold text-muted-foreground uppercase tracking-wider\">\r\n              Navigation\r\n            </h3>\r\n            {!stepNotStarted && currentStep && (\r\n              <p className=\"text-sm font-medium text-foreground mt-1\">\r\n                Steg {currentStepIndex + 1}: {currentStep.title}\r\n                {currentStep.durationMinutes && (\r\n                  <span className=\"text-muted-foreground ml-2\">({currentStep.durationMinutes} min)</span>\r\n                )}\r\n              </p>\r\n            )}\r\n          </div>\r\n          {stepNotStarted ? (\r\n            <Button\r\n              variant=\"primary\"\r\n              size=\"sm\"\r\n              onClick={goToFirstStep}\r\n              disabled={disabled}\r\n              className=\"gap-1.5\"\r\n            >\r\n              <PlayIcon className=\"h-4 w-4\" />\r\n              Starta spelet\r\n            </Button>\r\n          ) : (\r\n            <div className=\"flex items-center gap-1\">\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={goToPrevStep}\r\n                disabled={disabled || currentStepIndex === 0}\r\n                className=\"h-8 w-8 p-0\"\r\n              >\r\n                <ChevronLeftIcon className=\"h-4 w-4\" />\r\n              </Button>\r\n              <span className=\"text-sm font-medium text-muted-foreground min-w-[4rem] text-center\">\r\n                {currentStepIndex + 1} / {totalSteps}\r\n              </span>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={goToNextStep}\r\n                disabled={disabled || currentStepIndex === totalSteps - 1}\r\n                className=\"h-8 w-8 p-0\"\r\n              >\r\n                <ChevronRightIcon className=\"h-4 w-4\" />\r\n              </Button>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Step content: description + leader script */}\r\n        {!stepNotStarted && currentStep && (currentStep.description || currentStep.leaderScript || currentStep.media?.url) && (\r\n          <div className=\"space-y-3 rounded-xl bg-muted/50 p-3\">\r\n            {currentStep.description && (\r\n              <div>\r\n                <p className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-1\">\r\n                  Beskrivning\r\n                </p>\r\n                <p className=\"text-sm text-foreground whitespace-pre-wrap\">{currentStep.description}</p>\r\n              </div>\r\n            )}\r\n\r\n            {currentStep.media?.url && (\r\n              <div>\r\n                <p className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-1\">\r\n                  Media\r\n                </p>\r\n                <div className=\"overflow-hidden rounded-lg border bg-background\">\r\n                  {/* eslint-disable-next-line @next/next/no-img-element */}\r\n                  <img\r\n                    src={currentStep.media.url}\r\n                    alt={currentStep.media.altText ?? currentStep.title}\r\n                    className=\"h-auto w-full\"\r\n                  />\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {currentStep.leaderScript && (\r\n              <div>\r\n                <p className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-1\">\r\n                  ­ƒÆ¼ Ledarskript\r\n                </p>\r\n                <div className=\"rounded-lg border border-primary/20 bg-primary/5 p-3\">\r\n                  <p className=\"text-sm text-foreground italic whitespace-pre-wrap\">&ldquo;{currentStep.leaderScript}&rdquo;</p>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n        {/* Step dots row */}\r\n        {!stepNotStarted && (\r\n          <div className=\"flex items-center justify-center gap-2\">\r\n            {Array.from({ length: totalSteps }).map((_, i) => (\r\n              <button\r\n                key={i}\r\n                onClick={() => onStepChange(i)}\r\n                disabled={disabled}\r\n                className={`h-3 w-3 rounded-full transition-all hover:scale-125 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 ${\r\n                  i === currentStepIndex\r\n                    ? 'bg-primary scale-125 ring-2 ring-primary ring-offset-2'\r\n                    : i < currentStepIndex\r\n                      ? 'bg-primary/50'\r\n                      : 'bg-muted hover:bg-muted-foreground/50'\r\n                }`}\r\n                title={steps?.[i]?.title ?? `Steg ${i + 1}`}\r\n              />\r\n            ))}\r\n          </div>\r\n        )}\r\n\r\n        {/* Phase section - lines/segments */}\r\n        {showPhases && totalPhases > 0 && !stepNotStarted && (\r\n          <div className=\"border-t border-border pt-4\">\r\n            <div className=\"flex items-center justify-between mb-2\">\r\n              <span className=\"text-xs font-medium text-muted-foreground uppercase tracking-wider\">\r\n                Fas\r\n              </span>\r\n              {phaseNotStarted ? (\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  onClick={goToFirstPhase}\r\n                  disabled={disabled}\r\n                  className=\"gap-1 h-7 text-xs\"\r\n                >\r\n                  <PlayIcon className=\"h-3 w-3\" />\r\n                  Starta fas\r\n                </Button>\r\n              ) : (\r\n                <div className=\"flex items-center gap-1\">\r\n                  <Button\r\n                    variant=\"ghost\"\r\n                    size=\"sm\"\r\n                    onClick={goToPrevPhase}\r\n                    disabled={disabled || currentPhaseIndex === 0}\r\n                    className=\"h-6 w-6 p-0\"\r\n                  >\r\n                    <ChevronLeftIcon className=\"h-3 w-3\" />\r\n                  </Button>\r\n                  <span className=\"text-xs font-medium text-muted-foreground\">\r\n                    {currentPhaseIndex + 1} / {totalPhases}\r\n                  </span>\r\n                  <Button\r\n                    variant=\"ghost\"\r\n                    size=\"sm\"\r\n                    onClick={goToNextPhase}\r\n                    disabled={disabled || currentPhaseIndex === totalPhases - 1}\r\n                    className=\"h-6 w-6 p-0\"\r\n                  >\r\n                    <ChevronRightIcon className=\"h-3 w-3\" />\r\n                  </Button>\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {/* Phase progress bar with segments */}\r\n            {!phaseNotStarted && (\r\n              <>\r\n                <div className=\"flex gap-1 h-2\">\r\n                  {Array.from({ length: totalPhases }).map((_, i) => (\r\n                    <button\r\n                      key={i}\r\n                      onClick={() => onPhaseChange(i)}\r\n                      disabled={disabled}\r\n                      className={`flex-1 rounded-sm transition-all hover:opacity-80 focus:outline-none focus:ring-2 focus:ring-secondary focus:ring-offset-1 ${\r\n                        i === currentPhaseIndex\r\n                          ? 'bg-secondary'\r\n                          : i < currentPhaseIndex\r\n                            ? 'bg-secondary/40'\r\n                            : 'bg-muted'\r\n                      }`}\r\n                      title={phases?.[i]?.name ?? `Fas ${i + 1}`}\r\n                    />\r\n                  ))}\r\n                </div>\r\n                {/* Current phase name */}\r\n                {currentPhase && (\r\n                  <p className=\"text-xs text-muted-foreground mt-2 text-center\">\r\n                    {currentPhase.name}\r\n                    {currentPhase.description && ` ÔÇô ${currentPhase.description}`}\r\n                  </p>\r\n                )}\r\n              </>\r\n            )}\r\n          </div>\r\n        )}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Steps Navigation */}\r\n      <div className=\"rounded-2xl border border-border bg-card p-4\">\r\n        <div className=\"mb-3 flex items-center justify-between\">\r\n          <h3 className=\"text-sm font-semibold text-muted-foreground uppercase tracking-wider\">\r\n            Steg\r\n          </h3>\r\n          <span className=\"text-sm font-medium text-muted-foreground\">\r\n            {stepNotStarted ? 'Ej startat' : `${currentStepIndex + 1} av ${totalSteps}`}\r\n          </span>\r\n        </div>\r\n        \r\n        {/* Not started state */}\r\n        {stepNotStarted ? (\r\n          <div className=\"space-y-4\">\r\n            <div className=\"rounded-xl bg-muted/50 p-4 text-center\">\r\n              <p className=\"text-muted-foreground\">\r\n                Stegen har inte startats ├ñnnu. Klicka p├Ñ knappen nedan f├Âr att starta f├Ârsta steget.\r\n              </p>\r\n            </div>\r\n            <Button\r\n              variant=\"primary\"\r\n              size=\"lg\"\r\n              onClick={goToFirstStep}\r\n              disabled={disabled}\r\n              className=\"w-full gap-2\"\r\n            >\r\n              <PlayIcon className=\"h-5 w-5\" />\r\n              Starta f├Ârsta steget\r\n            </Button>\r\n          </div>\r\n        ) : (\r\n          <>\r\n            {/* Current step info */}\r\n            {currentStep && (\r\n              <div className=\"mb-4 rounded-xl bg-muted/50 p-3\">\r\n                <p className=\"font-medium text-foreground\">{currentStep.title}</p>\r\n                {currentStep.durationMinutes && (\r\n                  <p className=\"mt-1 text-sm text-muted-foreground\">\r\n                    {currentStep.durationMinutes} min\r\n                  </p>\r\n                )}\r\n              </div>\r\n            )}\r\n        \r\n            {/* Step controls */}\r\n            <div className=\"flex items-center gap-2\">\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={goToFirstStep}\r\n                disabled={disabled || currentStepIndex === 0}\r\n                title=\"F├Ârsta steget\"\r\n                className=\"p-2\"\r\n              >\r\n                <ChevronDoubleLeftIcon className=\"h-4 w-4\" />\r\n              </Button>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"lg\"\r\n                onClick={goToPrevStep}\r\n                disabled={disabled || currentStepIndex === 0}\r\n                className=\"flex-1 gap-2\"\r\n              >\r\n                <ChevronLeftIcon className=\"h-4 w-4\" />\r\n                F├Âreg├Ñende\r\n              </Button>\r\n              <Button\r\n                size=\"lg\"\r\n                onClick={goToNextStep}\r\n                disabled={disabled || currentStepIndex === totalSteps - 1}\r\n                className=\"flex-1 gap-2\"\r\n              >\r\n                N├ñsta\r\n                <ChevronRightIcon className=\"h-4 w-4\" />\r\n              </Button>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={goToLastStep}\r\n                disabled={disabled || currentStepIndex === totalSteps - 1}\r\n                title=\"Sista steget\"\r\n                className=\"p-2\"\r\n              >\r\n                <ChevronDoubleRightIcon className=\"h-4 w-4\" />\r\n              </Button>\r\n            </div>\r\n        \r\n            {/* Step dots */}\r\n            <div className=\"mt-4 flex flex-wrap justify-center gap-1\">\r\n              {Array.from({ length: totalSteps }).map((_, i) => (\r\n                <button\r\n                  key={i}\r\n                  onClick={() => onStepChange(i)}\r\n                  disabled={disabled}\r\n                  className={`h-2.5 w-2.5 rounded-full transition-all hover:scale-125 ${\r\n                    i === currentStepIndex \r\n                      ? 'bg-primary scale-125' \r\n                      : i < currentStepIndex \r\n                        ? 'bg-primary/40' \r\n                        : 'bg-muted hover:bg-muted-foreground/50'\r\n                  }`}\r\n                  title={`G├Ñ till steg ${i + 1}`}\r\n                />\r\n              ))}\r\n            </div>\r\n          </>\r\n        )}\r\n      </div>\r\n      \r\n      {/* Phases Navigation */}\r\n      {showPhases && totalPhases > 0 && (\r\n        <div className=\"rounded-2xl border border-border bg-card p-4\">\r\n          <div className=\"mb-3 flex items-center justify-between\">\r\n            <h3 className=\"text-sm font-semibold text-muted-foreground uppercase tracking-wider\">\r\n              Fas\r\n            </h3>\r\n            <span className=\"text-sm font-medium text-muted-foreground\">\r\n              {phaseNotStarted ? 'Ej startat' : `${currentPhaseIndex + 1} av ${totalPhases}`}\r\n            </span>\r\n          </div>\r\n          \r\n          {/* Not started state */}\r\n          {phaseNotStarted ? (\r\n            <div className=\"space-y-4\">\r\n              <div className=\"rounded-xl bg-muted/50 p-4 text-center\">\r\n                <p className=\"text-muted-foreground\">\r\n                  Faserna har inte startats ├ñnnu. Klicka p├Ñ knappen nedan f├Âr att starta f├Ârsta fasen.\r\n                </p>\r\n              </div>\r\n              <Button\r\n                variant=\"primary\"\r\n                size=\"lg\"\r\n                onClick={goToFirstPhase}\r\n                disabled={disabled}\r\n                className=\"w-full gap-2\"\r\n              >\r\n                <PlayIcon className=\"h-5 w-5\" />\r\n                Starta f├Ârsta fasen\r\n              </Button>\r\n            </div>\r\n          ) : (\r\n            <>\r\n              {/* Current phase info */}\r\n              {currentPhase && (\r\n                <div className=\"mb-4 rounded-xl bg-muted/50 p-3\">\r\n                  <p className=\"font-medium text-foreground\">{currentPhase.name}</p>\r\n                  {currentPhase.description && (\r\n                    <p className=\"mt-1 text-sm text-muted-foreground\">\r\n                      {currentPhase.description}\r\n                    </p>\r\n                  )}\r\n                </div>\r\n              )}\r\n          \r\n              {/* Phase controls */}\r\n              <div className=\"flex items-center gap-2\">\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"lg\"\r\n                  onClick={goToPrevPhase}\r\n                  disabled={disabled || currentPhaseIndex === 0}\r\n                  className=\"flex-1 gap-2\"\r\n                >\r\n                  <ChevronLeftIcon className=\"h-4 w-4\" />\r\n                  F├Âreg├Ñende\r\n                </Button>\r\n                <Button\r\n                  size=\"lg\"\r\n                  onClick={goToNextPhase}\r\n                  disabled={disabled || currentPhaseIndex === totalPhases - 1}\r\n                  className=\"flex-1 gap-2\"\r\n                >\r\n                  N├ñsta\r\n                  <ChevronRightIcon className=\"h-4 w-4\" />\r\n                </Button>\r\n              </div>\r\n          \r\n              {/* Phase dots */}\r\n              <div className=\"mt-4 flex flex-wrap justify-center gap-1\">\r\n                {Array.from({ length: totalPhases }).map((_, i) => (\r\n                  <button\r\n                    key={i}\r\n                    onClick={() => onPhaseChange(i)}\r\n                    disabled={disabled}\r\n                    className={`h-2.5 w-2.5 rounded-full transition-all hover:scale-125 ${\r\n                      i === currentPhaseIndex \r\n                        ? 'bg-secondary scale-125' \r\n                        : i < currentPhaseIndex \r\n                          ? 'bg-secondary/40' \r\n                          : 'bg-muted hover:bg-muted-foreground/50'\r\n                    }`}\r\n                    title={`G├Ñ till fas ${i + 1}`}\r\n                  />\r\n                ))}\r\n              </div>\r\n            </>\r\n          )}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\StepViewer.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":98,"column":109,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":98,"endColumn":117}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ClockIcon, CubeIcon, DocumentTextIcon, ShieldExclamationIcon } from \"@heroicons/react/24/outline\";\nimport type { Step } from \"../types\";\n\ntype StepViewerProps = {\n  step: Step;\n  index: number;\n  total: number;\n  timerSeconds?: number;\n  timerTotalSeconds?: number;\n  timerRunning?: boolean;\n  formatTime?: (seconds: number) => string;\n};\n\nexport function StepViewer({ step, index, total, timerSeconds, timerTotalSeconds, timerRunning, formatTime }: StepViewerProps) {\n  const totalSeconds = typeof timerTotalSeconds === \"number\" ? timerTotalSeconds : 0;\n  const remainingSeconds = typeof timerSeconds === \"number\" ? timerSeconds : totalSeconds;\n  const timerProgress = totalSeconds > 0 ? Math.max(0, Math.min(1, remainingSeconds / totalSeconds)) : null;\n  const timerLabel = formatTime ? formatTime(remainingSeconds) : `${remainingSeconds}s`;\n\n  return (\n    <article className=\"space-y-5 rounded-3xl border border-border/60 bg-card p-5 shadow-md sm:p-6\">\n      <div className=\"flex items-start justify-between gap-3\">\n        <div className=\"space-y-1\">\n          <div className=\"flex items-center gap-2\">\n            <span className=\"flex h-6 w-6 items-center justify-center rounded-full bg-primary text-[10px] font-bold text-primary-foreground\">\n              {index + 1}\n            </span>\n            <p className=\"text-[10px] font-bold uppercase tracking-[0.2em] text-primary\">\n              Steg {index + 1} av {total}\n            </p>\n          </div>\n          <div className=\"flex flex-wrap items-center gap-2\">\n            <h2 className=\"text-xl font-semibold text-foreground sm:text-2xl\">{step.title}</h2>\n            {step.tag ? (\n              <span className=\"inline-flex items-center rounded-full bg-muted px-3 py-1 text-[11px] font-semibold text-muted-foreground\">\n                {step.tag}\n              </span>\n            ) : null}\n          </div>\n        </div>\n        {step.durationMinutes ? (\n          <span className=\"inline-flex shrink-0 items-center gap-1.5 rounded-full bg-primary/10 px-3 py-1.5 text-xs font-semibold text-primary\">\n            <ClockIcon className=\"h-3.5 w-3.5\" aria-hidden />\n            {step.durationMinutes} min\n          </span>\n        ) : null}\n      </div>\n\n      <p className=\"text-base leading-relaxed text-foreground sm:text-lg\">{step.description}</p>\n\n      {timerProgress !== null && (\n        <div className=\"space-y-2 rounded-2xl bg-muted/40 p-4\">\n          <div className=\"flex items-center justify-between text-xs font-medium text-muted-foreground\">\n            <span>{timerRunning ? \"Tid p├Ñg├Ñr\" : \"Tid pausad\"}</span>\n            <span className=\"text-sm font-semibold text-foreground\">{timerLabel}</span>\n          </div>\n          <div className=\"h-2 w-full overflow-hidden rounded-full bg-muted\">\n            <div\n              className=\"h-full rounded-full bg-primary transition-all duration-300 ease-out\"\n              style={{ width: `${timerProgress * 100}%` }}\n              aria-hidden\n            />\n          </div>\n        </div>\n      )}\n\n      {step.materials && step.materials.length > 0 && (\n        <div className=\"space-y-2.5 rounded-2xl bg-muted/40 p-4\">\n          <div className=\"flex items-center gap-2\">\n            <CubeIcon className=\"h-4 w-4 text-muted-foreground\" aria-hidden />\n            <p className=\"text-xs font-bold uppercase tracking-[0.15em] text-muted-foreground\">Material</p>\n          </div>\n          <ul className=\"space-y-1.5 pl-6 text-sm text-foreground\">\n            {step.materials.map((item) => (\n              <li key={item} className=\"flex items-start gap-2\">\n                <span className=\"mt-1.5 h-1.5 w-1.5 shrink-0 rounded-full bg-muted-foreground/50\" aria-hidden />\n                <span>{item}</span>\n              </li>\n            ))}\n          </ul>\n        </div>\n      )}\n\n      {step.note && (\n        <div className=\"space-y-2.5 rounded-2xl bg-muted/40 p-4\">\n          <div className=\"flex items-center gap-2\">\n            <DocumentTextIcon className=\"h-4 w-4 text-muted-foreground\" aria-hidden />\n            <p className=\"text-xs font-bold uppercase tracking-[0.15em] text-muted-foreground\">Anteckning</p>\n          </div>\n          <p className=\"text-sm leading-relaxed text-foreground\">{step.note}</p>\n        </div>\n      )}\n\n      {step.safety && (\n        <div className=\"space-y-2.5 rounded-2xl border border-amber-200 bg-amber-50 p-4 dark:border-amber-800 dark:bg-amber-950/30\">\n          <div className=\"flex items-center gap-2\">\n            <ShieldExclamationIcon className=\"h-4 w-4 text-amber-600 dark:text-amber-400\" aria-hidden />\n            <p className=\"text-xs font-bold uppercase tracking-[0.15em] text-amber-700 dark:text-amber-300\">S├ñkerhet</p>\n          </div>\n          <p className=\"text-sm leading-relaxed text-amber-900 dark:text-amber-100\">{step.safety}</p>\n        </div>\n      )}\n    </article>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\StoryViewModal.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":145,"column":96,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":147,"endColumn":19},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":163,"column":14,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":165,"endColumn":13},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":231,"column":18,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":231,"endColumn":46},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":255,"column":55,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":257,"endColumn":11}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * StoryViewModal Component\r\n * \r\n * Shows all steps with leader scripts as a scrollable narrative.\r\n * Helps the host preview the full game flow before or during a session.\r\n * \r\n * Task 3.4 - Session Cockpit Architecture\r\n */\r\n\r\n'use client';\r\n\r\nimport { useState } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { cn } from '@/lib/utils';\r\nimport {\r\n  XMarkIcon,\r\n  BookOpenIcon,\r\n  ChevronDownIcon,\r\n  ChevronUpIcon,\r\n  ClockIcon,\r\n  DocumentTextIcon,\r\n} from '@heroicons/react/24/outline';\r\nimport type { CockpitStep } from '@/types/session-cockpit';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface StoryViewModalProps {\r\n  /** Is the modal open? */\r\n  open: boolean;\r\n  /** Called when user closes the modal */\r\n  onClose: () => void;\r\n  /** All steps in the game */\r\n  steps: CockpitStep[];\r\n  /** Current step index (for highlighting) */\r\n  currentStepIndex?: number;\r\n  /** Session/game name */\r\n  title?: string;\r\n  /** Callback when user clicks to navigate to a step */\r\n  onNavigateToStep?: (stepIndex: number) => void;\r\n}\r\n\r\n// =============================================================================\r\n// StepCard Component\r\n// =============================================================================\r\n\r\nfunction StepCard({\r\n  step,\r\n  index,\r\n  isCurrent,\r\n  isPast,\r\n  onNavigate,\r\n}: {\r\n  step: CockpitStep;\r\n  index: number;\r\n  isCurrent: boolean;\r\n  isPast: boolean;\r\n  onNavigate?: () => void;\r\n}) {\r\n  const [isExpanded, setIsExpanded] = useState(isCurrent);\r\n  \r\n  const hasLeaderScript = Boolean(step.leaderScript);\r\n  \r\n  return (\r\n    <Card \r\n      className={cn(\r\n        'overflow-hidden transition-all',\r\n        isCurrent && 'ring-2 ring-primary shadow-lg',\r\n        isPast && 'opacity-60'\r\n      )}\r\n    >\r\n      {/* Header - always visible */}\r\n      <button\r\n        type=\"button\"\r\n        onClick={() => setIsExpanded(!isExpanded)}\r\n        className=\"w-full flex items-start gap-3 p-4 hover:bg-muted/50 transition-colors text-left\"\r\n      >\r\n        {/* Step number */}\r\n        <div className={cn(\r\n          'flex h-8 w-8 shrink-0 items-center justify-center rounded-full text-sm font-semibold',\r\n          isCurrent \r\n            ? 'bg-primary text-primary-foreground' \r\n            : isPast \r\n              ? 'bg-muted text-muted-foreground' \r\n              : 'bg-primary/10 text-primary'\r\n        )}>\r\n          {index + 1}\r\n        </div>\r\n        \r\n        {/* Title and meta */}\r\n        <div className=\"flex-1 min-w-0\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <h3 className=\"font-medium text-foreground truncate\">\r\n              {step.title || 'Namnl├Âst steg'}\r\n            </h3>\r\n            {isCurrent && (\r\n              <Badge variant=\"primary\" size=\"sm\">Nu</Badge>\r\n            )}\r\n          </div>\r\n          <div className=\"flex items-center gap-3 mt-0.5 text-xs text-muted-foreground\">\r\n            {step.durationMinutes && (\r\n              <span className=\"flex items-center gap-1\">\r\n                <ClockIcon className=\"h-3.5 w-3.5\" />\r\n                {step.durationMinutes} min\r\n              </span>\r\n            )}\r\n            {hasLeaderScript && (\r\n              <span className=\"flex items-center gap-1 text-amber-600\">\r\n                <DocumentTextIcon className=\"h-3.5 w-3.5\" />\r\n                Script\r\n              </span>\r\n            )}\r\n          </div>\r\n        </div>\r\n        \r\n        {/* Expand/collapse icon */}\r\n        <div className=\"shrink-0 text-muted-foreground\">\r\n          {isExpanded ? (\r\n            <ChevronUpIcon className=\"h-5 w-5\" />\r\n          ) : (\r\n            <ChevronDownIcon className=\"h-5 w-5\" />\r\n          )}\r\n        </div>\r\n      </button>\r\n      \r\n      {/* Expanded content */}\r\n      {isExpanded && (\r\n        <div className=\"px-4 pb-4 space-y-3 border-t pt-3\">\r\n          {/* Description */}\r\n          {step.description && (\r\n            <div className=\"text-sm text-muted-foreground\">\r\n              {step.description}\r\n            </div>\r\n          )}\r\n          \r\n          {/* Leader Script */}\r\n          {hasLeaderScript && (\r\n            <div className=\"p-3 bg-amber-50 border border-amber-200 rounded-lg dark:bg-amber-950/20 dark:border-amber-800\">\r\n              <div className=\"flex items-start gap-2\">\r\n                <DocumentTextIcon className=\"h-5 w-5 text-amber-600 shrink-0 mt-0.5\" />\r\n                <div>\r\n                  <div className=\"text-xs font-medium text-amber-700 dark:text-amber-400 mb-1\">\r\n                    S├äGA TILL GRUPPEN\r\n                  </div>\r\n                  <div className=\"text-sm text-amber-900 dark:text-amber-100 whitespace-pre-wrap\">\r\n                    {step.leaderScript}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n          \r\n          {/* Navigate button */}\r\n          {onNavigate && !isCurrent && (\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              onClick={onNavigate}\r\n              className=\"w-full\"\r\n            >\r\n              G├Ñ till detta steg\r\n            </Button>\r\n          )}\r\n        </div>\r\n      )}\r\n    </Card>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function StoryViewModal({\r\n  open,\r\n  onClose,\r\n  steps,\r\n  currentStepIndex = -1,\r\n  title = 'Ber├ñttelsen',\r\n  onNavigateToStep,\r\n}: StoryViewModalProps) {\r\n  if (!open) return null;\r\n  \r\n  const totalDuration = steps.reduce((sum, s) => sum + (s.durationMinutes ?? 0), 0);\r\n  const stepsWithScripts = steps.filter((s) => s.leaderScript).length;\r\n  \r\n  return (\r\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center\">\r\n      {/* Backdrop */}\r\n      <div \r\n        className=\"absolute inset-0 bg-black/50 backdrop-blur-sm\"\r\n        onClick={onClose}\r\n      />\r\n      \r\n      {/* Modal */}\r\n      <div className=\"relative w-full max-w-2xl max-h-[90vh] bg-background rounded-xl shadow-2xl flex flex-col mx-4\">\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between border-b px-6 py-4\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <BookOpenIcon className=\"h-6 w-6 text-primary\" />\r\n            <div>\r\n              <h2 className=\"font-semibold text-foreground text-lg\">{title}</h2>\r\n              <div className=\"text-xs text-muted-foreground flex items-center gap-3\">\r\n                <span>{steps.length} steg</span>\r\n                {totalDuration > 0 && <span>~{totalDuration} min totalt</span>}\r\n                {stepsWithScripts > 0 && (\r\n                  <span className=\"text-amber-600\">\r\n                    {stepsWithScripts} scripts\r\n                  </span>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            onClick={onClose}\r\n          >\r\n            <XMarkIcon className=\"h-5 w-5\" />\r\n          </Button>\r\n        </div>\r\n        \r\n        {/* Content */}\r\n        <div className=\"flex-1 overflow-y-auto p-6\">\r\n          {steps.length === 0 ? (\r\n            <div className=\"text-center py-12 text-muted-foreground\">\r\n              <BookOpenIcon className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\r\n              <p>Inga steg i detta spel ├ñnnu.</p>\r\n            </div>\r\n          ) : (\r\n            <div className=\"space-y-3\">\r\n              {steps.map((step, index) => (\r\n                <StepCard\r\n                  key={step.id}\r\n                  step={step}\r\n                  index={index}\r\n                  isCurrent={index === currentStepIndex}\r\n                  isPast={index < currentStepIndex}\r\n                  onNavigate={\r\n                    onNavigateToStep\r\n                      ? () => onNavigateToStep(index)\r\n                      : undefined\r\n                  }\r\n                />\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n        \r\n        {/* Footer */}\r\n        <div className=\"border-t px-6 py-4 flex justify-end\">\r\n          <Button variant=\"outline\" onClick={onClose}>\r\n            St├ñng\r\n          </Button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\TimeBankLivePanel.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":189,"column":56,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":189,"endColumn":73},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":195,"column":47,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":195,"endColumn":66},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":221,"column":71,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":223,"endColumn":7},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":372,"column":56,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":374,"endColumn":17},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":493,"column":61,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":494,"endColumn":13}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * TimeBankLivePanel Component\r\n * \r\n * Live display and control panel for TimeBank during Director Mode.\r\n * Shows current balance, recent changes, and allows manual adjustments.\r\n * \r\n * Task 4.6 - Session Cockpit Architecture\r\n */\r\n\r\n'use client';\r\n\r\nimport React, { useState, useCallback, useMemo } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardHeader,\r\n  CardTitle,\r\n} from '@/components/ui/card';\r\nimport { Tooltip } from '@/components/ui/tooltip';\r\nimport {\r\n  ClockIcon,\r\n  PlusIcon,\r\n  MinusIcon,\r\n  PauseIcon,\r\n  PlayIcon,\r\n  ArrowPathIcon,\r\n  ExclamationTriangleIcon,\r\n  ArrowTrendingUpIcon,\r\n  ArrowTrendingDownIcon,\r\n  ClipboardDocumentListIcon,\r\n  BoltIcon,\r\n} from '@heroicons/react/24/outline';\r\nimport type { TimeBankEntry, TimeBankRules } from '@/types/session-cockpit';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\n/** TimeBank state for the live panel */\r\nexport interface TimeBankState {\r\n  balance: number;\r\n  paused: boolean;\r\n  ledger: TimeBankEntry[];\r\n  rules: TimeBankRules;\r\n}\r\n\r\nexport interface TimeBankLivePanelProps {\r\n  /** Current TimeBank state */\r\n  state: TimeBankState;\r\n  /** Apply a delta to the balance */\r\n  onApplyDelta: (delta: number, reason?: string) => void;\r\n  /** Pause/resume the TimeBank */\r\n  onTogglePause: () => void;\r\n  /** Reset to initial balance */\r\n  onReset?: () => void;\r\n  /** Compact mode for inline display */\r\n  compact?: boolean;\r\n  /** Optional className */\r\n  className?: string;\r\n}\r\n\r\n// =============================================================================\r\n// Constants\r\n// =============================================================================\r\n\r\nconst QUICK_ADJUSTMENTS = [\r\n  { delta: 30, label: '+30s' },\r\n  { delta: 60, label: '+1m' },\r\n  { delta: 300, label: '+5m' },\r\n  { delta: -30, label: '-30s' },\r\n  { delta: -60, label: '-1m' },\r\n  { delta: -300, label: '-5m' },\r\n];\r\n\r\n// =============================================================================\r\n// Helper: Format Time\r\n// =============================================================================\r\n\r\nconst formatTime = (seconds: number, showSign = false): string => {\r\n  const absSeconds = Math.abs(seconds);\r\n  const mins = Math.floor(absSeconds / 60);\r\n  const secs = absSeconds % 60;\r\n  const sign = seconds < 0 ? '-' : (showSign && seconds > 0 ? '+' : '');\r\n  \r\n  if (mins >= 60) {\r\n    const hours = Math.floor(mins / 60);\r\n    const remainingMins = mins % 60;\r\n    return `${sign}${hours}:${remainingMins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;\r\n  }\r\n  \r\n  return `${sign}${mins}:${secs.toString().padStart(2, '0')}`;\r\n};\r\n\r\n// =============================================================================\r\n// Helper: Get Balance Status\r\n// =============================================================================\r\n\r\ntype BalanceStatus = 'critical' | 'warning' | 'normal' | 'good';\r\n\r\nconst getBalanceStatus = (balance: number, maxBalance: number): BalanceStatus => {\r\n  if (balance <= 0) return 'critical';\r\n  if (balance < 60) return 'warning';\r\n  if (balance > maxBalance * 0.8) return 'good';\r\n  return 'normal';\r\n};\r\n\r\n// =============================================================================\r\n// Sub-Component: BalanceDisplay\r\n// =============================================================================\r\n\r\ninterface BalanceDisplayProps {\r\n  balance: number;\r\n  maxBalance: number;\r\n  paused: boolean;\r\n  compact?: boolean;\r\n}\r\n\r\nfunction BalanceDisplay({ balance, maxBalance, paused, compact }: BalanceDisplayProps) {\r\n  const status = getBalanceStatus(balance, maxBalance);\r\n  const percentage = Math.min(100, Math.max(0, (balance / maxBalance) * 100));\r\n  \r\n  const statusColors: Record<BalanceStatus, string> = {\r\n    critical: 'text-red-500',\r\n    warning: 'text-yellow-500',\r\n    normal: 'text-foreground',\r\n    good: 'text-green-500',\r\n  };\r\n  \r\n  const progressColors: Record<BalanceStatus, string> = {\r\n    critical: 'bg-red-500',\r\n    warning: 'bg-yellow-500',\r\n    normal: 'bg-primary',\r\n    good: 'bg-green-500',\r\n  };\r\n  \r\n  if (compact) {\r\n    return (\r\n      <div className=\"flex items-center gap-2\">\r\n        <ClockIcon className={`h-4 w-4 ${statusColors[status]}`} />\r\n        <span className={`font-mono font-bold ${statusColors[status]}`}>\r\n          {formatTime(balance)}\r\n        </span>\r\n        {paused && (\r\n          <Badge variant=\"outline\" className=\"text-xs\">\r\n            <PauseIcon className=\"h-3 w-3 mr-1\" />\r\n            Pausad\r\n          </Badge>\r\n        )}\r\n      </div>\r\n    );\r\n  }\r\n  \r\n  return (\r\n    <div className=\"space-y-3\">\r\n      {/* Main balance display */}\r\n      <div className=\"flex items-center justify-center gap-3\">\r\n        <div className={`\r\n          text-5xl font-mono font-bold tabular-nums\r\n          ${statusColors[status]}\r\n          ${paused ? 'opacity-50' : ''}\r\n          ${status === 'critical' && !paused ? 'animate-pulse' : ''}\r\n        `}>\r\n          {formatTime(balance)}\r\n        </div>\r\n        {paused && (\r\n          <Badge variant=\"outline\" className=\"h-8\">\r\n            <PauseIcon className=\"h-4 w-4 mr-1\" />\r\n            Pausad\r\n          </Badge>\r\n        )}\r\n      </div>\r\n      \r\n      {/* Progress bar */}\r\n      <div className=\"w-full h-2 bg-muted rounded-full overflow-hidden\">\r\n        <div\r\n          className={`h-full transition-all duration-500 ${progressColors[status]}`}\r\n          style={{ width: `${percentage}%` }}\r\n        />\r\n      </div>\r\n      \r\n      {/* Status indicator */}\r\n      <div className=\"flex items-center justify-center gap-2 text-sm\">\r\n        {status === 'critical' && (\r\n          <>\r\n            <ExclamationTriangleIcon className=\"h-4 w-4 text-red-500\" />\r\n            <span className=\"text-red-500 font-medium\">Kritisk tidsniv├Ñ!</span>\r\n          </>\r\n        )}\r\n        {status === 'warning' && (\r\n          <>\r\n            <ExclamationTriangleIcon className=\"h-4 w-4 text-yellow-500\" />\r\n            <span className=\"text-yellow-500\">Tiden ├ñr snart slut</span>\r\n          </>\r\n        )}\r\n        {status === 'good' && (\r\n          <span className=\"text-green-500\">\r\n            <ArrowTrendingUpIcon className=\"h-4 w-4 inline mr-1\" />\r\n            Bra tidsmarginal\r\n          </span>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: LedgerHistory\r\n// =============================================================================\r\n\r\ninterface LedgerHistoryProps {\r\n  ledger: TimeBankEntry[];\r\n  maxItems?: number;\r\n}\r\n\r\nfunction LedgerHistory({ ledger, maxItems = 5 }: LedgerHistoryProps) {\r\n  if (ledger.length === 0) {\r\n    return (\r\n      <div className=\"text-xs text-muted-foreground text-center py-2\">\r\n        Inga justeringar ├ñnnu\r\n      </div>\r\n    );\r\n  }\r\n  \r\n  // Get most recent entries\r\n  const recentEntries = ledger.slice(-maxItems).reverse();\r\n  \r\n  return (\r\n    <div className=\"space-y-1\">\r\n      {recentEntries.map((entry) => (\r\n        <div\r\n          key={entry.id}\r\n          className=\"flex items-center justify-between text-xs p-1.5 rounded bg-muted/30\"\r\n        >\r\n          <div className=\"flex items-center gap-2 min-w-0\">\r\n            {entry.deltaSeconds >= 0 ? (\r\n              <ArrowTrendingUpIcon className=\"h-3 w-3 text-green-500 flex-shrink-0\" />\r\n            ) : (\r\n              <ArrowTrendingDownIcon className=\"h-3 w-3 text-red-500 flex-shrink-0\" />\r\n            )}\r\n            <span className=\"truncate text-muted-foreground\">\r\n              {entry.reason || 'Manuell justering'}\r\n            </span>\r\n          </div>\r\n          <div className=\"flex items-center gap-2 flex-shrink-0\">\r\n            <span className={`font-mono font-medium ${entry.deltaSeconds >= 0 ? 'text-green-500' : 'text-red-500'}`}>\r\n              {formatTime(entry.deltaSeconds, true)}\r\n            </span>\r\n            <span className=\"text-muted-foreground/50\">\r\n              {new Date(entry.createdAt).toLocaleTimeString('sv-SE', {\r\n                hour: '2-digit',\r\n                minute: '2-digit',\r\n              })}\r\n            </span>\r\n          </div>\r\n        </div>\r\n      ))}\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function TimeBankLivePanel({\r\n  state,\r\n  onApplyDelta,\r\n  onTogglePause,\r\n  onReset,\r\n  compact = false,\r\n  className,\r\n}: TimeBankLivePanelProps) {\r\n  const [customDelta, setCustomDelta] = useState<string>('');\r\n  const [customReason, setCustomReason] = useState<string>('');\r\n  const [showHistory, setShowHistory] = useState(false);\r\n  \r\n  const handleQuickAdjust = useCallback((delta: number) => {\r\n    onApplyDelta(delta, `Snabbjustering: ${formatTime(delta, true)}`);\r\n  }, [onApplyDelta]);\r\n  \r\n  const handleCustomAdjust = useCallback(() => {\r\n    const delta = parseInt(customDelta);\r\n    if (isNaN(delta) || delta === 0) return;\r\n    \r\n    onApplyDelta(delta, customReason || 'Manuell justering');\r\n    setCustomDelta('');\r\n    setCustomReason('');\r\n  }, [customDelta, customReason, onApplyDelta]);\r\n  \r\n  // Calculate recent trend\r\n  const recentTrend = useMemo(() => {\r\n    const recentEntries = state.ledger.slice(-5);\r\n    const totalDelta = recentEntries.reduce((sum: number, e: TimeBankEntry) => sum + e.deltaSeconds, 0);\r\n    return totalDelta;\r\n  }, [state.ledger]);\r\n  \r\n  // Compact mode\r\n  if (compact) {\r\n    return (\r\n      <div className={`flex items-center gap-3 ${className}`}>\r\n        <BalanceDisplay\r\n          balance={state.balance}\r\n          maxBalance={state.rules.maxBalance ?? 600}\r\n          paused={state.paused}\r\n          compact\r\n        />\r\n        \r\n        <div className=\"flex items-center gap-1\">\r\n          <Tooltip content=\"+30 sekunder\">\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"sm\"\r\n              onClick={() => handleQuickAdjust(30)}\r\n              className=\"h-7 w-7 p-0\"\r\n            >\r\n              <PlusIcon className=\"h-4 w-4\" />\r\n            </Button>\r\n          </Tooltip>\r\n          \r\n          <Tooltip content=\"-30 sekunder\">\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"sm\"\r\n              onClick={() => handleQuickAdjust(-30)}\r\n              className=\"h-7 w-7 p-0\"\r\n            >\r\n              <MinusIcon className=\"h-4 w-4\" />\r\n            </Button>\r\n          </Tooltip>\r\n          \r\n          <Tooltip content={state.paused ? '├àteruppta' : 'Pausa'}>\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"sm\"\r\n              onClick={onTogglePause}\r\n              className=\"h-7 w-7 p-0\"\r\n            >\r\n              {state.paused ? (\r\n                <PlayIcon className=\"h-4 w-4\" />\r\n              ) : (\r\n                <PauseIcon className=\"h-4 w-4\" />\r\n              )}\r\n            </Button>\r\n          </Tooltip>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n  \r\n  // Full panel\r\n  return (\r\n    <Card className={className}>\r\n      <CardHeader className=\"pb-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <CardTitle className=\"flex items-center gap-2 text-base\">\r\n            <ClockIcon className=\"h-5 w-5\" />\r\n            TimeBank\r\n          </CardTitle>\r\n          \r\n          <div className=\"flex items-center gap-1\">\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              onClick={onTogglePause}\r\n              className={state.paused ? 'bg-yellow-500/10' : ''}\r\n            >\r\n              {state.paused ? (\r\n                <>\r\n                  <PlayIcon className=\"h-4 w-4 mr-1\" />\r\n                  ├àteruppta\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <PauseIcon className=\"h-4 w-4 mr-1\" />\r\n                  Pausa\r\n                </>\r\n              )}\r\n            </Button>\r\n            \r\n            {onReset && (\r\n              <Tooltip content=\"├àterst├ñll till start\">\r\n                <Button\r\n                  variant=\"ghost\"\r\n                  size=\"sm\"\r\n                  onClick={onReset}\r\n                  className=\"h-8 w-8 p-0\"\r\n                >\r\n                  <ArrowPathIcon className=\"h-4 w-4\" />\r\n                </Button>\r\n              </Tooltip>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </CardHeader>\r\n      \r\n      <CardContent className=\"space-y-4\">\r\n        {/* Balance display */}\r\n        <BalanceDisplay\r\n          balance={state.balance}\r\n          maxBalance={state.rules.maxBalance ?? 600}\r\n          paused={state.paused}\r\n        />\r\n        \r\n        {/* Quick adjustments */}\r\n        <div className=\"grid grid-cols-6 gap-2\">\r\n          {QUICK_ADJUSTMENTS.map((adj) => (\r\n            <Tooltip key={adj.delta} content={`${adj.delta > 0 ? 'L├ñgg till' : 'Dra av'} ${Math.abs(adj.delta)} sekunder`}>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={() => handleQuickAdjust(adj.delta)}\r\n                className={`\r\n                  font-mono text-xs\r\n                  ${adj.delta > 0 ? 'hover:bg-green-500/10 hover:text-green-600 hover:border-green-500/50' : ''}\r\n                  ${adj.delta < 0 ? 'hover:bg-red-500/10 hover:text-red-600 hover:border-red-500/50' : ''}\r\n                `}\r\n              >\r\n                {adj.label}\r\n              </Button>\r\n            </Tooltip>\r\n          ))}\r\n        </div>\r\n        \r\n        {/* Custom adjustment */}\r\n        <div className=\"space-y-2 p-3 border rounded-lg bg-muted/30\">\r\n          <div className=\"text-xs font-medium text-muted-foreground uppercase tracking-wider\">\r\n            Anpassad justering\r\n          </div>\r\n          <div className=\"flex gap-2\">\r\n            <Input\r\n              type=\"number\"\r\n              value={customDelta}\r\n              onChange={(e) => setCustomDelta(e.target.value)}\r\n              placeholder=\"Sekunder (+/-)\"\r\n              className=\"w-24\"\r\n            />\r\n            <Input\r\n              value={customReason}\r\n              onChange={(e) => setCustomReason(e.target.value)}\r\n              placeholder=\"Anledning (valfri)\"\r\n              className=\"flex-1\"\r\n            />\r\n            <Button\r\n              size=\"sm\"\r\n              onClick={handleCustomAdjust}\r\n              disabled={!customDelta || parseInt(customDelta) === 0}\r\n            >\r\n              <BoltIcon className=\"h-4 w-4\" />\r\n            </Button>\r\n          </div>\r\n        </div>\r\n        \r\n        {/* History toggle & display */}\r\n        <div className=\"space-y-2\">\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            onClick={() => setShowHistory(!showHistory)}\r\n            className=\"w-full justify-between text-muted-foreground hover:text-foreground\"\r\n          >\r\n            <span className=\"flex items-center gap-2\">\r\n              <ClipboardDocumentListIcon className=\"h-4 w-4\" />\r\n              Historik\r\n              <Badge variant=\"outline\" className=\"text-xs\">\r\n                {state.ledger.length}\r\n              </Badge>\r\n            </span>\r\n            <span>{showHistory ? 'ÔêÆ' : '+'}</span>\r\n          </Button>\r\n          \r\n          {showHistory && (\r\n            <div className=\"pt-2\">\r\n              <LedgerHistory ledger={state.ledger} maxItems={8} />\r\n            </div>\r\n          )}\r\n        </div>\r\n        \r\n        {/* Trend indicator */}\r\n        {state.ledger.length >= 3 && (\r\n          <div className={`\r\n            flex items-center justify-center gap-2 text-xs p-2 rounded\r\n            ${recentTrend >= 0 ? 'bg-green-500/10 text-green-600' : 'bg-red-500/10 text-red-600'}\r\n          `}>\r\n            {recentTrend >= 0 ? (\r\n              <ArrowTrendingUpIcon className=\"h-3 w-3\" />\r\n            ) : (\r\n              <ArrowTrendingDownIcon className=\"h-3 w-3\" />\r\n            )}\r\n            <span>\r\n              Senaste trend: {formatTime(recentTrend, true)} (senaste 5 h├ñndelser)\r\n            </span>\r\n          </div>\r\n        )}\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\TimeBankPanel.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":103,"column":56,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":103,"endColumn":96},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":155,"column":10,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":157,"endColumn":9},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":162,"column":96,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":162,"endColumn":113},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":170,"column":58,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":170,"endColumn":65},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":172,"column":58,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":172,"endColumn":78}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useCallback, useEffect, useMemo, useState } from 'react';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { applySessionTimeBankDelta, getSessionTimeBank, type TimeBankLedgerRow } from '@/features/play/api/time-bank-api';\r\nimport { useLiveSession } from '@/features/play/hooks/useLiveSession';\r\n\r\ntype TimeBankPanelProps = {\r\n  sessionId: string;\r\n  disabled?: boolean;\r\n};\r\n\r\nfunction formatSeconds(totalSeconds: number): string {\r\n  const s = Math.max(0, Math.floor(totalSeconds));\r\n  const minutes = Math.floor(s / 60);\r\n  const seconds = s % 60;\r\n  return `${minutes}:${String(seconds).padStart(2, '0')}`;\r\n}\r\n\r\nexport function TimeBankPanel({ sessionId, disabled = false }: TimeBankPanelProps) {\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const [balanceSeconds, setBalanceSeconds] = useState(0);\r\n  const [ledger, setLedger] = useState<TimeBankLedgerRow[]>([]);\r\n\r\n  const [customDelta, setCustomDelta] = useState('');\r\n  const [customReason, setCustomReason] = useState('manual');\r\n  const [submitting, setSubmitting] = useState(false);\r\n\r\n  const load = useCallback(async () => {\r\n    setLoading(true);\r\n    setError(null);\r\n    try {\r\n      const res = await getSessionTimeBank(sessionId);\r\n      setBalanceSeconds(res.timeBank.balanceSeconds ?? 0);\r\n      setLedger(res.ledger ?? []);\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : 'Kunde inte ladda tidsbank');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [sessionId]);\r\n\r\n  useEffect(() => {\r\n    void load();\r\n  }, [load]);\r\n\r\n  const { connected } = useLiveSession({\r\n    sessionId,\r\n    enabled: true,\r\n    onTimeBankChanged: (payload) => {\r\n      if (payload.sessionId !== sessionId) return;\r\n      void load();\r\n    },\r\n  });\r\n\r\n  const quickButtons = useMemo(\r\n    () => [\r\n      { label: '+30s', deltaSeconds: 30 },\r\n      { label: '+60s', deltaSeconds: 60 },\r\n      { label: '-30s', deltaSeconds: -30 },\r\n      { label: '-60s', deltaSeconds: -60 },\r\n    ],\r\n    []\r\n  );\r\n\r\n  const applyDelta = useCallback(\r\n    async (deltaSeconds: number, reason: string) => {\r\n      setSubmitting(true);\r\n      setError(null);\r\n      try {\r\n        await applySessionTimeBankDelta(sessionId, {\r\n          deltaSeconds,\r\n          reason,\r\n        });\r\n        await load();\r\n      } catch (err) {\r\n        setError(err instanceof Error ? err.message : 'Kunde inte uppdatera tidsbank');\r\n      } finally {\r\n        setSubmitting(false);\r\n      }\r\n    },\r\n    [sessionId, load]\r\n  );\r\n\r\n  const handleApplyCustom = useCallback(async () => {\r\n    const deltaSeconds = Number(customDelta);\r\n    if (!Number.isFinite(deltaSeconds) || !Number.isInteger(deltaSeconds) || deltaSeconds === 0) return;\r\n    const reason = customReason.trim() || 'manual';\r\n    await applyDelta(deltaSeconds, reason);\r\n    setCustomDelta('');\r\n  }, [customDelta, customReason, applyDelta]);\r\n\r\n  return (\r\n    <Card variant=\"elevated\" className=\"p-6\">\r\n      <div className=\"flex items-center justify-between gap-3\">\r\n        <div>\r\n          <h2 className=\"text-lg font-semibold text-foreground\">Tidsbank</h2>\r\n          <p className=\"text-sm text-muted-foreground\">L├ñgg till eller dra av tid under spelet.</p>\r\n        </div>\r\n        <Badge variant={connected ? 'success' : 'secondary'} size=\"sm\">\r\n          {connected ? 'Live' : 'Offline'}\r\n        </Badge>\r\n      </div>\r\n\r\n      <div className=\"mt-4 flex items-baseline gap-3\">\r\n        <div className=\"text-3xl font-mono font-bold text-primary\">{formatSeconds(balanceSeconds)}</div>\r\n        <div className=\"text-sm text-muted-foreground\">min:sek</div>\r\n      </div>\r\n\r\n      {error && <div className=\"mt-3 text-sm text-destructive\">{error}</div>}\r\n\r\n      <div className=\"mt-4 flex flex-wrap gap-2\">\r\n        {quickButtons.map((b) => (\r\n          <Button\r\n            key={b.label}\r\n            type=\"button\"\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            onClick={() => void applyDelta(b.deltaSeconds, 'quick')}\r\n            disabled={disabled || submitting}\r\n          >\r\n            {b.label}\r\n          </Button>\r\n        ))}\r\n      </div>\r\n\r\n      <div className=\"mt-4 grid gap-2 sm:grid-cols-3\">\r\n        <Input\r\n          value={customDelta}\r\n          onChange={(e) => setCustomDelta(e.target.value)}\r\n          placeholder=\"Delta sekunder (t.ex. 120)\"\r\n          disabled={disabled || submitting}\r\n        />\r\n        <Input\r\n          value={customReason}\r\n          onChange={(e) => setCustomReason(e.target.value)}\r\n          placeholder=\"Orsak (t.ex. hint)\"\r\n          disabled={disabled || submitting}\r\n        />\r\n        <Button\r\n          type=\"button\"\r\n          onClick={() => void handleApplyCustom()}\r\n          disabled={\r\n            disabled ||\r\n            submitting ||\r\n            !customDelta.trim() ||\r\n            !Number.isFinite(Number(customDelta)) ||\r\n            Number(customDelta) === 0\r\n          }\r\n        >\r\n          Anv├ñnd\r\n        </Button>\r\n      </div>\r\n\r\n      <div className=\"mt-6\">\r\n        <div className=\"mb-2 flex items-center justify-between\">\r\n          <h3 className=\"text-sm font-semibold uppercase tracking-wider text-muted-foreground\">Senaste ├ñndringar</h3>\r\n          <Button type=\"button\" variant=\"ghost\" size=\"sm\" onClick={() => void load()} disabled={loading}>\r\n            Uppdatera\r\n          </Button>\r\n        </div>\r\n\r\n        <div className=\"max-h-64 overflow-auto rounded-md border border-border p-3 space-y-2\">\r\n          {loading ? (\r\n            <p className=\"text-sm text-muted-foreground\">LaddarÔÇª</p>\r\n          ) : ledger.length === 0 ? (\r\n            <p className=\"text-sm text-muted-foreground\">Inga ├ñndringar ├ñnnu.</p>\r\n          ) : (\r\n            ledger.map((row) => (\r\n              <div key={row.id} className=\"text-sm\">\r\n                <div className=\"flex items-center justify-between gap-2\">\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <Badge variant=\"secondary\" size=\"sm\">\r\n                      {row.delta_seconds >= 0 ? `+${row.delta_seconds}s` : `${row.delta_seconds}s`}\r\n                    </Badge>\r\n                    <span className=\"text-muted-foreground\">{row.reason}</span>\r\n                  </div>\r\n                  <span className=\"text-xs text-muted-foreground\">\r\n                    {new Date(row.created_at).toLocaleTimeString()}\r\n                  </span>\r\n                </div>\r\n              </div>\r\n            ))\r\n          )}\r\n        </div>\r\n      </div>\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\TimeBankRuleEditor.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"Beskriv n├ñr denna regel aktiveras\". Consider using useTranslations() or t() for internationalization.","line":369,"column":25,"nodeType":"Literal","messageId":"hardcodedString","endLine":369,"endColumn":60},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":376,"column":20,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":376,"endColumn":23},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":393,"column":22,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":393,"endColumn":25},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":448,"column":50,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":448,"endColumn":83},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":570,"column":28,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":572,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"V├ñlj trigger\". Consider using useTranslations() or t() for internationalization.","line":651,"column":31,"nodeType":"Literal","messageId":"hardcodedString","endLine":651,"endColumn":45},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":660,"column":46,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":660,"endColumn":64},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":661,"column":65,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":663,"endColumn":15},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":676,"column":56,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":676,"endColumn":71},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":686,"column":40,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":688,"endColumn":17},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":714,"column":52,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":716,"endColumn":13}],"suppressedMessages":[],"errorCount":11,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * TimeBankRuleEditor Component\r\n * \r\n * CRUD component for creating and editing TimeBank reward rules.\r\n * Used in Game Builder to configure how time is awarded/deducted.\r\n * \r\n * Task 4.5 - Session Cockpit Architecture\r\n */\r\n\r\n'use client';\r\n\r\nimport React, { useState, useCallback } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Select } from '@/components/ui/select';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from '@/components/ui/card';\r\nimport { Switch } from '@/components/ui/switch';\r\nimport {\r\n  ClockIcon,\r\n  PlusIcon,\r\n  TrashIcon,\r\n  Bars3Icon,\r\n} from '@heroicons/react/24/outline';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport type TimeBankRuleTrigger =\r\n  | 'artifact_solved'        // When any/specific artifact is solved\r\n  | 'step_completed'         // When a step is completed\r\n  | 'phase_completed'        // When a phase is completed\r\n  | 'trigger_fired'          // When a specific trigger fires\r\n  | 'time_elapsed'           // After a certain time has passed\r\n  | 'manual';                // Manual adjustment by host\r\n\r\nexport type TimeBankOperator =\r\n  | 'add'                    // Add time\r\n  | 'subtract'               // Subtract time\r\n  | 'set'                    // Set to specific value\r\n  | 'multiply';              // Multiply remaining time\r\n\r\nexport interface TimeBankRule {\r\n  id: string;\r\n  name: string;\r\n  description?: string;\r\n  trigger: TimeBankRuleTrigger;\r\n  /** For artifact_solved, step_completed, etc - specific ID or '*' for any */\r\n  targetId?: string;\r\n  operator: TimeBankOperator;\r\n  /** Value in seconds (for add/subtract/set) or multiplier (for multiply) */\r\n  value: number;\r\n  /** Maximum times this rule can fire (0 = unlimited) */\r\n  maxFires: number;\r\n  /** Is this rule enabled? */\r\n  enabled: boolean;\r\n  /** Optional condition - only fire if TimeBank balance is below/above threshold */\r\n  condition?: {\r\n    type: 'balance_below' | 'balance_above';\r\n    threshold: number;\r\n  };\r\n}\r\n\r\nexport interface TimeBankConfig {\r\n  /** Initial balance in seconds */\r\n  initialBalance: number;\r\n  /** Minimum balance (can be negative for \"debt\") */\r\n  minBalance: number;\r\n  /** Maximum balance */\r\n  maxBalance: number;\r\n  /** What happens when balance reaches 0 */\r\n  onZeroAction: 'pause' | 'end_game' | 'continue' | 'trigger';\r\n  /** If onZeroAction is 'trigger', which trigger to fire */\r\n  onZeroTriggerId?: string;\r\n  /** Show countdown to participants */\r\n  showToParticipants: boolean;\r\n  /** Reward rules */\r\n  rules: TimeBankRule[];\r\n}\r\n\r\nexport interface TimeBankRuleEditorProps {\r\n  /** Current config */\r\n  config: TimeBankConfig;\r\n  /** Callback when config changes */\r\n  onChange: (config: TimeBankConfig) => void;\r\n  /** Available artifacts for targeting */\r\n  artifacts?: Array<{ id: string; name: string }>;\r\n  /** Available steps for targeting */\r\n  steps?: Array<{ id: string; name: string }>;\r\n  /** Available triggers for targeting */\r\n  triggers?: Array<{ id: string; name: string }>;\r\n  /** Optional className */\r\n  className?: string;\r\n}\r\n\r\n// =============================================================================\r\n// Constants\r\n// =============================================================================\r\n\r\nconst TRIGGER_OPTIONS = [\r\n  { value: 'artifact_solved', label: 'Artefakt l├Âst' },\r\n  { value: 'step_completed', label: 'Steg klart' },\r\n  { value: 'phase_completed', label: 'Fas klar' },\r\n  { value: 'trigger_fired', label: 'Trigger aktiverad' },\r\n  { value: 'time_elapsed', label: 'Tid passerat' },\r\n  { value: 'manual', label: 'Manuell justering' },\r\n];\r\n\r\nconst OPERATOR_OPTIONS = [\r\n  { value: 'add', label: 'L├ñgg till (+)' },\r\n  { value: 'subtract', label: 'Dra av (-)' },\r\n  { value: 'set', label: 'S├ñtt till (=)' },\r\n  { value: 'multiply', label: 'Multiplicera (├ù)' },\r\n];\r\n\r\nconst ZERO_ACTION_OPTIONS = [\r\n  { value: 'pause', label: 'Pausa spelet' },\r\n  { value: 'end_game', label: 'Avsluta spelet' },\r\n  { value: 'continue', label: 'Forts├ñtt (negativ tid)' },\r\n  { value: 'trigger', label: 'Aktivera trigger' },\r\n];\r\n\r\nconst CONDITION_OPTIONS = [\r\n  { value: 'none', label: 'Inget villkor' },\r\n  { value: 'balance_below', label: 'Om tid under' },\r\n  { value: 'balance_above', label: 'Om tid ├Âver' },\r\n];\r\n\r\n// =============================================================================\r\n// Helper: Generate ID\r\n// =============================================================================\r\n\r\nconst generateId = () => Math.random().toString(36).substring(2, 10);\r\n\r\n// =============================================================================\r\n// Helper: Format Time\r\n// =============================================================================\r\n\r\nconst formatTime = (seconds: number): string => {\r\n  const mins = Math.floor(Math.abs(seconds) / 60);\r\n  const secs = Math.abs(seconds) % 60;\r\n  const sign = seconds < 0 ? '-' : '';\r\n  return `${sign}${mins}:${secs.toString().padStart(2, '0')}`;\r\n};\r\n\r\n// =============================================================================\r\n// Helper: Create Default Rule\r\n// =============================================================================\r\n\r\nconst createDefaultRule = (): TimeBankRule => ({\r\n  id: generateId(),\r\n  name: 'Ny regel',\r\n  trigger: 'artifact_solved',\r\n  targetId: '*',\r\n  operator: 'add',\r\n  value: 30,\r\n  maxFires: 0,\r\n  enabled: true,\r\n});\r\n\r\n// =============================================================================\r\n// Default Config\r\n// =============================================================================\r\n\r\nexport const DEFAULT_TIMEBANK_CONFIG: TimeBankConfig = {\r\n  initialBalance: 600, // 10 minutes\r\n  minBalance: -60,     // Allow 1 minute debt\r\n  maxBalance: 1800,    // 30 minutes max\r\n  onZeroAction: 'pause',\r\n  showToParticipants: true,\r\n  rules: [],\r\n};\r\n\r\n// =============================================================================\r\n// Sub-Component: RuleCard\r\n// =============================================================================\r\n\r\ninterface RuleCardProps {\r\n  rule: TimeBankRule;\r\n  isEditing: boolean;\r\n  onEdit: () => void;\r\n  onUpdate: (rule: TimeBankRule) => void;\r\n  onDelete: () => void;\r\n  onDuplicate: () => void;\r\n  artifacts?: Array<{ id: string; name: string }>;\r\n  steps?: Array<{ id: string; name: string }>;\r\n  triggers?: Array<{ id: string; name: string }>;\r\n}\r\n\r\nfunction RuleCard({\r\n  rule,\r\n  isEditing,\r\n  onEdit,\r\n  onUpdate,\r\n  onDelete,\r\n  onDuplicate,\r\n  artifacts = [],\r\n  steps = [],\r\n  triggers = [],\r\n}: RuleCardProps) {\r\n  const triggerOption = TRIGGER_OPTIONS.find((o) => o.value === rule.trigger);\r\n  \r\n  // Get target name\r\n  const getTargetName = () => {\r\n    if (rule.targetId === '*') return 'alla';\r\n    \r\n    switch (rule.trigger) {\r\n      case 'artifact_solved':\r\n        return artifacts.find((a) => a.id === rule.targetId)?.name || rule.targetId;\r\n      case 'step_completed':\r\n        return steps.find((s) => s.id === rule.targetId)?.name || rule.targetId;\r\n      case 'trigger_fired':\r\n        return triggers.find((t) => t.id === rule.targetId)?.name || rule.targetId;\r\n      default:\r\n        return rule.targetId;\r\n    }\r\n  };\r\n  \r\n  // Get value display\r\n  const getValueDisplay = () => {\r\n    switch (rule.operator) {\r\n      case 'add':\r\n        return `+${formatTime(rule.value)}`;\r\n      case 'subtract':\r\n        return `-${formatTime(rule.value)}`;\r\n      case 'set':\r\n        return `= ${formatTime(rule.value)}`;\r\n      case 'multiply':\r\n        return `├ù ${rule.value}`;\r\n    }\r\n  };\r\n  \r\n  // Get target options for select\r\n  const getTargetOptions = () => {\r\n    const options = [{ value: '*', label: 'Alla' }];\r\n    \r\n    switch (rule.trigger) {\r\n      case 'artifact_solved':\r\n        return [...options, ...artifacts.map(a => ({ value: a.id, label: a.name }))];\r\n      case 'step_completed':\r\n        return [...options, ...steps.map(s => ({ value: s.id, label: s.name }))];\r\n      case 'trigger_fired':\r\n        return [...options, ...triggers.map(t => ({ value: t.id, label: t.name }))];\r\n      default:\r\n        return options;\r\n    }\r\n  };\r\n  \r\n  if (!isEditing) {\r\n    // Collapsed view\r\n    return (\r\n      <div\r\n        className={`\r\n          group flex items-center gap-3 p-3 border rounded-lg cursor-pointer\r\n          hover:border-primary/50 transition-colors\r\n          ${!rule.enabled ? 'opacity-50' : ''}\r\n        `}\r\n        onClick={onEdit}\r\n      >\r\n        <Bars3Icon className=\"h-4 w-4 text-muted-foreground opacity-0 group-hover:opacity-100\" />\r\n        \r\n        <Switch\r\n          checked={rule.enabled}\r\n          onCheckedChange={(checked) => {\r\n            onUpdate({ ...rule, enabled: checked });\r\n          }}\r\n          onClick={(e) => e.stopPropagation()}\r\n        />\r\n        \r\n        <div className=\"flex-1 min-w-0\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <span className=\"font-medium truncate\">{rule.name}</span>\r\n            {rule.maxFires > 0 && (\r\n              <Badge variant=\"outline\" className=\"text-xs\">\r\n                max {rule.maxFires}├ù\r\n              </Badge>\r\n            )}\r\n          </div>\r\n          <div className=\"text-xs text-muted-foreground truncate\">\r\n            {triggerOption?.label}: {getTargetName()}\r\n          </div>\r\n        </div>\r\n        \r\n        <Badge \r\n          variant={rule.operator === 'subtract' ? 'destructive' : 'default'}\r\n          className=\"font-mono\"\r\n        >\r\n          {getValueDisplay()}\r\n        </Badge>\r\n        \r\n        <div className=\"flex items-center gap-1 opacity-0 group-hover:opacity-100\">\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            onClick={(e) => {\r\n              e.stopPropagation();\r\n              onDuplicate();\r\n            }}\r\n            className=\"h-8 w-8 p-0\"\r\n          >\r\n            <PlusIcon className=\"h-4 w-4\" />\r\n          </Button>\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            onClick={(e) => {\r\n              e.stopPropagation();\r\n              onDelete();\r\n            }}\r\n            className=\"h-8 w-8 p-0 text-destructive hover:text-destructive\"\r\n          >\r\n            <TrashIcon className=\"h-4 w-4\" />\r\n          </Button>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n  \r\n  // Expanded editing view\r\n  return (\r\n    <Card className=\"border-primary\">\r\n      <CardHeader className=\"pb-2\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <CardTitle className=\"text-base\">Redigera regel</CardTitle>\r\n          <div className=\"flex items-center gap-2\">\r\n            <Switch\r\n              checked={rule.enabled}\r\n              onCheckedChange={(checked) => onUpdate({ ...rule, enabled: checked })}\r\n            />\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"sm\"\r\n              onClick={onDelete}\r\n              className=\"text-destructive hover:text-destructive\"\r\n            >\r\n              <TrashIcon className=\"h-4 w-4\" />\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </CardHeader>\r\n      \r\n      <CardContent className=\"space-y-4\">\r\n        {/* Name */}\r\n        <div className=\"space-y-2\">\r\n          <Label htmlFor={`rule-name-${rule.id}`}>Namn</Label>\r\n          <Input\r\n            id={`rule-name-${rule.id}`}\r\n            value={rule.name}\r\n            onChange={(e) => onUpdate({ ...rule, name: e.target.value })}\r\n            placeholder=\"Regelnamn\"\r\n          />\r\n        </div>\r\n        \r\n        {/* Description */}\r\n        <div className=\"space-y-2\">\r\n          <Label htmlFor={`rule-desc-${rule.id}`}>Beskrivning (valfri)</Label>\r\n          <Input\r\n            id={`rule-desc-${rule.id}`}\r\n            value={rule.description || ''}\r\n            onChange={(e) => onUpdate({ ...rule, description: e.target.value })}\r\n            placeholder=\"Beskriv n├ñr denna regel aktiveras\"\r\n          />\r\n        </div>\r\n        \r\n        {/* Trigger */}\r\n        <div className=\"grid grid-cols-2 gap-4\">\r\n          <div className=\"space-y-2\">\r\n            <Label>N├ñr</Label>\r\n            <Select\r\n              value={rule.trigger}\r\n              onChange={(e) => onUpdate({\r\n                ...rule,\r\n                trigger: e.target.value as TimeBankRuleTrigger,\r\n                targetId: '*',\r\n              })}\r\n              options={TRIGGER_OPTIONS}\r\n            />\r\n          </div>\r\n          \r\n          {/* Target selection (context-dependent) */}\r\n          {(rule.trigger === 'artifact_solved' || \r\n            rule.trigger === 'step_completed' || \r\n            rule.trigger === 'trigger_fired') && (\r\n            <div className=\"space-y-2\">\r\n              <Label>M├Ñl</Label>\r\n              <Select\r\n                value={rule.targetId || '*'}\r\n                onChange={(e) => onUpdate({ ...rule, targetId: e.target.value })}\r\n                options={getTargetOptions()}\r\n              />\r\n            </div>\r\n          )}\r\n          \r\n          {rule.trigger === 'time_elapsed' && (\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor={`rule-elapsed-${rule.id}`}>Efter (sekunder)</Label>\r\n              <Input\r\n                id={`rule-elapsed-${rule.id}`}\r\n                type=\"number\"\r\n                value={parseInt(rule.targetId || '0')}\r\n                onChange={(e) => onUpdate({ ...rule, targetId: e.target.value })}\r\n                min={1}\r\n                step={10}\r\n              />\r\n            </div>\r\n          )}\r\n        </div>\r\n        \r\n        {/* Operator and value */}\r\n        <div className=\"grid grid-cols-2 gap-4\">\r\n          <div className=\"space-y-2\">\r\n            <Label>Operation</Label>\r\n            <Select\r\n              value={rule.operator}\r\n              onChange={(e) => onUpdate({\r\n                ...rule,\r\n                operator: e.target.value as TimeBankOperator,\r\n              })}\r\n              options={OPERATOR_OPTIONS}\r\n            />\r\n          </div>\r\n          \r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor={`rule-value-${rule.id}`}>\r\n              {rule.operator === 'multiply' ? 'Faktor' : 'Sekunder'}\r\n            </Label>\r\n            <Input\r\n              id={`rule-value-${rule.id}`}\r\n              type=\"number\"\r\n              value={rule.value}\r\n              onChange={(e) => onUpdate({ ...rule, value: parseFloat(e.target.value) || 0 })}\r\n              min={rule.operator === 'multiply' ? 0.1 : 1}\r\n              step={rule.operator === 'multiply' ? 0.1 : 5}\r\n            />\r\n          </div>\r\n        </div>\r\n        \r\n        {/* Max fires */}\r\n        <div className=\"space-y-2\">\r\n          <Label htmlFor={`rule-max-${rule.id}`}>Max antal g├Ñnger (0 = obegr├ñnsat)</Label>\r\n          <Input\r\n            id={`rule-max-${rule.id}`}\r\n            type=\"number\"\r\n            value={rule.maxFires}\r\n            onChange={(e) => onUpdate({ ...rule, maxFires: parseInt(e.target.value) || 0 })}\r\n            min={0}\r\n          />\r\n        </div>\r\n        \r\n        {/* Condition */}\r\n        <div className=\"space-y-2 p-3 border rounded-lg bg-muted/30\">\r\n          <Label className=\"text-sm font-medium\">Villkor (valfritt)</Label>\r\n          <div className=\"grid grid-cols-2 gap-2\">\r\n            <Select\r\n              value={rule.condition?.type || 'none'}\r\n              onChange={(e) => {\r\n                const value = e.target.value;\r\n                if (value === 'none') {\r\n                  onUpdate({ ...rule, condition: undefined });\r\n                } else {\r\n                  onUpdate({\r\n                    ...rule,\r\n                    condition: {\r\n                      type: value as 'balance_below' | 'balance_above',\r\n                      threshold: rule.condition?.threshold || 60,\r\n                    },\r\n                  });\r\n                }\r\n              }}\r\n              options={CONDITION_OPTIONS}\r\n            />\r\n            \r\n            {rule.condition && (\r\n              <Input\r\n                type=\"number\"\r\n                value={rule.condition.threshold}\r\n                onChange={(e) => onUpdate({\r\n                  ...rule,\r\n                  condition: {\r\n                    ...rule.condition!,\r\n                    threshold: parseInt(e.target.value) || 0,\r\n                  },\r\n                })}\r\n                min={0}\r\n                placeholder=\"Sekunder\"\r\n              />\r\n            )}\r\n          </div>\r\n        </div>\r\n        \r\n        {/* Done button */}\r\n        <div className=\"pt-2\">\r\n          <Button variant=\"outline\" onClick={onEdit} className=\"w-full\">\r\n            Klar\r\n          </Button>\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function TimeBankRuleEditor({\r\n  config,\r\n  onChange,\r\n  artifacts = [],\r\n  steps = [],\r\n  triggers = [],\r\n  className,\r\n}: TimeBankRuleEditorProps) {\r\n  const [editingId, setEditingId] = useState<string | null>(null);\r\n  \r\n  const updateConfig = useCallback((updates: Partial<TimeBankConfig>) => {\r\n    onChange({ ...config, ...updates });\r\n  }, [config, onChange]);\r\n  \r\n  const addRule = useCallback(() => {\r\n    const newRule = createDefaultRule();\r\n    updateConfig({ rules: [...config.rules, newRule] });\r\n    setEditingId(newRule.id);\r\n  }, [config.rules, updateConfig]);\r\n  \r\n  const updateRule = useCallback((rule: TimeBankRule) => {\r\n    updateConfig({\r\n      rules: config.rules.map((r) => (r.id === rule.id ? rule : r)),\r\n    });\r\n  }, [config.rules, updateConfig]);\r\n  \r\n  const deleteRule = useCallback((id: string) => {\r\n    updateConfig({\r\n      rules: config.rules.filter((r) => r.id !== id),\r\n    });\r\n    if (editingId === id) {\r\n      setEditingId(null);\r\n    }\r\n  }, [config.rules, updateConfig, editingId]);\r\n  \r\n  const duplicateRule = useCallback((rule: TimeBankRule) => {\r\n    const newRule: TimeBankRule = {\r\n      ...rule,\r\n      id: generateId(),\r\n      name: `${rule.name} (kopia)`,\r\n    };\r\n    updateConfig({ rules: [...config.rules, newRule] });\r\n    setEditingId(newRule.id);\r\n  }, [config.rules, updateConfig]);\r\n  \r\n  // Build trigger options for zero action\r\n  const triggerSelectOptions = triggers.map(t => ({ value: t.id, label: t.name }));\r\n  \r\n  return (\r\n    <div className={className}>\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"flex items-center gap-2\">\r\n            <ClockIcon className=\"h-5 w-5\" />\r\n            TimeBank\r\n          </CardTitle>\r\n          <CardDescription>\r\n            Konfigurera tidsbank och bel├Âningsregler\r\n          </CardDescription>\r\n        </CardHeader>\r\n        \r\n        <CardContent className=\"space-y-6\">\r\n          {/* Basic settings */}\r\n          <div className=\"grid grid-cols-3 gap-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"tb-initial\">Starttid (sek)</Label>\r\n              <Input\r\n                id=\"tb-initial\"\r\n                type=\"number\"\r\n                value={config.initialBalance}\r\n                onChange={(e) => updateConfig({\r\n                  initialBalance: parseInt(e.target.value) || 0,\r\n                })}\r\n                min={0}\r\n                step={60}\r\n              />\r\n              <div className=\"text-xs text-muted-foreground\">\r\n                {formatTime(config.initialBalance)}\r\n              </div>\r\n            </div>\r\n            \r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"tb-min\">Minimum</Label>\r\n              <Input\r\n                id=\"tb-min\"\r\n                type=\"number\"\r\n                value={config.minBalance}\r\n                onChange={(e) => updateConfig({\r\n                  minBalance: parseInt(e.target.value) || 0,\r\n                })}\r\n                step={30}\r\n              />\r\n              <div className=\"text-xs text-muted-foreground\">\r\n                {config.minBalance < 0 ? 'Till├Ñt skuld' : 'Ingen skuld'}\r\n              </div>\r\n            </div>\r\n            \r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"tb-max\">Maximum</Label>\r\n              <Input\r\n                id=\"tb-max\"\r\n                type=\"number\"\r\n                value={config.maxBalance}\r\n                onChange={(e) => updateConfig({\r\n                  maxBalance: parseInt(e.target.value) || 0,\r\n                })}\r\n                min={0}\r\n                step={60}\r\n              />\r\n              <div className=\"text-xs text-muted-foreground\">\r\n                {formatTime(config.maxBalance)}\r\n              </div>\r\n            </div>\r\n          </div>\r\n          \r\n          {/* On zero action */}\r\n          <div className=\"grid grid-cols-2 gap-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label>Vid tid = 0</Label>\r\n              <Select\r\n                value={config.onZeroAction}\r\n                onChange={(e) => updateConfig({\r\n                  onZeroAction: e.target.value as TimeBankConfig['onZeroAction'],\r\n                })}\r\n                options={ZERO_ACTION_OPTIONS}\r\n              />\r\n            </div>\r\n            \r\n            {config.onZeroAction === 'trigger' && (\r\n              <div className=\"space-y-2\">\r\n                <Label>Trigger att aktivera</Label>\r\n                <Select\r\n                  value={config.onZeroTriggerId || ''}\r\n                  onChange={(e) => updateConfig({\r\n                    onZeroTriggerId: e.target.value,\r\n                  })}\r\n                  options={triggerSelectOptions}\r\n                  placeholder=\"V├ñlj trigger\"\r\n                />\r\n              </div>\r\n            )}\r\n          </div>\r\n          \r\n          {/* Show to participants */}\r\n          <div className=\"flex items-center justify-between p-3 border rounded-lg\">\r\n            <div>\r\n              <Label className=\"font-medium\">Visa f├Âr deltagare</Label>\r\n              <p className=\"text-xs text-muted-foreground mt-1\">\r\n                Visa tidsbanken i deltagarnas gr├ñnssnitt\r\n              </p>\r\n            </div>\r\n            <Switch\r\n              checked={config.showToParticipants}\r\n              onCheckedChange={(checked) => updateConfig({\r\n                showToParticipants: checked,\r\n              })}\r\n            />\r\n          </div>\r\n          \r\n          {/* Rules section */}\r\n          <div className=\"space-y-3 pt-4 border-t\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <Label className=\"text-base font-medium\">Bel├Âningsregler</Label>\r\n              <Badge variant=\"outline\">\r\n                {config.rules.filter((r) => r.enabled).length} aktiva\r\n              </Badge>\r\n            </div>\r\n            \r\n            {config.rules.length === 0 ? (\r\n              <div className=\"text-center py-8 text-muted-foreground border rounded-lg bg-muted/30\">\r\n                <ClockIcon className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\r\n                <p>Inga regler definierade</p>\r\n                <p className=\"text-sm\">\r\n                  L├ñgg till regler f├Âr att automatiskt justera tidbanken\r\n                </p>\r\n              </div>\r\n            ) : (\r\n              <div className=\"space-y-2\">\r\n                {config.rules.map((rule) => (\r\n                  <RuleCard\r\n                    key={rule.id}\r\n                    rule={rule}\r\n                    isEditing={editingId === rule.id}\r\n                    onEdit={() => setEditingId(editingId === rule.id ? null : rule.id)}\r\n                    onUpdate={updateRule}\r\n                    onDelete={() => deleteRule(rule.id)}\r\n                    onDuplicate={() => duplicateRule(rule)}\r\n                    artifacts={artifacts}\r\n                    steps={steps}\r\n                    triggers={triggers}\r\n                  />\r\n                ))}\r\n              </div>\r\n            )}\r\n            \r\n            <Button\r\n              variant=\"outline\"\r\n              onClick={addRule}\r\n              className=\"w-full\"\r\n            >\r\n              <PlusIcon className=\"h-4 w-4 mr-2\" />\r\n              L├ñgg till regel\r\n            </Button>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Exports\r\n// =============================================================================\r\n\r\nexport { TRIGGER_OPTIONS, OPERATOR_OPTIONS, ZERO_ACTION_OPTIONS };\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\TimerControl.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":194,"column":49,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":196,"endColumn":15},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":218,"column":52,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":220,"endColumn":13}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * TimerControl Component\r\n * \r\n * Timer display and controls for facilitators.\r\n * Shows remaining time with visual feedback and control buttons.\r\n */\r\n\r\n'use client';\r\n\r\nimport { useState, useCallback } from 'react';\r\nimport { \r\n  PlayIcon, \r\n  PauseIcon, \r\n  ArrowPathIcon,\r\n  ClockIcon,\r\n} from '@heroicons/react/24/solid';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { useLiveTimer } from '@/features/play/hooks/useLiveSession';\r\nimport { formatTime, getTrafficLightColor } from '@/lib/utils/timer-utils';\r\nimport type { TimerState } from '@/types/play-runtime';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface TimerControlProps {\r\n  /** Current timer state */\r\n  timerState: TimerState | null;\r\n  /** Called when timer should start */\r\n  onStart: (durationSeconds: number) => void;\r\n  /** Called when timer should pause */\r\n  onPause: () => void;\r\n  /** Called when timer should resume */\r\n  onResume: () => void;\r\n  /** Called when timer should reset */\r\n  onReset: () => void;\r\n  /** Default duration in seconds for new timers */\r\n  defaultDuration?: number;\r\n  /** Whether controls are disabled */\r\n  disabled?: boolean;\r\n  /** Size variant */\r\n  size?: 'sm' | 'md' | 'lg';\r\n}\r\n\r\n// =============================================================================\r\n// Component\r\n// =============================================================================\r\n\r\nexport function TimerControl({\r\n  timerState,\r\n  onStart,\r\n  onPause,\r\n  onResume,\r\n  onReset,\r\n  defaultDuration = 300, // 5 minutes\r\n  disabled = false,\r\n  size = 'md',\r\n}: TimerControlProps) {\r\n  // Input for setting timer duration\r\n  const [inputMinutes, setInputMinutes] = useState(Math.floor(defaultDuration / 60));\r\n  const [inputSeconds, setInputSeconds] = useState(defaultDuration % 60);\r\n  \r\n  // Calculate display from timer state\r\n  const timerDisplay = useLiveTimer({ timerState });\r\n  \r\n  // Handle start\r\n  const handleStart = useCallback(() => {\r\n    const totalSeconds = (inputMinutes * 60) + inputSeconds;\r\n    if (totalSeconds > 0) {\r\n      onStart(totalSeconds);\r\n    }\r\n  }, [inputMinutes, inputSeconds, onStart]);\r\n  \r\n  // Handle quick time buttons\r\n  const handleQuickTime = useCallback((minutes: number) => {\r\n    setInputMinutes(minutes);\r\n    setInputSeconds(0);\r\n    onStart(minutes * 60);\r\n  }, [onStart]);\r\n  \r\n  // Traffic light color\r\n  const trafficColor = timerState \r\n    ? getTrafficLightColor(timerDisplay)\r\n    : 'green';\r\n  \r\n  // Size classes\r\n  const sizeClasses = {\r\n    sm: 'text-2xl',\r\n    md: 'text-4xl',\r\n    lg: 'text-6xl',\r\n  };\r\n  \r\n  const colorClasses = {\r\n    green: 'text-green-500',\r\n    yellow: 'text-yellow-500',\r\n    red: 'text-red-500',\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {/* Timer Display */}\r\n      <div className=\"flex flex-col items-center justify-center rounded-2xl bg-muted/50 p-6\">\r\n        {timerState ? (\r\n          <>\r\n            {/* Active timer display */}\r\n            <div className={`font-mono font-bold tabular-nums ${sizeClasses[size]} ${colorClasses[trafficColor]}`}>\r\n              {formatTime(timerDisplay.remaining)}\r\n            </div>\r\n            <div className=\"mt-2 flex items-center gap-2 text-sm text-muted-foreground\">\r\n              <ClockIcon className=\"h-4 w-4\" />\r\n              {timerDisplay.isPaused ? 'Pausad' : timerDisplay.isFinished ? 'Klar!' : 'P├Ñg├Ñr'}\r\n            </div>\r\n            \r\n            {/* Progress bar */}\r\n            <div className=\"mt-4 h-2 w-full max-w-xs overflow-hidden rounded-full bg-muted\">\r\n              <div\r\n                className={`h-full rounded-full transition-all duration-300 ${\r\n                  trafficColor === 'green' ? 'bg-green-500' :\r\n                  trafficColor === 'yellow' ? 'bg-yellow-500' : 'bg-red-500'\r\n                }`}\r\n                style={{ width: `${timerDisplay.progress * 100}%` }}\r\n              />\r\n            </div>\r\n          </>\r\n        ) : (\r\n          <>\r\n            {/* Timer input when no active timer */}\r\n            <div className=\"flex items-center gap-2\">\r\n              <Input\r\n                type=\"number\"\r\n                min={0}\r\n                max={99}\r\n                value={inputMinutes}\r\n                onChange={(e) => setInputMinutes(Math.max(0, parseInt(e.target.value) || 0))}\r\n                className=\"w-16 text-center text-2xl font-mono\"\r\n                disabled={disabled}\r\n              />\r\n              <span className=\"text-2xl font-bold text-muted-foreground\">:</span>\r\n              <Input\r\n                type=\"number\"\r\n                min={0}\r\n                max={59}\r\n                value={inputSeconds.toString().padStart(2, '0')}\r\n                onChange={(e) => setInputSeconds(Math.max(0, Math.min(59, parseInt(e.target.value) || 0)))}\r\n                className=\"w-16 text-center text-2xl font-mono\"\r\n                disabled={disabled}\r\n              />\r\n            </div>\r\n            <p className=\"mt-2 text-sm text-muted-foreground\">Minuter : Sekunder</p>\r\n            \r\n            {/* Quick time buttons */}\r\n            <div className=\"mt-4 flex flex-wrap justify-center gap-2\">\r\n              {[1, 2, 3, 5, 10, 15].map((min) => (\r\n                <Button\r\n                  key={min}\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  onClick={() => handleQuickTime(min)}\r\n                  disabled={disabled}\r\n                  className=\"text-xs\"\r\n                >\r\n                  {min} min\r\n                </Button>\r\n              ))}\r\n            </div>\r\n          </>\r\n        )}\r\n      </div>\r\n      \r\n      {/* Control Buttons */}\r\n      <div className=\"flex items-center justify-center gap-3\">\r\n        {!timerState ? (\r\n          // Start button\r\n          <Button\r\n            size=\"lg\"\r\n            onClick={handleStart}\r\n            disabled={disabled || (inputMinutes === 0 && inputSeconds === 0)}\r\n            className=\"gap-2\"\r\n          >\r\n            <PlayIcon className=\"h-5 w-5\" />\r\n            Starta timer\r\n          </Button>\r\n        ) : (\r\n          <>\r\n            {/* Pause/Resume */}\r\n            {timerDisplay.isPaused ? (\r\n              <Button\r\n                size=\"lg\"\r\n                onClick={onResume}\r\n                disabled={disabled}\r\n                className=\"gap-2\"\r\n              >\r\n                <PlayIcon className=\"h-5 w-5\" />\r\n                Forts├ñtt\r\n              </Button>\r\n            ) : (\r\n              <Button\r\n                size=\"lg\"\r\n                variant=\"outline\"\r\n                onClick={onPause}\r\n                disabled={disabled || timerDisplay.isFinished}\r\n                className=\"gap-2\"\r\n              >\r\n                <PauseIcon className=\"h-5 w-5\" />\r\n                Pausa\r\n              </Button>\r\n            )}\r\n            \r\n            {/* Reset */}\r\n            <Button\r\n              size=\"lg\"\r\n              variant=\"outline\"\r\n              onClick={onReset}\r\n              disabled={disabled}\r\n              className=\"gap-2\"\r\n            >\r\n              <ArrowPathIcon className=\"h-5 w-5\" />\r\n              ├àterst├ñll\r\n            </Button>\r\n          </>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\TriggerDryRunPanel.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":233,"column":49,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":234,"endColumn":15},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":260,"column":49,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":261,"endColumn":25},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":264,"column":46,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":264,"endColumn":53},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":282,"column":79,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":284,"endColumn":15},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":389,"column":26,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":390,"endColumn":66},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":398,"column":20,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":398,"endColumn":31},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":481,"column":50,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":483,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":512,"column":60,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":514,"endColumn":11}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * TriggerDryRunPanel Component\r\n * \r\n * Simulates trigger events in lobby/builder without affecting live session.\r\n * Shows which triggers would fire for simulated events.\r\n * \r\n * Task 5.5 - Session Cockpit Architecture\r\n */\r\n\r\n'use client';\r\n\r\nimport React, { useState, useCallback, useMemo } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from '@/components/ui/card';\r\nimport { Select } from '@/components/ui/select';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport {\r\n  Collapsible,\r\n  CollapsibleContent,\r\n  CollapsibleTrigger,\r\n} from '@/components/ui/collapsible';\r\nimport {\r\n  BoltIcon,\r\n  PlayIcon,\r\n  ChevronDownIcon,\r\n  ChevronRightIcon,\r\n  ExclamationTriangleIcon,\r\n  CheckCircleIcon,\r\n  InformationCircleIcon,\r\n  CursorArrowRaysIcon,\r\n  ClockIcon,\r\n} from '@heroicons/react/24/outline';\r\nimport type { Trigger, TriggerCondition, TriggerAction } from '@/types/trigger';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface TriggerDryRunPanelProps {\r\n  /** All triggers to test */\r\n  triggers: Trigger[];\r\n  /** Available artifacts for event simulation */\r\n  artifacts?: Array<{ id: string; name: string; type: string }>;\r\n  /** Available steps for event simulation */\r\n  steps?: Array<{ id: string; name: string }>;\r\n  /** Available phases for event simulation */\r\n  phases?: Array<{ id: string; name: string }>;\r\n  /** Optional className */\r\n  className?: string;\r\n}\r\n\r\nexport interface SimulationEvent {\r\n  type: string;\r\n  [key: string]: unknown;\r\n}\r\n\r\nexport interface SimulationResult {\r\n  event: SimulationEvent;\r\n  matchingTriggers: Trigger[];\r\n  timestamp: Date;\r\n}\r\n\r\n// =============================================================================\r\n// Constants: Event types that can be simulated\r\n// =============================================================================\r\n\r\nconst EVENT_TYPES: Array<{\r\n  value: string;\r\n  label: string;\r\n  targetType?: 'step' | 'phase' | 'artifact' | 'custom';\r\n  targetField?: string;\r\n}> = [\r\n  { value: 'step_started', label: 'Steg startat', targetType: 'step', targetField: 'stepId' },\r\n  { value: 'step_completed', label: 'Steg klart', targetType: 'step', targetField: 'stepId' },\r\n  { value: 'phase_started', label: 'Fas startad', targetType: 'phase', targetField: 'phaseId' },\r\n  { value: 'phase_completed', label: 'Fas klar', targetType: 'phase', targetField: 'phaseId' },\r\n  { value: 'keypad_correct', label: 'R├ñtt kod', targetType: 'artifact', targetField: 'keypadId' },\r\n  { value: 'keypad_failed', label: 'Fel kod', targetType: 'artifact', targetField: 'keypadId' },\r\n  { value: 'artifact_unlocked', label: 'Artefakt uppl├Ñst', targetType: 'artifact', targetField: 'artifactId' },\r\n  { value: 'timer_ended', label: 'Timer slut', targetType: 'custom', targetField: 'timerId' },\r\n  { value: 'counter_reached', label: 'R├ñknare n├Ñdd', targetType: 'artifact', targetField: 'counterKey' },\r\n  { value: 'riddle_correct', label: 'G├Ñta l├Âst', targetType: 'artifact', targetField: 'riddleId' },\r\n  { value: 'signal_received', label: 'Signal mottagen', targetType: 'custom', targetField: 'channel' },\r\n  { value: 'time_bank_expired', label: 'Tidsbank slut', targetType: undefined },\r\n  { value: 'hotspot_found', label: 'Hotspot hittad', targetType: 'artifact', targetField: 'hotspotHuntId' },\r\n  { value: 'tile_puzzle_complete', label: 'Pussel l├Âst', targetType: 'artifact', targetField: 'tilePuzzleId' },\r\n  { value: 'cipher_decoded', label: 'Chiffer avkodat', targetType: 'artifact', targetField: 'cipherId' },\r\n  { value: 'logic_grid_solved', label: 'Logikrutn├ñt l├Âst', targetType: 'artifact', targetField: 'gridId' },\r\n];\r\n\r\n// =============================================================================\r\n// Helper: Check if condition matches event\r\n// =============================================================================\r\n\r\nfunction conditionMatches(condition: TriggerCondition, event: SimulationEvent): boolean {\r\n  if (condition.type !== event.type) return false;\r\n\r\n  // Check type-specific field matching\r\n  switch (condition.type) {\r\n    case 'step_started':\r\n    case 'step_completed':\r\n      return !('stepId' in condition) || condition.stepId === event.stepId;\r\n\r\n    case 'phase_started':\r\n    case 'phase_completed':\r\n      return !('phaseId' in condition) || condition.phaseId === event.phaseId;\r\n\r\n    case 'keypad_correct':\r\n    case 'keypad_failed':\r\n      return !('keypadId' in condition) || condition.keypadId === event.keypadId;\r\n\r\n    case 'artifact_unlocked':\r\n      return !('artifactId' in condition) || condition.artifactId === event.artifactId;\r\n\r\n    case 'timer_ended':\r\n      return !('timerId' in condition) || condition.timerId === event.timerId;\r\n\r\n    case 'signal_received':\r\n      // If no channel specified, matches any signal\r\n      if (!('channel' in condition) || !condition.channel) return true;\r\n      return condition.channel === event.channel;\r\n\r\n    case 'counter_reached':\r\n      return !('counterKey' in condition) || condition.counterKey === event.counterKey;\r\n\r\n    case 'riddle_correct':\r\n      return !('riddleId' in condition) || condition.riddleId === event.riddleId;\r\n\r\n    case 'time_bank_expired':\r\n      // Matches if no specific time bank or matches ID\r\n      if (!('timeBankId' in condition) || !condition.timeBankId) return true;\r\n      return condition.timeBankId === event.timeBankId;\r\n\r\n    case 'hotspot_found':\r\n    case 'hotspot_hunt_complete':\r\n      return !('hotspotHuntId' in condition) || condition.hotspotHuntId === event.hotspotHuntId;\r\n\r\n    case 'tile_puzzle_complete':\r\n      return !('tilePuzzleId' in condition) || condition.tilePuzzleId === event.tilePuzzleId;\r\n\r\n    case 'cipher_decoded':\r\n      return !('cipherId' in condition) || condition.cipherId === event.cipherId;\r\n\r\n    case 'logic_grid_solved':\r\n      return !('gridId' in condition) || condition.gridId === event.gridId;\r\n\r\n    case 'manual':\r\n      // Manual triggers don't match simulated events\r\n      return false;\r\n\r\n    default:\r\n      return true;\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// Helper: Get action description\r\n// =============================================================================\r\n\r\nfunction getActionDescription(action: TriggerAction): string {\r\n  switch (action.type) {\r\n    case 'show_countdown':\r\n      return `Visa nedr├ñkning: ${action.duration}s`;\r\n    case 'reveal_artifact':\r\n      return `Visa artefakt`;\r\n    case 'hide_artifact':\r\n      return `D├Âlj artefakt`;\r\n    case 'advance_step':\r\n      return `G├Ñ till n├ñsta steg`;\r\n    case 'advance_phase':\r\n      return `G├Ñ till n├ñsta fas`;\r\n    case 'start_timer':\r\n      return `Starta timer: ${action.name}`;\r\n    case 'send_message':\r\n      return `Skicka meddelande`;\r\n    case 'send_signal':\r\n      return `Skicka signal: ${action.channel}`;\r\n    case 'time_bank_apply_delta':\r\n      return `Justera tidsbank: ${action.deltaSeconds > 0 ? '+' : ''}${action.deltaSeconds}s`;\r\n    case 'show_leader_script':\r\n      return `Visa ledarscript`;\r\n    case 'trigger_signal':\r\n      return `Aktivera signalgenerator`;\r\n    case 'time_bank_pause':\r\n      return action.pause ? 'Pausa tidsbank' : '├àteruppta tidsbank';\r\n    default:\r\n      return action.type;\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: SimulationResultCard\r\n// =============================================================================\r\n\r\ninterface SimulationResultCardProps {\r\n  result: SimulationResult;\r\n}\r\n\r\nfunction SimulationResultCard({ result }: SimulationResultCardProps) {\r\n  const [isExpanded, setIsExpanded] = useState(result.matchingTriggers.length > 0);\r\n  const hasMatches = result.matchingTriggers.length > 0;\r\n\r\n  return (\r\n    <Card className={hasMatches ? 'border-green-500/50' : 'border-muted'}>\r\n      <Collapsible open={isExpanded} onOpenChange={setIsExpanded}>\r\n        <CollapsibleTrigger asChild>\r\n          <CardHeader className=\"cursor-pointer hover:bg-muted/50 transition-colors pb-2\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div className=\"flex items-center gap-2\">\r\n                {isExpanded ? (\r\n                  <ChevronDownIcon className=\"h-4 w-4\" />\r\n                ) : (\r\n                  <ChevronRightIcon className=\"h-4 w-4\" />\r\n                )}\r\n                {hasMatches ? (\r\n                  <CheckCircleIcon className=\"h-4 w-4 text-green-500\" />\r\n                ) : (\r\n                  <InformationCircleIcon className=\"h-4 w-4 text-muted-foreground\" />\r\n                )}\r\n                <CardTitle className=\"text-sm font-medium\">\r\n                  {EVENT_TYPES.find((e) => e.value === result.event.type)?.label || result.event.type}\r\n                </CardTitle>\r\n              </div>\r\n              <Badge variant={hasMatches ? 'default' : 'outline'}>\r\n                {result.matchingTriggers.length} tr├ñffar\r\n              </Badge>\r\n            </div>\r\n          </CardHeader>\r\n        </CollapsibleTrigger>\r\n\r\n        <CollapsibleContent>\r\n          <CardContent className=\"pt-0\">\r\n            {hasMatches ? (\r\n              <div className=\"space-y-2\">\r\n                {result.matchingTriggers.map((trigger) => (\r\n                  <div\r\n                    key={trigger.id}\r\n                    className=\"p-2 rounded bg-green-500/10 border border-green-500/20\"\r\n                  >\r\n                    <div className=\"flex items-center justify-between\">\r\n                      <span className=\"font-medium text-sm\">{trigger.name}</span>\r\n                      {trigger.executeOnce && (\r\n                        <Badge variant=\"outline\" className=\"text-xs\">\r\n                          1├ù\r\n                        </Badge>\r\n                      )}\r\n                    </div>\r\n                    <div className=\"text-xs text-muted-foreground mt-1\">\r\n                      {trigger.delaySeconds && trigger.delaySeconds > 0 && (\r\n                        <span className=\"inline-flex items-center gap-1 mr-2\">\r\n                          <ClockIcon className=\"h-3 w-3\" />\r\n                          {trigger.delaySeconds}s f├Ârdr├Âjning\r\n                        </span>\r\n                      )}\r\n                      <span>\r\n                        {trigger.then.length} ├Ñtg├ñrd{trigger.then.length !== 1 ? 'er' : ''}\r\n                      </span>\r\n                    </div>\r\n                    <div className=\"mt-2 space-y-1\">\r\n                      {trigger.then.map((action, i) => (\r\n                        <div\r\n                          key={i}\r\n                          className=\"text-xs bg-background px-2 py-1 rounded flex items-center gap-2\"\r\n                        >\r\n                          <CursorArrowRaysIcon className=\"h-3 w-3 text-muted-foreground\" />\r\n                          {getActionDescription(action)}\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            ) : (\r\n              <div className=\"text-sm text-muted-foreground text-center py-4\">\r\n                Ingen trigger matchar denna h├ñndelse\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </CollapsibleContent>\r\n      </Collapsible>\r\n    </Card>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function TriggerDryRunPanel({\r\n  triggers,\r\n  artifacts = [],\r\n  steps = [],\r\n  phases = [],\r\n  className,\r\n}: TriggerDryRunPanelProps) {\r\n  const [selectedEventType, setSelectedEventType] = useState<string>('');\r\n  const [targetId, setTargetId] = useState<string>('');\r\n  const [customValue, setCustomValue] = useState<string>('');\r\n  const [results, setResults] = useState<SimulationResult[]>([]);\r\n\r\n  const selectedEvent = EVENT_TYPES.find((e) => e.value === selectedEventType);\r\n\r\n  // Get target options based on event type\r\n  const targetOptions = useMemo(() => {\r\n    if (!selectedEvent?.targetType) return [];\r\n\r\n    switch (selectedEvent.targetType) {\r\n      case 'step':\r\n        return steps.map((s) => ({ value: s.id, label: s.name }));\r\n      case 'phase':\r\n        return phases.map((p) => ({ value: p.id, label: p.name }));\r\n      case 'artifact':\r\n        // Filter artifacts by type if event is specific\r\n        let filteredArtifacts = artifacts;\r\n        if (selectedEventType === 'keypad_correct' || selectedEventType === 'keypad_failed') {\r\n          filteredArtifacts = artifacts.filter((a) => a.type === 'keypad');\r\n        }\r\n        if (selectedEventType === 'riddle_correct') {\r\n          filteredArtifacts = artifacts.filter((a) => a.type === 'riddle');\r\n        }\r\n        if (selectedEventType === 'counter_reached') {\r\n          filteredArtifacts = artifacts.filter((a) => a.type === 'counter');\r\n        }\r\n        if (selectedEventType === 'hotspot_found') {\r\n          filteredArtifacts = artifacts.filter((a) => a.type === 'hotspot');\r\n        }\r\n        if (selectedEventType === 'tile_puzzle_complete') {\r\n          filteredArtifacts = artifacts.filter((a) => a.type === 'tile_puzzle');\r\n        }\r\n        if (selectedEventType === 'cipher_decoded') {\r\n          filteredArtifacts = artifacts.filter((a) => a.type === 'cipher');\r\n        }\r\n        if (selectedEventType === 'logic_grid_solved') {\r\n          filteredArtifacts = artifacts.filter((a) => a.type === 'logic_grid');\r\n        }\r\n        return filteredArtifacts.map((a) => ({ value: a.id, label: a.name }));\r\n      default:\r\n        return [];\r\n    }\r\n  }, [selectedEvent, selectedEventType, artifacts, steps, phases]);\r\n\r\n  // Simulate event\r\n  const handleSimulate = useCallback(() => {\r\n    if (!selectedEventType) return;\r\n\r\n    const event: SimulationEvent = { type: selectedEventType };\r\n\r\n    // Add target field if applicable\r\n    if (selectedEvent?.targetField) {\r\n      if (selectedEvent.targetType === 'custom') {\r\n        event[selectedEvent.targetField] = customValue;\r\n      } else {\r\n        event[selectedEvent.targetField] = targetId;\r\n      }\r\n    }\r\n\r\n    // Find matching triggers\r\n    const matchingTriggers = triggers.filter(\r\n      (t) => t.enabled && t.status === 'armed' && conditionMatches(t.when, event)\r\n    );\r\n\r\n    const result: SimulationResult = {\r\n      event,\r\n      matchingTriggers,\r\n      timestamp: new Date(),\r\n    };\r\n\r\n    setResults((prev) => [result, ...prev].slice(0, 10));\r\n  }, [selectedEventType, selectedEvent, targetId, customValue, triggers]);\r\n\r\n  // Count armed triggers\r\n  const armedCount = triggers.filter((t) => t.status === 'armed' && t.enabled).length;\r\n\r\n  return (\r\n    <Card className={className}>\r\n      <CardHeader>\r\n        <CardTitle className=\"flex items-center gap-2 text-base\">\r\n          <BoltIcon className=\"h-5 w-5\" />\r\n          Trigger Dry-Run\r\n        </CardTitle>\r\n        <CardDescription>\r\n          Testa vilka triggers som aktiveras av olika h├ñndelser ({armedCount} aktiva)\r\n        </CardDescription>\r\n      </CardHeader>\r\n\r\n      <CardContent className=\"space-y-4\">\r\n        {/* Event selector */}\r\n        <div className=\"grid gap-3\">\r\n          <div className=\"space-y-2\">\r\n            <Label>H├ñndelsetyp</Label>\r\n            <Select\r\n              value={selectedEventType}\r\n              onChange={(e) => {\r\n                setSelectedEventType(e.target.value);\r\n                setTargetId('');\r\n                setCustomValue('');\r\n              }}\r\n              options={[\r\n                { value: '', label: 'V├ñlj h├ñndelse att simulera' },\r\n                ...EVENT_TYPES.map((event) => ({\r\n                  value: event.value,\r\n                  label: event.label,\r\n                })),\r\n              ]}\r\n            />\r\n          </div>\r\n\r\n          {/* Target selector */}\r\n          {selectedEvent?.targetType === 'step' && (\r\n            <div className=\"space-y-2\">\r\n              <Label>Steg</Label>\r\n              <Select\r\n                value={targetId}\r\n                onChange={(e) => setTargetId(e.target.value)}\r\n                options={[\r\n                  { value: '', label: 'V├ñlj steg' },\r\n                  ...targetOptions,\r\n                ]}\r\n              />\r\n            </div>\r\n          )}\r\n\r\n          {selectedEvent?.targetType === 'phase' && (\r\n            <div className=\"space-y-2\">\r\n              <Label>Fas</Label>\r\n              <Select\r\n                value={targetId}\r\n                onChange={(e) => setTargetId(e.target.value)}\r\n                options={[\r\n                  { value: '', label: 'V├ñlj fas' },\r\n                  ...targetOptions,\r\n                ]}\r\n              />\r\n            </div>\r\n          )}\r\n\r\n          {selectedEvent?.targetType === 'artifact' && (\r\n            <div className=\"space-y-2\">\r\n              <Label>Artefakt</Label>\r\n              <Select\r\n                value={targetId}\r\n                onChange={(e) => setTargetId(e.target.value)}\r\n                options={[\r\n                  { value: '', label: 'V├ñlj artefakt' },\r\n                  ...targetOptions,\r\n                ]}\r\n              />\r\n            </div>\r\n          )}\r\n\r\n          {selectedEvent?.targetType === 'custom' && (\r\n            <div className=\"space-y-2\">\r\n              <Label>{selectedEvent.targetField}</Label>\r\n              <Input\r\n                value={customValue}\r\n                onChange={(e) => setCustomValue(e.target.value)}\r\n                placeholder={`Ange ${selectedEvent.targetField}`}\r\n              />\r\n            </div>\r\n          )}\r\n\r\n          <Button\r\n            onClick={handleSimulate}\r\n            disabled={\r\n              !selectedEventType ||\r\n              (selectedEvent?.targetType === 'step' && !targetId && steps.length > 0) ||\r\n              (selectedEvent?.targetType === 'phase' && !targetId && phases.length > 0) ||\r\n              (selectedEvent?.targetType === 'artifact' && !targetId && targetOptions.length > 0) ||\r\n              (selectedEvent?.targetType === 'custom' && !customValue)\r\n            }\r\n            className=\"w-full\"\r\n          >\r\n            <PlayIcon className=\"h-4 w-4 mr-2\" />\r\n            Simulera h├ñndelse\r\n          </Button>\r\n        </div>\r\n\r\n        {/* Results */}\r\n        {results.length > 0 && (\r\n          <div className=\"space-y-3 pt-4 border-t\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <Label className=\"text-sm font-medium\">Resultat</Label>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={() => setResults([])}\r\n                className=\"h-7 text-xs\"\r\n              >\r\n                Rensa\r\n              </Button>\r\n            </div>\r\n\r\n            <div className=\"space-y-2 max-h-[400px] overflow-y-auto\">\r\n              {results.map((result, i) => (\r\n                <SimulationResultCard key={i} result={result} />\r\n              ))}\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Warning if no triggers */}\r\n        {triggers.length === 0 && (\r\n          <div className=\"flex items-center gap-2 p-3 rounded-lg bg-yellow-500/10 text-yellow-600 text-sm\">\r\n            <ExclamationTriangleIcon className=\"h-4 w-4\" />\r\n            Inga triggers definierade f├Âr detta spel\r\n          </div>\r\n        )}\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\TriggerKillSwitch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\TriggerLivePanel.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":320,"column":55,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":320,"endColumn":64},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":325,"column":57,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":325,"endColumn":69},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":339,"column":65,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":339,"endColumn":74},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":535,"column":28,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":536,"endColumn":9},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":552,"column":66,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":554,"endColumn":19},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":558,"column":39,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":558,"endColumn":64},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":560,"column":68,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":563,"endColumn":21},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":567,"column":67,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":569,"endColumn":21},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":583,"column":56,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":585,"endColumn":15},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":590,"column":64,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":592,"endColumn":15}],"suppressedMessages":[],"errorCount":10,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * TriggerLivePanel Component\r\n * \r\n * Live display and control panel for session triggers during Director Mode.\r\n * Groups triggers by status, allows manual fire, and shows errors.\r\n * \r\n * Task 5.2 - Session Cockpit Architecture\r\n */\r\n\r\n'use client';\r\n\r\nimport React, { useState, useCallback, useMemo } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from '@/components/ui/card';\r\nimport {\r\n  Collapsible,\r\n  CollapsibleContent,\r\n  CollapsibleTrigger,\r\n} from '@/components/ui/collapsible';\r\nimport { Tooltip } from '@/components/ui/tooltip';\r\nimport {\r\n  AlertDialog,\r\n  AlertDialogAction,\r\n  AlertDialogCancel,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n  AlertDialogTrigger,\r\n} from '@/components/ui/alert-dialog';\r\nimport {\r\n  BoltIcon,\r\n  PlayIcon,\r\n  PauseIcon,\r\n  ArrowPathIcon,\r\n  ExclamationTriangleIcon,\r\n  CheckCircleIcon,\r\n  XCircleIcon,\r\n  ChevronDownIcon,\r\n  ChevronRightIcon,\r\n  ShieldCheckIcon,\r\n  ShieldExclamationIcon,\r\n} from '@heroicons/react/24/outline';\r\nimport type { Trigger, TriggerStatus, TriggerCondition } from '@/types/trigger';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface TriggerLivePanelProps {\r\n  /** All session triggers */\r\n  triggers: Trigger[];\r\n  /** Fire a trigger manually */\r\n  onFireTrigger: (triggerId: string) => Promise<void>;\r\n  /** Disable a trigger */\r\n  onDisableTrigger: (triggerId: string) => Promise<void>;\r\n  /** Re-arm a trigger (clear error or enable disabled) */\r\n  onRearmTrigger: (triggerId: string) => Promise<void>;\r\n  /** Disable all triggers (kill switch) */\r\n  onDisableAll?: () => Promise<void>;\r\n  /** Re-arm all triggers */\r\n  onRearmAll?: () => Promise<void>;\r\n  /** Is the kill switch engaged? */\r\n  killSwitchActive?: boolean;\r\n  /** Compact mode for inline display */\r\n  compact?: boolean;\r\n  /** Optional className */\r\n  className?: string;\r\n}\r\n\r\n// =============================================================================\r\n// Helper: Group triggers by status\r\n// =============================================================================\r\n\r\ninterface TriggerGroup {\r\n  status: TriggerStatus;\r\n  label: string;\r\n  icon: React.ReactNode;\r\n  triggers: Trigger[];\r\n  variant: 'default' | 'outline' | 'destructive';\r\n}\r\n\r\nconst groupTriggers = (triggers: Trigger[]): TriggerGroup[] => {\r\n  const armed = triggers.filter((t) => t.status === 'armed');\r\n  const fired = triggers.filter((t) => t.status === 'fired');\r\n  const error = triggers.filter((t) => t.status === 'error');\r\n  const disabled = triggers.filter((t) => t.status === 'disabled');\r\n\r\n  const groups: TriggerGroup[] = [\r\n    {\r\n      status: 'armed' as TriggerStatus,\r\n      label: 'Redo',\r\n      icon: <BoltIcon className=\"h-4 w-4 text-green-500\" />,\r\n      triggers: armed,\r\n      variant: 'default',\r\n    },\r\n    {\r\n      status: 'error' as TriggerStatus,\r\n      label: 'Fel',\r\n      icon: <ExclamationTriangleIcon className=\"h-4 w-4 text-red-500\" />,\r\n      triggers: error,\r\n      variant: 'destructive',\r\n    },\r\n    {\r\n      status: 'fired' as TriggerStatus,\r\n      label: 'Aktiverade',\r\n      icon: <CheckCircleIcon className=\"h-4 w-4 text-blue-500\" />,\r\n      triggers: fired,\r\n      variant: 'outline',\r\n    },\r\n    {\r\n      status: 'disabled' as TriggerStatus,\r\n      label: 'Inaktiverade',\r\n      icon: <XCircleIcon className=\"h-4 w-4 text-muted-foreground\" />,\r\n      triggers: disabled,\r\n      variant: 'outline',\r\n    },\r\n  ];\r\n  \r\n  return groups.filter((g) => g.triggers.length > 0);\r\n};\r\n\r\n// =============================================================================\r\n// Helper: Get condition description\r\n// =============================================================================\r\n\r\nconst getConditionLabel = (condition: TriggerCondition): string => {\r\n  switch (condition.type) {\r\n    case 'step_started':\r\n      return 'Steg startat';\r\n    case 'step_completed':\r\n      return 'Steg klart';\r\n    case 'phase_started':\r\n      return 'Fas startad';\r\n    case 'phase_completed':\r\n      return 'Fas klar';\r\n    case 'keypad_correct':\r\n      return 'R├ñtt kod';\r\n    case 'keypad_failed':\r\n      return 'Fel kod';\r\n    case 'artifact_unlocked':\r\n      return 'Artefakt uppl├Ñst';\r\n    case 'timer_ended':\r\n      return 'Timer slut';\r\n    case 'manual':\r\n      return 'Manuell';\r\n    case 'signal_received':\r\n      return 'Signal mottagen';\r\n    case 'counter_reached':\r\n      return 'R├ñknare n├Ñdd';\r\n    case 'riddle_correct':\r\n      return 'G├Ñta l├Âst';\r\n    case 'time_bank_expired':\r\n      return 'Tidsbank slut';\r\n    case 'signal_generator_triggered':\r\n      return 'Signalgenerator';\r\n    default:\r\n      return condition.type;\r\n  }\r\n};\r\n\r\n// =============================================================================\r\n// Sub-Component: TriggerRow\r\n// =============================================================================\r\n\r\ninterface TriggerRowProps {\r\n  trigger: Trigger;\r\n  onFire: () => Promise<void>;\r\n  onDisable: () => Promise<void>;\r\n  onRearm: () => Promise<void>;\r\n  isLoading: boolean;\r\n}\r\n\r\nfunction TriggerRow({\r\n  trigger,\r\n  onFire,\r\n  onDisable,\r\n  onRearm,\r\n  isLoading,\r\n}: TriggerRowProps) {\r\n  const [isExpanded, setIsExpanded] = useState(false);\r\n\r\n  const statusColors: Record<TriggerStatus, string> = {\r\n    armed: 'border-l-green-500',\r\n    fired: 'border-l-blue-500',\r\n    error: 'border-l-red-500',\r\n    disabled: 'border-l-muted-foreground',\r\n  };\r\n\r\n  return (\r\n    <div\r\n      className={`\r\n        border-l-4 ${statusColors[trigger.status]}\r\n        bg-card rounded-r-lg p-3\r\n      `}\r\n    >\r\n      <div className=\"flex items-center gap-3\">\r\n        {/* Expand toggle */}\r\n        <button\r\n          type=\"button\"\r\n          onClick={() => setIsExpanded(!isExpanded)}\r\n          className=\"p-1 hover:bg-muted rounded\"\r\n        >\r\n          {isExpanded ? (\r\n            <ChevronDownIcon className=\"h-4 w-4\" />\r\n          ) : (\r\n            <ChevronRightIcon className=\"h-4 w-4\" />\r\n          )}\r\n        </button>\r\n\r\n        {/* Trigger info */}\r\n        <div className=\"flex-1 min-w-0\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <span className=\"font-medium truncate\">{trigger.name}</span>\r\n            <Badge variant=\"outline\" className=\"text-xs\">\r\n              {getConditionLabel(trigger.when)}\r\n            </Badge>\r\n            {trigger.executeOnce && (\r\n              <Badge variant=\"outline\" className=\"text-xs\">\r\n                1├ù\r\n              </Badge>\r\n            )}\r\n          </div>\r\n\r\n          {/* Error message */}\r\n          {trigger.status === 'error' && trigger.lastError && (\r\n            <div className=\"text-xs text-red-500 mt-1 truncate\">\r\n              {trigger.lastError}\r\n            </div>\r\n          )}\r\n\r\n          {/* Fired info */}\r\n          {trigger.firedCount > 0 && (\r\n            <div className=\"text-xs text-muted-foreground mt-1\">\r\n              Aktiverad {trigger.firedCount}├ù\r\n              {trigger.firedAt && (\r\n                <> ÔÇó {new Date(trigger.firedAt).toLocaleTimeString('sv-SE')}</>\r\n              )}\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Actions */}\r\n        <div className=\"flex items-center gap-1\">\r\n          {trigger.status === 'armed' && (\r\n            <>\r\n              <Tooltip content=\"Aktivera nu\">\r\n                <Button\r\n                  variant=\"ghost\"\r\n                  size=\"sm\"\r\n                  onClick={onFire}\r\n                  disabled={isLoading}\r\n                  className=\"h-8 w-8 p-0\"\r\n                >\r\n                  <PlayIcon className=\"h-4 w-4\" />\r\n                </Button>\r\n              </Tooltip>\r\n\r\n              <Tooltip content=\"Inaktivera\">\r\n                <Button\r\n                  variant=\"ghost\"\r\n                  size=\"sm\"\r\n                  onClick={onDisable}\r\n                  disabled={isLoading}\r\n                  className=\"h-8 w-8 p-0 text-muted-foreground\"\r\n                >\r\n                  <PauseIcon className=\"h-4 w-4\" />\r\n                </Button>\r\n              </Tooltip>\r\n            </>\r\n          )}\r\n\r\n          {(trigger.status === 'disabled' || trigger.status === 'error') && (\r\n            <Tooltip content={trigger.status === 'error' ? 'Rensa fel & ├Ñteraktivera' : '├àteraktivera'}>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={onRearm}\r\n                disabled={isLoading}\r\n                className=\"h-8 w-8 p-0\"\r\n              >\r\n                <ArrowPathIcon className=\"h-4 w-4\" />\r\n              </Button>\r\n            </Tooltip>\r\n          )}\r\n\r\n          {trigger.status === 'fired' && trigger.executeOnce && (\r\n            <Tooltip content=\"├àterst├ñll (kan aktiveras igen)\">\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={onRearm}\r\n                disabled={isLoading}\r\n                className=\"h-8 w-8 p-0\"\r\n              >\r\n                <ArrowPathIcon className=\"h-4 w-4\" />\r\n              </Button>\r\n            </Tooltip>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Expanded details */}\r\n      {isExpanded && (\r\n        <div className=\"mt-3 pt-3 border-t text-sm\">\r\n          <div className=\"grid grid-cols-2 gap-2 text-xs\">\r\n            <div>\r\n              <span className=\"text-muted-foreground\">Villkor:</span>{' '}\r\n              <code className=\"bg-muted px-1 rounded\">{trigger.when.type}</code>\r\n            </div>\r\n            <div>\r\n              <span className=\"text-muted-foreground\">├àtg├ñrder:</span>{' '}\r\n              {trigger.then.length} st\r\n            </div>\r\n            {trigger.delaySeconds && trigger.delaySeconds > 0 && (\r\n              <div>\r\n                <span className=\"text-muted-foreground\">F├Ârdr├Âjning:</span>{' '}\r\n                {trigger.delaySeconds}s\r\n              </div>\r\n            )}\r\n            {trigger.errorCount > 0 && (\r\n              <div>\r\n                <span className=\"text-muted-foreground\">Fel totalt:</span>{' '}\r\n                {trigger.errorCount}\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {/* Actions list */}\r\n          <div className=\"mt-2\">\r\n            <div className=\"text-xs text-muted-foreground mb-1\">├àtg├ñrder:</div>\r\n            <div className=\"space-y-1\">\r\n              {trigger.then.map((action, i) => (\r\n                <div\r\n                  key={i}\r\n                  className=\"text-xs bg-muted px-2 py-1 rounded font-mono\"\r\n                >\r\n                  {action.type}\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: TriggerGroupSection\r\n// =============================================================================\r\n\r\ninterface TriggerGroupSectionProps {\r\n  group: TriggerGroup;\r\n  onFireTrigger: (id: string) => Promise<void>;\r\n  onDisableTrigger: (id: string) => Promise<void>;\r\n  onRearmTrigger: (id: string) => Promise<void>;\r\n  loadingTriggerId: string | null;\r\n}\r\n\r\nfunction TriggerGroupSection({\r\n  group,\r\n  onFireTrigger,\r\n  onDisableTrigger,\r\n  onRearmTrigger,\r\n  loadingTriggerId,\r\n}: TriggerGroupSectionProps) {\r\n  const [isOpen, setIsOpen] = useState(\r\n    group.status === 'armed' || group.status === 'error'\r\n  );\r\n\r\n  return (\r\n    <Collapsible open={isOpen} onOpenChange={setIsOpen}>\r\n      <CollapsibleTrigger asChild>\r\n        <button\r\n          type=\"button\"\r\n          className=\"flex items-center gap-2 w-full p-2 hover:bg-muted rounded-lg transition-colors\"\r\n        >\r\n          {isOpen ? (\r\n            <ChevronDownIcon className=\"h-4 w-4\" />\r\n          ) : (\r\n            <ChevronRightIcon className=\"h-4 w-4\" />\r\n          )}\r\n          {group.icon}\r\n          <span className=\"font-medium\">{group.label}</span>\r\n          <Badge variant={group.variant} className=\"ml-auto\">\r\n            {group.triggers.length}\r\n          </Badge>\r\n        </button>\r\n      </CollapsibleTrigger>\r\n\r\n      <CollapsibleContent className=\"space-y-2 mt-2 ml-6\">\r\n        {group.triggers.map((trigger) => (\r\n          <TriggerRow\r\n            key={trigger.id}\r\n            trigger={trigger}\r\n            onFire={() => onFireTrigger(trigger.id)}\r\n            onDisable={() => onDisableTrigger(trigger.id)}\r\n            onRearm={() => onRearmTrigger(trigger.id)}\r\n            isLoading={loadingTriggerId === trigger.id}\r\n          />\r\n        ))}\r\n      </CollapsibleContent>\r\n    </Collapsible>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function TriggerLivePanel({\r\n  triggers,\r\n  onFireTrigger,\r\n  onDisableTrigger,\r\n  onRearmTrigger,\r\n  onDisableAll,\r\n  onRearmAll,\r\n  killSwitchActive = false,\r\n  compact = false,\r\n  className,\r\n}: TriggerLivePanelProps) {\r\n  const [loadingTriggerId, setLoadingTriggerId] = useState<string | null>(null);\r\n  const [isKillSwitchLoading, setIsKillSwitchLoading] = useState(false);\r\n\r\n  const groups = useMemo(() => groupTriggers(triggers), [triggers]);\r\n\r\n  const armedCount = triggers.filter((t) => t.status === 'armed').length;\r\n  const errorCount = triggers.filter((t) => t.status === 'error').length;\r\n\r\n  const handleFireTrigger = useCallback(\r\n    async (id: string) => {\r\n      setLoadingTriggerId(id);\r\n      try {\r\n        await onFireTrigger(id);\r\n      } finally {\r\n        setLoadingTriggerId(null);\r\n      }\r\n    },\r\n    [onFireTrigger]\r\n  );\r\n\r\n  const handleDisableTrigger = useCallback(\r\n    async (id: string) => {\r\n      setLoadingTriggerId(id);\r\n      try {\r\n        await onDisableTrigger(id);\r\n      } finally {\r\n        setLoadingTriggerId(null);\r\n      }\r\n    },\r\n    [onDisableTrigger]\r\n  );\r\n\r\n  const handleRearmTrigger = useCallback(\r\n    async (id: string) => {\r\n      setLoadingTriggerId(id);\r\n      try {\r\n        await onRearmTrigger(id);\r\n      } finally {\r\n        setLoadingTriggerId(null);\r\n      }\r\n    },\r\n    [onRearmTrigger]\r\n  );\r\n\r\n  const handleDisableAll = useCallback(async () => {\r\n    if (!onDisableAll) return;\r\n    setIsKillSwitchLoading(true);\r\n    try {\r\n      await onDisableAll();\r\n    } finally {\r\n      setIsKillSwitchLoading(false);\r\n    }\r\n  }, [onDisableAll]);\r\n\r\n  const handleRearmAll = useCallback(async () => {\r\n    if (!onRearmAll) return;\r\n    setIsKillSwitchLoading(true);\r\n    try {\r\n      await onRearmAll();\r\n    } finally {\r\n      setIsKillSwitchLoading(false);\r\n    }\r\n  }, [onRearmAll]);\r\n\r\n  // Compact mode\r\n  if (compact) {\r\n    return (\r\n      <div className={`flex items-center gap-3 ${className}`}>\r\n        <BoltIcon className=\"h-4 w-4\" />\r\n        <span className=\"text-sm font-medium\">Triggers</span>\r\n        <Badge variant={armedCount > 0 ? 'default' : 'outline'}>\r\n          {armedCount} redo\r\n        </Badge>\r\n        {errorCount > 0 && (\r\n          <Badge variant=\"destructive\">\r\n            {errorCount} fel\r\n          </Badge>\r\n        )}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <Card className={className}>\r\n      <CardHeader className=\"pb-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <CardTitle className=\"flex items-center gap-2 text-base\">\r\n            <BoltIcon className=\"h-5 w-5\" />\r\n            Triggers\r\n          </CardTitle>\r\n\r\n          <div className=\"flex items-center gap-2\">\r\n            {/* Stats badges */}\r\n            <Badge variant={armedCount > 0 ? 'default' : 'outline'}>\r\n              {armedCount} redo\r\n            </Badge>\r\n            {errorCount > 0 && (\r\n              <Badge variant=\"destructive\">\r\n                {errorCount} fel\r\n              </Badge>\r\n            )}\r\n          </div>\r\n        </div>\r\n        <CardDescription>\r\n          {triggers.length} triggers ÔÇó Automatiserade h├ñndelser\r\n        </CardDescription>\r\n      </CardHeader>\r\n\r\n      <CardContent className=\"space-y-4\">\r\n        {/* Kill switch controls */}\r\n        {(onDisableAll || onRearmAll) && (\r\n          <div className=\"flex items-center gap-2 p-2 border rounded-lg bg-muted/30\">\r\n            {onDisableAll && armedCount > 0 && (\r\n              <AlertDialog>\r\n                <AlertDialogTrigger asChild>\r\n                  <Button\r\n                    variant=\"destructive\"\r\n                    size=\"sm\"\r\n                    disabled={isKillSwitchLoading}\r\n                    className=\"gap-1\"\r\n                  >\r\n                    <ShieldExclamationIcon className=\"h-4 w-4\" />\r\n                    N├Âdstopp\r\n                  </Button>\r\n                </AlertDialogTrigger>\r\n                <AlertDialogContent>\r\n                  <AlertDialogHeader>\r\n                    <AlertDialogTitle>Inaktivera alla triggers?</AlertDialogTitle>\r\n                    <AlertDialogDescription>\r\n                      Detta kommer att inaktivera alla {armedCount} aktiva triggers.\r\n                      Inga automatiska h├ñndelser kommer att k├Âras.\r\n                      Du kan ├Ñteraktivera dem manuellt efter├Ñt.\r\n                    </AlertDialogDescription>\r\n                  </AlertDialogHeader>\r\n                  <AlertDialogFooter>\r\n                    <AlertDialogCancel>Avbryt</AlertDialogCancel>\r\n                    <AlertDialogAction onClick={handleDisableAll}>\r\n                      Ja, inaktivera alla\r\n                    </AlertDialogAction>\r\n                  </AlertDialogFooter>\r\n                </AlertDialogContent>\r\n              </AlertDialog>\r\n            )}\r\n\r\n            {onRearmAll && armedCount < triggers.filter((t) => t.enabled).length && (\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={handleRearmAll}\r\n                disabled={isKillSwitchLoading}\r\n                className=\"gap-1\"\r\n              >\r\n                <ShieldCheckIcon className=\"h-4 w-4\" />\r\n                ├àteraktivera alla\r\n              </Button>\r\n            )}\r\n\r\n            {killSwitchActive && (\r\n              <div className=\"flex items-center gap-1 text-sm text-destructive ml-auto\">\r\n                <ExclamationTriangleIcon className=\"h-4 w-4\" />\r\n                N├Âdstopp aktivt\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n        {/* Trigger groups */}\r\n        {groups.length === 0 ? (\r\n          <div className=\"text-center py-8 text-muted-foreground\">\r\n            <BoltIcon className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\r\n            <p>Inga triggers i denna session</p>\r\n          </div>\r\n        ) : (\r\n          <div className=\"space-y-2\">\r\n            {groups.map((group) => (\r\n              <TriggerGroupSection\r\n                key={group.status}\r\n                group={group}\r\n                onFireTrigger={handleFireTrigger}\r\n                onDisableTrigger={handleDisableTrigger}\r\n                onRearmTrigger={handleRearmTrigger}\r\n                loadingTriggerId={loadingTriggerId}\r\n              />\r\n            ))}\r\n          </div>\r\n        )}\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\TriggerPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\TriggerTemplateLibrary.tsx","messages":[{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":334,"column":75,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":336,"endColumn":13},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":384,"column":50,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":386,"endColumn":11},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded text detected: \"S├Âk mallar...\". Consider using useTranslations() or t() for internationalization.","line":509,"column":25,"nodeType":"Literal","messageId":"hardcodedString","endLine":509,"endColumn":40},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":519,"column":18,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":519,"endColumn":50},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":524,"column":18,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":524,"endColumn":48},{"ruleId":"lekbanken/no-hardcoded-strings","severity":2,"message":"Hardcoded JSX text detected. Use {t(\"key\")} instead of literal text.","line":579,"column":32,"nodeType":"JSXText","messageId":"hardcodedJsxText","endLine":581,"endColumn":13}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * TriggerTemplateLibrary Component\r\n * \r\n * UI for browsing and selecting trigger templates.\r\n * Makes it easy to add pre-configured triggers to a game.\r\n * \r\n * Backlog B.6: Trigger template library\r\n */\r\n\r\n'use client';\r\n\r\nimport React, { useState, useMemo } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n  CardFooter,\r\n} from '@/components/ui/card';\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from '@/components/ui/dialog';\r\nimport { Select } from '@/components/ui/select';\r\nimport { Tabs, TabPanel } from '@/components/ui/tabs';\r\nimport { ScrollArea } from '@/components/ui/scroll-area';\r\nimport {\r\n  MagnifyingGlassIcon,\r\n  PlusIcon,\r\n  BoltIcon,\r\n  BookOpenIcon,\r\n  ChevronRightIcon,\r\n} from '@heroicons/react/24/outline';\r\nimport {\r\n  TRIGGER_TEMPLATES,\r\n  TEMPLATE_CATEGORY_LABELS,\r\n  TEMPLATE_CATEGORY_ICONS,\r\n  searchTemplates,\r\n  applyTemplateVariables,\r\n  type TriggerTemplate,\r\n  type TriggerTemplateCategory,\r\n  type TriggerTemplateVariable,\r\n} from '@/lib/trigger-templates';\r\nimport type { TriggerCondition, TriggerAction } from '@/types/trigger';\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface TriggerTemplateLibraryProps {\r\n  /** Called when a template is selected and configured */\r\n  onSelect: (config: {\r\n    name: string;\r\n    when: TriggerCondition;\r\n    then: TriggerAction[];\r\n    executeOnce?: boolean;\r\n    delaySeconds?: number;\r\n  }) => void;\r\n  /** Available steps for variable selection */\r\n  steps?: Array<{ id: string; name: string }>;\r\n  /** Available phases for variable selection */\r\n  phases?: Array<{ id: string; name: string }>;\r\n  /** Available artifacts for variable selection */\r\n  artifacts?: Array<{ id: string; name: string; type: string }>;\r\n  /** Available signal channels */\r\n  channels?: string[];\r\n  /** Whether the library is in a dialog */\r\n  asDialog?: boolean;\r\n  /** Dialog open state (when asDialog=true) */\r\n  open?: boolean;\r\n  /** Dialog open change callback */\r\n  onOpenChange?: (open: boolean) => void;\r\n  /** Optional className */\r\n  className?: string;\r\n}\r\n\r\n// =============================================================================\r\n// Constants\r\n// =============================================================================\r\n\r\nconst COMPLEXITY_LABELS = {\r\n  beginner: 'Enkel',\r\n  intermediate: 'Medel',\r\n  advanced: 'Avancerad',\r\n};\r\n\r\nconst COMPLEXITY_COLORS = {\r\n  beginner: 'bg-green-500/10 text-green-600 border-green-500/20',\r\n  intermediate: 'bg-yellow-500/10 text-yellow-600 border-yellow-500/20',\r\n  advanced: 'bg-red-500/10 text-red-600 border-red-500/20',\r\n};\r\n\r\nconst CATEGORY_ORDER: TriggerTemplateCategory[] = [\r\n  'navigation',\r\n  'puzzle',\r\n  'reveal',\r\n  'timing',\r\n  'feedback',\r\n  'advanced',\r\n];\r\n\r\n// =============================================================================\r\n// Sub-Component: TemplateCard\r\n// =============================================================================\r\n\r\ninterface TemplateCardProps {\r\n  template: TriggerTemplate;\r\n  onSelect: () => void;\r\n}\r\n\r\nfunction TemplateCard({ template, onSelect }: TemplateCardProps) {\r\n  return (\r\n    <Card\r\n      className=\"cursor-pointer hover:border-primary/50 transition-colors\"\r\n      onClick={onSelect}\r\n    >\r\n      <CardHeader className=\"pb-2\">\r\n        <div className=\"flex items-start justify-between\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <span className=\"text-xl\">\r\n              {TEMPLATE_CATEGORY_ICONS[template.category]}\r\n            </span>\r\n            <CardTitle className=\"text-sm font-medium\">\r\n              {template.name}\r\n            </CardTitle>\r\n          </div>\r\n          <Badge\r\n            variant=\"outline\"\r\n            className={COMPLEXITY_COLORS[template.complexity]}\r\n          >\r\n            {COMPLEXITY_LABELS[template.complexity]}\r\n          </Badge>\r\n        </div>\r\n      </CardHeader>\r\n      <CardContent className=\"pb-3\">\r\n        <CardDescription className=\"text-xs line-clamp-2\">\r\n          {template.description}\r\n        </CardDescription>\r\n      </CardContent>\r\n      <CardFooter className=\"pt-0 pb-3\">\r\n        <div className=\"flex flex-wrap gap-1\">\r\n          {template.tags.slice(0, 3).map((tag) => (\r\n            <Badge key={tag} variant=\"default\" className=\"text-xs\">\r\n              {tag}\r\n            </Badge>\r\n          ))}\r\n          {template.tags.length > 3 && (\r\n            <Badge variant=\"default\" className=\"text-xs\">\r\n              +{template.tags.length - 3}\r\n            </Badge>\r\n          )}\r\n        </div>\r\n      </CardFooter>\r\n    </Card>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: VariableInput\r\n// =============================================================================\r\n\r\ninterface VariableInputProps {\r\n  variable: TriggerTemplateVariable;\r\n  value: unknown;\r\n  onChange: (value: unknown) => void;\r\n  steps?: Array<{ id: string; name: string }>;\r\n  phases?: Array<{ id: string; name: string }>;\r\n  artifacts?: Array<{ id: string; name: string; type: string }>;\r\n  channels?: string[];\r\n}\r\n\r\nfunction VariableInput({\r\n  variable,\r\n  value,\r\n  onChange,\r\n  steps = [],\r\n  phases = [],\r\n  artifacts = [],\r\n  channels = [],\r\n}: VariableInputProps) {\r\n  switch (variable.type) {\r\n    case 'step':\r\n      return (\r\n        <Select\r\n          value={value as string}\r\n          onChange={(e) => onChange(e.target.value)}\r\n          options={[\r\n            { value: '', label: 'V├ñlj steg' },\r\n            ...steps.map((step) => ({ value: step.id, label: step.name })),\r\n          ]}\r\n        />\r\n      );\r\n\r\n    case 'phase':\r\n      return (\r\n        <Select\r\n          value={value as string}\r\n          onChange={(e) => onChange(e.target.value)}\r\n          options={[\r\n            { value: '', label: 'V├ñlj fas' },\r\n            ...phases.map((phase) => ({ value: phase.id, label: phase.name })),\r\n          ]}\r\n        />\r\n      );\r\n\r\n    case 'artifact':\r\n      return (\r\n        <Select\r\n          value={value as string}\r\n          onChange={(e) => onChange(e.target.value)}\r\n          options={[\r\n            { value: '', label: 'V├ñlj artefakt' },\r\n            ...artifacts.map((artifact) => ({\r\n              value: artifact.id,\r\n              label: `${artifact.name} (${artifact.type})`,\r\n            })),\r\n          ]}\r\n        />\r\n      );\r\n\r\n    case 'channel':\r\n      return (\r\n        <Select\r\n          value={value as string}\r\n          onChange={(e) => onChange(e.target.value)}\r\n          options={[\r\n            { value: '', label: 'V├ñlj kanal' },\r\n            ...channels.map((channel) => ({ value: channel, label: channel })),\r\n            { value: 'success', label: 'success' },\r\n            { value: 'warning', label: 'warning' },\r\n            { value: 'attention', label: 'attention' },\r\n          ]}\r\n        />\r\n      );\r\n\r\n    case 'number':\r\n    case 'duration':\r\n      return (\r\n        <Input\r\n          type=\"number\"\r\n          value={value as number}\r\n          onChange={(e) => onChange(Number(e.target.value))}\r\n          min={0}\r\n        />\r\n      );\r\n\r\n    case 'string':\r\n    default:\r\n      return (\r\n        <Input\r\n          type=\"text\"\r\n          value={value as string}\r\n          onChange={(e) => onChange(e.target.value)}\r\n          placeholder={variable.description}\r\n        />\r\n      );\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// Sub-Component: ConfigureTemplateDialog\r\n// =============================================================================\r\n\r\ninterface ConfigureTemplateDialogProps {\r\n  template: TriggerTemplate | null;\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  onConfirm: (values: Record<string, unknown>) => void;\r\n  steps?: Array<{ id: string; name: string }>;\r\n  phases?: Array<{ id: string; name: string }>;\r\n  artifacts?: Array<{ id: string; name: string; type: string }>;\r\n  channels?: string[];\r\n}\r\n\r\nfunction ConfigureTemplateDialog({\r\n  template,\r\n  open,\r\n  onOpenChange,\r\n  onConfirm,\r\n  steps,\r\n  phases,\r\n  artifacts,\r\n  channels,\r\n}: ConfigureTemplateDialogProps) {\r\n  const [values, setValues] = useState<Record<string, unknown>>({});\r\n\r\n  // Initialize with defaults when template changes\r\n  React.useEffect(() => {\r\n    if (template) {\r\n      const defaults: Record<string, unknown> = {};\r\n      for (const variable of template.variables) {\r\n        if (variable.defaultValue !== undefined) {\r\n          defaults[variable.name] = variable.defaultValue;\r\n        }\r\n      }\r\n      setValues(defaults);\r\n    }\r\n  }, [template]);\r\n\r\n  if (!template) return null;\r\n\r\n  const handleValueChange = (name: string, value: unknown) => {\r\n    setValues((prev) => ({ ...prev, [name]: value }));\r\n  };\r\n\r\n  const canConfirm = template.variables\r\n    .filter((v) => v.required)\r\n    .every((v) => values[v.name] !== undefined && values[v.name] !== '');\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"max-w-lg\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"flex items-center gap-2\">\r\n            <span className=\"text-xl\">\r\n              {TEMPLATE_CATEGORY_ICONS[template.category]}\r\n            </span>\r\n            {template.name}\r\n          </DialogTitle>\r\n          <DialogDescription>{template.description}</DialogDescription>\r\n        </DialogHeader>\r\n\r\n        <div className=\"space-y-4 py-4\">\r\n          {template.variables.length === 0 ? (\r\n            <p className=\"text-sm text-muted-foreground text-center py-4\">\r\n              Denna mall beh├Âver ingen konfiguration.\r\n            </p>\r\n          ) : (\r\n            template.variables.map((variable) => (\r\n              <div key={variable.name} className=\"space-y-2\">\r\n                <Label className=\"flex items-center gap-1\">\r\n                  {variable.label}\r\n                  {variable.required && (\r\n                    <span className=\"text-red-500\">*</span>\r\n                  )}\r\n                </Label>\r\n                {variable.description && (\r\n                  <p className=\"text-xs text-muted-foreground\">\r\n                    {variable.description}\r\n                  </p>\r\n                )}\r\n                <VariableInput\r\n                  variable={variable}\r\n                  value={values[variable.name]}\r\n                  onChange={(v) => handleValueChange(variable.name, v)}\r\n                  steps={steps}\r\n                  phases={phases}\r\n                  artifacts={artifacts}\r\n                  channels={channels}\r\n                />\r\n              </div>\r\n            ))\r\n          )}\r\n\r\n          {template.examples && template.examples.length > 0 && (\r\n            <div className=\"pt-4 border-t\">\r\n              <p className=\"text-sm font-medium mb-2\">Exempel:</p>\r\n              <ul className=\"text-sm text-muted-foreground space-y-1\">\r\n                {template.examples.map((example, i) => (\r\n                  <li key={i} className=\"flex items-start gap-2\">\r\n                    <ChevronRightIcon className=\"h-4 w-4 mt-0.5 text-muted-foreground\" />\r\n                    {example}\r\n                  </li>\r\n                ))}\r\n              </ul>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        <DialogFooter>\r\n          <Button variant=\"outline\" onClick={() => onOpenChange(false)}>\r\n            Avbryt\r\n          </Button>\r\n          <Button onClick={() => onConfirm(values)} disabled={!canConfirm}>\r\n            <PlusIcon className=\"h-4 w-4 mr-2\" />\r\n            L├ñgg till trigger\r\n          </Button>\r\n        </DialogFooter>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function TriggerTemplateLibrary({\r\n  onSelect,\r\n  steps = [],\r\n  phases = [],\r\n  artifacts = [],\r\n  channels = [],\r\n  asDialog = false,\r\n  open,\r\n  onOpenChange,\r\n  className,\r\n}: TriggerTemplateLibraryProps) {\r\n  const [searchQuery, setSearchQuery] = useState('');\r\n  const [selectedCategory, setSelectedCategory] = useState<TriggerTemplateCategory | 'all'>('all');\r\n  const [activeTab, setActiveTab] = useState('browse');\r\n  const [selectedTemplate, setSelectedTemplate] = useState<TriggerTemplate | null>(null);\r\n  const [configDialogOpen, setConfigDialogOpen] = useState(false);\r\n\r\n  // Filter templates\r\n  const filteredTemplates = useMemo(() => {\r\n    let templates = TRIGGER_TEMPLATES;\r\n\r\n    if (searchQuery.trim()) {\r\n      templates = searchTemplates(searchQuery);\r\n    }\r\n\r\n    if (selectedCategory !== 'all') {\r\n      templates = templates.filter((t) => t.category === selectedCategory);\r\n    }\r\n\r\n    return templates;\r\n  }, [searchQuery, selectedCategory]);\r\n\r\n  // Handle template selection\r\n  const handleSelectTemplate = (template: TriggerTemplate) => {\r\n    setSelectedTemplate(template);\r\n    setConfigDialogOpen(true);\r\n  };\r\n\r\n  // Handle configuration confirm\r\n  const handleConfirm = (values: Record<string, unknown>) => {\r\n    if (!selectedTemplate) return;\r\n\r\n    const { when, then } = applyTemplateVariables(selectedTemplate, values);\r\n\r\n    onSelect({\r\n      name: selectedTemplate.name,\r\n      when,\r\n      then,\r\n      executeOnce: selectedTemplate.executeOnce,\r\n      delaySeconds: selectedTemplate.delaySeconds,\r\n    });\r\n\r\n    setConfigDialogOpen(false);\r\n    setSelectedTemplate(null);\r\n    onOpenChange?.(false);\r\n  };\r\n\r\n  // Tab configuration\r\n  const tabs = [\r\n    { id: 'browse', label: 'Bl├ñddra' },\r\n    { id: 'search', label: 'S├Âk' },\r\n  ];\r\n\r\n  const content = (\r\n    <div className={`space-y-4 ${className}`}>\r\n      {/* Tabs for browse/search */}\r\n      <Tabs tabs={tabs} activeTab={activeTab} onChange={setActiveTab} />\r\n\r\n      <TabPanel id=\"browse\" activeTab={activeTab}>\r\n        {/* Category filter */}\r\n        <div className=\"mb-4\">\r\n          <Select\r\n            value={selectedCategory}\r\n            onChange={(e) => setSelectedCategory(e.target.value as TriggerTemplateCategory | 'all')}\r\n            options={[\r\n              { value: 'all', label: 'Alla kategorier' },\r\n              ...CATEGORY_ORDER.map((cat) => ({\r\n                value: cat,\r\n                label: `${TEMPLATE_CATEGORY_ICONS[cat]} ${TEMPLATE_CATEGORY_LABELS[cat]}`,\r\n              })),\r\n            ]}\r\n          />\r\n        </div>\r\n\r\n        {/* Templates grid */}\r\n        <ScrollArea maxHeight=\"400px\">\r\n          {filteredTemplates.length === 0 ? (\r\n            <div className=\"text-center py-8 text-muted-foreground\">\r\n              <BookOpenIcon className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\r\n              <p>Inga mallar hittades</p>\r\n            </div>\r\n          ) : (\r\n            <div className=\"grid grid-cols-2 gap-3 pr-4\">\r\n              {filteredTemplates.map((template) => (\r\n                <TemplateCard\r\n                  key={template.id}\r\n                  template={template}\r\n                  onSelect={() => handleSelectTemplate(template)}\r\n                />\r\n              ))}\r\n            </div>\r\n          )}\r\n        </ScrollArea>\r\n      </TabPanel>\r\n\r\n      <TabPanel id=\"search\" activeTab={activeTab}>\r\n        {/* Search input */}\r\n        <div className=\"relative mb-4\">\r\n          <MagnifyingGlassIcon className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n          <Input\r\n            value={searchQuery}\r\n            onChange={(e) => setSearchQuery(e.target.value)}\r\n            placeholder=\"S├Âk mallar...\"\r\n            className=\"pl-9\"\r\n          />\r\n        </div>\r\n\r\n        {/* Search results */}\r\n        <ScrollArea maxHeight=\"400px\">\r\n          {searchQuery.trim() === '' ? (\r\n            <div className=\"text-center py-8 text-muted-foreground\">\r\n              <MagnifyingGlassIcon className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\r\n              <p>Ange s├Âkord f├Âr att hitta mallar</p>\r\n            </div>\r\n          ) : filteredTemplates.length === 0 ? (\r\n            <div className=\"text-center py-8 text-muted-foreground\">\r\n              <BookOpenIcon className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\r\n              <p>Inga mallar matchade s├Âkningen</p>\r\n            </div>\r\n          ) : (\r\n            <div className=\"grid grid-cols-2 gap-3 pr-4\">\r\n              {filteredTemplates.map((template) => (\r\n                <TemplateCard\r\n                  key={template.id}\r\n                  template={template}\r\n                  onSelect={() => handleSelectTemplate(template)}\r\n                />\r\n              ))}\r\n            </div>\r\n          )}\r\n        </ScrollArea>\r\n      </TabPanel>\r\n\r\n      {/* Stats */}\r\n      <div className=\"flex items-center justify-between text-sm text-muted-foreground pt-2 border-t\">\r\n        <span>{filteredTemplates.length} mallar</span>\r\n        <div className=\"flex items-center gap-3\">\r\n          <span className={COMPLEXITY_COLORS.beginner}>\r\n            {TRIGGER_TEMPLATES.filter((t) => t.complexity === 'beginner').length} enkla\r\n          </span>\r\n          <span className={COMPLEXITY_COLORS.intermediate}>\r\n            {TRIGGER_TEMPLATES.filter((t) => t.complexity === 'intermediate').length} medel\r\n          </span>\r\n          <span className={COMPLEXITY_COLORS.advanced}>\r\n            {TRIGGER_TEMPLATES.filter((t) => t.complexity === 'advanced').length} avancerade\r\n          </span>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Configuration dialog */}\r\n      <ConfigureTemplateDialog\r\n        template={selectedTemplate}\r\n        open={configDialogOpen}\r\n        onOpenChange={setConfigDialogOpen}\r\n        onConfirm={handleConfirm}\r\n        steps={steps}\r\n        phases={phases}\r\n        artifacts={artifacts}\r\n        channels={channels}\r\n      />\r\n    </div>\r\n  );\r\n\r\n  if (asDialog) {\r\n    return (\r\n      <Dialog open={open} onOpenChange={onOpenChange}>\r\n        <DialogContent className=\"max-w-3xl\">\r\n          <DialogHeader>\r\n            <DialogTitle className=\"flex items-center gap-2\">\r\n              <BoltIcon className=\"h-5 w-5\" />\r\n              Trigger-mallbibliotek\r\n            </DialogTitle>\r\n            <DialogDescription>\r\n              V├ñlj en f├ñrdig mall f├Âr att snabbt l├ñgga till en trigger\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          {content}\r\n        </DialogContent>\r\n      </Dialog>\r\n    );\r\n  }\r\n\r\n  return content;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\components\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\hooks\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\hooks\\useBatchArtifacts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\hooks\\useDirectorShortcuts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\hooks\\useLiveSession.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\hooks\\useMultiLanguageScript.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\hooks\\usePlayBroadcast.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\hooks\\usePuzzleRealtime.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\hooks\\useSessionAchievements.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\hooks\\useSessionAnalytics.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\hooks\\useSessionChat.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\hooks\\useSessionEvents.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\hooks\\useSessionReadiness.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\hooks\\useSessionState.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\hooks\\useSessionTimeline.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\hooks\\useSignalCapabilities.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\hooks\\useTriggerEngine.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\hooks\\withSignalAndTimeBank.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Dokument\\GitHub\\Lekbanken\\lekbanken-main\\features\\play\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
